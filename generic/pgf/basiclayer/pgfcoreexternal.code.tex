% Copyright 2006 by Till Tantau
%
% This file may be distributed and/or modified
%
% 1. under the LaTeX Project Public License and/or
% 2. under the GNU Public License.
%
% See the file doc/generic/pgf/licenses/LICENSE for more details.

\ProvidesFileRCS $Header: /cvsroot/pgf/pgf/generic/pgf/basiclayer/pgfcoreexternal.code.tex,v 1.1 2010/03/25 20:57:13 ludewich Exp $



\newif\ifpgfexternal@allow@aux

\pgfkeys{
	/pgf/images/include external/.code={\pgfimage{#1}},
	/pgf/images/aux in dpth/.is if=pgfexternal@allow@aux,
	/pgf/images/aux in dpth/.default=true
}

% The external read/write mechanism is used as follows:
%
% In your document, you put a number or all of your pgfpicture (or
% tikzpicture) environments inside a pair of \beginpgfexternal and
% \endpgfexternal. The \beginpgfexternal gets one parameter called the
% graphics name.
%
% Once this is done, the next step is to declare the names of your
% graphics in the document at the beginning using the
% \pgfdeclaregraphicname command.
%
% Now, when you typeset your document, each time a \beginpgfexternal
% command is encountered, it will be checked whether the corresponding
% graphics file exists. If this is the case, it will be included and
% the code between \beginpgfexternal and \endpgfexternal is
% ignored. Otherwise, the code is executed normally.
%
% Things change when you run tex on your file with the \jobname set to
% the name of a decalred graphics name. In this case, only your
% graphic will be typeset, the rest of the document will be "thrown away". 
% To be more precise, everything is gobbled up to the beginning
% of the first \beginpgfexternal with the given graphics name. Then,
% the content of the "environment" is put in a box (this "environment"
% need not contain a graphics, it may contain anything that can be put
% in a box). Then a single page is output whose size is exactly the
% size of the picture.
%
% So, once you have run tex repeatedly, each time with the jobname set
% to each of the graphics, you can then run tex on the whole document
% and this will cause all graphics to be included rather than begin
% typeset.
%
% Finally, once all the graphics have been created, you can also say
% \input pgfexternal.tex instead of including pgf/TikZ.


\newif\ifpgfexternalreadmainaux
\pgfexternalreadmainauxtrue

% Tells pgf which jobname is the name of the real file
%
% #1 = name
%
% Description:
%
% This command is used to tell pgf that the file named #1 should be
% typeset normally. If \jobname is not equal to #1, only
% the graphic called \jobname will be typeset. 
%
% Example:
%
% \pgfrealjobname{survey}
%
% Note that afterwards, \jobname will be set to the argument. In our
% example, \jobname will be 'survey'. This is to accomplish
% compatibility with aux-file generation.

\def\pgfrealjobname#1{%
  \global\let\pgfactualjobname=\jobname
  \edef\pgf@tempa{\expandafter\string\csname #1\endcsname}%
  \edef\pgf@tempb{\expandafter\string\csname\jobname\endcsname}%
  \ifx\pgf@tempa\pgf@tempb%
  \else%
    \pgf@external@grabshipouttrue%
	\pgfexternal@nofiles
	\ifpgfexternalreadmainaux
		% and reset the jobname. This should allow to handle any
		% \label/\ref constructions which are stored in \jobname.aux (and
		% which won't be found otherwise)
		\gdef\jobname{#1}%
	\fi
	\ifpgfexternal@allow@aux
		\csname newwrite\endcsname\w@pgfexternal@auxout
	\fi
  \fi%
  \gdef\pgfrealjobname##1{}% avoid multiple calls.
}

\def\pgfexternal@nofiles{%
	% replace \relax. The \nofiles macros does
	% \let\makeglossary=\relax
	% but the glossary.sty calls \renewcommand\makeglossary (which
	% will fail if \makeglossary=\relax). Stupid, but it works.
	\let\pgfexternal@nofiles@=\relax
	\def\relax{\relax}%
	%
	% suppress generation of LaTeX .aux, .toc etc files. 
	% generation of these files is not thread-safe.
	% the \csname \endcsname yields \relax if \nofiles doesn't exist.
	\csname nofiles\endcsname
	%
	\let\relax=\pgfexternal@nofiles@
}%

\newif\ifpgf@external@grabshipout
\newbox\pgfexternal@startupbox

\AtBeginDocument{%
  \ifpgf@external@grabshipout%
    \global\let\pgfexternal@originalshipout=\shipout%
    \global\def\shipout{\setbox\pgfpic=}%
    \maxdeadcycles=10000%
    % Ok, gather everything we have seen up to now in a box. This box
    % will contain any specials that have been used.
    {%
      \output{\global\setbox\pgfexternal@startupbox=\vbox{\csname @begindvi\endcsname\unvbox255}}%
      \hbox{}\eject%
    }%
  \fi%
}


% "Environment" for an external graphic.
%
% #1 = graphic name
%
% Example:
%
% \beginpgfgraphicnamed{main-graphic2}
%   \begin{tikzpicture}
%     ...
%   \end{tikzpicture}
% \endpgfgraphicnamed

\def\pgf@externalbegin#1{%
  % First, check whether we wish to grab this graphic:
  \let\pgf@next=\pgf@external@normal%
  \ifpgf@external@grabshipout%
    \edef\pgf@tempa{\expandafter\string\csname #1\endcsname}%
    \edef\pgf@tempb{\expandafter\string\csname\pgfactualjobname\endcsname}%
    \ifx\pgf@tempa\pgf@tempb%
      \let\pgf@next=\pgf@external@grab%
    \fi%
  \fi%
  \pgf@next{#1}%
}


\AtBeginDocument{
  \let\beginpgfgraphicnamed=\pgf@externalbegin% overwrite definition of pgfexternal.tex if necessary   
  \let\endpgfgraphicnamed=\unskip
}


% Normal operation: Include an external graphic instead of the
% picture, if such an external picture exists.
\def\pgf@external@normal#1{%
  \let\pgf@filename=\pgfutil@empty%
  \expandafter\pgf@findfile\pgfsys@imagesuffixlist:+{#1}%
  \ifx\pgf@filename\pgfutil@empty%
    % Ok, no such image... Just typeset the picture normally.
    \let\pgf@next=\relax%
  \else%
    \let\pgf@next=\pgf@replacepicturebygraphic%
  \fi%
  \pgf@next%  
}

\long\def\pgf@replacepicturebygraphic#1\endpgfgraphicnamed{%
	\expandafter\pgfincludeexternalgraphics\expandafter{\pgf@filename}\unskip
}

% This is almost the same as \includegraphics{#1}, but it checks
% whether '#1.dpth' exists. In such case, it restores the boxes depth
% stored in #1.dpth.
%
% Furthermore, the .dpth file may contain .aux related information
% collected for the external graphics (references). They start after
% the first line (if any).
\def\pgfincludeexternalgraphics#1{%
	\begingroup
	\setbox1=\hbox{\pgfkeysvalueof{/pgf/images/include external/.@cmd}{#1}\pgfeov}%
	%
	\let\pgfincludeexternalgraphics@dp=\pgfutil@empty
	\endlinechar=-1 % suppress white space at end
	\catcode`\@=11
	\openin\r@pgf@reada=#1.dpth
	\pgfincludeexternalgraphics@read@dpth
	\ifx\pgfincludeexternalgraphics@dp\pgfutil@empty
		\box1
	\else
		\dimen0=\pgfincludeexternalgraphics@dp\relax
		\hbox{\lower\dimen0 \box1 }%
	\fi
	\endgroup
}
%
% The .dpth consists of 0-N lines, where each is either a single
% dimension (the box' depth) or something which belongs to the .aux
% file (such lines will always start with a macro).
\def\pgfincludeexternalgraphics@read@dpth{%
	\ifeof\r@pgf@reada
		\closein\r@pgf@reada
	\else
		\read\r@pgf@reada to\pgfincludeexternalgraphics@auxline
		\ifx\pgfincludeexternalgraphics@auxline\pgfutil@empty
		\else
			\expandafter\pgfincludeexternalgraphics@read@dpth@line\pgfincludeexternalgraphics@auxline\pgfincludeexternalgraphics@read@dpth@line@EOI
		\fi
		\expandafter\pgfincludeexternalgraphics@read@dpth
	\fi
}%
\long\def\pgfincludeexternalgraphics@read@dpth@line#1#2\pgfincludeexternalgraphics@read@dpth@line@EOI{%
	\ifcat\noexpand#1\relax
		% Ah -- the first token is a control sequence. It belongs to
		% the .aux file.
		%
		% #1#2\relax% do NOT set the information! many LaTeX commands don't support it (\label for example)
		\pgfutil@ifundefined{if@filesw}{%
			% sorry, .aux file support only for latex
		}{%
			% append to main .aux file (for forward references)
			\if@filesw
				{%
				\toks0={#1#2}%
				% believe it or not, but the
				% \def\dpthimport{...}\dpthimport *makes* a
				% difference! In ensures any occuring `##' characters
				% are properly expanded to `#'.
				\immediate\write\@auxout{\noexpand\def\noexpand\dpthimport{\the\toks0 }\noexpand\dpthimport }%
				}%
			\fi				
		}%
	\else
		\def\pgfincludeexternalgraphics@dp{#1#2}%
	\fi
}%



% Grab operation: If jobname matches the graphic name, typeset this
% picture normall.
% REMARK:
%   this method is also invoked from within the tikz external library.
\def\pgf@external@grab#1{%
  \def\pgf@filename{#1}%
  \ifpgfexternal@allow@aux	
  	\begingroup
	\pgf@external@init@aux@in@dpth
  \fi
  \setbox\pgfpic=\hbox\bgroup\bgroup%
    \let\endpgfgraphicnamed=\pgf@externalend%
}

\let\pgf@external@@protected@write@orig=\protected@write
\long\def\pgf@external@@protected@write@immediate#1#2#3{%
	\begingroup
		\let\pgf@write@=\write
		\def\write{\noexpand\immediate\pgf@write@}%
		\pgf@external@@protected@write@orig{#1}{#2}{#3}%
	\endgroup
}%

\def\pgf@external@init@aux@in@dpth{%
	% tell LaTeX to write aux files...
	\csname @fileswtrue\endcsname
	% ... but redirect output to the .dpth file!
	\immediate\openout\w@pgfexternal@auxout=\pgf@filename.dpth
	\let\@auxout=\w@pgfexternal@auxout
	% ... and disable the correct page numbers. I can't get that
	% (because the correct page number is only available in the
	% shipout routine). Use immediate output:
	\let\protected@write=\pgf@external@@protected@write@immediate
}%

% REMARK:
%   this method is also invoked from within the tikz external library.
\def\pgf@externalend{%
  \unskip\egroup\egroup%
  {%
    \parindent0pt % leave the space
%    \leftmargin0pt%
%    \rightmargin0pt%
    \dimen0\ht\pgfpic%
    \advance\dimen0\dp\pgfpic%
	\ifdim\dp\pgfpic=0pt\relax
	\else% store the picture's depth. Otherwise, it would be lost.
		\ifpgfexternal@allow@aux
			\immediate\write\@auxout{\the\dp\pgfpic}%
			\immediate\closeout\@auxout
		\else
			\immediate\openout\pgf@plotwrite=\pgf@filename.dpth
			\immediate\write\pgf@plotwrite{\the\dp\pgfpic}%
			\immediate\closeout\pgf@plotwrite
		\fi
	\fi
    \pgfsys@papersize{\the\wd\pgfpic}{\the\dimen0}%
    \setbox0=\vbox{%
      \kern -1truein %
      \hbox{%
        \kern -1truein %
        \hbox to0pt{%
          \wd\pgfexternal@startupbox=0pt %
          \ht\pgfexternal@startupbox=0pt %
          \dp\pgfexternal@startupbox=0pt %
          \box\pgfexternal@startupbox%
          \pgfsys@atbegindocument\hss}%
        \box\pgfpic%
        \kern 1truein }%
      \kern1truein }%
    \pgfexternal@originalshipout\box0 %
  }%
  \ifpgfexternal@allow@aux
  	\endgroup
  \fi
}


\endinput

