% Copyright 2006 by Till Tantau
%
% This file may be distributed and/or modified
%
% 1. under the LaTeX Project Public License and/or
% 2. under the GNU Public License.
%
% See the file doc/generic/pgf/licenses/LICENSE for more details.

\ProvidesFileRCS[v\pgfversion] $Header: /cvsroot/pgf/pgf/generic/pgf/frontendlayer/tikz/libraries/tikzlibrarycalc.code.tex,v 1.1 2008/01/25 20:35:40 tantau Exp $


\def\tikz@parse@calculator#1(${%$
  \def\tikz@cc@command{#1}%
  \begingroup%
    %
    % Startup: Remove brace, if necessary
    %
    \expandafter\tikz@cc@look@for@l\pgfutil@firstofone%
}
\def\tikz@cc@look@for@l{%
  \pgfutil@ifnextchar l{%
    % Aha. Check for e.
    \tikz@cc@look@for@le
  }%
  {%
    % no. so enter main computation.
    \tikz@cc@main%
  }%
}

\def\tikz@cc@look@for@le l{%
  \pgfutil@ifnextchar e{%
    % Bingo. Must be let, not ln.
    \tikz@cc@handle@let l%
  }%
  {% Nope. Possibly ln. We will see...
    \tikz@cc@main l%
  }%
}


%
% Syntax: let \macroname = (coord) in ...
%
% Causes (\macroname) to be the same as (coord) and \macronamex to be
% its x-coordinate and \macronamey to be its y-coordinate

\def\tikz@cc@handle@let let{%
  \pgfutil@ifnextchar x{% just get rid of spaces
    \tikz@cc@handle@let@a}{\tikz@cc@handle@let@a}%
}
\def\tikz@cc@handle@let@a#1#2={%
  \edef\tikz@cc@name{\expandafter\pgfutil@gobble\string#1}%
  \tikz@scan@one@point\tikz@cc@dolet%
}
\def\tikz@cc@dolet#1{%
  \pgf@process{#1}%
  \expandafter\edef\csname\tikz@cc@name\endcsname{\the\pgf@x,\the\pgf@y}%
  \expandafter\edef\csname\tikz@cc@name x\endcsname{\the\pgf@x}%
  \expandafter\edef\csname\tikz@cc@name y\endcsname{\the\pgf@y}%
  \pgfutil@ifnextchar i{\tikz@cc@afterlet}{\PackageError{tikz}{``in'' expected}{}\tikz@cc@end}%
}
\def\tikz@cc@afterlet in{\tikz@cc@look@for@l}%


%
% Parse main computation. It's a series of optional factors in front
% of coordiantes.
%

\def\tikz@cc@main{%
  \pgf@xa=0pt% We accumulate the result in here.
  \pgf@ya=0pt%
  \tikz@cc@parse+% 
}

\def\tikz@cc@parse{%
  \pgfutil@ifnextchar${%$
    % Ok, we found the end...
    \tikz@cc@end%
  }
  {\pgfutil@ifnextchar+{%
      % Ok, we found a coordinate...
      \tikz@cc@add%
    }{%
      \pgfutil@ifnextchar-{%
        \tikz@cc@sub%
      }{%
        \PackageError{tikz}{+ or - expected}{}%
        \tikz@cc@end$%$
      }%
    }%
  }%
}

%
% The end is reached with $
%
\def\tikz@cc@end$#1){%$
    \xdef\tikz@marshal{\noexpand\pgfqpoint{\the\pgf@xa}{\the\pgf@ya}}%
  \endgroup%
  \expandafter\tikz@cc@command\expandafter{\tikz@marshal}%
}


%
% Another coordinate with +/-, possibly with a factor
%
\def\tikz@cc@add+{%
  \def\tikz@cc@factor{1}%
  \tikz@cc@factororcoordinate%
}
\def\tikz@cc@sub-{%
  \def\tikz@cc@factor{-1}%
  \tikz@cc@factororcoordinate%
}

%
% Check for a factor: If we see a (, its a coordinate...
% 
\def\tikz@cc@factororcoordinate{%
  \pgfutil@ifnextchar({%)
    % Ok, found coordinate
    \tikz@cc@coordinate%
  }{%
    \tikz@cc@parse@factor%
  }%
}

%
% ... otherwise it's a factor. It ends at ...*(
%
\def\tikz@cc@parse@factor#1*({%
  \pgfmathparse{#1*\tikz@cc@factor}%
  \let\tikz@cc@factor=\pgfmathresult%
  \tikz@cc@coordinate(%)
}

\def\tikz@cc@coordinate{%
  \tikz@scan@absolute\tikz@cc@after@coordinate%
}
\def\tikz@cc@after@coordinate#1{%
  \pgf@process{#1}%
  \pgf@xb=\pgf@x%
  \pgf@yb=\pgf@y%
  \tikz@cc@mid@checks%
}


%
% A coordinate can be followed by !...!(...)
%

\def\tikz@cc@mid@checks{
  \pgfutil@ifnextchar!{%
    \tikz@cc@mid%
  }{%
    \advance\pgf@xa by\tikz@cc@factor\pgf@xb%
    \advance\pgf@ya by\tikz@cc@factor\pgf@yb%
    \tikz@cc@parse% continue
  }%
}

\def\tikz@cc@mid!{%
  \pgfutil@ifnextchar({%
    \tikz@scan@one@point\tikz@cc@project%
  }{%
    \tikz@cc@mid@num%
  }%
}

%
% Simple case: (coord a)!number!(coord b)
%
% Returns the position that is at <number> fraction on the way from a
% to b. This, (a)!0!(b) is (a), (a)!.5!(b) is the middle and (a)!1!(b)
% is (b)
%
\def\tikz@cc@mid@num#1!{%
  \pgfmathparse{#1}%
  \let\tikz@cc@mid@factor=\pgfmathresult%
  \pgfmathparse{1-\tikz@cc@mid@factor}%
  \let\tikz@cc@mid@factor@one=\pgfmathresult%
  \tikz@scan@one@point\tikz@cc@after@mid%
}

\def\tikz@cc@after@mid#1{%
  \pgf@process{#1}%
  \pgf@xb=\tikz@cc@mid@factor@one\pgf@xb%
  \pgf@yb=\tikz@cc@mid@factor@one\pgf@yb%
  \advance\pgf@xb by\tikz@cc@mid@factor\pgf@x%
  \advance\pgf@yb by\tikz@cc@mid@factor\pgf@y%
  \tikz@cc@mid@checks%
}

%
% Projection case: (a)!(p)!(b)
%
% Projection of p on line from a to b
%
\def\tikz@cc@project#1{%
  \pgf@process{#1}%
  % Save in c
  \pgf@xc=\pgf@x%
  \pgf@yc=\pgf@y%
  \expandafter\tikz@scan@one@point\expandafter\tikz@cc@after@project\tikz@cc@scan@ex%
}

\def\tikz@cc@scan@ex!{}

\def\tikz@cc@after@project#1{%
  \pgf@process{#1}%
  % Ok, now we need to project (xc,yc) on the line (xb,xc) to (x,y)
  \advance\pgf@x by-\pgf@xb%
  \advance\pgf@y by-\pgf@yb%
  \advance\pgf@xc by-\pgf@xb%
  \advance\pgf@yc by-\pgf@yb%
  \pgf@process{\pgfpointnormalised{}}%
  % Scalar product
  \pgf@xc=\pgf@sys@tonumber{\pgf@xc}\pgf@x%
  \advance\pgf@xc by\pgf@sys@tonumber{\pgf@yc}\pgf@y%
  % and add
  \advance\pgf@xb by\pgf@sys@tonumber{\pgf@xc}\pgf@x%
  \advance\pgf@yb by\pgf@sys@tonumber{\pgf@xc}\pgf@y%
  \tikz@cc@mid@checks%
}