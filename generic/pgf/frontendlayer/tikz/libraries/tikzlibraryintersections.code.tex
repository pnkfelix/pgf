% Copyright 2008 by Mark Wibrow
%
% This file may be distributed and/or modified
%
% 1. under the LaTeX Project Public License and/or
% 2. under the GNU Free Documentation License.
%
% See the file doc/generic/pgf/licenses/LICENSE for more details.

\usepgflibrary{intersections}

\let\tikz@finish@orig=\tikz@finish
\def\tikz@finish{% 
	\iftikz@path@named%
		\pgfgetpath\tikz@temp@path%
		\expandafter\expandafter\expandafter\pgfutil@g@addto@macro\expandafter\tikz@path@name\expandafter{\tikz@temp@path}%
		\tikz@path@namedfalse%
	\fi%
	\tikz@finish@orig}

\newif\iftikz@path@named%
\def\tikz@cs@nonetext{none}
\pgfkeys{/tikz/path name/.code={%
	\def\tikz@cs@test{#1}%
	\ifx\tikz@cs@test\tikz@cs@nonetext%
		\tikz@path@namedfalse%
	\else%
		\tikz@path@namedtrue%
		\expandafter\def\expandafter\tikz@path@name\expandafter{\csname tikz@cs@path@name@#1\endcsname}%
		\expandafter\global\expandafter\let\tikz@path@name=\pgfutil@empty%
	\fi%
	}%
}%

\pgfkeys{/tikz/cs/id/.store in=\tikz@cs@intersect@id}

\let\tikz@cs@intersect@id=\pgfutil@empty

\tikzdeclarecoordinatesystem{solution}{%
	\tikzset{/tikz/cs/.unknown/.code={%
		\let\tikz@cs@value=\pgfkeyscurrentname%
		\tikzset{/tikz/cs/solution=\tikz@cs@value}}}%
	\tikzset{/tikz/cs/.cd,#1}%
	\ifnum\pgfkeysvalueof{/tikz/cs/solution}<1\relax%
		\pgfpoint@intersect@solution@orgin%
	\else%
		\ifnum\pgfkeysvalueof{/tikz/cs/solution}>\pgfintersectionsolutions\relax%
			\pgfpoint@intersect@solution@orgin%
		\else%
			\csname tikz@intersection@solution@\tikz@cs@intersect@id @\pgfkeysvalueof{/tikz/cs/solution}\endcsname%
		\fi%
	\fi%
}

\pgfkeys{/tikz/cs/.cd,
  first path/.code=\def\tikz@cs@path@a{#1}\def\tikz@cs@type@a{path},
  second path/.code=\def\tikz@cs@path@b{#1}\def\tikz@cs@type@b{path}
}

\def\tikz@intersect@path@and@path{%
	\pgfinterruptpath%
		\expandafter\path\tikz@cs@path@a[path name=tikz@cs@path@a];%
	\endpgfinterruptpath%
	\pgfinterruptpath%
		\expandafter\path\tikz@cs@path@b[path name=tikz@cs@path@b];%
	\endpgfinterruptpath%
	\tikz@intersectnamedpaths[]{tikz@cs@path@a}{tikz@cs@path@b}%
	\pgfpointintersectionsolution{\pgfkeysvalueof{/tikz/cs/solution}}%
}%

\pgfkeys{/tikz/cs/.cd,
	first path name/.code=\def\tikz@cs@path@a{#1}\def\tikz@cs@type@a{namedpath},
	second path name/.code=\def\tikz@cs@path@b{#1}\def\tikz@cs@type@b{namedpath},
	path names/.code=\tikz@cs@namedpath@parse#1\tikz@stop
}

\def\tikz@intersect@namedpath@and@namedpath{%
	\tikz@@intersectnamedpaths%
	\expandafter\pgfpointintersectionsolution{\pgfkeysvalueof{/tikz/cs/solution}}%
}

\def\tikzintersectnamedpaths{\pgfutil@ifnextchar[{\tikz@intersectnamedpaths}{\tikz@intersectnamedpaths[]}}

\def\tikz@intersectnamedpaths[#1]#2#3{%
	\tikzset{/tikz/cs/.cd,#1}%
	\def\tikz@cs@path@a{#2}%
	\def\tikz@cs@path@b{#3}%
	\tikz@@intersectnamedpaths%	
}%

\def\tikz@@intersectnamedpaths{%
	\pgfutil@ifundefined{tikz@cs@path@name@\tikz@cs@path@a}{%
	\PackageError{tikz}{I do not know the path named `\tikz@cs@path@a'. Perhaps you misspelt it}{}}%
	{\pgfutil@ifundefined{tikz@cs@path@name@\tikz@cs@path@b}{%
		\PackageError{tikz}{I do not know the path named `\tikz@cs@path@b'. Perhaps you misspelt it}{}}%
		{%
			\pgfintersectionofpaths%
				{\expandafter\pgfsetpath\csname tikz@cs@path@name@\tikz@cs@path@a\endcsname}%
				{\expandafter\pgfsetpath\csname tikz@cs@path@name@\tikz@cs@path@b\endcsname}%
				\expandafter\edef\csname\tikz@cs@intersect@id solutions\endcsname{\the\pgfintersectionsolutions}%
				\tikz@intersect@translate@solutions%
		}%
	}%
	\let\tikz@cs@intersect@id=\pgfutil@empty%
}
	

\def\tikz@cs@namedpath@parse#1 and #2\tikz@stop{%
	\def\tikz@cs@path@a{#1}%
	\def\tikz@cs@path@b{#2}%
	\def\tikz@cs@type@a{namedpath}
	\def\tikz@cs@type@b{namedpath}
}

\pgfkeys{%
	/tikz/intersect named paths/.code={%
		\tikz@cs@namedpath@parse#1\tikz@stop%
		\tikz@@intersectnamedpaths%
	},
	/tikz/intersection id/.store in=\tikz@cs@intersect@id,
	/tikz/intersect named paths/.code={\tikzset{/tikz/cs/.cd, #1}\tikz@@intersectnamedpaths}
}

\def\tikz@intersect@translate@solutions{%
	\pgfmathloop%
		\ifnum\pgfmathcounter>\pgfintersectionsolutions%
		\else%
			\pgfpointintersectionsolution{\pgfmathcounter}%
			\def\tikz@marshal{\expandafter\def\csname tikz@intersection@solution@\tikz@cs@intersect@id @\pgfmathcounter\endcsname}%
			\expandafter\expandafter\expandafter\tikz@marshal\expandafter\expandafter\expandafter%
			{\csname pgfpoint@intersect@solution@\pgfmathcounter\endcsname}%
	\repeatpgfmathloop%
}

\endinput
