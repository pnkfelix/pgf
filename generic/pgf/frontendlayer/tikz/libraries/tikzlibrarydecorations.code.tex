% Copyright 2008 by Mark Wibrow
%
% This file may be distributed and/or modified
%
% 1. under the LaTeX Project Public License and/or
% 2. under the GNU Public License.
%
% See the file doc/generic/pgf/licenses/LICENSE for more details.

\usepgflibrary{decorations}

\newif\iftikz@decorate
\newif\iftikz@metadecoration

\def\tikz@lib@dec@addtomacro#1#2{\expandafter\def\expandafter#1\expandafter{#1#2}}

\let\tikz@lib@dec@decorationlist\tikz@nonetext
\let\tikz@lib@dec@lastdecorationlist\tikz@nonetext

% /tikz/decoration=<decoration name>
%
% Decorate the path with a single decoration.
%
% Examples:
%
%	\tikz\draw [decoration=crosses]	
%		(0,0) ..controls (0,2) and (3,0) .. (3,2);
%		
%	
%	\tikz\draw (-1,0) -- (0,0) 
%		[decoration=zigzag]	.. controls (0,2) and (3,0) .. (3,2) 
%		[decoration=none]   -- (4,2);
%
%	\pgfdeclaredecoration{stars}{move}{
%		\state{move}[width=7.5pt, next state=star]{}
%	  \state{star}[width=7.5pt, next state=move]
%	  {
%	  	\pgfmathparse{round(rnd*100)}
%	  	\pgfsetfillcolor{yellow!\pgfmathresult!orange}
%	    \pgfsetstrokecolor{yellow!\pgfmathresult!red}
%	    \pgfmathparse{rnd*.75+.25}
%	    \pgftransformscale{\pgfmathresult}
%	    \pgfnode{star}{center}{}{}{\pgfusepath{stroke,fill}}
%	  }
%	  \state{final}
%	  {
%	  	\pgfpathmoveto{\pgfpointdecoratedpathlast}
%	  }
%	}
%	
%	\tikz\path[decoration=stars, rotate=45]
%		 (0,0) .. controls (0,2)  and (3,2)  .. (3,0)
%		       .. controls (3,-3) and (0,0)  .. (0,-3)
%		       .. controls (0,-5) and (3,-5) .. (3,-3); 
%
\tikzset{%
	decoration/.code={%
		\def\tikz@lib@dec@decorationlist{#1}%
		\ifx\tikz@lib@dec@decorationlist\tikz@nonetext%
		\else%
			\def\tikz@lib@dec@decorationlist{{#1}{\pgfdecoratedpathlength}{}{}}%
		\fi%
		\tikz@metadecorationfalse%
	}
}


% /tikz/meta decoration=<metadecoration name>
%
% Decorate the path with a meta decoration.
%
% Example:
%
%	\pgfdeclaremetadecoration{fancy line}{line to}{
%		\state{line to}[width=1cm, next state=zigzag]
%		{
%			\decoration{lineto}
%			\beforedecoration
%			{
%				\pgfpathmoveto{\pgfpointdecoratedpathfirst}		
%			}	
%			\afterdecoration
%			{
%				\pgfsetstrokecolor{black}
%				\pgfusepath{stroke}			
%			}
%		}
%		\state{zigzag}[width=2cm, next state=line to]
%		{
%			\decoration{zigzag}	
%			\beforedecoration
%			{
%				\pgfpathmoveto{\pgfpointdecoratedpathfirst}		
%			}
%			\afterdecoration
%			{
%				\pgfsetstrokecolor{red}
%				\pgfusepath{stroke}	
%			}
%		}
%		\state{final}
%		{
%			\decoration{lineto}
%			\beforedecoration
%			{
%				\pgfpathmoveto{\pgfpointdecoratedpathfirst}		
%			}
%			\afterdecoration
%			{
%				\pgfsetstrokecolor{black}
%				\pgfusepath{stroke}			
%			}
%		}
%	}
%	
%	\tikz\draw[meta decoration=fancy line]
%		 	(0,0) .. controls (0,2)  and (3,2)  .. (3,0)
%			      .. controls (3,-3) and (0,0)  .. (0,-3)
%			      .. controls (0,-5) and (3,-5) .. (3,-3); 
%			      
\tikzset{%
	meta decoration/.code={%
		\def\tikz@lib@dec@decorationlist{#1}%
		\tikz@lib@dec@decorationlist{#1}
		\tikz@metadecorationtrue%
	}
}

% Internal environment for tikz decorations.
%
\def\tikz@lib@dec@env{%
	\iftikz@metadecoration%
		\let\tikz@lib@dec@next\tikz@lib@dec@metadecoration@env%
	\else%
		\let\tikz@lib@dec@next\tikz@lib@dec@decoration@env%
	\fi%
	\tikz@lib@dec@next%
}

\def\tikz@lib@dec@decoration@env#1{%
	\pgfdecoration{#1}%
		\def\tikz@lib@dec@lastdecorationlist{#1}%
		\tikz@decoratetrue%
		\ifx\pgfdecorateexistingpath\pgfutil@empty%
			\pgfpathmoveto{\pgfqpoint{\the\tikz@lastxsaved}{\the\tikz@lastysaved}}%
		\fi%
}

\def\tikz@lib@dec@metadecoration@env#1{%
	\pgfmetadecoration{#1}%
		\def\tikz@lib@dec@lastdecorationlist{#1}%
		\tikz@decoratetrue%
		\ifx\pgfdecorateexistingpath\pgfutil@empty%
			\pgfpathmoveto{\pgfqpoint{\the\tikz@lastxsaved}{\the\tikz@lastysaved}}%
		\fi%
}

\def\endtikz@lib@dec@env{%
	\iftikz@metadecoration%
		\let\tikz@lib@dec@next\tikz@lib@dec@metadecoration@endenv%
	\else%
		\let\tikz@lib@dec@next\tikz@lib@dec@decoration@endenv%
	\fi%
	\tikz@lib@dec@next%
}


\def\tikz@lib@dec@decoration@endenv{\endpgfdecoration}%

\def\tikz@lib@dec@metadecoration@endenv{\endpgfmetadecoration}%
	

\def\tikz@parse@options#1]{%
	\tikzset{#1}%
	%
	% Update decoration here otherwise some key values 
	% will be lost inside the scope of the decoration.
	% 
  \expandafter\tikz@lib@dec@check\expandafter{\tikz@lib@dec@decorationlist}%
  \tikz@scan@next@command%
}


\def\tikz@lib@dec@check#1{%
	\def\tikz@lib@dec@decorationlist{#1}%
	\ifx\tikz@lib@dec@decorationlist\tikz@lib@dec@lastdecorationlist%
	\else%
		\ifx\tikz@lib@dec@lastdecorationlist\tikz@nonetext%
			% Start a new decoration.
			\tikz@lib@dec@env{#1}%
		\else%
			\ifx\tikz@lib@dec@decorationlist\tikz@nonetext%
				% End existing decoration.
				\endtikz@lib@dec@env%
			\else%
				% End existing decoration and start new decoration.
				\endtikz@lib@dec@env%
				\tikz@lib@dec@env{#1}%
			\fi%
		\fi%
	\fi%
}


% Hack \tikz@@command@path.
%
\def\tikz@@command@path{%
  \edef\tikzscope@linewidth{\the\pgflinewidth}%
  \begingroup%
    \let\tikz@options=\pgfutil@empty%
    \let\tikz@mode=\pgfutil@empty%
    \let\tikz@moveto@waiting=\relax%
    \let\tikz@timer=\relax%
    \let\tikz@collected@onpath=\pgfutil@empty%
    \let\tikz@preactions=\pgfutil@empty%
    \let\tikz@postactions=\pgfutil@empty%
    \tikz@snakedfalse%
    \tikz@decoratefalse%
    \let\tikz@lib@dec@decorationlist\tikz@nonetext%
    \tikz@node@is@a@labelfalse%
    \tikz@expandcount=1000\relax%
    \tikz@lastx=0pt%
    \tikz@lasty=0pt%
    \tikz@lastxsaved=0pt%
    \tikz@lastysaved=0pt%
    \tikzset{every path/.try}%
    \tikz@scan@next@command%
}

% Hack \tikz@path@close for closing a decorated path.
%
\def\tikz@path@close#1{%
	\iftikz@snaked%
    {%
      \pgftransformreset%
      \pgfpathsnakesto{\tikz@presnake,{\tikz@snake}{\tikz@mainsnakelength},\tikz@postsnake}{#1}%
    }%
  \else%
	  \iftikz@decorate%
	  	\pgfpathlineto{#1}%
	  	\endtikz@lib@dec@env%
	  \fi%
  \fi%
  \pgfpathclose%
}

% Hack \tikz@finish.
%
\let\tikz@orig@finish\tikz@finish
\def\tikz@finish{%
	\iftikz@decorate%
		\endtikz@lib@dec@env%
	\fi%
	\tikz@decoratefalse%
	\tikz@orig@finish}
		
\endinput