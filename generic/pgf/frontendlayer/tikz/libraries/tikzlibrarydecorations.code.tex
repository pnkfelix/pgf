% Copyright 2008 by Mark Wibrow
%
% This file may be distributed and/or modified
%
% 1. under the LaTeX Project Public License and/or
% 2. under the GNU Public License.
%
% See the file doc/generic/pgf/licenses/LICENSE for more details.

\usepgflibrary{decorations}



\newif\iftikz@metadecoration

\def\tikz@lib@dec@addtomacro#1#2{\expandafter\def\expandafter#1\expandafter{#1#2}}

\let\tikz@lib@dec@decorationlist\tikz@nonetext


% The decorate path command:

\def\tikz@lib@decoration[#1]{%
  \begingroup%
    % Just to be on the save side...
    %
    % Now, let's parse the options:
    \tikzset{#1}%
    %
    \ifx\tikz@lib@dec@decorationlist\tikz@nonetext%
    % Ok, let's forget about this decoration stuff...
    \else
      \expandafter\tikz@lib@do@dec%
    \fi%
}
\def\tikz@lib@do@dec{%
      % Ok, now what?
      \iftikz@metadecoration%
        \expandafter\pgfmetadecoration\expandafter{\tikz@lib@dec@decorationlist}%
      \else%
        \expandafter\pgfdecoration\expandafter{\tikz@lib@dec@decorationlist}%
      \fi%
      \ifx\pgfdecorateexistingpath\pgfutil@empty%
        \pgfpathmoveto{\pgfqpoint{\the\tikz@lastxsaved}{\the\tikz@lastysaved}}%
      \fi%
      % Now, we expect a brace.
      \pgfutil@ifnextchar\bgroup{%
        \begingroup%
        \aftergroup\tikz@enddecoration%
        \afterassignment\tikz@scan@next@command%
        \let\tikz@lib@next% gobble \bgroup%
      }%
      {%
        \PackageError{tikz}{A decoration must begin with a brace}{}%
        \tikz@enddecoration%
      }%
}

\def\tikz@enddecoration{%
    \ifx\tikz@lib@dec@decorationlist\tikz@nonetext%
    % ignore this.
    \else
      % Ok, now what?
      \iftikz@metadecoration%
        \endpgfmetadecoration%
      \else%
        \endpgfdecoration%
      \fi%
    \fi
  \endgroup%
}


% The decorate path command:
\def\tikz@lib@dec@decorate@path{%
  \ifx\tikz@lib@dec@decorationlist\tikz@nonetext%
  \else%
    \pgfgetpath\tikz@lib@dec@currentpath%
    \pgfsetpath\pgfutil@empty%
    \iftikz@metadecoration%
      \expandafter\pgfmetadecoration\expandafter{\tikz@lib@dec@decorationlist}%
        \pgfsetpath\tikz@lib@dec@currentpath%
      \endpgfmetadecoration%
    \else%
      \expandafter\pgfdecoration\expandafter{\tikz@lib@dec@decorationlist}%
        \pgfsetpath\tikz@lib@dec@currentpath%
      \endpgfdecoration%
    \fi%
  \fi%
}


% /tikz/decoration=<decoration name>
%
% Decorate the path with a single decoration.
%
% Examples:
%
%	\tikz\draw [decoration=crosses]	
%		(0,0) ..controls (0,2) and (3,0) .. (3,2);
%		
%	
%	\tikz\draw (-1,0) -- (0,0) 
%		[decoration=zigzag]	.. controls (0,2) and (3,0) .. (3,2) 
%		[decoration=none]   -- (4,2);
%
%	\pgfdeclaredecoration{stars}{move}{
%		\state{move}[width=7.5pt, next state=star]{}
%	  \state{star}[width=7.5pt, next state=move]
%	  {
%	  	\pgfmathparse{round(rnd*100)}
%	  	\pgfsetfillcolor{yellow!\pgfmathresult!orange}
%	    \pgfsetstrokecolor{yellow!\pgfmathresult!red}
%	    \pgfmathparse{rnd*.75+.25}
%	    \pgftransformscale{\pgfmathresult}
%	    \pgfnode{star}{center}{}{}{\pgfusepath{stroke,fill}}
%	  }
%	  \state{final}
%	  {
%	  	\pgfpathmoveto{\pgfpointdecoratedpathlast}
%	  }
%	}
%	
%	\tikz\path[decoration=stars, rotate=45]
%		 (0,0) .. controls (0,2)  and (3,2)  .. (3,0)
%		       .. controls (3,-3) and (0,0)  .. (0,-3)
%		       .. controls (0,-5) and (3,-5) .. (3,-3); 
%
\tikzset{%
  decoration/.code={%
    \def\tikz@lib@dec@decorationlist{#1}%
    \ifx\tikz@lib@dec@decorationlist\tikz@nonetext%
    \else%
      \def\tikz@lib@dec@decorationlist{{#1}{\pgfdecoratedpathlength}{}{}}%
    \fi%
    \tikz@metadecorationfalse%
  }
}


% /tikz/meta-decoration=<metadecoration name>
%
% Decorate the path with a meta decoration.
%
% Example:
%
%	\pgfdeclaremetadecoration{fancy line}{line to}{
%		\state{line to}[width=1cm, next state=zigzag]
%		{
%			\decoration{lineto}
%			\beforedecoration
%			{
%				\pgfpathmoveto{\pgfpointdecoratedpathfirst}		
%			}	
%			\afterdecoration
%			{
%				\pgfsetstrokecolor{black}
%				\pgfusepath{stroke}			
%			}
%		}
%		\state{zigzag}[width=2cm, next state=line to]
%		{
%			\decoration{zigzag}	
%			\beforedecoration
%			{
%				\pgfpathmoveto{\pgfpointdecoratedpathfirst}		
%			}
%			\afterdecoration
%			{
%				\pgfsetstrokecolor{red}
%				\pgfusepath{stroke}	
%			}
%		}
%		\state{final}
%		{
%			\decoration{lineto}
%			\beforedecoration
%			{
%				\pgfpathmoveto{\pgfpointdecoratedpathfirst}		
%			}
%			\afterdecoration
%			{
%				\pgfsetstrokecolor{black}
%				\pgfusepath{stroke}			
%			}
%		}
%	}
%	
%	\tikz\draw[meta-decoration=fancy line]
%		 	(0,0) .. controls (0,2)  and (3,2)  .. (3,0)
%			      .. controls (3,-3) and (0,0)  .. (0,-3)
%			      .. controls (0,-5) and (3,-5) .. (3,-3); 
%			      
\tikzset{%
  meta-decoration/.code={%
    \def\tikz@lib@dec@decorationlist{#1}%
    \tikz@metadecorationtrue%
  }
}



\endinput
