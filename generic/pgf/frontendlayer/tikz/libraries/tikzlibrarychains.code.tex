% Copyright 2006 by Till Tantau
%
% This file may be distributed and/or modified
%
% 1. under the LaTeX Project Public License and/or
% 2. under the GNU Public License.
%
% See the file doc/generic/pgf/licenses/LICENSE for more details.

\ProvidesFileRCS[v\pgfversion] $Header: /cvsroot/pgf/pgf/generic/pgf/frontendlayer/tikz/libraries/tikzlibrarychains.code.tex,v 1.1 2008/02/10 19:23:16 tantau Exp $

\tikzset{start chain/.default=,
         start chain/.code={%
    \tikz@lib@chain@parse{#1}%
    \ifx\tikz@lib@chain@name\pgfutil@empty%
      \def\tikz@lib@chain@name{chain}%
    \fi%
    \ifx\tikz@lib@chain@direction\relax%
      \let\tikz@lib@chain@direction=\tikz@lib@chain@default@direction%
    \fi%
    \expandafter\global\expandafter\let\csname tikz@lib@chain@exists@\tikz@lib@chain@name\endcsname=\pgfutil@empty% does not matter
    % Setup chain parameters
    \expandafter\gdef\csname tikz@lib@chain@count@\tikz@lib@chain@name\endcsname{0}%
    \expandafter\global\expandafter\let\csname tikz@lib@chain@dir@\tikz@lib@chain@name\endcsname\tikz@lib@chain@direction%
    \expandafter\gdef\csname tikz@lib@chain@last@\tikz@lib@chain@name\endcsname{}%
    \pgfkeysalso{/tikz/chain/.expanded=\tikz@lib@chain@name}%
    \let\chainin=\tikz@lib@chainin%
  },
  redirect chain/.default=,
  redirect chain/.code={%
    \tikz@lib@chain@parse{#1}%
    \ifx\tikz@lib@chain@name\pgfutil@empty%
      \pgfkeysgetvalue{/tikz/chain}\tikz@lib@chain@name%
    \fi%
    \expandafter\ifx\csname tikz@lib@chain@exists@\tikz@lib@chain@name\endcsname\relax%
      \PackageError{tikz}{Unknown chain ``#1''}{}%
    \else%
      \ifx\tikz@lib@chain@direction\relax%
        \PackageError{tikz}{You must provide a direction}{}%
      \fi%
      % Setup chain parameters
      \expandafter\global\expandafter\let\csname tikz@lib@chain@dir@\tikz@lib@chain@name\endcsname\tikz@lib@chain@direction%
    \fi%
  },
  join/.code=\tikz@lib@parse@join{#1},
  join/.default={}% 
}

\def\tikz@lib@chain@parse#1{%
  \pgfutil@in@{going }{#1}%
  \ifpgfutil@in@%
    \tikz@lib@chain@going#1\pgf@stop%
  \else%
    \pgfutil@in@{placed }{#1}%
    \ifpgfutil@in@%
      \tikz@lib@chain@positioning#1\pgf@stop%
    \else%
      \def\tikz@lib@chain@name{#1}%
      \let\tikz@lib@chain@direction\relax%
    \fi%
  \fi%
}

\def\tikz@lib@chain@going#1going #2\pgf@stop{%
  \def\tikz@lib@chain@name{#1}%
  \ifx\tikz@lib@chain@name\pgfutil@empty%
  \else%
    \tikz@lib@chain@strip#1\pgf@stop%%
  \fi%
  \tikz@lib@chain@is@goingtrue%
  \def\tikz@lib@chain@direction{%
    \ifx\tikzchainprevious\pgfutil@empty%
    \else%
      \tikz@lib@chain@place{#2}%
    \fi%
  }%  
}

\def\tikz@lib@chain@positioning#1placed #2\pgf@stop{%
  \def\tikz@lib@chain@name{#1}%
  \ifx\tikz@lib@chain@name\pgfutil@empty%
  \else%
    \tikz@lib@chain@strip#1\pgf@stop%%
  \fi%
  \tikz@lib@chain@is@goingfalse%
  \def\tikz@lib@chain@direction{\tikz@lib@chain@place{#2}}%
}
\newif\iftikz@lib@chain@is@going


\tikzset{/tikz/chain default direction/.code=%
  {%
    \tikz@lib@chain@parse{#1}%
    \let\tikz@lib@chain@default@direction=\tikz@lib@chain@direction%
  },%
  /tikz/chain default direction=going right
}

\tikzset{chain/.initial=chain}
\tikzset{
  on chain/.default=,
  on chain/.code=\tikz@lib@on@chain{#1}%
}
\def\tikz@lib@on@chain#1{%    
  \tikz@lib@chain@parse{#1}%
  \ifx\tikz@lib@chain@name\pgfutil@empty%
    \pgfkeysgetvalue{/tikz/chain}\tikz@lib@chain@name%
  \fi%
  \expandafter\ifx\csname tikz@lib@chain@exists@\tikz@lib@chain@name\endcsname\relax%
    \PackageError{tikz}{Unknown chain ``\tikz@lib@chain@name''}{}%
  \else%
    \ifx\tikz@lib@chain@direction\relax%
      \def\tikz@lib@chain@direction{\csname tikz@lib@chain@dir@\tikz@lib@chain@name\endcsname}% use default
    \fi%
    % Increase the count and set name, if necessary.
    \c@pgf@counta\csname tikz@lib@chain@count@\tikz@lib@chain@name\endcsname\relax%
    \advance\c@pgf@counta by1\relax%
    \expandafter\xdef\csname tikz@lib@chain@count@\tikz@lib@chain@name\endcsname{\the\c@pgf@counta}%
    \ifx\tikz@fig@name\pgfutil@empty%
      \edef\tikz@fig@name{\tikz@lib@chain@name-\csname tikz@lib@chain@count@\tikz@lib@chain@name\endcsname}%
    \fi%
    \expandafter\global\expandafter\let\expandafter\tikzchaincount\csname tikz@lib@chain@count@\tikz@lib@chain@name\endcsname%
    \expandafter\global\expandafter\let\expandafter\tikzchainprevious\csname tikz@lib@chain@last@\tikz@lib@chain@name\endcsname%
    \tikz@lib@chain@direction%
    \expandafter\def\expandafter\tikz@node@begin@hook\expandafter{\tikz@node@begin@hook\tikz@lib@set@last}%
  \fi%
  \tikzset{after node path={\pgfextra{\global\let\tikzchaincurrent=\tikz@last@fig@name}},every on chain/.try}%
}

\def\tikz@lib@set@last{%
  \let\tikzchaincurrent\tikz@fig@name%
  \expandafter\global\expandafter\let\csname tikz@lib@chain@last@\tikz@lib@chain@name\endcsname\tikz@fig@name%
}%

\def\tikz@lib@chain@place#1{%
  \pgfutil@in@{=}{#1}%
  \ifpgfutil@in@%
    \tikzset{#1}%
  \else%
    \tikzset{#1=of \tikzchainprevious}%
  \fi%
}

\def\tikz@lib@chain@strip#1 \pgf@stop{%
  \def\tikz@lib@chain@name{#1}%
}

\def\tikz@lib@parse@join#1{%
  \def\tikz@temp{#1}%
  \ifx\tikz@temp\pgfutil@empty%
    \tikz@lib@parse@join@by by \pgf@stop%
  \else%
    \pgfutil@in@{with }{#1}%
    \ifpgfutil@in@%
      \pgfutil@in@{by }{#1}%
      \ifpgfutil@in@%
        \tikz@lib@parse@join@with@by#1\pgf@stop%
      \else%
        \tikz@lib@parse@join@with#1\pgf@stop%
      \fi%
    \else%
      \tikz@lib@parse@join@by#1\pgf@stop%
    \fi%
  \fi%
}
\def\tikz@lib@parse@join@with@by with #1 by #2\pgf@stop{%
  \tikzset{after node path={(#1)edge[every join,#2](\tikzchaincurrent)}}%
}
\def\tikz@lib@parse@join@with with #1\pgf@stop{%
  \tikzset{after node path={(#1)edge[every join](\tikzchaincurrent)}}%
}
\def\tikz@lib@parse@join@by by #1\pgf@stop{%
  \tikzset{after node path={\ifx\tikzchainprevious\pgfutil@empty\else (\tikzchainprevious)edge[every join,#1](\tikzchaincurrent)\fi}}%
}
\tikzset{every join/.style=}


\def\tikz@lib@chainin#1(#2){\pgfutil@ifnextchar[{\tikz@lib@chainin@{#2}}{\tikz@lib@chainin@{#2}[]}}%]
\def\tikz@lib@chainin@#1[#2]#3;{%
  \let\tikz@lib@chain@name\pgfutil@empty%
  \path[late options={%
    name=#1,%
    on chain/.store in=\tikz@lib@chain@name,%
    every chain in/.try,
    #2,
    /utils/exec={%
      \expandafter\tikz@lib@on@chain\expandafter{\tikz@lib@chain@name}%
      \global\let\tikzchaincurrent=\tikz@fig@name%
    }
  }];
}


%
% Branches
%

\tikzset{start branch/.code={%
    % save last node on current chain:
    \pgfkeysgetvalue{/tikz/chain}{\tikz@lib@branch@chain}%
    \expandafter\let\expandafter\tikz@lib@branch@start\csname tikz@lib@chain@last@\tikz@lib@branch@chain\endcsname%
    \pgfkeysalso{/tikz/start chain/.expand once=\tikz@lib@branch@chain/#1}%
    \path[late options={name=\tikz@lib@branch@start,on chain}];%
  }%
}
\tikzset{branch/.code={%
    \pgfkeysgetvalue{/tikz/chain}{\tikz@lib@branch@chain}%
    \pgfkeysalso{/tikz/chain/.expand once=\tikz@lib@branch@chain/#1}%
  }
}

\endinput
