% Copyright 2008 by Mark Wibrow
%
% This file may be distributed and/or modified
%
% 1. under the LaTeX Project Public License and/or
% 2. under the GNU Public License.
%
% See the file doc/generic/pgf/licenses/LICENSE for more details.

\usetikzlibrary{decorations}
\usepgflibrary{decorations.pathreplacing}


\newif\iftikz@lib@curvecontrol@createsnodes
\newif\iftikz@lib@curvecontrol@showpolygon
\tikzset{
  curve control action/.style={},
  curve control node prefix/.code={\def\tikz@lib@curvecontrol@prefix{#1}\tikz@lib@curvecontrol@createsnodestrue},%
  create curve control nodes/.is if=tikz@lib@curvecontrol@createsnodes,
  show curve control polygon/.is if=tikz@lib@curvecontrol@showpolygon
}

\def\tikz@lib@curvecontrol@prefix{curve point}


% The curve control points decoration enables the control
% points of cubic beziers to be shown.

\pgfdeclaredecoration{curve control points}{initial}{
	\state{initial}[width=0pt, next state=process segment, 
	  persistent precomputation={\xdef\tikz@lib@curvecontrol@node@count{1}}]{}
	\state{process segment}[width=\pgfdecoratedinputsegmentremainingdistance]
	{
		\ifx\pgf@decorate@movealonginputsegment\pgf@decorate@movealonginputsegment@curve%
			\egroup% Exit the state transformation.
			\pgf@process{\pgf@decorate@inputsegment@last}%
			\pgf@xc\pgf@x%
			\pgf@yc\pgf@y%
			\pgf@process{\pgf@decorate@inputsegment@supportb}%
			\pgf@xb\pgf@x%
			\pgf@yb\pgf@y%
			\pgf@process{\pgf@decorate@inputsegment@supporta}%
			\pgf@xa\pgf@x%
			\pgf@ya\pgf@y%
			\pgf@process{\pgf@decorate@inputsegment@first}%
			\iftikz@lib@curvecontrol@showpolygon%
				\edef\pgf@marshal{%
					\noexpand\path[curve control action](\the\pgf@x,\the\pgf@y)--(\the\pgf@xa,\the\pgf@ya)--%
					  (\the\pgf@xb,\the\pgf@yb)--(\the\pgf@xc,\the\pgf@yc);
				}%
			\else%
				\edef\pgf@marshal{%
					\noexpand\path[curve control action](\the\pgf@x,\the\pgf@y)--(\the\pgf@xa,\the\pgf@ya);
					\noexpand\path[curve control action](\the\pgf@xc,\the\pgf@yc)--(\the\pgf@xb,\the\pgf@yb);
				}%
			\fi%
			\begingroup%
				\pgf@marshal%
			\endgroup%
			\iftikz@lib@curvecontrol@createsnodes%
				\begingroup%
					\pgftransformreset%
					\pgftransformshift{\pgf@decorate@inputsegment@first}%
					\pgfmultipartnode{coordinate}{center}{\tikz@lib@curvecontrol@prefix-\tikz@lib@curvecontrol@node@count}{}%
					\c@pgf@counta\tikz@lib@curvecontrol@node@count\relax%
					\advance\c@pgf@counta1\relax%
					\xdef\tikz@lib@curvecontrol@node@count{\the\c@pgf@counta}%
					%
					\pgftransformreset%
					\pgftransformshift{\pgf@decorate@inputsegment@supporta}%
					\pgfmultipartnode{coordinate}{center}{\tikz@lib@curvecontrol@prefix-\tikz@lib@curvecontrol@node@count}{}%
					\c@pgf@counta\tikz@lib@curvecontrol@node@count\relax%
					\advance\c@pgf@counta1\relax%
					\xdef\tikz@lib@curvecontrol@node@count{\the\c@pgf@counta}%
					%
					\pgftransformreset%
					\pgftransformshift{\pgf@decorate@inputsegment@supportb}%
					\pgfmultipartnode{coordinate}{center}{\tikz@lib@curvecontrol@prefix-\tikz@lib@curvecontrol@node@count}{}%
					\c@pgf@counta\tikz@lib@curvecontrol@node@count\relax%
					\advance\c@pgf@counta1\relax%
					\xdef\tikz@lib@curvecontrol@node@count{\the\c@pgf@counta}%
					%
					\pgftransformreset%
					\pgftransformshift{\pgf@decorate@inputsegment@last}%
					\pgfmultipartnode{coordinate}{center}{\tikz@lib@curvecontrol@prefix-\tikz@lib@curvecontrol@node@count}{}%
					\c@pgf@counta\tikz@lib@curvecontrol@node@count\relax%
					\advance\c@pgf@counta1\relax%
					\xdef\tikz@lib@curvecontrol@node@count{\the\c@pgf@counta}%
				\endgroup
			\fi%
			\bgroup%
		\fi%
	}
}

\endinput
