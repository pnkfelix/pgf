% Copyright 2006 by Till Tantau and Mark Wibrow
%
% This file may be distributed and/or modified
%
% 1. under the LaTeX Project Public License and/or
% 2. under the GNU Public License.
%
% See the file doc/generic/pgf/licenses/LICENSE for more details.

\ProvidesFileRCS[v\pgfversion] $Header: /cvsroot/pgf/pgf/generic/pgf/libraries/Attic/pgflibraryshapes.geometric.code.tex,v 1.7 2007/07/10 14:09:15 vibrovski Exp $

\pgfdeclareshape{ellipse}
%
% Draws a circle around the text
%
{
  \savedanchor\centerpoint{%
    \pgf@x=.5\wd\pgfnodeparttextbox%
    \pgf@y=.5\ht\pgfnodeparttextbox%
    \advance\pgf@y by-.5\dp\pgfnodeparttextbox%
  }
  \savedanchor\radius{%
    % 
    % Caculate ``height radius''
    % 
    \pgf@y=.5\ht\pgfnodeparttextbox%
    \advance\pgf@y by.5\dp\pgfnodeparttextbox%
    \pgfmathsetlength\pgf@yb{\pgfshapeinnerysep}%
    \advance\pgf@y by\pgf@yb%
    % 
    % Caculate ``width radius''
    % 
    \pgf@x=.5\wd\pgfnodeparttextbox%
    \pgfmathsetlength\pgf@xb{\pgfshapeinnerxsep}%
    \advance\pgf@x by\pgf@xb%
    % 
    % Adjust
    % 
    \pgf@x=1.4142136\pgf@x%
    \pgf@y=1.4142136\pgf@y%
    % 
    % Adjust hieght, if necessary
    % 
    \pgfmathsetlength\pgf@yc{\pgfshapeminheight}%
    \ifdim\pgf@y<.5\pgf@yc%
      \pgf@y=.5\pgf@yc%
    \fi%
    % 
    % Adjust width, if necessary
    % 
    \pgfmathsetlength\pgf@xc{\pgfshapeminwidth}%
    \ifdim\pgf@x<.5\pgf@xc%
      \pgf@x=.5\pgf@xc%
    \fi%
    % 
    % Add outer sep
    % 
    \pgfmathsetlength{\pgf@xb}{\pgfshapeouterxsep}%  
    \pgfmathsetlength{\pgf@yb}{\pgfshapeouterysep}%  
    \advance\pgf@x by\pgf@xb%
    \advance\pgf@y by\pgf@yb%
  }

  %
  % Anchors
  % 
  \anchor{center}{\centerpoint}
  \anchor{mid}{\centerpoint\pgfmathsetlength\pgf@y{.5ex}}
  \anchor{base}{\centerpoint\pgf@y=0pt}
  \anchor{north}
  {
    \pgf@process{\radius}
    \pgf@ya=\pgf@y%
    \pgf@process{\centerpoint}
    \advance\pgf@y by\pgf@ya
  }
  \anchor{south}
  {
    \pgf@process{\radius}
    \pgf@ya=\pgf@y%
    \pgf@process{\centerpoint}
    \advance\pgf@y by-\pgf@ya
  }
  \anchor{west}
  {
    \pgf@process{\radius}
    \pgf@xa=\pgf@x%
    \pgf@process{\centerpoint}
    \advance\pgf@x by-\pgf@xa
  }
  \anchor{mid west}
  {%
    \pgf@process{\radius}
    \pgf@xa=\pgf@x%
    \pgf@process{\centerpoint}
    \advance\pgf@x by-\pgf@xa%
    \pgfmathsetlength\pgf@y{.5ex}
  }
  \anchor{base west}
  {%
    \pgf@process{\radius}
    \pgf@xa=\pgf@x%
    \pgf@process{\centerpoint}
    \advance\pgf@x by-\pgf@xa%
    \pgf@y=0pt
  }
  \anchor{north west}
  {
    \pgf@process{\radius}
    \pgf@xa=\pgf@x%
    \pgf@ya=\pgf@y%
    \pgf@process{\centerpoint}
    \advance\pgf@x by-0.707107\pgf@xa
    \advance\pgf@y by0.707107\pgf@ya
  }
  \anchor{south west}
  {
    \pgf@process{\radius}
    \pgf@xa=\pgf@x%
    \pgf@ya=\pgf@y%
    \pgf@process{\centerpoint}
    \advance\pgf@x by-0.707107\pgf@xa
    \advance\pgf@y by-0.707107\pgf@ya
  }
  \anchor{east}
  {%
    \pgf@process{\radius}
    \pgf@xa=\pgf@x%
    \pgf@process{\centerpoint}
    \advance\pgf@x by\pgf@xa
  }
  \anchor{mid east}
  {%
    \pgf@process{\radius}
    \pgf@xa=\pgf@x%
    \pgf@process{\centerpoint}
    \advance\pgf@x by\pgf@xa%
    \pgfmathsetlength\pgf@y{.5ex}
  }
  \anchor{base east}
  {%
    \pgf@process{\radius}
    \pgf@xa=\pgf@x%
    \pgf@process{\centerpoint}
    \advance\pgf@x by\pgf@xa%
    \pgf@y=0pt
  }
  \anchor{north east}
  {
    \pgf@process{\radius}
    \pgf@xa=\pgf@x%
    \pgf@ya=\pgf@y%
    \pgf@process{\centerpoint}
    \advance\pgf@x by0.707107\pgf@xa
    \advance\pgf@y by0.707107\pgf@ya
  }
  \anchor{south east}
  {
    \pgf@process{\radius}
    \pgf@xa=\pgf@x%
    \pgf@ya=\pgf@y%
    \pgf@process{\centerpoint}
    \advance\pgf@x by0.707107\pgf@xa
    \advance\pgf@y by-0.707107\pgf@ya
  }
  \anchorborder{
    \edef\pgf@marshal{%
      \noexpand\pgfpointborderellipse
      {\noexpand\pgfqpoint{\the\pgf@x}{\the\pgf@y}}
      {\noexpand\radius}%
    }%
    \pgf@marshal%
    \pgf@xa=\pgf@x%
    \pgf@ya=\pgf@y%
    \centerpoint%
    \advance\pgf@x by\pgf@xa%
    \advance\pgf@y by\pgf@ya%
  }

  %
  % Background path
  %
  \backgroundpath
  {
    \pgf@process{\radius}%
    \pgfutil@tempdima=\pgf@x%
    \pgfutil@tempdimb=\pgf@y%
    \pgfmathsetlength{\pgf@xb}{\pgfshapeouterxsep}%  
    \pgfmathsetlength{\pgf@yb}{\pgfshapeouterysep}%  
    \advance\pgfutil@tempdima by-\pgf@xb%
    \advance\pgfutil@tempdimb by-\pgf@yb%
    \pgfpathellipse{\centerpoint}{\pgfqpoint{\pgfutil@tempdima}{0pt}}{\pgfqpoint{0pt}{\pgfutil@tempdimb}}%
  }
}




% Set the recommended shape aspect ratio
%
% #1 = aspect ratio
%
% Example:
%
% \pgfsetshapeminwidth{1.5}

\def\pgfsetshapeaspect#1{%
  \def\pgfshapeaspect{#1}%
  % Invert
  \pgfutil@tempdima=#1pt%
  \pgfutil@tempdima=.125\pgfutil@tempdima%
  \c@pgf@counta=\pgfutil@tempdima\relax% 8192*determinant
  \pgfutil@tempdima=8192pt%
  \divide\pgfutil@tempdima by\c@pgf@counta%
  \edef\pgfshapeaspectinverse{\pgf@sys@tonumber{\pgfutil@tempdima}}
}
\pgfsetshapeaspect{1}



\pgfdeclareshape{diamond}
{
  \savedanchor\outernortheast{%
    %
    % Calculate width and height of the inner rectangle
    %
    \pgf@xa=.5\wd\pgfnodeparttextbox%
    \pgfmathsetlength\pgf@xc{\pgfshapeinnerxsep}%
    \advance\pgf@xa by\pgf@xc%
    \pgf@ya=.5\ht\pgfnodeparttextbox%
    \advance\pgf@ya by.5\dp\pgfnodeparttextbox%
    \pgfmathsetlength\pgf@yc{\pgfshapeinnerysep}%
    \advance\pgf@ya by\pgf@yc%
    %
    % Calculate width and height of diamond
    %
    \pgf@x=\pgf@xa%
    \advance\pgf@x by\pgfshapeaspect\pgf@ya%
    \pgf@y=\pgfshapeaspectinverse\pgf@xa%
    \advance\pgf@y by\pgf@ya%
    %
    % Check against minimum height/width
    %
    \pgfmathsetlength\pgf@xb{\pgfshapeminwidth}%
    \ifdim\pgf@x<\pgf@xb%
      % yes, too small. Enlarge...
      \pgf@x=\pgf@xb%
    \fi%
    \pgfmathsetlength\pgf@yb{\pgfshapeminheight}%
    \ifdim\pgf@y<\pgf@yb%
      % yes, too small. Enlarge...
      \pgf@y=\pgf@yb%
    \fi%
    %
    % Add outer border
    %
    \pgfmathsetlength\pgf@xa{\pgfshapeouterxsep}%
    \advance\pgf@x by\pgf@xa%
    \pgfmathsetlength\pgf@ya{\pgfshapeouterysep}%
    \advance\pgf@y by\pgf@ya%
  }
  \savedanchor\text{%
    \pgf@x=-.5\wd\pgfnodeparttextbox%
    \pgf@y=-.5\ht\pgfnodeparttextbox%
    \advance\pgf@y by.5\dp\pgfnodeparttextbox%
  }

  %
  % Anchors
  %
  \anchor{text}{\text}%
  \anchor{center}{\pgfpointorigin}%
  \anchor{mid}{%
    \pgf@process{\text}%
    \pgf@x=0pt%
    \pgfmathsetlength\pgf@ya{.5ex}
    \advance\pgf@y by\pgf@ya%
  }
  \anchor{base}{\pgf@process{\text}\pgf@x=0pt  }
  \anchor{north}{\pgf@process{\outernortheast}\pgf@x=0pt}
  \anchor{south}{\pgf@process{\outernortheast}\pgf@x=0pt\pgf@y=-\pgf@y}
  \anchor{west}{\pgf@process{\outernortheast}\pgf@x=-\pgf@x\pgf@y=0pt}
  \anchor{north west}{\pgf@process{\outernortheast}\pgf@x=-.5\pgf@x\pgf@y=.5\pgf@y}
  \anchor{south west}{\pgf@process{\outernortheast}\pgf@x=-.5\pgf@x\pgf@y=-.5\pgf@y}
  \anchor{east}{\pgf@process{\outernortheast}\pgf@y=0pt}
  \anchor{north east}{\pgf@process{\outernortheast}\pgf@x=.5\pgf@x\pgf@y=.5\pgf@y}
  \anchor{south east}{\pgf@process{\outernortheast}\pgf@x=.5\pgf@x\pgf@y=-.5\pgf@y}
  \anchorborder{%
    \pgf@xa=\pgf@x%
    \pgf@ya=\pgf@y%
    \pgf@process{\outernortheast}%
    \ifdim\pgf@xa>0pt%
    \else%
      \pgf@x=-\pgf@x%
    \fi%
    \ifdim\pgf@ya>0pt%
    \else%
      \pgf@y=-\pgf@y%
    \fi%
    \edef\pgf@marshal{%
      \noexpand\pgfpointintersectionoflines
      {\noexpand\pgfpointorigin}
      {\noexpand\pgfqpoint{\the\pgf@xa}{\the\pgf@ya}}
      {\noexpand\pgfqpoint{\the\pgf@x}{0pt}}
      {\noexpand\pgfqpoint{0pt}{\the\pgf@y}}%
    }%
    \pgf@process{\pgf@marshal}%
  }

  %
  % Background path
  %
  \backgroundpath{
    \pgf@process{\outernortheast}%
    \pgf@xc=\pgf@x%
    \pgf@yc=\pgf@y%
    \pgfmathsetlength{\pgf@xa}{\pgfshapeouterxsep}%
    \pgfmathsetlength{\pgf@ya}{\pgfshapeouterysep}%
    \advance\pgf@xc by-1.414213\pgf@xa%
    \advance\pgf@yc by-1.414213\pgf@ya%
    \pgfpathmoveto{\pgfqpoint{\pgf@xc}{0pt}}%
    \pgfpathlineto{\pgfqpoint{0pt}{\pgf@yc}}%
    \pgfpathlineto{\pgfqpoint{-\pgf@xc}{0pt}}%
    \pgfpathlineto{\pgfqpoint{0pt}{-\pgf@yc}}%
    \pgfpathclose%
  }
}




\makeatletter


% \pgfsavepgf@process
%
% Little `helper' macro.
%
\def\pgfsavepgf@process#1#2{%
	\pgf@process{#2}%
	\edef#1{\noexpand\pgf@x\the\pgf@x\noexpand\pgf@y\the\pgf@y}%
}

% \ifpgfshapeborderusesincircle
%
% Determine if a shape uses an incircle to
% calculate its border dimensions.
%
\newif\ifpgfshapeborderusesincircle
\pgfshapeborderusesincirclefalse

% \pgfsetshapeborderrotate
%
% Set the rotation of the shape border. 
%
\def\pgfsetshapeborderrotate#1{%
	\pgfmathparse{#1}%
	\pgfmathmod@{\pgfmathresult}{360}%
	\ifdim\pgfmathresult pt<0pt\relax%
		\pgfmathadd@{\pgfmathresult}{360}%
	\fi%
	\let\pgfshapeborderrotate\pgfmathresult}
\pgfsetshapeborderrotate{0}





% \pgfsetstarpoints
%
% Set the number of points on a star.
%
\def\pgfsetstarpoints#1{%
	\pgfmathsetcounter{pgf@counta}{#1}%
	\edef\pgfstarpoints{\the\c@pgfmath@counta}}
\pgfsetstarpoints{5}

% \pgfsetstarpointheight
%
% Set the height of the points (this is the
% distance between the outer and inner point 
% radii).
%
\def\pgfsetstarpointheight#1{%
	\pgfmathparse{#1}%
	\edef\pgfstarpointheight{\pgfmathresult pt}}
\pgfsetstarpointheight{12pt}

% \pgfsetstarpointratio
%
% Set the ratio between the outer and 
% inner point radii.
%
\def\pgfsetstarpointratio#1{%
	\pgfmathparse{#1}%
	\edef\pgfstarpointratio{\pgfmathresult}%
	\def\pgfstarpointheight{-16383pt}% If negative, the ratio is used.
}
\pgfsetstarpointratio{1.75}

% Shape star.
%
\pgfdeclareshape{star}{
	\savedmacro\totalstarpoints{%
		\pgfmathadd@{\pgfstarpoints}{\pgfstarpoints}%
		\let\totalstarpoints\pgfmathresult%
	}
	\savedmacro\anglestep{%
		\pgfmathdivide@{180}{\pgfstarpoints}%
		\let\anglestep\pgfmathresult%
	}
	\savedmacro\calculateradii{%
		%
		% Get the node dimensions.
		%
		\pgfmathsetlength\pgf@x{+\pgfshapeinnerxsep}%
		\pgfmathaddtolength\pgf@x{+.5\wd\pgfnodeparttextbox}%
		\pgfmathsetlength\pgf@y{\pgfshapeinnerysep}%
		\pgfmathaddtolength\pgf@y{+.5\ht\pgfnodeparttextbox}%
		\pgfmathaddtolength\pgf@y{+.5\dp\pgfnodeparttextbox}%
		\ifdim\pgf@y>\pgf@x%
			\pgf@x\pgf@y%
		\fi%
		%
		% Calculate the incircle radius.
		%
		\pgf@x1.41421\pgf@x%
		\edef\innerradius{\the\pgf@x}%
		%
		% Calculate the circumcircle radius.
		%
		% If the star point height is negative use the star point ratio.
		%
		\pgfmathsetlength\pgf@xb{+\pgfstarpointheight}%
		\ifdim\pgf@xb<0pt\relax%
			\pgf@x\pgfstarpointratio\pgf@x%
		\else%
			\advance\pgf@x\pgf@xb%
		\fi%
		\pgf@xc\pgf@x%
		%
		% Accommodate the larger of the minimum height/width.
		%
		\pgfmathsetlength\pgf@xa{+\pgfshapeminwidth}%
		\pgfmathsetlength\pgf@ya{+\pgfshapeminheight}%
		\ifdim\pgf@ya>\pgf@xa%
			\pgf@xa\pgf@ya%
		\fi%
		\ifdim\pgf@x<.5\pgf@xa%
	   	\pgf@x.5\pgf@xa%
	   \fi%
	   \edef\outerradius{\the\pgf@x}%
	   %
	   % If the outer radius has been enlarged, adjust the inner radius...
	   %
	   \ifdim\pgf@x>\pgf@xc%
	   	%
	   	% ...using the star point ratio, or...
	   	%
	   	\ifdim\pgf@xb<0pt\relax%
	   		\pgfmathreciprocal@{\pgfstarpointratio}%
	   		\pgf@xa\pgfmathresult\pgf@x\relax%
	   		\edef\innerradius{\the\pgf@xa}%
			\else%
				%
				% The star point height.
				%
				\pgf@xa\pgf@x\relax%
				\advance\pgf@xa-\pgf@xb%
				\edef\innerradius{\the\pgf@xa}%
			\fi%
		\fi%
		\edef\outerradius{\the\pgf@x}%
		%
		% Now calculate the anchor radiii from the outer sep.
		%
		\pgfmathsetlength\pgf@xa{+\pgfshapeouterxsep}%
		\pgfmathsetlength\pgf@ya{+\pgfshapeouterysep}%
		\ifdim\pgf@ya>\pgf@xa%
			\pgf@xa\pgf@ya%
		\fi
		%
		% Take into account the miter length...
		%
		\pgfmathdivide@{180}{\pgfstarpoints}%
		\let\angletofirstpoint\pgfmathresult%
		\pgfmathmultiply@{\angletofirstpoint}{2}%
		\let\angletosecondpoint\pgfmathresult%
		%
		% ...for the outer radius...
		%
		\pgfmathanglebetweenlines%
			{\pgfqpointpolar{\angletofirstpoint}{\outerradius}}%
			{\pgfqpointpolar{\angletosecondpoint}{\innerradius}}%
			{\pgfqpointpolar{\angletofirstpoint}{\outerradius}}%		
			{\pgfqpointpolar{0}{\innerradius}}%		
		\pgfmathdivide@{\pgfmathresult}{2}%
		\pgfmathcosec@{\pgfmathresult}%
		\pgf@x\outerradius\relax%
		\advance\pgf@x\pgfmathresult\pgf@xa%
		\edef\anchorouterradius{\the\pgf@x}%
		%
		% ...and for the inner radius.
		%
		\pgfmathanglebetweenlines%
			{\pgfqpointpolar{\angletofirstpoint}{\innerradius}}%		
			{\pgfqpointpolar{0}{\outerradius}}%	
			{\pgfqpointpolar{\angletofirstpoint}{\innerradius}}%
			{\pgfqpointpolar{\angletosecondpoint}{\outerradius}}%						
		\pgfmathdivide@{\pgfmathresult}{2}%
		\pgfmathcosec@{\pgfmathresult}%
		\pgf@x\innerradius\relax%
		\advance\pgf@x\pgfmathresult\pgf@xa%
		\edef\anchorinnerradius{\the\pgf@x}%
		%	
		% Save all radii.
		%
		\def\calculateradii{%
			\noexpand\def\noexpand\innerradius{\innerradius}%
			\noexpand\def\noexpand\outerradius{\outerradius}%
			\noexpand\def\noexpand\anchorinnerradius{\anchorinnerradius}%
			\noexpand\def\noexpand\anchorouterradius{\anchorouterradius}%
		}%
	}
	\savedmacro\startangle{%
		\pgfmathadd@{90}{\pgfshapeborderrotate}%
		\let\startangle\pgfmathresult%
	}
	%
	% Saved anchors.
	%
	\savedanchor{\centerpoint}{%
		\pgfmathsetlength\pgf@x{+.5\wd\pgfnodeparttextbox}%
		\pgfmathsetlength\pgf@y{+.5\ht\pgfnodeparttextbox}%
		\pgfmathaddtolength\pgf@y{+-.5\dp\pgfnodeparttextbox}%
	}%
	\savedanchor{\midpoint}{%
		\pgfmathsetlength\pgf@x{+.5\wd\pgfnodeparttextbox}%
		\pgfmathsetlength\pgf@y{+.5ex}%
	}%	
	%
	% Other anchors.
	%
%
	% Other anchors.
	%
	\anchor{center}{\centerpoint}%
	\anchor{mid}{\centerpoint\pgfmathsetlength\pgf@y{.5ex}}%
 	\anchor{base}{\centerpoint\pgf@y=0pt}%
 	\anchor{north}{%
 		\calculateradii%
 		\csname pgf@anchor@star@border\endcsname{\pgfqpoint{0pt}{\anchorouterradius}}}%
 	\anchor{south}{%
 		\calculateradii%
 		\csname pgf@anchor@star@border\endcsname{\pgfqpoint{0pt}{-\anchorouterradius}}}%
 	\anchor{east}{%
 		\calculateradii%
 		\csname pgf@anchor@star@border\endcsname{\pgfqpoint{\anchorouterradius}{0pt}}}%
 	\anchor{west}{%
 		\calculateradii%
 		\csname pgf@anchor@star@border\endcsname{\pgfqpoint{-\anchorouterradius}{0pt}}}%
 	\anchor{north east}{%
 		\calculateradii%
 		\csname pgf@anchor@star@border\endcsname{\pgfqpoint{\anchorouterradius}{\anchorouterradius}}}%
 	\anchor{north west}{%
 		\calculateradii%
 		\csname pgf@anchor@star@border\endcsname{\pgfqpoint{-\anchorouterradius}{\anchorouterradius}}}%
 	\anchor{south east}{%
 		\calculateradii%
 		\csname pgf@anchor@star@border\endcsname{\pgfqpoint{\anchorouterradius}{-\anchorouterradius}}}%
 	\anchor{south west}{%
 		\calculateradii%
 		\csname pgf@anchor@star@border\endcsname{\pgfqpoint{-\anchorouterradius}{-\anchorouterradius}}}%	 	
 	%
 	% Background path.
 	%
	\backgroundpath{%
		\calculateradii%
		\let\angle\startangle%
		\pgfpathmoveto{\pgfpointadd{\centerpoint}{\pgfqpointpolar{\startangle}{\outerradius}}}%
		\pgfmathloop%
			\c@pgf@counta\pgfmathcounter\relax%
			\advance\c@pgf@counta1\relax%
			\divide\c@pgf@counta2\relax%
			\c@pgf@countb\c@pgf@counta\relax%
			\advance\c@pgf@countb-1\relax%
			\ifodd\pgfmathcounter%
				%
				% Define anchors for outer points.
				%
				\pgfutil@ifundefined{pgf@anchor@star@outer point\space\the\c@pgf@counta}{%
					\expandafter\xdef\csname pgf@anchor@star@outer point\space\the\c@pgf@counta\endcsname{%
						\noexpand\calculateradii%
						\noexpand\pgfmathmultiply@{\the\c@pgf@countb}{\noexpand\anglestep}%
						\noexpand\pgfmathmultiply@{\noexpand\pgfmathresult}{2}%
						\noexpand\pgfmathadd@{\noexpand\pgfmathresult}{\noexpand\startangle}%
						\noexpand\let\noexpand\angle\noexpand\pgfmathresult%
						\noexpand\pgfpointadd{\noexpand\centerpoint}%
							{\noexpand\pgfqpointpolar{\noexpand\angle}{\noexpand\anchorouterradius}}%
						}%
				}{}%
			\else
				%
				% Define anchors for inner points.
				%
				\pgfutil@ifundefined{pgf@anchor@star@inner point\space\the\c@pgf@counta}{%
					\expandafter\xdef\csname pgf@anchor@star@inner point\space\the\c@pgf@counta\endcsname{%
						\noexpand\calculateradii%
						\noexpand\pgfmathmultiply@{\the\c@pgf@countb}{\noexpand\anglestep}%
						\noexpand\pgfmathmultiply@{\noexpand\pgfmathresult}{2}%
						\noexpand\pgfmathadd@{\noexpand\pgfmathresult}{\noexpand\anglestep}%
						\noexpand\pgfmathadd@{\noexpand\pgfmathresult}{\noexpand\startangle}%
						\noexpand\let\noexpand\angle\noexpand\pgfmathresult%
						\noexpand\pgfpointadd{\noexpand\centerpoint}%
							{\noexpand\pgfqpointpolar{\noexpand\angle}{\noexpand\anchorinnerradius}}%
					}%
				}{}%
			\fi%
			\pgfmathadd@{\angle}{\anglestep}%
			\let\angle\pgfmathresult%
		\ifnum\pgfmathcounter=\totalstarpoints%
			\pgfpathclose%
		\else%
			\ifodd\pgfmathcounter
				\pgfpathlineto{\pgfpointadd{\centerpoint}{\pgfqpointpolar{\angle}{\innerradius}}}%
			\else%
				\pgfpathlineto{\pgfpointadd{\centerpoint}{\pgfqpointpolar{\angle}{\outerradius}}}%
			\fi%
		\repeatpgfmathloop%
	}%
	%
	% Define points on the anchor border.
	%
	\anchorborder{%
		%
		% Save x and y.
		%
		\edef\externalx{\the\pgf@x}%
		\edef\externaly{\the\pgf@y}%
		%
		% Adjust the location of the external 
		% point relative to \centerpoint.
		%
		\centerpoint%
		\pgf@xa\externalx\relax%
		\pgf@ya\externaly\relax%
		\advance\pgf@xa\pgf@x%
		\advance\pgf@ya\pgf@y%
		\edef\externalx{\the\pgf@xa}%
		\edef\externaly{\the\pgf@ya}%
		%
		% Get the angle of the external point to the \centerpoint.
		%
		\pgfmathanglebetweenpoints{\centerpoint}{\pgfqpoint{\externalx}{\externaly}}%
		%
		% Locate the appropriate sides on the star border...
		%
		\pgfmathsubtract@{\pgfmathresult}{\startangle}%
		\ifdim\pgfmathresult pt<0pt\relax%
			\pgfmathadd@{\pgfmathresult}{360}%
		\fi%
		\pgfmathdivide@{\pgfmathresult}{\anglestep}%
		\pgfmathfloor@{\pgfmathresult}%
		\afterassignment\pgfmath@gobbletilpgfmath@
		\c@pgf@counta\pgfmathresult\relax\pgfmath@
		\pgfmathmultiply@{\pgfmathresult}{\anglestep}%
		\pgfmathadd@{\pgfmathresult}{\startangle}%
		\let\firstangle\pgfmathresult%
		\pgfmathadd@{\pgfmathresult}{\anglestep}%
		\let\secondangle\pgfmathresult%
		\calculateradii%
		%
		% ...and thus, the point on the star border.
		%
		\ifodd\c@pgf@counta
			\pgfpointintersectionoflines{\centerpoint}{\pgfpoint{+\externalx}{+\externaly}}%
				{%
					\pgfpointadd{\centerpoint}%
						{\pgfqpointpolar{+\firstangle}{+\anchorinnerradius}}%
					}%	
					{%
						\pgfpointadd{\centerpoint}%
							{\pgfqpointpolar{+\secondangle}{+\anchorouterradius}}%
					}%	
		\else%
			\pgfpointintersectionoflines{\centerpoint}{\pgfpoint{+\externalx}{+\externaly}}%
				{%
					\pgfpointadd{\centerpoint}%
						{\pgfqpointpolar{+\firstangle}{+\anchorouterradius}}%
					}%	
					{%
						\pgfpointadd{\centerpoint}%
							{\pgfqpointpolar{+\secondangle}{+\anchorinnerradius}}%
					}%	
		\fi%
	}
}





% \pgfsetpolygonsides
%
% Set the number of sides on a polygon.
%
\def\pgfsetpolygonsides#1{%
	\pgfmathsetcounter{pgf@counta}{#1}%
	\edef\pgfpolygonsides{\the\c@pgfmath@counta}}
\pgfsetpolygonsides{6}


% Shape Regular Polygon.
%
\pgfdeclareshape{regular polygon}{
	\savedmacro\sides{%
		\let\sides\pgfpolygonsides%
	}
	\savedmacro\anglestep{%
		\pgfmathdivide@{360}{\pgfpolygonsides}%
		\let\anglestep\pgfmathresult%
	}
	\savedmacro\calculateradii{%
		%
		% Get the node dimensions.
		%
		\pgfmathsetlength\pgf@x{+\pgfshapeinnerxsep}%
		\pgfmathaddtolength\pgf@x{+.5\wd\pgfnodeparttextbox}%
		\pgfmathsetlength\pgf@y{\pgfshapeinnerysep}%
		\pgfmathaddtolength\pgf@y{+.5\ht\pgfnodeparttextbox}%
		\pgfmathaddtolength\pgf@y{+.5\dp\pgfnodeparttextbox}%
		\ifdim\pgf@y>\pgf@x%
			\pgf@x\pgf@y%
		\fi%
		%
		% Calculate i, the incircle radius 
		%
		\pgf@x1.41421\pgf@x%
		%
		% Calculate r, the polygon radius
		%
		% r = i / cos(360 / s / 2)
		%
		% (s = polygon sides)
		%
		\pgfmathdivide@{180}{\pgfpolygonsides}%
		\pgfmathsec@{\pgfmathresult}%
		\pgf@x\pgfmathresult\pgf@x%
		%
		% Accommodate the minimum width/height.
		%
		\pgfmathsetlength\pgf@xa{+\pgfshapeminwidth}%
		\pgfmathsetlength\pgf@ya{+\pgfshapeminheight}%
		\ifdim\pgf@ya>\pgf@xa%
			\pgf@xa\pgf@ya%
		\fi%
		\ifdim\pgf@x<.5\pgf@xa%
			\pgf@x.5\pgf@xa%
		\fi%
		\edef\radius{\the\pgf@x}%
		%
		% Now calculate the anchor radius from the outer sep.
		%
		\pgfmathsetlength\pgf@xa{+\pgfshapeouterxsep}%
		\pgfmathsetlength\pgf@ya{+\pgfshapeouterysep}%
		\ifdim\pgf@ya>\pgf@xa%
			\pgf@xa\pgf@ya%
		\fi
		%
		% Take into account the miter length.
		%
		% m = o / sin (90 - (360 / s / 2))
		%
		% (o = outer sep, s = sides)
		%
		\pgfmathdivide@{180}{\pgfpolygonsides}%
		\pgfmathsubtract@{90}{\pgfmathresult}%
		\pgfmathcosec@{\pgfmathresult}%
		\advance\pgf@x\pgfmathresult\pgf@xa%
		\edef\anchorradius{\the\pgf@x}%
		%
		% Save both radii.
		%
		\def\calculateradii{%
			\noexpand\def\noexpand\radius{\radius}%
			\noexpand\def\noexpand\anchorradius{\anchorradius}%
		}%
	}
	\savedmacro\startangle{%
		\ifodd\pgfpolygonsides%
			\edef\pgfmathresult{90}%
		\else%
			\pgfmathdivide@{\anglestep}{2}%
			\pgfmathsubtract@{90}{\pgfmathresult}%
		\fi%
		\pgfmathadd@{\pgfmathresult}{\pgfshapeborderrotate}%
		\let\startangle\pgfmathresult%
	}
	%
	% Saved anchors.
	%
	\savedanchor{\centerpoint}{%
		\pgfmathsetlength\pgf@x{+.5\wd\pgfnodeparttextbox}%
		\pgfmathsetlength\pgf@y{+.5\ht\pgfnodeparttextbox}%
		\pgfmathaddtolength\pgf@y{+-.5\dp\pgfnodeparttextbox}%
	}%
	\savedanchor{\midpoint}{%
		\pgfmathsetlength\pgf@x{+.5\wd\pgfnodeparttextbox}%
		\pgfmathsetlength\pgf@y{+.5ex}%
	}%	
	%
	% Other anchors.
	%
	\anchor{center}{\centerpoint}%
	\anchor{mid}{\centerpoint\pgfmathsetlength\pgf@y{.5ex}}%
 	\anchor{base}{\centerpoint\pgf@y=0pt}%
 	\anchor{north}{%
 		\calculateradii%
 		\csname pgf@anchor@regular polygon@border\endcsname{\pgfqpoint{0pt}{\anchorradius}}}%
 	\anchor{south}{%
 		\calculateradii%
 		\csname pgf@anchor@regular polygon@border\endcsname{\pgfqpoint{0pt}{-\anchorradius}}}%
 	\anchor{east}{%
 		\calculateradii%
 		\csname pgf@anchor@regular polygon@border\endcsname{\pgfqpoint{\anchorradius}{0pt}}}%
 	\anchor{west}{%
 		\calculateradii%
 		\csname pgf@anchor@regular polygon@border\endcsname{\pgfqpoint{-\anchorradius}{0pt}}}%
 	\anchor{north east}{%
 		\calculateradii%
 		\csname pgf@anchor@regular polygon@border\endcsname{\pgfqpoint{\anchorradius}{\anchorradius}}}%
 	\anchor{north west}{%
 		\calculateradii%
 		\csname pgf@anchor@regular polygon@border\endcsname{\pgfqpoint{-\anchorradius}{\anchorradius}}}%
 	\anchor{south east}{%
 		\calculateradii%
 		\csname pgf@anchor@regular polygon@border\endcsname{\pgfqpoint{\anchorradius}{-\anchorradius}}}%
 	\anchor{south west}{%
 		\calculateradii%
 		\csname pgf@anchor@regular polygon@border\endcsname{\pgfqpoint{-\anchorradius}{-\anchorradius}}}%	
 	%
 	% Background path.
 	%
	\backgroundpath{%
		\calculateradii%
		\pgfpathmoveto{%
			\pgfpointadd{\centerpoint}{\pgfqpointpolar{\startangle}{\radius}}%
		}%
		\let\angle\startangle%
		\pgfmathloop%
			%
			% If the corner and side anchors have not been declared 
			% by a previous polygon shape. Define them here...
			%
			\pgfutil@ifundefined{pgf@anchor@regular polygon@corner\space\pgfmathcounter}{%
				%
				% ...(manually \xdef as \gdef is normally used by \anchor)...
				%
				\expandafter\xdef\csname pgf@anchor@regular polygon@corner\space\pgfmathcounter\endcsname{%
					\noexpand\calculateradii%
					\noexpand\pgfmathsubtract@{\pgfmathcounter}{1}%
					\noexpand\pgfmathmultiply@{\noexpand\pgfmathresult}{\noexpand\anglestep}%
					\noexpand\pgfmathadd@{\noexpand\pgfmathresult}{\noexpand\startangle}%
					\noexpand\let\noexpand\angle\noexpand\pgfmathresult%
					\noexpand\pgfpointadd{\noexpand\centerpoint}%
						{\noexpand\pgfqpointpolar{\noexpand\angle}{\noexpand\anchorradius}}%
				}%
				\expandafter\xdef\csname pgf@anchor@regular polygon@side\space\pgfmathcounter\endcsname{%
					\noexpand\calculateradii%
					\noexpand\pgfmathsubtract@{\pgfmathcounter}{1}%
					\noexpand\pgfmathmultiply@{\noexpand\pgfmathresult}{\noexpand\anglestep}%
					\noexpand\pgfmathadd@{\noexpand\pgfmathresult}{\noexpand\startangle}%
					\noexpand\let\noexpand\firstangle\noexpand\pgfmathresult%
					\noexpand\pgfmathadd@{\noexpand\pgfmathresult}{\noexpand\anglestep}%
					\noexpand\let\noexpand\secondangle\noexpand\pgfmathresult%
					\noexpand\pgfpointlineattime{0.5}%
						{\noexpand\pgfpointadd{\noexpand\centerpoint}%
							{\noexpand\pgfqpointpolar{\noexpand\firstangle}{\noexpand\anchorradius}}}%
						{\noexpand\pgfpointadd{\noexpand\centerpoint}%
							{\noexpand\pgfqpointpolar{\noexpand\secondangle}{\noexpand\anchorradius}}}%
				}%
			}{}% ...Or do nothing.
		\ifnum\pgfmathcounter=\sides\relax% 
			\pgfpathclose%
		\else%
			\pgfmathadd@{\angle}{\anglestep}%
			\let\angle\pgfmathresult%
			\pgfpathlineto{%
				\pgfpointadd{\centerpoint}{\pgfqpointpolar{\angle}{\radius}}%
			}%
		\repeatpgfmathloop%	
	}%
	\anchorborder{%
		%
		% Save x and y.
		%
		\edef\externalx{\the\pgf@x}%
		\edef\externaly{\the\pgf@y}%
		%
		% Adjust the location of the external 
		% point relative to \centerpoint.
		%
		\centerpoint%
		\pgf@xa\externalx\relax%
		\pgf@ya\externaly\relax%
		\advance\pgf@xa\pgf@x%
		\advance\pgf@ya\pgf@y%
		\edef\externalx{\the\pgf@xa}%
		\edef\externaly{\the\pgf@ya}%
		%
		% Get the angle of the external point to the \centerpoint.
		%
		\pgfmathanglebetweenpoints{\centerpoint}{\pgfqpoint{\externalx}{\externaly}}%
		%
		% Locate the appropriate sides on the polygon border...
		%
		\pgfmathsubtract@{\pgfmathresult}{\startangle}%
		\ifdim\pgfmathresult pt<0pt\relax%
			\pgfmathadd@{\pgfmathresult}{360}%
		\fi%
		\pgfmathdivide@{\pgfmathresult}{\anglestep}%
		\pgfmathfloor@{\pgfmathresult}%
		\pgfmathmultiply@{\pgfmathresult}{\anglestep}%
		\pgfmathadd@{\pgfmathresult}{\startangle}%
		\let\firstangle\pgfmathresult%
		\pgfmathadd@{\pgfmathresult}{\anglestep}%
		\let\secondangle\pgfmathresult%
		\calculateradii%
		%
		% ...and thus, the point on the polygon border.
		%
		\pgfpointintersectionoflines{\centerpoint}{\pgfpoint{+\externalx}{+\externaly}}%
			{%
				\pgfpointadd{\centerpoint}%
					{\pgfqpointpolar{+\firstangle}{+\anchorradius}}%
				}%	
				{%
					\pgfpointadd{\centerpoint}%
						{\pgfqpointpolar{+\secondangle}{+\anchorradius}}%
				}%	
	}
}





% \pgfsettrapeziumleftextension
%
% Set the extension of the lower left corner of the trapezium. 
% Negative extensions extend the upper left corner.
%
\def\pgfsettrapeziumleftextension#1{%
	\pgfmathparse{#1}%
	\edef\pgftrapeziumleftextension{\pgfmathresult pt}%
}
\pgfsettrapeziumleftextension{1.5ex}

% \pgfsettrapeziumleftextension
%
% Set the extension of the lower right corner of the trapezium. 
% Negative extensions extend the upper right corner.
%
\def\pgfsettrapeziumrightextension#1{%
	\pgfmathparse{#1}%
	\edef\pgftrapeziumrightextension{\pgfmathresult pt}%
}
\pgfsettrapeziumrightextension{1.5ex}

% Shape trapezium.
%
\pgfdeclareshape{trapezium}{
	\savedmacro\installtrapeziumparameters{%
		%
		% Get the node dimensions.
		%
		\pgfmathsetlength\pgf@x{+\pgfshapeinnerxsep}%
		\pgfmathaddtolength\pgf@x{+.5\wd\pgfnodeparttextbox}%
		\pgfmathsetlength\pgf@y{+\pgfshapeinnerysep}%
		\pgfmathaddtolength\pgf@y{+.5\ht\pgfnodeparttextbox}%
		\pgfmathaddtolength\pgf@y{+.5\dp\pgfnodeparttextbox}%
		\ifpgfshapeborderusesincircle%
			%
			% Get the rotation (no rounding).
			%
			\let\rotate\pgfshapeborderrotate%
			%
			% Use the radius of the incircle if required...
			%
			\ifdim\pgf@x<\pgf@y%
				\pgf@x\pgf@y%
			\fi%			
			\pgf@x1.41421\pgf@x%
			\pgf@y\pgf@x%
		\else%
			%
			% Get the rotation (with rounding).
			%
			\pgfmathmod@{\pgfshapeborderrotate}{360}%
			\afterassignment\pgfmath@gobbletilpgfmath@%
			\expandafter\c@pgf@counta\pgfmathresult\relax\pgfmath@%
			\advance\c@pgf@counta45\relax%
			\divide\c@pgf@counta90\relax%
			\multiply\c@pgf@counta90\relax%
			\ifnum\c@pgf@counta<0\relax%
				\advance\c@pgf@counta360\relax%
			\fi%
			\edef\rotate{\the\c@pgf@counta}%
			%
			% Calculate the width and height of the node
			% contents, according to any border rotation.
			%
			\ifnum\c@pgf@counta=90\relax%
				\pgf@xc\pgf@x%
				\pgf@x\pgf@y%
				\pgf@y\pgf@xc%
			\else%
				\ifnum\c@pgf@counta=270\relax%
					\pgf@xc\pgf@x%
					\pgf@x\pgf@y%
					\pgf@y\pgf@xc%
				\fi%
			\fi%
		\fi%
		%
		% Take into account minimum height and width.
		%
		\pgfmathsetlength\pgf@ya{+\pgfshapeminheight}%
		\ifdim\pgf@y<.5\pgf@ya%
			\pgf@y.5\pgf@ya%
		\fi%
		\edef\halfheight{\the\pgf@y}%
		\pgfmathsetlength\pgf@xa{+\pgftrapeziumleftextension}%
		\edef\leftextension{\the\pgf@xa}%
		\ifdim\pgf@xa<0pt\relax%
			\pgf@xa-\pgf@xa%
		\fi%
		\pgfmathsetlength\pgf@xb{+\pgftrapeziumrightextension}%
		\edef\rightextension{\the\pgf@xb}%
		\ifdim\pgf@xb<0pt\relax%
			\advance\pgf@xa-\pgf@xb%
		\else%
			\advance\pgf@xa\pgf@xb%
		\fi%
		\pgf@xb\pgf@xa\relax%
		\advance\pgf@xb2.0\pgf@x%
		%
		% The body of the trapezium is extended to 
		% accommodate any minimum width.
		%
		\pgfmathsetlength\pgf@yc{+\pgfshapeminwidth}%
		\ifdim\pgf@xb<\pgf@yc%
			\pgf@xb\pgf@yc%
			\pgf@xc\pgf@xb%
			\ifdim\leftextension<0pt\relax%
				\advance\pgf@xc\leftextension%
			\else%
				\advance\pgf@xc-\leftextension%
			\fi%
			\ifdim\rightextension<0pt\relax%
				\advance\pgf@xc\rightextension%
			\else%
				\advance\pgf@xc-\rightextension%
			\fi%
			\divide\pgf@xc2\relax%
			\pgf@x\pgf@xc%
		\fi%
		\edef\halfwidth{\the\pgf@x}%
		\pgf@xc\pgf@xb%
		%
		% Take the larger of the outer sep.
		%
		\pgfmathsetlength\pgf@x{+\pgfshapeouterxsep}%
		\pgfmathsetlength\pgf@y{+\pgfshapeouterysep}%
		\ifdim\pgf@y>\pgf@x%
			\pgf@x\pgf@y%
		\fi%
		\edef\outersep{\the\pgf@x}%
		%
		% The \externalradius is a length that is
		% guarenteed to produce a point outside the trapezium.
		%
		\advance\pgf@xc2.0\pgf@x%
		\pgf@yc\halfheight\relax%
		\multiply\pgf@yc2\relax%
		\advance\pgf@yc2.0\pgf@x%
		\ifdim\pgf@xc<\pgf@yc%
			\edef\externalradius{\the\pgf@yc}%
		\else%
			\edef\externalradius{\the\pgf@xc}%
		\fi%
		%
		% Calculate the centre base and mid poins of the node.
		%
		\pgfsavepgf@process\centerpoint{%
			\pgfmathsetlength\pgf@x{+.5\wd\pgfnodeparttextbox}%
			\pgfmathsetlength\pgf@y{+.5\ht\pgfnodeparttextbox}%
			\pgfmathaddtolength\pgf@y{+-.5\dp\pgfnodeparttextbox}%
		}%
		\pgfsavepgf@process\basepoint{%
			\pgfmathsetlength\pgf@x{+.5\wd\pgfnodeparttextbox}%
			\pgf@y0pt\relax%
		}%
		\pgfsavepgf@process\midpoint{%
			\pgfmathsetlength\pgf@x{+.5\wd\pgfnodeparttextbox}%
			\pgfmathsetlength\pgf@y{+.5ex}%
		}%
		%
		% Calculate each point on the trapezium (without rotation).
		%
		\pgfsavepgf@process\lowerleftpoint{%
			\centerpoint%
			\advance\pgf@x-\halfwidth\relax%
			\ifdim\leftextension>0pt\relax%
				\advance\pgf@x-\leftextension\relax%
			\fi%
			\advance\pgf@y-\halfheight\relax%
		}%
		\pgfsavepgf@process\upperleftpoint{%
			\centerpoint%
			\advance\pgf@x-\halfwidth\relax%
			\ifdim\leftextension<0pt\relax%
				\advance\pgf@x\leftextension\relax%
			\fi%
			\advance\pgf@y\halfheight\relax%
		}%
		\pgfsavepgf@process\upperrightpoint{%
			\centerpoint%
			\advance\pgf@x\halfwidth\relax%
			\ifdim\rightextension<0pt\relax%
				\advance\pgf@x-\rightextension\relax%
			\fi%
			\advance\pgf@y\halfheight\relax%
		}%
		\pgfsavepgf@process\lowerrightpoint{%
			\centerpoint%
			\advance\pgf@x\halfwidth\relax%
			\ifdim\rightextension>0pt\relax%
				\advance\pgf@x\rightextension\relax%
			\fi%
			\advance\pgf@y-\halfheight\relax%
		}%
		%
		% Now calculate the adjustment for the miter length at each corner 
		% of the trapezium. This ensures more accurate anchor positioning
		% when the line width is particularly thick.
		%
		\pgfsavepgf@process\lowerleftmiter{%
			\pgfmathanglebetweenlines{\lowerleftpoint}{\lowerrightpoint}{\lowerleftpoint}{\upperleftpoint}%
			\pgfmathmultiply@{\pgfmathresult}{.5}%
			\pgfmathtan@{\pgfmathresult}%	
			\pgfmathreciprocal@{\pgfmathresult}%
			\pgf@x-\outersep\relax%
			\pgf@x\pgfmathresult\pgf@x%
			\pgf@y-\outersep\relax%
		}%
		\pgfsavepgf@process\upperleftmiter{%
			\pgfmathanglebetweenlines{\upperleftpoint}{\lowerleftpoint}{\upperleftpoint}{\upperrightpoint}%
			\pgfmathmultiply@{\pgfmathresult}{.5}%
			\pgfmathtan@{\pgfmathresult}%
			\pgfmathreciprocal@{\pgfmathresult}%
			\pgf@x-\outersep\relax%
			\pgf@x\pgfmathresult\pgf@x%
			\pgf@y\outersep\relax%
		}%
		\pgfsavepgf@process\upperrightmiter{%
			\pgfmathanglebetweenlines{\upperrightpoint}{\upperleftpoint}{\upperrightpoint}{\lowerrightpoint}%
			\pgfmathmultiply@{\pgfmathresult}{.5}%
			\pgfmathtan@{\pgfmathresult}%
			\pgfmathreciprocal@{\pgfmathresult}%
			\pgf@x\outersep\relax%
			\pgf@x\pgfmathresult\pgf@x%
			\pgf@y\outersep\relax%
		}%
		\pgfsavepgf@process\lowerrightmiter{%
			\pgfmathanglebetweenlines{\lowerrightpoint}{\upperrightpoint}{\lowerrightpoint}{\lowerleftpoint}%
			\pgfmathmultiply@{\pgfmathresult}{.5}%
			\pgfmathtan@{\pgfmathresult}%
			\pgfmathreciprocal@{\pgfmathresult}%
			\pgf@x\outersep\relax%
			\pgf@x\pgfmathresult\pgf@x%
			\pgf@y-\outersep\relax%
		}%
		%
		% Now calculate the corners for determining anchor border
		% points, by adding the adjustment for the miter length.
		%
		\pgfsavepgf@process\lowerleftborderpoint{%
			\pgfpointadd{\lowerleftpoint}{\lowerleftmiter}%
		}%
		\pgfsavepgf@process\upperleftborderpoint{%
			\pgfpointadd{\upperleftpoint}{\upperleftmiter}%
		}%
		\pgfsavepgf@process\upperrightborderpoint{%
			\pgfpointadd{\upperrightpoint}{\upperrightmiter}%
		}%
		\pgfsavepgf@process\lowerrightborderpoint{%
			\pgfpointadd{\lowerrightpoint}{\lowerrightmiter}%
		}%
		%
		% Calulate the angle from the centerpoint to each corner.
		% Rotation is not important here (see \anchorborder code).
		%
		\pgfmathanglebetweenpoints{\centerpoint}{\lowerleftborderpoint}%
		\let\angletolowerleft\pgfmathresult%
		\pgfmathanglebetweenpoints{\centerpoint}{\upperleftborderpoint}%
		\let\angletoupperleft\pgfmathresult%
		\pgfmathanglebetweenpoints{\centerpoint}{\upperrightborderpoint}%
		\let\angletoupperright\pgfmathresult%
		\pgfmathanglebetweenpoints{\centerpoint}{\lowerrightborderpoint}%
		\let\angletolowerright\pgfmathresult%
		%
		% Do the same for the *inversely rotated* base point...
		%
		\pgfsavepgf@process\rotatedbasepoint{%
			\pgfmathrotatepointaround{\basepoint}{\centerpoint}{-\rotate}%
		}%
		\pgfmathanglebetweenpoints{\rotatedbasepoint}{\lowerleftborderpoint}%
		\let\baseangletolowerleft\pgfmathresult%
		\pgfmathanglebetweenpoints{\rotatedbasepoint}{\upperleftborderpoint}%
		\let\baseangletoupperleft\pgfmathresult%
		\pgfmathanglebetweenpoints{\rotatedbasepoint}{\upperrightborderpoint}%
		\let\baseangletoupperright\pgfmathresult%
		\pgfmathanglebetweenpoints{\rotatedbasepoint}{\lowerrightborderpoint}%
		\let\baseangletolowerright\pgfmathresult%
		%
		% And the *inversely rotated* mid point...
		%
		\pgfsavepgf@process\rotatedmidpoint{%
			\pgfmathrotatepointaround{\midpoint}{\centerpoint}{-\rotate}%
		}%
		\pgfmathanglebetweenpoints{\rotatedmidpoint}{\lowerleftborderpoint}%
		\let\midangletolowerleft\pgfmathresult%
		\pgfmathanglebetweenpoints{\rotatedmidpoint}{\upperleftborderpoint}%
		\let\midangletoupperleft\pgfmathresult%
		\pgfmathanglebetweenpoints{\rotatedmidpoint}{\upperrightborderpoint}%
		\let\midangletoupperright\pgfmathresult%
		\pgfmathanglebetweenpoints{\rotatedmidpoint}{\lowerrightborderpoint}%
		\let\midangletolowerright\pgfmathresult%
		%
		% Now rotate the border points around the centerpoint...
		%
		\pgfsavepgf@process\lowerleftborderpoint{%
			\pgfmathrotatepointaround%
				{\lowerleftborderpoint}%
				{\centerpoint}%
				{\rotate}%
		}%
		\pgfsavepgf@process\upperleftborderpoint{%
			\pgfmathrotatepointaround%
				{\upperleftborderpoint}%
				{\centerpoint}%
				{\rotate}%
		}%
		\pgfsavepgf@process\upperrightborderpoint{%
			\pgfmathrotatepointaround%
				{\upperrightborderpoint}%
				{\centerpoint}%
				{\rotate}%
		}%
		\pgfsavepgf@process\lowerrightborderpoint{%
			\pgfmathrotatepointaround%
				{\lowerrightborderpoint}%
				{\centerpoint}%
				{\rotate}%
		}%
		%
		% ...and the points for drawing the border (i.e. no outer sep).
		%
		\pgfsavepgf@process\lowerleftpoint{%
			\pgfmathrotatepointaround{\lowerleftpoint}{\centerpoint}{\rotate}%
		}%
		\pgfsavepgf@process\upperleftpoint{%
			\pgfmathrotatepointaround{\upperleftpoint}{\centerpoint}{\rotate}%
		}%
		\pgfsavepgf@process\upperrightpoint{%
			\pgfmathrotatepointaround{\upperrightpoint}{\centerpoint}{\rotate}%
		}%
		\pgfsavepgf@process\lowerrightpoint{%
			\pgfmathrotatepointaround{\lowerrightpoint}{\centerpoint}{\rotate}%
		}%			
		%
		% And finally, save all the relevant stuff.
		%
		% Parameters are are logically grouped (hopefully more efficient in some way).
		%
		\def\getbackgroundpathpoints{%
			\noexpand\def\noexpand\lowerleftpoint{\lowerleftpoint}%
			\noexpand\def\noexpand\upperleftpoint{\upperleftpoint}%
			\noexpand\def\noexpand\upperrightpoint{\upperrightpoint}%
			\noexpand\def\noexpand\lowerrightpoint{\lowerrightpoint}%
		}%
		\def\getanchorborderpoints{%
			\noexpand\def\noexpand\lowerleftborderpoint{\lowerleftborderpoint}%
			\noexpand\def\noexpand\upperleftborderpoint{\upperleftborderpoint}%
			\noexpand\def\noexpand\upperrightborderpoint{\upperrightborderpoint}%
			\noexpand\def\noexpand\lowerrightborderpoint{\lowerrightborderpoint}%
		}%
		\def\getanchorborderangles{%
			\noexpand\def\noexpand\angletolowerleft{\angletolowerleft}%
			\noexpand\def\noexpand\angletoupperleft{\angletoupperleft}%
			\noexpand\def\noexpand\angletoupperright{\angletoupperright}%
			\noexpand\def\noexpand\angletolowerright{\angletolowerright}%
			%
			\noexpand\def\noexpand\baseangletolowerleft{\baseangletolowerleft}%
			\noexpand\def\noexpand\baseangletoupperleft{\baseangletoupperleft}%
			\noexpand\def\noexpand\baseangletoupperright{\baseangletoupperright}%
			\noexpand\def\noexpand\baseangletolowerright{\baseangletolowerright}%
			%
			\noexpand\def\noexpand\midangletolowerleft{\midangletolowerleft}%
			\noexpand\def\noexpand\midangletoupperleft{\midangletoupperleft}%
			\noexpand\def\noexpand\midangletoupperright{\midangletoupperright}%
			\noexpand\def\noexpand\midangletolowerright{\midangletolowerright}%
		}%
		\def\installtrapeziumparameters{%
			\noexpand\def\noexpand\getbackgroundpathpoints{\getbackgroundpathpoints}%
			\noexpand\def\noexpand\getanchorborderpoints{\getanchorborderpoints}%
			\noexpand\def\noexpand\getanchorborderangles{\getanchorborderangles}%
			\noexpand\def\noexpand\rotate{\rotate}%
			\noexpand\def\noexpand\externalradius{\externalradius}%
		}%
	}
	\savedanchor\centerpoint{%
		\pgfmathsetlength\pgf@x{+.5\wd\pgfnodeparttextbox}%
		\pgfmathsetlength\pgf@y{+.5\ht\pgfnodeparttextbox}%
		\pgfmathaddtolength\pgf@y{-.5\dp\pgfnodeparttextbox}%
	}%
	\savedanchor\basepoint{%
		\pgfmathsetlength\pgf@x{+.5\wd\pgfnodeparttextbox}%
		\pgfmathsetlength\pgf@y{+.5\ht\pgfnodeparttextbox}%
		\pgf@y0pt\relax%
	}%
	\savedanchor\midpoint{%
		\centerpoint%
		\pgfmathsetlength\pgf@y{+.5ex}%
	}%
	\anchor{center}{\centerpoint}%
	\anchor{base}{\basepoint}%
	\anchor{base east}{%
		\installtrapeziumparameters%
		\let\pgf@trapeziumanchorborderreferencepoint\basepoint%
		\csname pgf@anchor@trapezium@border\endcsname{\pgfqpoint{\externalradius}{0pt}}%
	}
	\anchor{base west}{%
		\installtrapeziumparameters%
		\let\pgf@trapeziumanchorborderreferencepoint\basepoint%
		\csname pgf@anchor@trapezium@border\endcsname{\pgfqpoint{-\externalradius}{0pt}}%
	}%
	\anchor{mid}{\midpoint}%
	\anchor{mid east}{%
		\installtrapeziumparameters%
		\let\pgf@trapeziumanchorborderreferencepoint\midpoint%
		\csname pgf@anchor@trapezium@border\endcsname{\pgfqpoint{\externalradius}{0pt}}%
	}
	\anchor{mid west}{%
		\installtrapeziumparameters%
		\let\pgf@trapeziumanchorborderreferencepoint\midpoint%
		\csname pgf@anchor@trapezium@border\endcsname{\pgfqpoint{-\externalradius}{0pt}}%
	}%
	\anchor{north}{%
		\installtrapeziumparameters%
		\csname pgf@anchor@trapezium@border\endcsname{\pgfqpoint{0pt}{\externalradius}}%
	}
	\anchor{south}{%
		\installtrapeziumparameters%
		\csname pgf@anchor@trapezium@border\endcsname{\pgfqpoint{0pt}{-\externalradius}}%
	}
	\anchor{east}{%
		\installtrapeziumparameters%
		\csname pgf@anchor@trapezium@border\endcsname{\pgfqpoint{\externalradius}{0pt}}%
	}
	\anchor{west}{%
		\installtrapeziumparameters%
		\csname pgf@anchor@trapezium@border\endcsname{\pgfqpoint{-\externalradius}{0pt}}%
	}
	\anchor{north east}{%
		\installtrapeziumparameters%
		\csname pgf@anchor@trapezium@border\endcsname{\pgfqpoint{\externalradius}{\externalradius}}%
	}
	\anchor{south west}{%
		\installtrapeziumparameters%
		\csname pgf@anchor@trapezium@border\endcsname{\pgfqpoint{-\externalradius}{-\externalradius}}%
	}
	\anchor{south east}{%
		\installtrapeziumparameters%
		\csname pgf@anchor@trapezium@border\endcsname{\pgfqpoint{\externalradius}{-\externalradius}}%
	}
	\anchor{north west}{%
		\installtrapeziumparameters%
		\csname pgf@anchor@trapezium@border\endcsname{\pgfqpoint{\externalradius}{-\externalradius}}%
	}
	\anchor{bottom left corner}{%
		\installtrapeziumparameters%
		\getanchorborderpoints%
		\lowerleftborderpoint%
	}%
	\anchor{top left corner}{%
		\installtrapeziumparameters%
		\getanchorborderpoints%
		\upperleftborderpoint%
	}%
	\anchor{top right corner}{%
		\installtrapeziumparameters%
		\getanchorborderpoints%
		\upperrightborderpoint%
	}%
	\anchor{bottom right corner}{%
		\installtrapeziumparameters%
		\getanchorborderpoints%
		\lowerrightborderpoint%
	}%	
	\anchor{left side}{%
		\installtrapeziumparameters%
		\getanchorborderpoints%
		\pgfpointlineattime{0.5}{\lowerleftborderpoint}{\upperleftborderpoint}%
	}%	
	\anchor{right side}{%
		\installtrapeziumparameters%
		\getanchorborderpoints%
		\pgfpointlineattime{0.5}{\lowerrightborderpoint}{\upperrightborderpoint}%
	}%	
	\anchor{top side}{%
		\installtrapeziumparameters%
		\getanchorborderpoints%
		\pgfpointlineattime{0.5}{\upperleftborderpoint}{\upperrightborderpoint}%
	}%	
	\anchor{bottom side}{%
		\installtrapeziumparameters%
		\getanchorborderpoints%
		\pgfpointlineattime{0.5}{\lowerleftborderpoint}{\lowerrightborderpoint}%
	}%		
	\backgroundpath{%
		\installtrapeziumparameters%
		\getbackgroundpathpoints%
		\pgfpathmoveto{\lowerleftpoint}%
		\pgfpathlineto{\upperleftpoint}%
		\pgfpathlineto{\upperrightpoint}%
		\pgfpathlineto{\lowerrightpoint}%
		\pgfpathclose%			
	}
	\anchorborder{%
		%
		% Save x and y.
		%
		\edef\externalx{\the\pgf@x}%
		\edef\externaly{\the\pgf@y}%
		%
		% This allows anchors base east, base west, mid east and mid west,
		% to redefine the `center' of the node to correctly calculate the
		% border points.
		%
		\pgfutil@ifundefined{pgf@trapeziumanchorborderreferencepoint}%
			{\let\referencepoint\centerpoint}%
			{\let\referencepoint\pgf@trapeziumanchorborderreferencepoint}%
		%
		% Adjust the location of the external 
		% point relative to the reference point.
		%
		\referencepoint%
		\pgf@xa\externalx\relax%
		\pgf@ya\externaly\relax%
		\advance\pgf@xa\pgf@x%
		\advance\pgf@ya\pgf@y%
		\edef\externalx{\the\pgf@xa}%
		\edef\externaly{\the\pgf@ya}%
		%
		% Install the required points and angles.
		%
		\installtrapeziumparameters%
		\getanchorborderpoints%
		\getanchorborderangles%
		%
		% Get the angle of the external point to the \referencepoint.
		%
		\pgfmathanglebetweenpoints{\referencepoint}{\pgfqpoint{\externalx}{\externaly}}%
		%
		% *Subtract* the rotation from the external angle. This is 
		% why the border point angles do not neeed to be rotated.
		%
		\pgfmathsubtract@{\pgfmathresult}{\rotate}%
		\ifdim\pgfmathresult pt<0pt\relax%
			\pgfmathadd@{\pgfmathresult}{360}%
		\fi%
		%
		% Get the relevant angles for the reference point.
		%
		\let\externalangle\pgfmathresult%
		\ifx\referencepoint\basepoint%
			\let\angletoupperright\baseangletoupperright%
			\let\angletoupperleft\baseangletoupperleft%
			\let\angletolowerright\baseangletolowerright%
			\let\angletolowerleft\baseangletolowerleft%
		\else%
			\ifx\referencepoint\midpoint%
				\let\angletoupperright\midangletoupperright%
				\let\angletoupperleft\midangletoupperleft%
				\let\angletolowerright\midangletolowerright%
				\let\angletolowerleft\midangletolowerleft%
		\fi\fi%
		%
		% Find the line on the border...
		%			
		\ifdim\externalangle pt<\angletoupperright pt\relax%
			\let\firstpoint\upperrightborderpoint%
			\let\secondpoint\lowerrightborderpoint%
		\else%
			\ifdim\externalangle pt<\angletoupperleft pt\relax%
				\let\firstpoint\upperleftborderpoint%
				\let\secondpoint\upperrightborderpoint%
			\else%
				\ifdim\externalangle pt<\angletolowerleft pt\relax%
					\let\firstpoint\upperleftborderpoint%
					\let\secondpoint\lowerleftborderpoint%
				\else%
					\ifdim\externalangle pt<\angletolowerright pt\relax%
						\let\firstpoint\lowerleftborderpoint%
						\let\secondpoint\lowerrightborderpoint%
					\else%
						\let\firstpoint\upperrightborderpoint%
						\let\secondpoint\lowerrightborderpoint%
					\fi%
				\fi%
			\fi%
		\fi%
		%
		% ...and thus the point on the border.
		%
		\pgfpointintersectionoflines{\referencepoint}{\pgfqpoint{\externalx}{\externaly}}%
				{\firstpoint}{\secondpoint}%
	}%
}




% Shape semicircle.
%
\pgfdeclareshape{semicircle}{
	\savedmacro\installsemicircleparameters{%
		%
		% Get the larger of the outer sep.
		%
		\pgfmathsetlength\pgf@x{+\pgfshapeouterxsep}%
		\pgfmathsetlength\pgf@y{+\pgfshapeouterysep}%
		\ifdim\pgf@x<\pgf@y%
			\pgf@x\pgf@y%
		\fi%
		\edef\outersep{\the\pgf@x}%
		%
		% Get the node dimensions.
		%
		\pgfmathsetlength\pgf@x{+\pgfshapeinnerxsep}%
		\pgfmathaddtolength\pgf@x{+.5\wd\pgfnodeparttextbox}%
		\pgfmathsetlength\pgf@y{+\pgfshapeinnerysep}%
		\pgfmathaddtolength\pgf@y{+.5\ht\pgfnodeparttextbox}%
		\pgfmathaddtolength\pgf@y{+.5\dp\pgfnodeparttextbox}%
		%
		% Use the radius of the incircle if required...
		%
		\ifpgfshapeborderusesincircle%
			%
			% Get the rotation (no rounding).
			%
			\let\rotate\pgfshapeborderrotate%
			\ifdim\pgf@x<\pgf@y%
				\pgf@x\pgf@y%
			\fi%			
			\pgf@x1.41421\pgf@x%
			\edef\halfheight{\the\pgf@x}%
			\advance\pgf@x\pgf@x%
		\else%
			%
			% Get the rotation (with rounding).
			%
			\pgfmathmod@{\pgfshapeborderrotate}{360}%
			\afterassignment\pgfmath@gobbletilpgfmath@%
			\expandafter\c@pgf@counta\pgfmathresult\relax\pgfmath@%
			\advance\c@pgf@counta45\relax%
			\divide\c@pgf@counta90\relax%
			\multiply\c@pgf@counta90\relax%
			\ifnum\c@pgf@counta<0\relax%
				\advance\c@pgf@counta360\relax%
			\fi%
			\edef\rotate{\the\c@pgf@counta}%
			%
			% Calculate the width and height of the node
			% contents, according to any border rotation.
			%
			\ifnum\c@pgf@counta=90\relax%
				\pgf@xc\pgf@x%
				\pgf@x\pgf@y%
				\pgf@y\pgf@xc%
			\else%
				\ifnum\c@pgf@counta=270\relax%
					\pgf@xc\pgf@x%
					\pgf@x\pgf@y%
					\pgf@y\pgf@xc%
				\fi%
			\fi%
			\advance\pgf@y\pgf@y%
			\pgfmathveclen@{\pgfmath@tonumber{\pgf@x}}{\pgfmath@tonumber{\pgf@y}}%
			\pgf@x\pgfmathresult pt\relax%
			\pgf@y.5\pgf@y%
			\edef\halfheight{\the\pgf@y}%
		\fi%
		\edef\defaultradius{\the\pgf@x}%
		%
		% Take into account minimum height and width.
		%
		\pgfmathsetlength\pgf@xa{+\pgfshapeminwidth}%
		\ifdim\pgf@x<.5\pgf@xa%
			\pgf@x.5\pgf@xa%
		\fi%
		\pgfmathsetlength\pgf@ya{+\pgfshapeminheight}%
		\ifdim\pgf@x<\pgf@ya%
			\pgf@x\pgf@ya%
		\fi%
		\edef\semicircleradius{\the\pgf@x}%
		%
		% Find the center/base/mid of the semi circle node.
		%		
		\pgfsavepgf@process\centerpoint{%
			\pgfmathsetlength\pgf@x{+.5\wd\pgfnodeparttextbox}%
			\pgfmathsetlength\pgf@y{+.5\ht\pgfnodeparttextbox}%
			\pgfmathaddtolength\pgf@y{-.5\dp\pgfnodeparttextbox}%
		}%
		\pgfsavepgf@process\basepoint{%
			\pgfmathsetlength\pgf@x{+.5\wd\pgfnodeparttextbox}%
			\pgf@y0pt\relax%
		}%
		\pgfsavepgf@process\midpoint{%
			\pgfmathsetlength\pgf@x{+.5\wd\pgfnodeparttextbox}%
			\pgfmathsetlength\pgf@y{+.5ex}%
		}%
		\pgfsavepgf@process\semicirclecenterpoint{%
			\centerpoint%
			\pgf@ya\semicircleradius\relax%
			\advance\pgf@ya-\defaultradius\relax%
			%
			% The point is adjusted to make the node contents
			% appear more centered if the node is enlarged to
			% some minimum size. The factor .4 just seems OK.
			%
			\pgf@ya.4\pgf@ya% 
			\advance\pgf@y-\pgf@ya%
			\pgf@ya\halfheight\relax%
			\advance\pgf@y-\pgf@ya%	
		}%
		%
		% Add the outer sep to the radius here.
		%
		\pgf@x\semicircleradius\relax%
		\advance\pgf@x\outersep\relax%
		\edef\semicircleradius{\the\pgf@x}%
		\pgfpointdiff{\centerpoint}{\semicirclecenterpoint}%
		\ifdim\pgf@y<0pt\pgf@y-\pgf@y\fi%
		\edef\centerpointdiff{\the\pgf@y}%
		%
		% Calculate the start and end points on the border.
		%		
		\pgfsavepgf@process\arcstartborder{%
			\semicirclecenterpoint%
			\advance\pgf@x\semicircleradius\relax%
		}%
		\pgfsavepgf@process\arcendborder{%
			\semicirclecenterpoint%
			\advance\pgf@x-\semicircleradius\relax%
		}%
		%
		% Calculate the start and end *corner* points on the border.
		% This is needed to accommodate the outer sep.
		%
		\pgfsavepgf@process\arcstartcorner{%
			\arcstartborder%
			\advance\pgf@y-\outersep\relax%
		}%
		\pgfsavepgf@process\arcendcorner{%
			\arcendborder%
			\advance\pgf@y-\outersep\relax%
		}
		%
		% Now calculate all the relevant angles.
		%
		% For the center point.
		%
		\pgfmathanglebetweenpoints{\centerpoint}{\arcstartborder}%
		\let\angletoarcstartborder\pgfmathresult%
		\pgfmathanglebetweenpoints{\centerpoint}{\arcendborder}%
		\let\angletoarcendborder\pgfmathresult%
		\pgfmathanglebetweenpoints{\centerpoint}{\arcstartcorner}%
		\let\angletoarcstartcorner\pgfmathresult%
		\pgfmathanglebetweenpoints{\centerpoint}{\arcendcorner}%
		\let\angletoarcendcorner\pgfmathresult%
		%
		% For the basepoint (rotated about the center point).
		%
		\pgfsavepgf@process\rotatedbasepoint{%
			\pgfmathrotatepointaround{\basepoint}{\centerpoint}{-\rotate}%
		}%
		\pgfmathanglebetweenpoints{\rotatedbasepoint}{\arcstartborder}%
		\let\baseangletoarcstartborder\pgfmathresult%
		\pgfmathanglebetweenpoints{\rotatedbasepoint}{\arcendborder}%
		\let\baseangletoarcendborder\pgfmathresult%
		\pgfmathanglebetweenpoints{\rotatedbasepoint}{\arcstartcorner}%
		\let\baseangletoarcstartcorner\pgfmathresult%
		\pgfmathanglebetweenpoints{\rotatedbasepoint}{\arcendcorner}%
		\let\baseangletoarcendcorner\pgfmathresult%
		%
		% For the midpoint (rotated about the center point).
		%
		\pgfsavepgf@process\rotatedmidpoint{%
			\pgfmathrotatepointaround{\midpoint}{\centerpoint}{-\rotate}%
		}%
		\pgfmathanglebetweenpoints{\rotatedmidpoint}{\arcstartborder}%
		\let\midangletoarcstartborder\pgfmathresult%
		\pgfmathanglebetweenpoints{\rotatedmidpoint}{\arcendborder}%
		\let\midangletoarcendborder\pgfmathresult%
		\pgfmathanglebetweenpoints{\rotatedmidpoint}{\arcstartcorner}%
		\let\midangletoarcstartcorner\pgfmathresult%
		\pgfmathanglebetweenpoints{\rotatedmidpoint}{\arcendcorner}%
		\let\midangletoarcendcorner\pgfmathresult%
		%
		% Now, rotate the semicircle points around the centerpoint.
		%
		\pgfsavepgf@process\semicirclecenterpoint{%
			\pgfmathrotatepointaround{\semicirclecenterpoint}{\centerpoint}{\rotate}%
		}%
		\pgfsavepgf@process\arcstartborder{%
			\pgfmathrotatepointaround{\arcstartborder}{\centerpoint}{\rotate}%
		}%
		\pgfsavepgf@process\arcendborder{%
			\pgfmathrotatepointaround{\arcendborder}{\centerpoint}{\rotate}%
		}%
		\pgfsavepgf@process\arcstartcorner{%
			\pgfmathrotatepointaround{\arcstartcorner}{\centerpoint}{\rotate}%
		}%
		\pgfsavepgf@process\arcendcorner{%
			\pgfmathrotatepointaround{\arcendcorner}{\centerpoint}{\rotate}%
		}%
		%
		% Calculate the distance between the base point and the (rotated) semicircle center.
		%
		\pgfpointdiff{\basepoint}{\semicirclecenterpoint}%
		\pgfmathveclen@{\pgfmath@tonumber{\pgf@x}}{\pgfmath@tonumber{\pgf@y}}%
		\edef\basesemicirclecenterdiff{\pgfmathresult pt}%
		%
		% Calculate the distance between the base point and the (rotated) semicircle center.
		%
		\pgfpointdiff{\midpoint}{\semicirclecenterpoint}%
		\pgfmathveclen@{\pgfmath@tonumber{\pgf@x}}{\pgfmath@tonumber{\pgf@y}}%
		\edef\midsemicirclecenterdiff{\pgfmathresult pt}%
		%
		% And save all the stuff.
		%
		\def\installsemicircleparameters{%
			\noexpand\def\noexpand\rotate{\rotate}%
			\noexpand\def\noexpand\outersep{\outersep}%
			\noexpand\def\noexpand\semicircleradius{\semicircleradius}%
			%
			\noexpand\def\noexpand\arcstartborder{\arcstartborder}%
			\noexpand\def\noexpand\arcendborder{\arcendborder}%
			\noexpand\def\noexpand\arcstartcorner{\arcstartcorner}%
			\noexpand\def\noexpand\arcendcorner{\arcendcorner}%
			\noexpand\def\noexpand\semicirclecenterpoint{\semicirclecenterpoint}%
			%
			\noexpand\def\noexpand\angletoarcstartborder{\angletoarcstartborder}%
			\noexpand\def\noexpand\angletoarcendborder{\angletoarcendborder}%
			\noexpand\def\noexpand\angletoarcstartcorner{\angletoarcstartcorner}%
			\noexpand\def\noexpand\angletoarcendcorner{\angletoarcendcorner}%
			%
			\noexpand\def\noexpand\centerpointdiff{\centerpointdiff}%
			\noexpand\def\noexpand\basesemicirclecenterdiff{\basesemicirclecenterdiff}%
			\noexpand\def\noexpand\midsemicirclecenterdiff{\midsemicirclecenterdiff}%
			%
			\noexpand\def\noexpand\baseangletoarcstartborder{\baseangletoarcstartborder}%
			\noexpand\def\noexpand\baseangletoarcendborder{\baseangletoarcendborder}%
			\noexpand\def\noexpand\baseangletoarcstartcorner{\baseangletoarcstartcorner}%
			\noexpand\def\noexpand\baseangletoarcendcorner{\baseangletoarcendcorner}%
			%
			\noexpand\def\noexpand\midangletoarcstartborder{\midangletoarcstartborder}%
			\noexpand\def\noexpand\midangletoarcendborder{\midangletoarcendborder}%
			\noexpand\def\noexpand\midangletoarcstartcorner{\midangletoarcstartcorner}%
			\noexpand\def\noexpand\midangletoarcendcorner{\midangletoarcendcorner}%
		}%
	}
	\savedanchor{\centerpoint}{%
		\pgfmathsetlength\pgf@x{+.5\wd\pgfnodeparttextbox}%
		\pgfmathsetlength\pgf@y{+.5\ht\pgfnodeparttextbox}%
		\pgfmathaddtolength\pgf@y{-.5\dp\pgfnodeparttextbox}%	
	}
	\savedanchor{\basepoint}{%
		\pgfmathsetlength\pgf@x{+.5\wd\pgfnodeparttextbox}%
		\pgf@y0pt\relax%
	}
	\savedanchor{\midpoint}{%
		\pgfmathsetlength\pgf@x{+.5\wd\pgfnodeparttextbox}%
		\pgfmathsetlength\pgf@y{+.5ex}%
	}
	\anchor{center}{\centerpoint}
	\anchor{base}{\basepoint}
	\anchor{base west}{%
		\installsemicircleparameters%
		\let\pgf@semicirclereferencepoint\basepoint%
		\csname pgf@anchor@semicircle@border\endcsname{\pgfqpoint{-\semicircleradius}{0pt}}%
	}
	\anchor{base east}{%
		\installsemicircleparameters%
		\let\pgf@semicirclereferencepoint\basepoint%
		\csname pgf@anchor@semicircle@border\endcsname{\pgfqpoint{\semicircleradius}{0pt}}%
	}
	\anchor{mid}{\midpoint}
	\anchor{mid west}{%
		\installsemicircleparameters%
		\let\pgf@semicirclereferencepoint\midpoint%
		\csname pgf@anchor@semicircle@border\endcsname{\pgfqpoint{-\semicircleradius}{0pt}}%
	}
	\anchor{mid east}{%
		\installsemicircleparameters%
		\let\pgf@semicirclereferencepoint\midpoint%
		\csname pgf@anchor@semicircle@border\endcsname{\pgfqpoint{\semicircleradius}{0pt}}%
	}
	\anchor{apex}{%
		\installsemicircleparameters%
		\pgfmathadd@{\rotate}{90}%
		\let\angle\pgfmathresult%
		\pgfpointadd{\semicirclecenterpoint}{\pgfqpointpolar{\angle}{\semicircleradius}}%
	}
	\anchor{arc start}{%
		\installsemicircleparameters%
		\arcstartcorner%
	}
	\anchor{arc end}{%
		\installsemicircleparameters%
		\arcendcorner%
	}
	\anchor{chord center}{%
		\installsemicircleparameters%
		\pgfpointlineattime{0.5}{\arcstartcorner}{\arcendcorner}%
	}
	\anchor{north}{%
		\installsemicircleparameters%
		\csname pgf@anchor@semicircle@border\endcsname{\pgfqpointpolar{90}{\semicircleradius}}%
	}
	\anchor{south}{%
		\installsemicircleparameters%
		\csname pgf@anchor@semicircle@border\endcsname{\pgfqpointpolar{270}{\semicircleradius}}%
	}
	\anchor{east}{%
		\installsemicircleparameters%
		\csname pgf@anchor@semicircle@border\endcsname{\pgfqpointpolar{0}{\semicircleradius}}%
	}
	\anchor{west}{%
		\installsemicircleparameters%
		\csname pgf@anchor@semicircle@border\endcsname{\pgfqpointpolar{180}{\semicircleradius}}%
	}
	\anchor{north west}{%
		\installsemicircleparameters%
		\csname pgf@anchor@semicircle@border\endcsname{\pgfqpointpolar{135}{\semicircleradius}}%
	}
	\anchor{south west}{%
		\installsemicircleparameters%
		\csname pgf@anchor@semicircle@border\endcsname{\pgfqpointpolar{225}{\semicircleradius}}%
	}
	\anchor{north east}{%
		\installsemicircleparameters%
		\csname pgf@anchor@semicircle@border\endcsname{\pgfqpointpolar{45}{\semicircleradius}}%
	}
	\anchor{south east}{%
		\installsemicircleparameters%
		\csname pgf@anchor@semicircle@border\endcsname{\pgfqpointpolar{315}{\semicircleradius}}%
	}
	\backgroundpath{%
		\installsemicircleparameters%
		\pgf@x\semicircleradius\relax%
		\advance\pgf@x-\outersep\relax%
		\edef\semicircleradius{\the\pgf@x}%
		\pgfpathmoveto{\pgfpointadd{\semicirclecenterpoint}{\pgfqpointpolar{\rotate}{\semicircleradius}}}%
		{%
			\pgftransformrotate{\rotate}%
			\pgfpatharc{0}{180}{\semicircleradius}%
			\pgfpathclose%	
		}%
	}
	\anchorborder{%
		%
		% Save x and y.
		%
		\edef\externalx{\the\pgf@x}%
		\edef\externaly{\the\pgf@y}%
		%
		% Check if a reference point has been defined (i.e. \midpoint or \basepoint).
		%
		\pgfutil@ifundefined{pgf@semicirclereferencepoint}%
			{\let\referencepoint\centerpoint}%
			{\let\referencepoint\pgf@semicirclereferencepoint}%
		%
		% Adjust the location of the external  point relative to the reference point.
		%
		\referencepoint%
		\pgf@xa\externalx\relax%
		\pgf@ya\externaly\relax%
		\advance\pgf@xa\pgf@x%
		\advance\pgf@ya\pgf@y%
		\edef\externalx{\the\pgf@xa}%
		\edef\externaly{\the\pgf@ya}%
		%
		% Install the required points and angles.
		%
		\installsemicircleparameters%
		%
		% Get the angle of the external point to the \referencepoint.
		%
		\pgfmathanglebetweenpoints{\referencepoint}{\pgfqpoint{\externalx}{\externaly}}%
		\let\externalangle\pgfmathresult%
		%
		% *Subtract* the rotation from the external angle.
		%
		\pgfmathsubtract@{\pgfmathresult}{\rotate}%
		\ifdim\pgfmathresult pt<0pt\relax%
			\pgfmathadd@{\pgfmathresult}{360}%
		\fi%
		\let\angle\pgfmathresult%
		\ifx\referencepoint\basepoint%
			\let\angletoarcstartborder\baseangletoarcstartborder%
			\let\angletoarcendborder\baseangletoarcendborder%
			\let\angletoarcstartcorner\baseangletoarcstartcorner%
			\let\angletoarcendcorner\baseangletoarcendcorner%
			\let\centerpointdiff\basesemicirclecenterdiff%
		\else%
			\ifx\referencepoint\midpoint%
				\let\angletoarcstartborder\midangletoarcstartborder%
				\let\angletoarcendborder\midangletoarcendborder%
				\let\angletoarcstartcorner\midangletoarcstartcorner%
				\let\angletoarcendcorner\midangletoarcendcorner%
				\let\centerpointdiff\midsemicirclecenterdiff%
		\fi\fi%
		%
		% Determine if the line will cross the semicircle arc, or the chord.
		% 
		\ifdim\angle pt>\angletoarcstartborder pt\relax%
			\let\firstpoint\pgfutil@empty%
			\let\secondpoint\pgfutil@empty%
		\else%
			\ifdim\angle pt>\angletoarcstartcorner pt\relax%
				\let\firstpoint\arcstartcorner%
				\let\secondpoint\arcstartborder%
			\else%
				\ifdim\angle pt>\angletoarcendcorner pt\relax%
					\let\firstpoint\arcendcorner%
					\let\secondpoint\arcstartcorner%
				\else%
					\ifdim\angle pt>\angletoarcendborder pt\relax%
						\let\firstpoint\arcendborder%
						\let\secondpoint\arcendcorner%
					\else%
						\let\firstpoint\pgfutil@empty%
						\let\secondpoint\pgfutil@empty%
					\fi%
				\fi%
			\fi%
		\fi%
		\ifx\firstpoint\pgfutil@empty
			%
			% Calculate the angle from the centre of the semicircle to the
			% point on the semicircle arc which intersects the line from 
			% the external point to the reference point...
			%
			\pgfmathanglebetweenlines{\referencepoint}{\pgfqpoint{\externalx}{\externaly}}%
				{\semicirclecenterpoint}{\referencepoint}%
			\pgfmathsin@{\pgfmathresult}%
			\let\sineangle\pgfmathresult%
			\pgf@x\semicircleradius\relax%
			\pgfmathreciprocal@{\pgfmath@tonumber{\pgf@x}}%
			\let\reciprocalradius\pgfmathresult%
			\pgf@x\centerpointdiff\relax%
			\pgf@x\sineangle\pgf@x%
			\pgf@x\reciprocalradius\pgf@x%
			\pgfmathasin@{\pgfmath@tonumber{\pgf@x}}%
			\pgf@x\pgfmathresult pt\relax%
			\advance\pgf@x\externalangle pt\relax%
			\edef\angle{\pgfmath@tonumber{\pgf@x}}%
			%
			% ...and thus the point on the border.
			%
			\pgfpointadd{\semicirclecenterpoint}{\pgfqpointpolar{\angle}{\semicircleradius}}%
		\else%
			%
			% Calculate the the point where the semicircle chord intersects 
			% the line from the external point to the reference point.
			%
			\pgfpointintersectionoflines{\referencepoint}{\pgfqpoint{\externalx}{\externaly}}%
				{\firstpoint}{\secondpoint}%
		\fi%
	}		
}





% \pgfsetisoscelestriangleapexangle
%
\def\pgfsetisoscelestriangleapexangle#1{\pgfmathsetmacro\pgfisoscelestriangleapexangle{#1}}
\pgfsetisoscelestriangleapexangle{45}

% Shape isosceles triangle.
%
\pgfdeclareshape{isosceles triangle}{
	\savedmacro\installtriangleparameters{%
		%
		% Define a \centerpoint, \basepoint and \midpoint.
		%
		\pgfsavepgf@process\centerpoint{%
			\pgfmathsetlength\pgf@x{+.5\wd\pgfnodeparttextbox}%
			\pgfmathsetlength\pgf@y{+.5\ht\pgfnodeparttextbox}%
			\pgfmathaddtolength\pgf@y{-.5\dp\pgfnodeparttextbox}%
		}%
		\pgfsavepgf@process\basepoint{%
			\pgfmathsetlength\pgf@x{+.5\wd\pgfnodeparttextbox}%
			\pgf@y0pt\relax%
		}%
		\pgfsavepgf@process\midpoint{%
			\pgfmathsetlength\pgf@x{+.5\wd\pgfnodeparttextbox}%
			\pgfmathsetlength\pgf@y{+.5ex}%
		}%
		%
		% Get the larger of the outer sep.
		%
		\pgfmathsetlength\pgf@x{+\pgfshapeouterxsep}%
		\pgfmathsetlength\pgf@y{+\pgfshapeouterysep}%
		\ifdim\pgf@x<\pgf@y%
			\pgf@x\pgf@y%
		\fi%
		\edef\outersep{\the\pgf@x}%
		%
		% Get the node dimensions.
		%
		\pgfmathsetlength\pgf@x{+\pgfshapeinnerxsep}%
		\pgfmathaddtolength\pgf@x{+.5\wd\pgfnodeparttextbox}%
		\pgfmathsetlength\pgf@y{+\pgfshapeinnerysep}%
		\pgfmathaddtolength\pgf@y{+.5\ht\pgfnodeparttextbox}%
		\pgfmathaddtolength\pgf@y{+.5\dp\pgfnodeparttextbox}%
		%
		% Half of the apex angle is more useful.
		%
		\pgfmathdivide@{\pgfisoscelestriangleapexangle}{2}%
		\let\halfapexangle\pgfmathresult%
		\pgfmathtan@{\halfapexangle}%
		\let\tanhalfapexangle\pgfmathresult%
		\pgfmathreciprocal@{\pgfmathresult}%
		\let\cothalfapexangle\pgfmathresult%
		%
		% Calculate the default (half) width and height of the triangle
		% contents, according to any border rotation...
		%
		\ifpgfshapeborderusesincircle%
			%
			% Get the rotation.
			%
			\let\rotate\pgfshapeborderrotate%
			%
			% Calculate the incircle radius.
			%	
			\ifdim\pgf@x<\pgf@y%
				\pgf@x\pgf@y%
			\fi%
			\pgf@x1.41421\pgf@x% incircle radius
			\pgfmathsin@{\halfapexangle}%
			\let\sinehalfapexangle\pgfmathresult%
			\pgfmathreciprocal@{\pgfmathresult}%
			\let\reciprocalsinehalfapexangle\pgfmathresult%
			\pgf@yb\pgfmathresult\pgf@x%
			\advance\pgf@yb\pgf@x% yb is the total height.
			\pgf@xb\tanhalfapexangle\pgf@yb% xb is the (half) width.
			%
			% Take into account minimum height and width.
			%
			\pgfmathsetlength\pgf@x{+\pgfshapeminwidth}%
			\pgfmathsetlength\pgf@y{+\pgfshapeminheight}%
			\pgf@xb\tanhalfapexangle\pgf@yb%
			\ifdim\pgf@xb<.5\pgf@x%
				\pgf@xb.5\pgf@x%
				\pgf@yb\cothalfapexangle\pgf@xb% yb is the new total height.
			\fi%
			\ifdim\pgf@yb<\pgf@y%
				\pgf@yb\pgf@y%
				\pgf@xb\tanhalfapexangle\pgf@yb% xb is new (half) width.
			\fi%
			%
			% Now recalculate radius.
			%
			\pgfmathadd@{\sinehalfapexangle}{1}%
			\pgfmathreciprocal{\pgfmathresult}%
			\pgf@yc\pgfmathresult\pgf@yb%
			\pgf@yc\sinehalfapexangle\pgf@yc% yc is triangle depth.
			\pgf@ya-\pgf@yc%
			\advance\pgf@ya\pgf@yb% ya is the triangle height.
			\edef\triangledepth{\the\pgf@yc}%
			\edef\triangleheight{\the\pgf@ya}%
			\edef\halftrianglewidth{\the\pgf@xb}%
		\else%
			%
			% Get the rotation (with rounding).
			%
			\pgfmathmod@{\pgfshapeborderrotate}{360}%
			\afterassignment\pgfmath@gobbletilpgfmath@%
			\expandafter\c@pgf@counta\pgfmathresult\relax\pgfmath@%
			\advance\c@pgf@counta45\relax%
			\divide\c@pgf@counta90\relax%
			\multiply\c@pgf@counta90\relax%
			\ifnum\c@pgf@counta<0\relax%
				\advance\c@pgf@counta360\relax%
			\fi%
			\edef\rotate{\the\c@pgf@counta}%
			%
			% Calculate the width and height of the node
			% contents, according to any border rotation.
			%
			\pgf@x2.0\pgf@x%
			\pgf@y2.0\pgf@y%
			\pgf@xa\pgf@x%
			\pgf@ya\pgf@y%
			\ifnum\c@pgf@counta=0\relax%
				\pgf@xc\pgf@xa%
				\pgf@xa\pgf@ya%
				\pgf@ya\pgf@xc%
			\else%
				\ifnum\c@pgf@counta=180\relax%
					\pgf@xc\pgf@xa%
					\pgf@xa\pgf@ya%
					\pgf@ya\pgf@xc%
				\fi%
			\fi%
			\pgf@yb.5\pgf@xa%
			\pgf@yb\cothalfapexangle\pgf@yb%
			\advance\pgf@yb\pgf@ya% yb is the total height.
			\pgf@yc-\pgf@yb%
			%			
			% Take into account minimum height and width.
			%
			\pgfmathsetlength\pgf@x{+\pgfshapeminwidth}%
			\pgfmathsetlength\pgf@y{+\pgfshapeminheight}%
			\pgf@xb.5\pgf@xa% xb is the (half) width.
			\pgf@xb\tanhalfapexangle\pgf@yb%
			\ifdim\pgf@xb<.5\pgf@x%
				\pgf@xb.5\pgf@x%
				\pgf@yb\cothalfapexangle\pgf@xb% yb is the new total height.
			\fi%
			\ifdim\pgf@yb<\pgf@y%
				\pgf@yb\pgf@y%
				\pgf@xb\tanhalfapexangle\pgf@yb% xb is new (half) width.
			\fi%
			%
			% Adjust the positioning of the node contents
			% NB center of node is not guaranteed to be any kind of
			%    geometric center of the triangle.
			%
			\advance\pgf@yc\pgf@yb%
			\pgf@yc.33333\pgf@yc%
			\advance\pgf@yc.5\pgf@ya% yc is the depth.
			\pgf@ya-\pgf@yc%
			\advance\pgf@ya\pgf@yb% ya is the height%
			\edef\triangledepth{\the\pgf@yc}%
			\edef\triangleheight{\the\pgf@ya}%
			\edef\halftrianglewidth{\the\pgf@xb}%
		\fi%
		\pgfmathdivide@{\halfapexangle}{2}%
		\pgfmathsubtract@{45}{\pgfmathresult}%
		\pgfmathtan@{\pgfmathresult}%
		\pgfmathreciprocal@{\pgfmathresult}%
		\pgf@x\outersep\relax%
		\pgf@x\pgfmathresult\pgf@x%
		\edef\lowerhorizontalmiter{\the\pgf@x}%
		\pgfmathsin@{\halfapexangle}%
		\pgfmathreciprocal@{\pgfmathresult}%
		\pgf@ya\outersep\relax%
		\pgf@ya\pgfmathresult\pgf@ya%
		\edef\apexmiter{\the\pgf@ya}%
		%
		% Calculate the points.
		%
		\pgfsavepgf@process\apex{%
			\centerpoint%
			\advance\pgf@x\triangleheight\relax%
		}%
		\pgfsavepgf@process\lowerleft{%
			\centerpoint%
			\advance\pgf@x-\triangledepth\relax%
			\advance\pgf@y\halftrianglewidth\relax%
		}%
		\pgfsavepgf@process\lowerright{%
			\centerpoint%
			\advance\pgf@x-\triangledepth\relax%
			\advance\pgf@y-\halftrianglewidth\relax%
		}%
		\pgfsavepgf@process\apexpoint{%
			\apex%
			\advance\pgf@x\apexmiter\relax%
		}%
		\pgfsavepgf@process\lowerleftpoint{%
			\lowerleft%
			\advance\pgf@x-\outersep\relax%
			\advance\pgf@y\lowerhorizontalmiter\relax%
		}%
		\pgfsavepgf@process\lowerrightpoint{%
			\lowerright%
			\advance\pgf@x-\outersep\relax%
			\advance\pgf@y-\lowerhorizontalmiter\relax%
		}%
		%
		% And the *unrotated* corner angles to the \centerpoint.
		%
		\pgfmathanglebetweenpoints{\centerpoint}{\apexpoint}%
		\let\angletoapex\pgfmathresult%
		\pgfmathanglebetweenpoints{\centerpoint}{\lowerleftpoint}%
		\let\angletolowerleft\pgfmathresult%
		\pgfmathanglebetweenpoints{\centerpoint}{\lowerrightpoint}%
		\let\angletolowerright\pgfmathresult%
		%
		% ...the *inversly rotated* \basepoint...
		%
		\pgfsavepgf@process\rotatedbasepoint{%
			\pgfmathrotatepointaround{\basepoint}{\centerpoint}{-\rotate}%
		}%
		\pgfmathanglebetweenpoints{\rotatedbasepoint}{\apexpoint}%
		\let\baseangletoapex\pgfmathresult%
		\pgfmathanglebetweenpoints{\rotatedbasepoint}{\lowerleftpoint}%
		\let\baseangletolowerleft\pgfmathresult%
		\pgfmathanglebetweenpoints{\rotatedbasepoint}{\lowerrightpoint}%
		\let\baseangletolowerright\pgfmathresult%
		%
		% ...and the *inversely rotated* \midpoint.
		%
		\pgfsavepgf@process\rotatedmidpoint{%
			\pgfmathrotatepointaround{\midpoint}{\centerpoint}{-\rotate}%
		}%
		\pgfmathanglebetweenpoints{\rotatedmidpoint}{\apexpoint}%
		\let\midangletoapex\pgfmathresult%
		\pgfmathanglebetweenpoints{\rotatedmidpoint}{\lowerleftpoint}%
		\let\midangletolowerleft\pgfmathresult%
		\pgfmathanglebetweenpoints{\rotatedmidpoint}{\lowerrightpoint}%
		\let\midangletolowerright\pgfmathresult%
		%
		% Now rotate the points.
		%
		\pgfsavepgf@process\apex{%
			\pgfmathrotatepointaround{\apex}{\centerpoint}{\rotate}%
		}%
		\pgfsavepgf@process\lowerleft{%
			\pgfmathrotatepointaround{\lowerleft}{\centerpoint}{\rotate}%
		}%
		\pgfsavepgf@process\lowerright{%
			\pgfmathrotatepointaround{\lowerright}{\centerpoint}{\rotate}%
		}%
		\pgfsavepgf@process\apexpoint{%
			\pgfmathrotatepointaround{\apexpoint}{\centerpoint}{\rotate}%
		}%
		\pgfsavepgf@process\lowerleftpoint{%
			\pgfmathrotatepointaround{\lowerleftpoint}{\centerpoint}{\rotate}%
		}%
		\pgfsavepgf@process\lowerrightpoint{%
			\pgfmathrotatepointaround{\lowerrightpoint}{\centerpoint}{\rotate}%
		}%
		%
		% Calculate a radius guaranteed to be outside the triangle.
		%
		\pgf@x\halftrianglewidth\relax%
		\advance\pgf@x\lowerhorizontalmiter%
		\pgf@x2.0\pgf@x%
		\pgf@y\triangleheight\relax%
		\advance\pgf@y\triangledepth\relax%
		\advance\pgf@y\outersep\relax%
		\advance\pgf@y\apexmiter\relax%
		\ifdim\pgf@x>\pgf@y%
			\edef\externalradius{\the\pgf@x}%
		\else%
			\edef\externalradius{\the\pgf@y}%
		\fi%		
		%
		% Save everything.
		%
		\def\installtriangleparameters{%
			\noexpand\def\noexpand\rotate{\rotate}%
			\noexpand\def\noexpand\outersep{\outersep}%
			\noexpand\def\noexpand\lowerhorizontalmiter{\lowerhorizontalmiter}%
			\noexpand\def\noexpand\apexmiter{\apexmiter}%
			\noexpand\def\noexpand\apexpoint{\apexpoint}%
			\noexpand\def\noexpand\lowerleftpoint{\lowerleftpoint}%
			\noexpand\def\noexpand\lowerrightpoint{\lowerrightpoint}%
			\noexpand\def\noexpand\apex{\apex}%
			\noexpand\def\noexpand\lowerleft{\lowerleft}%
			\noexpand\def\noexpand\lowerright{\lowerright}%
			%
			\noexpand\def\noexpand\angletoapex{\angletoapex}%
			\noexpand\def\noexpand\angletolowerleft{\angletolowerleft}%
			\noexpand\def\noexpand\angletolowerright{\angletolowerright}%
			%
			\noexpand\def\noexpand\baseangletoapex{\baseangletoapex}%
			\noexpand\def\noexpand\baseangletolowerleft{\baseangletolowerleft}%
			\noexpand\def\noexpand\baseangletolowerright{\baseangletolowerright}%
			%
			\noexpand\def\noexpand\midangletoapex{\midangletoapex}%
			\noexpand\def\noexpand\midangletolowerleft{\midangletolowerleft}%
			\noexpand\def\noexpand\midangletolowerright{\angletolowerright}%
			%
			\noexpand\def\noexpand\externalradius{\externalradius}%
		}%
	}
	\savedanchor\centerpoint{%
		\pgfmathsetlength\pgf@x{+.5\wd\pgfnodeparttextbox}%
		\pgfmathsetlength\pgf@y{+.5\ht\pgfnodeparttextbox}%
		\pgfmathaddtolength\pgf@y{-.5\dp\pgfnodeparttextbox}%
	}%
	\savedanchor\basepoint{%
		\pgfmathsetlength\pgf@x{+.5\wd\pgfnodeparttextbox}%
		\pgf@y0pt\relax%
	}%
	\savedanchor\midpoint{%
		\pgfmathsetlength\pgf@x{+.5\wd\pgfnodeparttextbox}%
		\pgfmathsetlength\pgf@y{+.5ex}%
	}%
	\anchor{center}{\centerpoint}%
	\anchor{base}{\basepoint}%
	\anchor{base west}{%
		\installtriangleparameters%
		\let\pgf@triangleanchorborderreferencepoint\basepoint%
		\csname pgf@anchor@isosceles triangle@border\endcsname{\pgfqpoint{-\externalradius}{0pt}}%
	}%
	\anchor{base east}{%
		\installtriangleparameters%
		\let\pgf@triangleanchorborderreferencepoint\basepoint%
		\csname pgf@anchor@isosceles triangle@border\endcsname{\pgfqpoint{\externalradius}{0pt}}%
	}%
	\anchor{mid}{\midpoint}%
	\anchor{mid west}{%
		\installtriangleparameters%
		\let\pgf@triangleanchorborderreferencepoint\midpoint%
		\csname pgf@anchor@isosceles triangle@border\endcsname{\pgfqpointpolar{180}{\externalradius}}%
	}%
	\anchor{mid east}{%
		\installtriangleparameters%
		\let\pgf@triangleanchorborderreferencepoint\midpoint%
		\csname pgf@anchor@isosceles triangle@border\endcsname{\pgfqpointpolar{0}{\externalradius}}%
	}%
	\anchor{apex}{%
		\installtriangleparameters%
		\apexpoint}
	\anchor{left corner}{%
		\installtriangleparameters%
		\lowerleftpoint}
	\anchor{right corner}{%
		\installtriangleparameters%
		\lowerrightpoint}
	\anchor{left side}{%
		\installtriangleparameters%
		\pgfpointlineattime{0.5}{\apexpoint}{\lowerleftpoint}%
	}	
	\anchor{right side}{%
		\installtriangleparameters%
		\pgfpointlineattime{0.5}{\apexpoint}{\lowerrightpoint}%
	}	
	\anchor{lower side}{%
		\installtriangleparameters%
		\pgfpointlineattime{0.5}{\lowerleftpoint}{\lowerrightpoint}%
	}
	\anchor{north}{%
		\installtriangleparameters%
		\csname pgf@anchor@isosceles triangle@border\endcsname{\pgfqpointpolar{90}{\externalradius}}%
	}
	\anchor{south}{%
		\installtriangleparameters%
		\csname pgf@anchor@isosceles triangle@border\endcsname{\pgfqpointpolar{270}{\externalradius}}%
	}
	\anchor{east}{%
		\installtriangleparameters%
		\csname pgf@anchor@isosceles triangle@border\endcsname{\pgfqpointpolar{0}{\externalradius}}%
	}
	\anchor{west}{%
		\installtriangleparameters%
		\csname pgf@anchor@isosceles triangle@border\endcsname{\pgfqpointpolar{180}{\externalradius}}%
	}
	\anchor{north east}{%
		\installtriangleparameters%
		\csname pgf@anchor@isosceles triangle@border\endcsname{\pgfqpointpolar{45}{\externalradius}}%
	}
	\anchor{south west}{%
		\installtriangleparameters%
		\csname pgf@anchor@isosceles triangle@border\endcsname{\pgfqpointpolar{225}{\externalradius}}%
	}
	\anchor{south east}{%
		\installtriangleparameters%
		\csname pgf@anchor@isosceles triangle@border\endcsname{\pgfqpointpolar{315}{\externalradius}}%
	}
	\anchor{north west}{%
		\installtriangleparameters%
		\csname pgf@anchor@isosceles triangle@border\endcsname{\pgfqpointpolar{135}{\externalradius}}%
	}
	\backgroundpath{%
		\installtriangleparameters%
		\pgfpathmoveto{\apex}%
		\pgfpathlineto{\lowerleft}%
		\pgfpathlineto{\lowerright}%
		\pgfpathclose}
	\anchorborder{%
		%
		% Save x and y.
		%
		\edef\externalx{\the\pgf@x}%
		\edef\externaly{\the\pgf@y}%
		%
		% This allows anchors base east, base west, mid east and mid west,
		% to redefine the `center' of the node to correctly calculate the
		% border points.
		%
		\pgfutil@ifundefined{pgf@triangleanchorborderreferencepoint}%
			{\let\referencepoint\centerpoint}%
			{\let\referencepoint\pgf@triangleanchorborderreferencepoint}%
		%
		% Adjust the location of the external 
		% point relative to the reference point.
		%
		\referencepoint%
		\pgf@xa\externalx\relax%
		\pgf@ya\externaly\relax%
		\advance\pgf@xa\pgf@x%
		\advance\pgf@ya\pgf@y%
		\edef\externalx{\the\pgf@xa}%
		\edef\externaly{\the\pgf@ya}%
		%
		% Install the required points and angles.
		%
		\installtriangleparameters%
		%
		% Get the angle of the external point to the \referencepoint.
		%
		\pgfmathanglebetweenpoints{\referencepoint}{\pgfqpoint{\externalx}{\externaly}}%
		%
		% *Subtract* the rotation from the external angle. This is 
		% why the border point angles do not neeed to be rotated.
		%
		\pgfmathsubtract@{\pgfmathresult}{\rotate}%
		\ifdim\pgfmathresult pt<0pt\relax%
			\pgfmathadd@{\pgfmathresult}{360}%
		\fi%
		\let\externalangle\pgfmathresult%
		\ifx\referencepoint\basepoint%
			\let\angletoapex\baseangletoapex%
			\let\angletolowerleft\baseangletolowerleft%
			\let\angletolowerright\baseangletolowerright%
		\else%
			\ifx\referencepoint\midpoint%
				\let\angletoapex\midangletoapex%
				\let\angletolowerleft\midangletolowerleft%
				\let\angletolowerright\midangletolowerright%			
		\fi\fi%
		\ifdim\externalangle pt<\angletoapex pt\relax%
			\let\firstpoint\apexpoint%
			\let\secondpoint\lowerrightpoint%
		\else%
			\ifdim\externalangle pt<\angletolowerleft pt\relax%
				\let\firstpoint\apexpoint%
				\let\secondpoint\lowerleftpoint%
			\else%
				\ifdim\externalangle pt<\angletolowerright pt\relax%
					\let\firstpoint\lowerleftpoint%
					\let\secondpoint\lowerrightpoint%
				\else%
					\let\firstpoint\apexpoint%
					\let\secondpoint\lowerrightpoint%
				\fi%
			\fi%
		\fi%
		\pgfpointintersectionoflines{\referencepoint}{\pgfqpoint{\externalx}{\externaly}}%
				{\firstpoint}{\secondpoint}%
	}%
}




% \pgfsetkiteuppervertexangle
%
\def\pgfsetkiteuppervertexangle#1{\pgfmathsetmacro\pgfkiteuppervertexangle{#1}}%
\pgfsetkiteuppervertexangle{120}%

% \pgfsetkitelowervertexangle
%
\def\pgfsetkitelowervertexangle#1{\pgfmathsetmacro\pgfkitelowervertexangle{#1}}%
\pgfsetkitelowervertexangle{60}

% Shape kite.
%
\pgfdeclareshape{kite}{
	\savedmacro\installkiteparameters{%
		%
		% Get the larger of the outer sep.
		%
		\pgfmathsetlength\pgf@x{+\pgfshapeouterxsep}%
		\pgfmathsetlength\pgf@y{+\pgfshapeouterysep}%
		\ifdim\pgf@x<\pgf@y%
			\pgf@x\pgf@y%
		\fi%
		\edef\outersep{\the\pgf@x}%
		%
		% Calculate the centre, base and mid points of the node.
		%
		\pgfsavepgf@process\centerpoint{%
			\pgfmathsetlength\pgf@x{+.5\wd\pgfnodeparttextbox}%
			\pgfmathsetlength\pgf@y{+.5\ht\pgfnodeparttextbox}%
			\pgfmathaddtolength\pgf@y{+-.5\dp\pgfnodeparttextbox}%
		}%
		\pgfsavepgf@process\basepoint{%
			\pgfmathsetlength\pgf@x{+.5\wd\pgfnodeparttextbox}%
			\pgf@y0pt\relax%
		}%
		\pgfsavepgf@process\midpoint{%
			\pgfmathsetlength\pgf@x{+.5\wd\pgfnodeparttextbox}%
			\pgfmathsetlength\pgf@y{+.5ex}%
		}%
		%
		% Halve the vertex angles.
		%
		\pgfmathdivide@{\pgfkiteuppervertexangle}{2}%
		\let\halfuppervertexangle\pgfmathresult%
		\pgfmathdivide@{\pgfkitelowervertexangle}{2}%
		\let\halflowervertexangle\pgfmathresult%
		%
		% Get the node dimensions.
		%
		\pgfmathsetlength\pgf@x{+\pgfshapeinnerxsep}%
		\pgfmathaddtolength\pgf@x{+.5\wd\pgfnodeparttextbox}%
		\pgfmathsetlength\pgf@y{+\pgfshapeinnerysep}%
		\pgfmathaddtolength\pgf@y{+.5\ht\pgfnodeparttextbox}%
		\pgfmathaddtolength\pgf@y{+.5\dp\pgfnodeparttextbox}%
		\ifpgfshapeborderusesincircle%
			%
			% Get the rotation.
			%
			\let\rotate\pgfshapeborderrotate%
			%
			% Get the radis of the incircle.
			%
			\ifdim\pgf@x<\pgf@y%
				\pgf@x\pgf@y%
			\fi%			
			\pgf@x1.41421\pgf@x%
			%
			% Get the distances from the upper and lower verticies
			% to the center of the incircle.
			%
			\pgfmathsin@{\halfuppervertexangle}%
			\pgfmathreciprocal@{\pgfmathresult}%
			\pgf@ya\pgfmathresult\pgf@x%
			\pgfmathsin@{\halflowervertexangle}%
			\pgfmathreciprocal@{\pgfmathresult}%
			\pgf@yb\pgfmathresult\pgf@x%
			%
			% Now calculate vertical offset (yc) between the center of 
			% the incircle, and the intersection of the kite diagonals.
			%
			% yc = y * cos(90 - a/2) * (a/4 - b/4) / sin(90 - a/4 - b/4)
			%
			% where
			%
			% ya = distance from the incircle centre to the upper vertex.
			% a  = upper vertex angle.
			% b  = lower vertex angle.
			%
			\pgfmathadd@{\halfuppervertexangle}{\halflowervertexangle}%
			\pgfmathdivide@{\pgfmathresult}{2}%
			\pgfmathsubtract@{90}{\pgfmathresult}%
			\pgfmathsin@{\pgfmathresult}%
			\pgfmathreciprocal@{\pgfmathresult}%
			\pgf@yc\pgfmathresult\pgf@ya%
			\pgfmathsubtract@{90}{\halfuppervertexangle}%
			\pgfmathcos@{\pgfmathresult}%
			\pgf@yc\pgfmathresult\pgf@yc%
			\pgfmathsubtract@{\halfuppervertexangle}{\halflowervertexangle}%
			\pgfmathdivide@{\pgfmathresult}{2}%
			\pgfmathsin@{\pgfmathresult}%
			\pgf@yc\pgfmathresult\pgf@yc%
			\edef\deltay{\the\pgf@yc}%
			%
			% Now calculate the height of the kite...
			%
			\advance\pgf@ya-\pgf@yc%
			%
			% ...and the depth.
			%
			\advance\pgf@yb\pgf@yc%
			%
			% Get the half width of the widest part of the kite.
			%
			\pgfmathtan@{\halfuppervertexangle}%
			\pgf@xa\pgfmathresult\pgf@ya%			
		\else%
			\multiply\pgf@x2\relax%
			\multiply\pgf@y2\relax%
			%
			% Get the rotation (with rounding).
			%
			\pgfmathmod@{\pgfshapeborderrotate}{360}%
			\afterassignment\pgfmath@gobbletilpgfmath@%
			\expandafter\c@pgf@counta\pgfmathresult\relax\pgfmath@%
			\advance\c@pgf@counta45\relax%
			\divide\c@pgf@counta90\relax%
			\multiply\c@pgf@counta90\relax%
			\ifnum\c@pgf@counta<0\relax%
				\advance\c@pgf@counta360\relax%
			\fi%
			\edef\rotate{\the\c@pgf@counta}%
			%
			% Calculate the width and height of the node
			% contents, according to any border rotation.
			%
			\ifnum\c@pgf@counta=90\relax%
				\pgf@xc\pgf@x%
				\pgf@x\pgf@y%
				\pgf@y\pgf@xc%
			\else%
				\ifnum\c@pgf@counta=270\relax%
					\pgf@xc\pgf@x%
					\pgf@x\pgf@y%
					\pgf@y\pgf@xc%
				\fi%
			\fi%
			%
			% The node contents (total height y) extends a distance ya into the 
			% upper isosceles triangle of the kite and a distance yb into the 
			% lower isosceles triangle. Thus, the following relationships hold:
			%
			%   ya/yb = tan(b/2)/tan(a/2)
			%
			% and   y = ya + yb
			%
			% so   ya = y * sin(a/2 + b/2) / (cos(a/2) * sin(b/2))
			%
			% (a = upper vertex angle, b = lower vertex angle).
			%
			\pgfmathadd@{\halfuppervertexangle}{\halflowervertexangle}%
			\pgfmathsin@{\pgfmathresult}%
			\pgfmathreciprocal@{\pgfmathresult}%
			\pgf@ya\pgfmathresult\pgf@y%
			\pgfmathcos@{\halfuppervertexangle}%
			\pgf@ya\pgfmathresult\pgf@ya%
			\pgfmathsin@{\halflowervertexangle}%
			\pgf@ya\pgfmathresult\pgf@ya%
			\pgf@yb\pgf@y%
			\advance\pgf@yb-\pgf@ya%
			%
			% The vertical offset between the center of the node, and
			% the intersection of the kite diagonals is given by:
			% 
			% yc = y/2 - ya
			%
			\pgf@yc.5\pgf@y%
			\advance\pgf@yc-\pgf@ya%
			\edef\deltay{\the\pgf@yc}%
			%
			% Get the half width of the widest part of the kite.
			%
			\pgfmathtan@{\halfuppervertexangle}%
			\pgf@xa.5\pgf@x%
			\advance\pgf@xa\pgfmathresult\pgf@ya%
			%
			% Now calculate the height of the kite...
			%
			\pgf@xb.5\pgf@x%
			\pgfmathreciprocal@{\pgfmathresult}%
			\advance\pgf@ya\pgfmathresult\pgf@xb%
			%
			% ...and the depth.
			%
			\pgfmathtan@{\halflowervertexangle}%
			\pgfmathreciprocal@{\pgfmathresult}%
			\advance\pgf@yb\pgfmathresult\pgf@xb%
		\fi%
		%
		% Take into account minimum height and width.
		%
		% ya is the kite height.
		% yb is the kite depth.
		% xa is the kite (half) width.
		%
		\pgfmathsetlength\pgf@yc{+\pgfshapeminheight}%
		\pgf@y\pgf@ya%
		\advance\pgf@y\pgf@yb%
		\ifdim\pgf@y<\pgf@yc%
			\pgfmathreciprocal@{\pgfmath@tonumber{\pgf@y}}%
			\pgf@yc\pgfmathresult\pgf@yc%
			\pgf@xa\pgfmath@tonumber{\pgf@yc}\pgf@xa%
			\pgf@ya\pgfmath@tonumber{\pgf@yc}\pgf@ya%
			\pgf@yb\pgfmath@tonumber{\pgf@yc}\pgf@yb%
		\fi%
		\pgf@x2.0\pgf@xa%	
		\pgfmathsetlength\pgf@xc{+\pgfshapeminwidth}%
		\ifdim\pgf@x<\pgf@xc%
			\pgfmathreciprocal@{\pgfmath@tonumber{\pgf@x}}%
			\pgf@xc\pgfmathresult\pgf@xc%
			\pgf@xa\pgfmath@tonumber{\pgf@xc}\pgf@xa%
			\pgf@ya\pgfmath@tonumber{\pgf@xc}\pgf@ya%
			\pgf@yb\pgfmath@tonumber{\pgf@xc}\pgf@yb%
		\fi%
		\edef\kitehalfwidth{\the\pgf@xa}%
		\edef\kiteheight{\the\pgf@ya}%
		\edef\kitedepth{\the\pgf@yb}%
		%
		% Calculate the basic points on the kite (for the background path).
		%
		\pgfsavepgf@process\toppoint{%
			\centerpoint%
			\advance\pgf@y\deltay\relax%
			\advance\pgf@y\kiteheight%
		}%
		\pgfsavepgf@process\bottompoint{%
			\centerpoint%
			\advance\pgf@y\deltay\relax%
			\advance\pgf@y-\kitedepth%
		}%
		\pgfsavepgf@process\leftpoint{%
			\centerpoint%
			\advance\pgf@y\deltay\relax%
			\advance\pgf@x-\kitehalfwidth%
		}%
		\pgfsavepgf@process\rightpoint{%
			\centerpoint%
			\advance\pgf@y\deltay\relax%
				\advance\pgf@x\kitehalfwidth%
		}%
		%
		% Now calculate the miter length. At the top...
		%
		\pgfmathsin@{\halfuppervertexangle}%
		\pgfmathreciprocal@{\pgfmathresult}%
		\pgf@y\outersep\relax%
		\pgf@y\pgfmathresult\pgf@y%
		\edef\topmiter{\the\pgf@y}%
		%
		% ...at the bottom...
		%
		\pgfmathsin@{\halflowervertexangle}%
		\pgfmathreciprocal@{\pgfmathresult}%
		\pgf@y\outersep\relax%
		\pgf@y\pgfmathresult\pgf@y%
		\edef\bottommiter{\the\pgf@y}%
		%
		% ...to the right...
		%
		\pgfmathsubtract@{180}{\halflowervertexangle}%
		\pgfmathsubtract@{\pgfmathresult}{\halfuppervertexangle}%
		\pgfmathdivide@{\pgfmathresult}{2}%
		\pgfmathsin@{\pgfmathresult}%
		\pgfmathreciprocal@{\pgfmathresult}%
		\pgf@xa\outersep\relax%
		\pgf@xa\pgfmathresult\pgf@xa%
		\pgfmathsubtract@{\halfuppervertexangle}{\halflowervertexangle}%
		\pgfmathdivide@{\pgfmathresult}{2}%
		\let\angle\pgfmathresult%
		\pgfsavepgf@process\rightmiter{%
			\pgfqpointpolar{\angle}{\the\pgf@xa}%
		}%
		%
		% ...and to the left.
		%
		\pgfmathsubtract@{180}{\angle}%
		\let\angle\pgfmathresult%
		\pgfsavepgf@process\leftmiter{%
			\pgfqpointpolar{\angle}{\the\pgf@xa}%
		}%
		%
		% Create the border points.
		%
		\pgfsavepgf@process\topborderpoint{%
			\toppoint%
			\advance\pgf@y\topmiter\relax%
		}%
		\pgfsavepgf@process\bottomborderpoint{%
			\bottompoint%
			\advance\pgf@y-\bottommiter\relax%
		}%
		\pgfsavepgf@process\leftborderpoint{%
			\leftpoint%
			\pgf@xa\pgf@x%
			\pgf@ya\pgf@y%
			\leftmiter%
			\advance\pgf@x\pgf@xa%
			\advance\pgf@y\pgf@ya%
		}%
		\pgfsavepgf@process\rightborderpoint{%
			\rightpoint%
			\pgf@xa\pgf@x%
			\pgf@ya\pgf@y%
			\rightmiter%
			\advance\pgf@x\pgf@xa%
			\advance\pgf@y\pgf@ya%
		}%
		%
		% Get the angle from the \centerpoint to the *unrotated points*.
		%
		\pgfmathanglebetweenpoints{\centerpoint}{\topborderpoint}%
		\let\angletotoppoint\pgfmathresult%
		\pgfmathanglebetweenpoints{\centerpoint}{\leftborderpoint}%
		\let\angletoleftpoint\pgfmathresult%
		\pgfmathanglebetweenpoints{\centerpoint}{\bottomborderpoint}%
		\let\angletobottompoint\pgfmathresult%
		\pgfmathanglebetweenpoints{\centerpoint}{\rightborderpoint}%
		\let\angletorightpoint\pgfmathresult%
		%
		% ...from the *inversly rotated* \basepoint...
		%
		\pgfsavepgf@process\rotatedbasepoint{%
			\pgfmathrotatepointaround{\basepoint}{\centerpoint}{-\rotate}%
		}%
		\pgfmathanglebetweenpoints{\rotatedbasepoint}{\topborderpoint}%
		\let\baseangletotoppoint\pgfmathresult%
		\pgfmathanglebetweenpoints{\rotatedbasepoint}{\leftborderpoint}%
		\let\baseangletoleftpoint\pgfmathresult%
		\pgfmathanglebetweenpoints{\rotatedbasepoint}{\bottomborderpoint}%
		\let\baseangletobottompoint\pgfmathresult%
		\pgfmathanglebetweenpoints{\rotatedbasepoint}{\rightborderpoint}%
		\let\baseangletorightpoint\pgfmathresult%
		%
		% ...and from the *inversely rotated* \midpoint.
		%
		\pgfsavepgf@process\rotatedmidpoint{%
			\pgfmathrotatepointaround{\midpoint}{\centerpoint}{-\rotate}%
		}%
		\pgfmathanglebetweenpoints{\rotatedmidpoint}{\topborderpoint}%
		\let\midangletotoppoint\pgfmathresult%
		\pgfmathanglebetweenpoints{\rotatedmidpoint}{\leftborderpoint}%
		\let\midangletoleftpoint\pgfmathresult%
		\pgfmathanglebetweenpoints{\rotatedmidpoint}{\bottomborderpoint}%
		\let\midangletobottompoint\pgfmathresult%
		\pgfmathanglebetweenpoints{\rotatedmidpoint}{\rightborderpoint}%
		\let\midangletorightpoint\pgfmathresult%
		%
		% Calculate a radius guaranteed to be outside the kite.
		%
		\pgfextractx\pgf@xa{\pgfpointdiff{\leftborderpoint}{\rightborderpoint}}%
		\ifdim\pgf@xa<0pt\relax%
			\pgf@xa-\pgf@xa%
		\fi%
		\pgfextracty\pgf@ya{\pgfpointdiff{\topborderpoint}{\bottomborderpoint}}%
		\ifdim\pgf@ya<0pt\relax%
			\pgf@ya-\pgf@ya%
		\fi%
		\ifdim\pgf@ya>\pgf@xa%
			\edef\externalradius{\the\pgf@ya}%
		\else%
			\edef\externalradius{\the\pgf@xa}%
		\fi%
		%
		% Now rotate the points...
		%
		\pgfsavepgf@process\toppoint{%
			\pgfmathrotatepointaround{\toppoint}{\centerpoint}{\rotate}%
		}%
		\pgfsavepgf@process\bottompoint{%
			\pgfmathrotatepointaround{\bottompoint}{\centerpoint}{\rotate}%
		}%
		\pgfsavepgf@process\leftpoint{%
			\pgfmathrotatepointaround{\leftpoint}{\centerpoint}{\rotate}%
		}%
		\pgfsavepgf@process\rightpoint{%
			\pgfmathrotatepointaround{\rightpoint}{\centerpoint}{\rotate}%
		}%
		%
		% ...and the border points.
		%
		\pgfsavepgf@process\topborderpoint{%
			\pgfmathrotatepointaround{\topborderpoint}{\centerpoint}{\rotate}%
		}%
		\pgfsavepgf@process\bottomborderpoint{%
			\pgfmathrotatepointaround{\bottomborderpoint}{\centerpoint}{\rotate}%
		}%
		\pgfsavepgf@process\leftborderpoint{%
			\pgfmathrotatepointaround{\leftborderpoint}{\centerpoint}{\rotate}%
		}%
		\pgfsavepgf@process\rightborderpoint{%
			\pgfmathrotatepointaround{\rightborderpoint}{\centerpoint}{\rotate}%
		}%
		%
		% Now save it all.
		%
		\def\installkiteparameters{%
			\noexpand\def\noexpand\rotate{\rotate}%
			\noexpand\def\noexpand\externalradius{\externalradius}%
			%
			\noexpand\def\noexpand\toppoint{\toppoint}%
			\noexpand\def\noexpand\bottompoint{\bottompoint}%
			\noexpand\def\noexpand\leftpoint{\leftpoint}%
			\noexpand\def\noexpand\rightpoint{\rightpoint}%
			%
			\noexpand\def\noexpand\topborderpoint{\topborderpoint}%
			\noexpand\def\noexpand\bottomborderpoint{\bottomborderpoint}%
			\noexpand\def\noexpand\leftborderpoint{\leftborderpoint}%
			\noexpand\def\noexpand\rightborderpoint{\rightborderpoint}%
			%
			\noexpand\def\noexpand\angletotoppoint{\angletotoppoint}%
			\noexpand\def\noexpand\angletobottompoint{\angletobottompoint}%
			\noexpand\def\noexpand\angletoleftpoint{\angletoleftpoint}%
			\noexpand\def\noexpand\angletorightpoint{\angletorightpoint}%
			%
			\noexpand\def\noexpand\baseangletotoppoint{\baseangletotoppoint}%
			\noexpand\def\noexpand\baseangletobottompoint{\baseangletobottompoint}%
			\noexpand\def\noexpand\baseangletoleftpoint{\baseangletoleftpoint}%
			\noexpand\def\noexpand\baseangletorightpoint{\baseangletorightpoint}%
			%
			\noexpand\def\noexpand\midangletotoppoint{\midangletotoppoint}%
			\noexpand\def\noexpand\midangletobottompoint{\midangletobottompoint}%
			\noexpand\def\noexpand\midangletoleftpoint{\midangletoleftpoint}%
			\noexpand\def\noexpand\midangletorightpoint{\midangletorightpoint}%			
		}%
	}
	\savedanchor\centerpoint{%
		\pgfmathsetlength\pgf@x{+.5\wd\pgfnodeparttextbox}%
		\pgfmathsetlength\pgf@y{+.5\ht\pgfnodeparttextbox}%
		\pgfmathaddtolength\pgf@y{+-.5\dp\pgfnodeparttextbox}%
	}%
	\savedanchor\basepoint{%
		\pgfmathsetlength\pgf@x{+.5\wd\pgfnodeparttextbox}%
		\pgf@y0pt\relax%
	}%
	\savedanchor\midpoint{%
		\pgfmathsetlength\pgf@x{+.5\wd\pgfnodeparttextbox}%
		\pgfmathsetlength\pgf@y{+.5ex}%
	}%
	\anchor{center}{\centerpoint}%
	\anchor{base}{\basepoint}%
	\anchor{base west}{%
		\installkiteparameters%
		\let\pgf@kiteanchorborderreferencepoint\basepoint%
		\csname pgf@anchor@kite@border\endcsname{\pgfqpoint{-\externalradius}{0pt}}%
	}%
	\anchor{base east}{%
		\installkiteparameters%
		\let\pgf@kiteanchorborderreferencepoint\basepoint%
		\csname pgf@anchor@kite@border\endcsname{\pgfqpoint{\externalradius}{0pt}}%
	}%
	\anchor{mid}{\midpoint}%
	\anchor{mid west}{%
		\installkiteparameters%
		\let\pgf@kiteanchorborderreferencepoint\midpoint%
		\csname pgf@anchor@kite@border\endcsname{\pgfqpoint{-\externalradius}{0pt}}%
	}%
	\anchor{mid east}{%
		\installkiteparameters%
		\let\pgf@kiteanchorborderreferencepoint\midpoint%
		\csname pgf@anchor@kite@border\endcsname{\pgfqpoint{\externalradius}{0pt}}%
	}%
	\anchor{north}{%
		\installkiteparameters%
		\csname pgf@anchor@kite@border\endcsname{\pgfqpoint{0pt}{\externalradius}}%
	}
	\anchor{south}{%
		\installkiteparameters%
		\csname pgf@anchor@kite@border\endcsname{\pgfqpoint{0pt}{-\externalradius}}%
	}
	\anchor{east}{%
		\installkiteparameters%
		\csname pgf@anchor@kite@border\endcsname{\pgfqpoint{\externalradius}{0pt}}%
	}
	\anchor{west}{%
		\installkiteparameters%
		\csname pgf@anchor@kite@border\endcsname{\pgfqpoint{-\externalradius}{0pt}}%
	}
	\anchor{north east}{%
		\installkiteparameters%
		\csname pgf@anchor@kite@border\endcsname{\pgfqpoint{\externalradius}{\externalradius}}%
	}
	\anchor{south west}{%
		\installkiteparameters%
		\csname pgf@anchor@kite@border\endcsname{\pgfqpoint{-\externalradius}{-\externalradius}}%
	}
	\anchor{south east}{%
		\installkiteparameters%
		\csname pgf@anchor@kite@border\endcsname{\pgfqpoint{\externalradius}{-\externalradius}}%
	}
	\anchor{north west}{%
		\installkiteparameters%
		\csname pgf@anchor@kite@border\endcsname{\pgfqpoint{-\externalradius}{\externalradius}}%
	}
	\anchor{upper vertex}{%
		\installkiteparameters%
		\topborderpoint}
	\anchor{lower vertex}{%
		\installkiteparameters%
		\bottomborderpoint}
	\anchor{left vertex}{%
		\installkiteparameters%
		\leftborderpoint}
	\anchor{right vertex}{%
		\installkiteparameters%
		\rightborderpoint}
	\anchor{upper left side}{%
		\installkiteparameters%
		\pgfpointlineattime{0.5}{\topborderpoint}{\leftborderpoint}}
	\anchor{lower left side}{%
		\installkiteparameters%
		\pgfpointlineattime{0.5}{\bottomborderpoint}{\leftborderpoint}}
	\anchor{upper right side}{%
		\installkiteparameters%
		\pgfpointlineattime{0.5}{\topborderpoint}{\rightborderpoint}}
	\anchor{lower right side}{%
		\installkiteparameters%
		\pgfpointlineattime{0.5}{\bottomborderpoint}{\rightborderpoint}}
	\backgroundpath{%
		\installkiteparameters%
		\pgfpathmoveto{\toppoint}%
		\pgfpathlineto{\leftpoint}%
		\pgfpathlineto{\bottompoint}%
		\pgfpathlineto{\rightpoint}%
		\pgfpathclose%
	}
	\anchorborder{%
		%
		% Save x and y.
		%
		\edef\externalx{\the\pgf@x}%
		\edef\externaly{\the\pgf@y}%
		%
		% This allows anchors base east, base west, mid east and mid west,
		% to redefine the `center' of the node to correctly calculate the
		% border points.
		%
		\pgfutil@ifundefined{pgf@kiteanchorborderreferencepoint}%
			{\let\referencepoint\centerpoint}%
			{\let\referencepoint\pgf@kiteanchorborderreferencepoint}%
		%
		% Adjust the location of the external 
		% point relative to the reference point.
		%
		\referencepoint%
		\pgf@xa\externalx\relax%
		\pgf@ya\externaly\relax%
		\advance\pgf@xa\pgf@x%
		\advance\pgf@ya\pgf@y%
		\edef\externalx{\the\pgf@xa}%
		\edef\externaly{\the\pgf@ya}%
		%
		% Install the required points and angles.
		%
		\installkiteparameters%
		%
		% Get the angle of the external point relative to \referencepoint.
		%
		\pgfmathanglebetweenpoints{\referencepoint}{\pgfqpoint{\externalx}{\externaly}}%
		%
		% *Subtract* the rotation from the external angle.
		%
		\pgfmathsubtract@{\pgfmathresult}{\rotate}%
		\ifdim\pgfmathresult pt<0pt\relax%
			\pgfmathadd@{\pgfmathresult}{360}%
		\fi%
		\let\externalangle\pgfmathresult%
		\ifx\referencepoint\basepoint%
			\let\angletotoppoint\baseangletotoppoint%
			\let\angletobottompoint\baseangletobottompoint%
			\let\angletoleftpoint\baseangletoleftpoint%
			\let\angletorightpoint\baseangletorightpoint%
		\else%
			\ifx\referencepoint\midpoint%
				\let\angletotoppoint\midangletotoppoint%
				\let\angletobottompoint\midangletobottompoint%
				\let\angletoleftpoint\midangletoleftpoint%
				\let\angletorightpoint\midangletorightpoint%
		\fi\fi%
		%
		%  Depending on the rotation, the angle to \rightborderpoint
		%  may be smaller than the angle to \topborderpoint.
		%
		\ifdim\angletorightpoint pt<\angletotoppoint pt\relax%
			\ifdim\externalangle pt<\angletorightpoint pt\relax%
				\let\firstpoint\rightborderpoint%
				\let\secondpoint\bottomborderpoint%
			\else%
				\ifdim\externalangle pt<\angletotoppoint pt\relax%
					\let\firstpoint\rightborderpoint%
					\let\secondpoint\topborderpoint%
				\else%
					\ifdim\externalangle pt<\angletoleftpoint pt\relax%
						\let\firstpoint\topborderpoint%
						\let\secondpoint\leftborderpoint%
					\else%
						\ifdim\externalangle pt<\angletobottompoint pt\relax%
							\let\firstpoint\leftborderpoint%
							\let\secondpoint\bottomborderpoint%
						\else%
							\let\firstpoint\rightborderpoint%
							\let\secondpoint\bottomborderpoint%
						\fi%
					\fi%
				\fi%
			\fi%
		\else%
			\ifdim\externalangle pt<\angletotoppoint pt\relax%
				\let\firstpoint\rightborderpoint%
				\let\secondpoint\topborderpoint%
			\else%
				\ifdim\externalangle pt<\angletoleftpoint pt\relax%
					\let\firstpoint\leftborderpoint%
					\let\secondpoint\topborderpoint%
				\else%
					\ifdim\externalangle pt<\angletobottompoint pt\relax%
						\let\firstpoint\bottomborderpoint%
						\let\secondpoint\leftborderpoint%
					\else%
						\ifdim\externalangle pt<\angletorightpoint pt\relax%
							\let\firstpoint\rightborderpoint%
							\let\secondpoint\bottomborderpoint%
						\else%
							\let\firstpoint\rightborderpoint%
							\let\secondpoint\topborderpoint%
						\fi%
					\fi%
				\fi%
			\fi%
		\fi%
		\pgfpointintersectionoflines{\referencepoint}{\pgfqpoint{\externalx}{\externaly}}%
				{\firstpoint}{\secondpoint}%
	}
}





% \pgfsetdarttipangle
%
\def\pgfsetdarttipangle#1{\pgfmathsetmacro\pgfdarttipangle{#1}}%
\pgfsetdarttipangle{45}

% \pgfsetdarttailangle
%
\def\pgfsetdarttailangle#1{\pgfmathsetmacro\pgfdarttailangle{#1}}%
\pgfsetdarttailangle{135}

% Shape dart.
%
\pgfdeclareshape{dart}{%
	\savedmacro\installdartparameters{%
		%
		% Get the halved angles (more useful).
		%
		\pgfmathdivide@{\pgfdarttipangle}{2}%
		\let\halftipangle\pgfmathresult%
		\pgfmathdivide@{\pgfdarttailangle}{2}%
		\let\halftailangle\pgfmathresult%
		%
		% Calculate some common results.
		%
		\pgfmathcot@{\halftipangle}%
		\let\cothalftipangle\pgfmathresult%
		%
		% Get the larger of the outer sep.
		%
		\pgfmathsetlength\pgf@x{+\pgfshapeouterxsep}%
		\pgfmathsetlength\pgf@y{+\pgfshapeouterysep}%
		\ifdim\pgf@x<\pgf@y%
			\pgf@x\pgf@y%
		\fi%
		\edef\outersep{\the\pgf@x}%
		%
		% Calculate the centre, base and mid points of the node.
		%
		\pgfsavepgf@process\centerpoint{%
			\pgfmathsetlength\pgf@x{+.5\wd\pgfnodeparttextbox}%
			\pgfmathsetlength\pgf@y{+.5\ht\pgfnodeparttextbox}%
			\pgfmathaddtolength\pgf@y{+-.5\dp\pgfnodeparttextbox}%
		}%
		\pgfsavepgf@process\basepoint{%
			\pgfmathsetlength\pgf@x{+.5\wd\pgfnodeparttextbox}%
			\pgf@y0pt\relax%
		}%
		\pgfsavepgf@process\midpoint{%
			\pgfmathsetlength\pgf@x{+.5\wd\pgfnodeparttextbox}%
			\pgfmathsetlength\pgf@y{+.5ex}%
		}%
		%
		% Get the (halved) dimension of the node.
		%
		\pgfmathsetlength\pgf@x{+\pgfshapeinnerxsep}%
		\pgfmathaddtolength\pgf@x{+.5\wd\pgfnodeparttextbox}%
		\pgfmathsetlength\pgf@y{+\pgfshapeinnerysep}%
		\pgfmathaddtolength\pgf@y{+.5\ht\pgfnodeparttextbox}%
		\pgfmathaddtolength\pgf@y{+.5\dp\pgfnodeparttextbox}%
		%
		% Get the length of the dart tip.
		%
		\ifpgfshapeborderusesincircle%
			%
			% Get the (unrounded) rotation.
			%
			\let\rotate\pgfshapeborderrotate%
			%
			% Get the radius of the incircle.
			%
			\ifdim\pgf@x<\pgf@y%
				\pgf@x\pgf@y%
			\fi%			
			\pgf@x1.41421\pgf@x%
			%
			% Calculate the length of the dart tip.
			%
			\pgf@xa\cothalftipangle\pgf@x%
			\advance\pgf@xa\pgf@x%
		\else%
			%
			% Get the rotation (with rounding).
			%
			\pgfmathmod@{\pgfshapeborderrotate}{360}%
			\afterassignment\pgfmath@gobbletilpgfmath@%
			\expandafter\c@pgf@counta\pgfmathresult\relax\pgfmath@%
			\advance\c@pgf@counta45\relax%
			\divide\c@pgf@counta90\relax%
			\multiply\c@pgf@counta90\relax%
			\ifnum\c@pgf@counta<0\relax%
				\advance\c@pgf@counta360\relax%
			\fi%
			\edef\rotate{\the\c@pgf@counta}%
			%
			% Flip the width and height of the node contents, 
			% according to the appropriate border rotation.
			%
			\ifnum\c@pgf@counta=90\relax%
				\pgf@xc\pgf@x%
				\pgf@x\pgf@y%
				\pgf@y\pgf@xc%
			\else%
				\ifnum\c@pgf@counta=270\relax%
					\pgf@xc\pgf@x%
					\pgf@x\pgf@y%
					\pgf@y\pgf@xc%
				\fi%
			\fi%
			%
			% Calculate the length of the dart tip.
			%
			\pgf@xa\cothalftipangle\pgf@y%
			\advance\pgf@xa2.0\pgf@x% 
		\fi%
		%
		% Get the (half) separation of the dart tails.
		%
		\pgfmathsubtract@{\halftailangle}{\halftipangle}%
		\pgfmathcosec@{\pgfmathresult}%
		\pgf@ya\pgfmathresult\pgf@xa%
		\pgfmathsin@{\halftipangle}%
		\pgf@ya\pgfmathresult\pgf@ya%
		\pgfmathcos@{\halftipangle}%
		\pgf@ya\pgfmathresult\pgf@ya%
		%
		% Get the total length of the dart...
		%
		\pgf@xb\cothalftipangle\pgf@ya%
		%
		% and hence the length of the tails. 
		%
		\pgf@xc-\pgf@xa%
		\advance\pgf@xc\pgf@xb%
		%
		% Adjust for minimum height (length of the dart).
		%
		\pgfmathsetlength\pgf@y{+\pgfshapeminheight}%
		\ifdim\pgf@xb<\pgf@y%
			\pgfmathreciprocal@{\pgfmath@tonumber{\pgf@xb}}%
			\pgf@y\pgfmathresult\pgf@y%
			\pgf@xa\pgfmath@tonumber{\pgf@y}\pgf@xa%
			\pgf@xc\pgfmath@tonumber{\pgf@y}\pgf@xc%
			\pgf@ya\pgfmath@tonumber{\pgf@y}\pgf@ya%
			\pgf@x\pgfmath@tonumber{\pgf@y}\pgf@x%
		\fi%
		%
		% Adjust for minimum width (tail separation length).
		%
		\pgfmathsetlength\pgf@y{+\pgfshapeminwidth}%
		\pgf@y.5\pgf@y%
		\ifdim\pgf@ya<\pgf@y%
			\pgfmathreciprocal@{\pgfmath@tonumber{\pgf@ya}}%
			\pgf@ya\pgf@y%
			\pgf@y\pgfmathresult\pgf@y%
			\pgf@xa\pgfmath@tonumber{\pgf@y}\pgf@xa%
			\pgf@xc\pgfmath@tonumber{\pgf@y}\pgf@xc%
			\pgf@x\pgfmath@tonumber{\pgf@y}\pgf@x%
		\fi%
		\edef\dartlength{\the\pgf@xa}%
		\edef\deltax{\the\pgf@x}%
		\edef\taillength{\the\pgf@xc}%
		\edef\halftailseparation{\the\pgf@ya}
		%
		% Create the basic points on the dart (for the backgroundo path).
		%
		\pgfsavepgf@process\tippoint{%
			\centerpoint%
			\advance\pgf@x\dartlength\relax%
			\advance\pgf@x-\deltax\relax%
		}%
		\pgfsavepgf@process\tailcenterpoint{%
			\centerpoint%
			\advance\pgf@x-\deltax\relax%
		}%
		\pgfsavepgf@process\lefttailpoint{%
			\centerpoint%
			\advance\pgf@x-\deltax\relax%
			\advance\pgf@x-\taillength\relax%
			\advance\pgf@y\halftailseparation\relax%
		}%
		\pgfsavepgf@process\righttailpoint{%
			\centerpoint%
			\advance\pgf@x-\deltax\relax%
			\advance\pgf@x-\taillength\relax%
			\advance\pgf@y-\halftailseparation\relax%
		}%
		%
		% Calculate the miter vectors. At the dart tip...
		%
		\pgfsavepgf@process\tipmiter{%
			\pgfmathcosec@{\halftipangle}%
			\pgf@x\outersep\relax%
			\pgf@x\pgfmathresult\pgf@x%
			\pgf@y0pt\relax%
		}%
		%
		% ...at the tail center...
		%
		\pgfsavepgf@process\tailcentermiter{%
			\pgfmathcosec@{\halftailangle}%
			\pgf@x-\outersep\relax%
			\pgf@x\pgfmathresult\pgf@x%
			\pgf@y0pt\relax%
		}%
		%
		% ...at the left tail...
		%
		\pgfmathsubtract@{\halftailangle}{\halftipangle}%
		\pgfmathdivide@{\pgfmathresult}{2}%
		\let\angle\pgfmathresult%
		\pgfmathcosec@{\pgfmathresult}%
		\pgf@x\outersep\relax%
		\pgf@x\pgfmathresult\pgf@x%
		\pgfmathadd@{\angle}{90}%
		\pgfmathsubtract{\pgfmathresult}{\halftailangle}%
		\pgfmathsincos@{\pgfmathresult}%
		\pgf@ya\pgfmathresultx\pgf@x%
		\pgf@xa\pgfmathresulty\pgf@x%
		\pgfsavepgf@process\lefttailmiter{%
			\pgf@x-\pgf@xa%
			\pgf@y\pgf@ya%
		}%
		%
		% ...and the right tail.
		%
		\pgfsavepgf@process\righttailmiter{%
			\pgf@x-\pgf@xa%
			\pgf@y-\pgf@ya%
		}%
		%
		% Create the border points.
		%
		\pgfsavepgf@process\tipborderpoint{%
			\pgfpointadd{\tippoint}{\tipmiter}
		}%
		\pgfsavepgf@process\tailcenterborderpoint{%
			\pgfpointadd{\tailcenterpoint}{\tailcentermiter}%
		}%
		\pgfsavepgf@process\lefttailborderpoint{%
			\pgfpointadd{\lefttailpoint}{\lefttailmiter}%
		}%
		\pgfsavepgf@process\righttailborderpoint{%
			\pgfpointadd{\righttailpoint}{\righttailmiter}%
		}%
		%
		% Calculate the angles between the centerpoint
		% and the *unrotated* borderpoints.
		%
		\pgfmathanglebetweenpoints{\centerpoint}{\tipborderpoint}%
		\let\angletotip\pgfmathresult%
		\pgfmathanglebetweenpoints{\centerpoint}{\tailcenterborderpoint}%
		\let\angletotailcenter\pgfmathresult%
		\pgfmathanglebetweenpoints{\centerpoint}{\lefttailborderpoint}%
		\let\angletolefttail\pgfmathresult%
		\pgfmathanglebetweenpoints{\centerpoint}{\righttailborderpoint}%
		\let\angletorighttail\pgfmathresult%
		%
		% Calculate the angles between the *inversly rotated* 
		% basepoint and the *unrotated* borderpoints.
		%
		\pgfsavepgf@process\rotatedbasepoint{%
			\pgfmathrotatepointaround{\basepoint}{\centerpoint}{-\rotate}%
		}%
		\pgfmathanglebetweenpoints{\rotatedbasepoint}{\tipborderpoint}%
		\let\baseangletotip\pgfmathresult%
		\pgfmathanglebetweenpoints{\rotatedbasepoint}{\tailcenterborderpoint}%
		\let\baseangletotailcenter\pgfmathresult%
		\pgfmathanglebetweenpoints{\rotatedbasepoint}{\lefttailborderpoint}%
		\let\baseangletolefttail\pgfmathresult%
		\pgfmathanglebetweenpoints{\rotatedbasepoint}{\righttailborderpoint}%
		\let\baseangletorighttail\pgfmathresult%
		%
		% Calculate the angles between the *inversly rotated* 
		% midpoint and the *unrotated* borderpoints.
		%
		\pgfsavepgf@process\rotatedmidpoint{%
			\pgfmathrotatepointaround{\midpoint}{\centerpoint}{-\rotate}%
		}%
		\pgfmathanglebetweenpoints{\rotatedmidpoint}{\tipborderpoint}%
		\let\midangletotip\pgfmathresult%
		\pgfmathanglebetweenpoints{\rotatedmidpoint}{\tailcenterborderpoint}%
		\let\midangletotailcenter\pgfmathresult%
		\pgfmathanglebetweenpoints{\rotatedmidpoint}{\lefttailborderpoint}%
		\let\midangletolefttail\pgfmathresult%
		\pgfmathanglebetweenpoints{\rotatedmidpoint}{\righttailborderpoint}%
		\let\midangletorighttail\pgfmathresult%
		%
		% Rotate the background path points.
		%
		\pgfsavepgf@process\tippoint{%
			\pgfmathrotatepointaround{\tippoint}{\centerpoint}{\rotate}%
		}%
		\pgfsavepgf@process\tailcenterpoint{%
			\pgfmathrotatepointaround{\tailcenterpoint}{\centerpoint}{\rotate}%
		}%
		\pgfsavepgf@process\lefttailpoint{%
			\pgfmathrotatepointaround{\lefttailpoint}{\centerpoint}{\rotate}%
		}%
		\pgfsavepgf@process\righttailpoint{%
			\pgfmathrotatepointaround{\righttailpoint}{\centerpoint}{\rotate}%
		}%
		%
		% Calculate a radius guaranteed to be outside the dart.
		%
		\pgfextractx\pgf@xa{\pgfpointdiff{\lefttailborderpoint}{\tipborderpoint}}%
		\pgfextracty\pgf@ya{\pgfpointdiff{\lefttailborderpoint}{\righttailborderpoint}}%
		\ifdim\pgf@xa<0pt\relax%
			\pgf@xa-\pgf@xa%
		\fi%
		\ifdim\pgf@ya<0pt\relax%
			\pgf@ya-\pgf@ya%
		\fi%
		\ifdim\pgf@xa>\pgf@ya%
			\edef\externalradius{\the\pgf@xa}%
		\else%
			\edef\externalradius{\the\pgf@ya}%
		\fi%
		%
		% Rotate the border anchor points.
		%
		\pgfsavepgf@process\tipborderpoint{%
			\pgfmathrotatepointaround{\tipborderpoint}{\centerpoint}{\rotate}%
		}%
		\pgfsavepgf@process\tailcenterborderpoint{%
			\pgfmathrotatepointaround{\tailcenterborderpoint}{\centerpoint}{\rotate}%
		}%
		\pgfsavepgf@process\lefttailborderpoint{%
			\pgfmathrotatepointaround{\lefttailborderpoint}{\centerpoint}{\rotate}%
		}%
		\pgfsavepgf@process\righttailborderpoint{%
			\pgfmathrotatepointaround{\righttailborderpoint}{\centerpoint}{\rotate}%
		}%
		%
		% Save everything.
		%
		\def\installdartparameters{%
			\noexpand\def\noexpand\rotate{\rotate}%
			\noexpand\def\noexpand\externalradius{\externalradius}%
			%
			\noexpand\def\noexpand\tippoint{\tippoint}%
			\noexpand\def\noexpand\tailcenterpoint{\tailcenterpoint}%
			\noexpand\def\noexpand\lefttailpoint{\lefttailpoint}%
			\noexpand\def\noexpand\righttailpoint{\righttailpoint}%
			%
			\noexpand\def\noexpand\tipborderpoint{\tipborderpoint}%
			\noexpand\def\noexpand\tailcenterborderpoint{\tailcenterborderpoint}%
			\noexpand\def\noexpand\lefttailborderpoint{\lefttailborderpoint}%
			\noexpand\def\noexpand\righttailborderpoint{\righttailborderpoint}%
			%
			\noexpand\def\noexpand\angletotip{\angletotip}%
			\noexpand\def\noexpand\angletotailcenter{\angletotailcenter}%
			\noexpand\def\noexpand\angletolefttail{\angletolefttail}%
			\noexpand\def\noexpand\angletorighttail{\angletorighttail}%
			%
			\noexpand\def\noexpand\baseangletotip{\baseangletotip}%
			\noexpand\def\noexpand\baseangletotailcenter{\baseangletotailcenter}%
			\noexpand\def\noexpand\baseangletolefttail{\baseangletolefttail}%
			\noexpand\def\noexpand\baseangletorighttail{\baseangletorighttail}%
			%
			\noexpand\def\noexpand\midangletotip{\midangletotip}%
			\noexpand\def\noexpand\midangletotailcenter{\midangletotailcenter}%
			\noexpand\def\noexpand\midangletolefttail{\midangletolefttail}%
			\noexpand\def\noexpand\midangletorighttail{\midangletorighttail}%
		}%
	}
	\savedanchor\centerpoint{%
		\pgfmathsetlength\pgf@x{+.5\wd\pgfnodeparttextbox}%
		\pgfmathsetlength\pgf@y{+.5\ht\pgfnodeparttextbox}%
		\pgfmathaddtolength\pgf@y{+-.5\dp\pgfnodeparttextbox}%
	}%
	\savedanchor\basepoint{%
		\pgfmathsetlength\pgf@x{+.5\wd\pgfnodeparttextbox}%
		\pgf@y0pt\relax%
	}%
	\savedanchor\midpoint{%
		\pgfmathsetlength\pgf@x{+.5\wd\pgfnodeparttextbox}%
		\pgfmathsetlength\pgf@y{+.5ex}%
	}%
	\anchor{center}{\centerpoint}%
	\anchor{base}{\basepoint}%
	\anchor{base west}{%
		\installdartparameters%
		\let\pgf@dartanchorborderreferencepoint\basepoint%
		\csname pgf@anchor@dart@border\endcsname{\pgfqpoint{-\externalradius}{0pt}}%
	}
	\anchor{base east}{%
		\installdartparameters%
		\let\pgf@dartanchorborderreferencepoint\basepoint%
		\csname pgf@anchor@dart@border\endcsname{\pgfqpoint{\externalradius}{0pt}}%
	}
	\anchor{mid}{\midpoint}%
	\anchor{mid west}{%
		\installdartparameters%
		\let\pgf@dartanchorborderreferencepoint\midpoint%
		\csname pgf@anchor@dart@border\endcsname{\pgfqpoint{-\externalradius}{0pt}}%
	}
	\anchor{mid east}{%
		\installdartparameters%
		\let\pgf@dartanchorborderreferencepoint\midpoint%
		\csname pgf@anchor@dart@border\endcsname{\pgfqpoint{\externalradius}{0pt}}%
	}
	\anchor{north}{%
		\installdartparameters%
		\csname pgf@anchor@dart@border\endcsname{\pgfqpoint{0pt}{\externalradius}}%
	}
	\anchor{south}{%
		\installdartparameters%
		\csname pgf@anchor@dart@border\endcsname{\pgfqpoint{0pt}{-\externalradius}}%
	}
	\anchor{east}{%
		\installdartparameters%
		\csname pgf@anchor@dart@border\endcsname{\pgfqpoint{\externalradius}{0pt}}%
	}
	\anchor{west}{%
		\installdartparameters%
		\csname pgf@anchor@dart@border\endcsname{\pgfqpoint{-\externalradius}{0pt}}%
	}
	\anchor{north east}{%
		\installdartparameters%
		\csname pgf@anchor@dart@border\endcsname{\pgfqpoint{\externalradius}{\externalradius}}%
	}
	\anchor{south west}{%
		\installdartparameters%
		\csname pgf@anchor@dart@border\endcsname{\pgfqpoint{-\externalradius}{-\externalradius}}%
	}
	\anchor{south east}{%
		\installdartparameters%
		\csname pgf@anchor@dart@border\endcsname{\pgfqpoint{\externalradius}{-\externalradius}}%
	}
	\anchor{north west}{%
		\installdartparameters%
		\csname pgf@anchor@dart@border\endcsname{\pgfqpoint{-\externalradius}{\externalradius}}%
	}
	\anchor{tip}{%
		\installdartparameters%
		\tipborderpoint}
	\anchor{left tail}{%
		\installdartparameters%
		\lefttailborderpoint}
	\anchor{right tail}{%
		\installdartparameters%
		\righttailborderpoint}
	\anchor{tail center}{%
		\installdartparameters%
		\tailcenterborderpoint}
	\anchor{left side}{%
		\installdartparameters%
		\pgfpointlineattime{0.5}{\tipborderpoint}{\lefttailborderpoint}}
	\anchor{right side}{%
		\installdartparameters%
		\pgfpointlineattime{0.5}{\tipborderpoint}{\righttailborderpoint}}
	\backgroundpath{%
		\installdartparameters%
		\pgfpathmoveto{\tippoint}%
		\pgfpathlineto{\lefttailpoint}%
		\pgfpathlineto{\tailcenterpoint}%
		\pgfpathlineto{\righttailpoint}%
		\pgfpathclose%
	}
	\anchorborder{%
		%
		% Save x and y.
		%
		\edef\externalx{\the\pgf@x}%
		\edef\externaly{\the\pgf@y}%
		%
		% This allows anchors base east, base west, mid east and mid west,
		% to redefine the `center' of the node to correctly calculate the
		% border points.
		%
		\pgfutil@ifundefined{pgf@dartanchorborderreferencepoint}%
			{\let\referencepoint\centerpoint}%
			{\let\referencepoint\pgf@dartanchorborderreferencepoint}%
		%
		% Adjust the location of the external 
		% point relative to the reference point.
		%
		\referencepoint%
		\pgf@xa\externalx\relax%
		\pgf@ya\externaly\relax%
		\advance\pgf@xa\pgf@x%
		\advance\pgf@ya\pgf@y%
		\edef\externalx{\the\pgf@xa}%
		\edef\externaly{\the\pgf@ya}%
		%
		% Install the required points and angles.
		%
		\installdartparameters%
		%
		% Get the angle of the external point relative to \referencepoint.
		%
		\pgfmathanglebetweenpoints{\referencepoint}{\pgfqpoint{\externalx}{\externaly}}%
		%
		% *Subtract* the rotation from the external angle.
		%
		\pgfmathsubtract@{\pgfmathresult}{\rotate}%
		\ifdim\pgfmathresult pt<0pt\relax%
			\pgfmathadd@{\pgfmathresult}{360}%
		\fi%
		\let\externalangle\pgfmathresult%
		%
		% Get the set of angles for the appropriate border point.
		%
		\ifx\referencepoint\basepoint%
			\let\angletotip\baseangletotip%
			\let\angletotailcenter\baseangletotailcenter%
			\let\angletolefttail\baseangletolefttail%
			\let\angletorighttail\baseangletorighttail%
		\else%
			\ifx\referencepoint\midpoint%
				\let\angletotip\midangletotip%
				\let\angletotailcenter\midangletotailcenter%
				\let\angletolefttail\midangletolefttail%
				\let\angletorighttail\midangletorighttail%
		\fi\fi%
		%
		% Locate the appropriate line on the border...
		%
		\ifdim\externalangle pt<\angletotip pt\relax%
			\let\firstpoint\tipborderpoint%
			\let\secondpoint\righttailborderpoint%
		\else%
			\ifdim\externalangle pt<\angletolefttail pt\relax%
				\let\firstpoint\lefttailborderpoint%
				\let\secondpoint\tipborderpoint%
			\else%
				\ifdim\externalangle pt<\angletotailcenter pt\relax%
					\let\firstpoint\lefttailborderpoint%
					\let\secondpoint\tailcenterborderpoint%
				\else%
					\ifdim\externalangle pt<\angletorighttail pt\relax%
						\let\firstpoint\righttailborderpoint%
						\let\secondpoint\tailcenterborderpoint%
					\else%
						\let\firstpoint\tipborderpoint%
						\let\secondpoint\righttailborderpoint%
					\fi%
				\fi%
			\fi%
		\fi%
		%
		% ...and thus the point on the border.
		%
		\pgfpointintersectionoflines{\referencepoint}{\pgfqpoint{\externalx}{\externaly}}%
				{\firstpoint}{\secondpoint}%
	}%
}
