% Copyright 2006 by Till Tantau and Mark Wibrow
%
% This file may be distributed and/or modified
%
% 1. under the LaTeX Project Public License and/or
% 2. under the GNU Public License.
%
% See the file doc/generic/pgf/licenses/LICENSE for more details.

\ProvidesFileRCS[v\pgfversion] $Header: /cvsroot/pgf/pgf/generic/pgf/libraries/Attic/pgflibraryshapes.geometric.code.tex,v 1.6 2007/06/23 18:09:37 vibrovski Exp $

\pgfdeclareshape{ellipse}
%
% Draws a circle around the text
%
{
  \savedanchor\centerpoint{%
    \pgf@x=.5\wd\pgfnodeparttextbox%
    \pgf@y=.5\ht\pgfnodeparttextbox%
    \advance\pgf@y by-.5\dp\pgfnodeparttextbox%
  }
  \savedanchor\radius{%
    % 
    % Caculate ``height radius''
    % 
    \pgf@y=.5\ht\pgfnodeparttextbox%
    \advance\pgf@y by.5\dp\pgfnodeparttextbox%
    \pgfmathsetlength\pgf@yb{\pgfshapeinnerysep}%
    \advance\pgf@y by\pgf@yb%
    % 
    % Caculate ``width radius''
    % 
    \pgf@x=.5\wd\pgfnodeparttextbox%
    \pgfmathsetlength\pgf@xb{\pgfshapeinnerxsep}%
    \advance\pgf@x by\pgf@xb%
    % 
    % Adjust
    % 
    \pgf@x=1.4142136\pgf@x%
    \pgf@y=1.4142136\pgf@y%
    % 
    % Adjust hieght, if necessary
    % 
    \pgfmathsetlength\pgf@yc{\pgfshapeminheight}%
    \ifdim\pgf@y<.5\pgf@yc%
      \pgf@y=.5\pgf@yc%
    \fi%
    % 
    % Adjust width, if necessary
    % 
    \pgfmathsetlength\pgf@xc{\pgfshapeminwidth}%
    \ifdim\pgf@x<.5\pgf@xc%
      \pgf@x=.5\pgf@xc%
    \fi%
    % 
    % Add outer sep
    % 
    \pgfmathsetlength{\pgf@xb}{\pgfshapeouterxsep}%  
    \pgfmathsetlength{\pgf@yb}{\pgfshapeouterysep}%  
    \advance\pgf@x by\pgf@xb%
    \advance\pgf@y by\pgf@yb%
  }

  %
  % Anchors
  % 
  \anchor{center}{\centerpoint}
  \anchor{mid}{\centerpoint\pgfmathsetlength\pgf@y{.5ex}}
  \anchor{base}{\centerpoint\pgf@y=0pt}
  \anchor{north}
  {
    \pgf@process{\radius}
    \pgf@ya=\pgf@y%
    \pgf@process{\centerpoint}
    \advance\pgf@y by\pgf@ya
  }
  \anchor{south}
  {
    \pgf@process{\radius}
    \pgf@ya=\pgf@y%
    \pgf@process{\centerpoint}
    \advance\pgf@y by-\pgf@ya
  }
  \anchor{west}
  {
    \pgf@process{\radius}
    \pgf@xa=\pgf@x%
    \pgf@process{\centerpoint}
    \advance\pgf@x by-\pgf@xa
  }
  \anchor{mid west}
  {%
    \pgf@process{\radius}
    \pgf@xa=\pgf@x%
    \pgf@process{\centerpoint}
    \advance\pgf@x by-\pgf@xa%
    \pgfmathsetlength\pgf@y{.5ex}
  }
  \anchor{base west}
  {%
    \pgf@process{\radius}
    \pgf@xa=\pgf@x%
    \pgf@process{\centerpoint}
    \advance\pgf@x by-\pgf@xa%
    \pgf@y=0pt
  }
  \anchor{north west}
  {
    \pgf@process{\radius}
    \pgf@xa=\pgf@x%
    \pgf@ya=\pgf@y%
    \pgf@process{\centerpoint}
    \advance\pgf@x by-0.707107\pgf@xa
    \advance\pgf@y by0.707107\pgf@ya
  }
  \anchor{south west}
  {
    \pgf@process{\radius}
    \pgf@xa=\pgf@x%
    \pgf@ya=\pgf@y%
    \pgf@process{\centerpoint}
    \advance\pgf@x by-0.707107\pgf@xa
    \advance\pgf@y by-0.707107\pgf@ya
  }
  \anchor{east}
  {%
    \pgf@process{\radius}
    \pgf@xa=\pgf@x%
    \pgf@process{\centerpoint}
    \advance\pgf@x by\pgf@xa
  }
  \anchor{mid east}
  {%
    \pgf@process{\radius}
    \pgf@xa=\pgf@x%
    \pgf@process{\centerpoint}
    \advance\pgf@x by\pgf@xa%
    \pgfmathsetlength\pgf@y{.5ex}
  }
  \anchor{base east}
  {%
    \pgf@process{\radius}
    \pgf@xa=\pgf@x%
    \pgf@process{\centerpoint}
    \advance\pgf@x by\pgf@xa%
    \pgf@y=0pt
  }
  \anchor{north east}
  {
    \pgf@process{\radius}
    \pgf@xa=\pgf@x%
    \pgf@ya=\pgf@y%
    \pgf@process{\centerpoint}
    \advance\pgf@x by0.707107\pgf@xa
    \advance\pgf@y by0.707107\pgf@ya
  }
  \anchor{south east}
  {
    \pgf@process{\radius}
    \pgf@xa=\pgf@x%
    \pgf@ya=\pgf@y%
    \pgf@process{\centerpoint}
    \advance\pgf@x by0.707107\pgf@xa
    \advance\pgf@y by-0.707107\pgf@ya
  }
  \anchorborder{
    \edef\pgf@marshal{%
      \noexpand\pgfpointborderellipse
      {\noexpand\pgfqpoint{\the\pgf@x}{\the\pgf@y}}
      {\noexpand\radius}%
    }%
    \pgf@marshal%
    \pgf@xa=\pgf@x%
    \pgf@ya=\pgf@y%
    \centerpoint%
    \advance\pgf@x by\pgf@xa%
    \advance\pgf@y by\pgf@ya%
  }

  %
  % Background path
  %
  \backgroundpath
  {
    \pgf@process{\radius}%
    \pgfutil@tempdima=\pgf@x%
    \pgfutil@tempdimb=\pgf@y%
    \pgfmathsetlength{\pgf@xb}{\pgfshapeouterxsep}%  
    \pgfmathsetlength{\pgf@yb}{\pgfshapeouterysep}%  
    \advance\pgfutil@tempdima by-\pgf@xb%
    \advance\pgfutil@tempdimb by-\pgf@yb%
    \pgfpathellipse{\centerpoint}{\pgfqpoint{\pgfutil@tempdima}{0pt}}{\pgfqpoint{0pt}{\pgfutil@tempdimb}}%
  }
}




% Set the recommended shape aspect ratio
%
% #1 = aspect ratio
%
% Example:
%
% \pgfsetshapeminwidth{1.5}

\def\pgfsetshapeaspect#1{%
  \def\pgfshapeaspect{#1}%
  % Invert
  \pgfutil@tempdima=#1pt%
  \pgfutil@tempdima=.125\pgfutil@tempdima%
  \c@pgf@counta=\pgfutil@tempdima\relax% 8192*determinant
  \pgfutil@tempdima=8192pt%
  \divide\pgfutil@tempdima by\c@pgf@counta%
  \edef\pgfshapeaspectinverse{\pgf@sys@tonumber{\pgfutil@tempdima}}
}
\pgfsetshapeaspect{1}



\pgfdeclareshape{diamond}
{
  \savedanchor\outernortheast{%
    %
    % Calculate width and height of the inner rectangle
    %
    \pgf@xa=.5\wd\pgfnodeparttextbox%
    \pgfmathsetlength\pgf@xc{\pgfshapeinnerxsep}%
    \advance\pgf@xa by\pgf@xc%
    \pgf@ya=.5\ht\pgfnodeparttextbox%
    \advance\pgf@ya by.5\dp\pgfnodeparttextbox%
    \pgfmathsetlength\pgf@yc{\pgfshapeinnerysep}%
    \advance\pgf@ya by\pgf@yc%
    %
    % Calculate width and height of diamond
    %
    \pgf@x=\pgf@xa%
    \advance\pgf@x by\pgfshapeaspect\pgf@ya%
    \pgf@y=\pgfshapeaspectinverse\pgf@xa%
    \advance\pgf@y by\pgf@ya%
    %
    % Check against minimum height/width
    %
    \pgfmathsetlength\pgf@xb{\pgfshapeminwidth}%
    \ifdim\pgf@x<\pgf@xb%
      % yes, too small. Enlarge...
      \pgf@x=\pgf@xb%
    \fi%
    \pgfmathsetlength\pgf@yb{\pgfshapeminheight}%
    \ifdim\pgf@y<\pgf@yb%
      % yes, too small. Enlarge...
      \pgf@y=\pgf@yb%
    \fi%
    %
    % Add outer border
    %
    \pgfmathsetlength\pgf@xa{\pgfshapeouterxsep}%
    \advance\pgf@x by\pgf@xa%
    \pgfmathsetlength\pgf@ya{\pgfshapeouterysep}%
    \advance\pgf@y by\pgf@ya%
  }
  \savedanchor\text{%
    \pgf@x=-.5\wd\pgfnodeparttextbox%
    \pgf@y=-.5\ht\pgfnodeparttextbox%
    \advance\pgf@y by.5\dp\pgfnodeparttextbox%
  }

  %
  % Anchors
  %
  \anchor{text}{\text}%
  \anchor{center}{\pgfpointorigin}%
  \anchor{mid}{%
    \pgf@process{\text}%
    \pgf@x=0pt%
    \pgfmathsetlength\pgf@ya{.5ex}
    \advance\pgf@y by\pgf@ya%
  }
  \anchor{base}{\pgf@process{\text}\pgf@x=0pt  }
  \anchor{north}{\pgf@process{\outernortheast}\pgf@x=0pt}
  \anchor{south}{\pgf@process{\outernortheast}\pgf@x=0pt\pgf@y=-\pgf@y}
  \anchor{west}{\pgf@process{\outernortheast}\pgf@x=-\pgf@x\pgf@y=0pt}
  \anchor{north west}{\pgf@process{\outernortheast}\pgf@x=-.5\pgf@x\pgf@y=.5\pgf@y}
  \anchor{south west}{\pgf@process{\outernortheast}\pgf@x=-.5\pgf@x\pgf@y=-.5\pgf@y}
  \anchor{east}{\pgf@process{\outernortheast}\pgf@y=0pt}
  \anchor{north east}{\pgf@process{\outernortheast}\pgf@x=.5\pgf@x\pgf@y=.5\pgf@y}
  \anchor{south east}{\pgf@process{\outernortheast}\pgf@x=.5\pgf@x\pgf@y=-.5\pgf@y}
  \anchorborder{%
    \pgf@xa=\pgf@x%
    \pgf@ya=\pgf@y%
    \pgf@process{\outernortheast}%
    \ifdim\pgf@xa>0pt%
    \else%
      \pgf@x=-\pgf@x%
    \fi%
    \ifdim\pgf@ya>0pt%
    \else%
      \pgf@y=-\pgf@y%
    \fi%
    \edef\pgf@marshal{%
      \noexpand\pgfpointintersectionoflines
      {\noexpand\pgfpointorigin}
      {\noexpand\pgfqpoint{\the\pgf@xa}{\the\pgf@ya}}
      {\noexpand\pgfqpoint{\the\pgf@x}{0pt}}
      {\noexpand\pgfqpoint{0pt}{\the\pgf@y}}%
    }%
    \pgf@process{\pgf@marshal}%
  }

  %
  % Background path
  %
  \backgroundpath{
    \pgf@process{\outernortheast}%
    \pgf@xc=\pgf@x%
    \pgf@yc=\pgf@y%
    \pgfmathsetlength{\pgf@xa}{\pgfshapeouterxsep}%
    \pgfmathsetlength{\pgf@ya}{\pgfshapeouterysep}%
    \advance\pgf@xc by-1.414213\pgf@xa%
    \advance\pgf@yc by-1.414213\pgf@ya%
    \pgfpathmoveto{\pgfqpoint{\pgf@xc}{0pt}}%
    \pgfpathlineto{\pgfqpoint{0pt}{\pgf@yc}}%
    \pgfpathlineto{\pgfqpoint{-\pgf@xc}{0pt}}%
    \pgfpathlineto{\pgfqpoint{0pt}{-\pgf@yc}}%
    \pgfpathclose%
  }
}




% \pgfsetstarpoints
%
% Set the number of points on a star.
%
\def\pgfsetstarpoints#1{%
	\pgfmathsetcounter{pgf@counta}{#1}%
	\edef\pgfstarpoints{\the\c@pgfmath@counta}}
\pgfsetstarpoints{5}

% \pgfsetstarpointheight
%
% Set the height of the points (this is the
% distance between the outer and inner point 
% radii).
%
\def\pgfsetstarpointheight#1{%
	\pgfmathparse{#1}%
	\edef\pgfstarpointheight{\pgfmathresult pt}}
\pgfsetstarpointheight{12pt}

% \pgfsetstarpointratio
%
% Set the ratio between the outer and 
% inner point radii.
%
\def\pgfsetstarpointratio#1{%
	\pgfmathparse{#1}%
	\edef\pgfstarpointratio{\pgfmathresult}%
	\def\pgfstarpointheight{-16383pt}% If negative, the ratio is used.
}
\pgfsetstarpointratio{1.75}

% \pgfsetstarrrotate
%
% Set the angle of rotation of the star
% border. This can be decimal.
%
\def\pgfsetstarrotate#1{%
	\pgfmathparse{#1}%
	\edef\pgfstarrotate{\pgfmathresult}}%
\pgfsetstarrotate{0}

% Shape star.
%
\pgfdeclareshape{star}{%
	\saveddimen{\points}{\pgf@x\pgfstarpoints pt}%
	\saveddimen{\pointratio}{\pgf@x\pgfstarpointratio pt}%
	\saveddimen{\rotate}{\pgf@x\pgfstarrotate pt}%
	\saveddimen{\pointheight}{\pgf@x\pgfstarpointheight}%
	\saveddimen{\minimumsize}{%
		\pgfmathsetlength\pgf@x{\pgfshapeminwidth}%
		\pgfmathsetlength\pgf@y{\pgfshapeminheight}%
		\ifdim\pgf@y>\pgf@x%
			\pgf@x\pgf@y%
		\fi}%	
	\saveddimen{\outersep}{%
		\pgfmathsetlength\pgf@x{\pgfshapeouterxsep}%
		\pgfmathsetlength\pgf@y{\pgfshapeouterysep}%
		\ifdim\pgf@y>\pgf@x%
			\pgf@x\pgf@y%
		\fi}%
	\savedanchor{\centerpoint}{%
		\pgf@x.5\wd\pgfnodeparttextbox%
		\pgf@y.5\ht\pgfnodeparttextbox%
		\advance\pgf@y-.5\dp\pgfnodeparttextbox%
	}%
	\saveddimen{\innerpointradius}{%
		% 
		% The innerpoint radius is the radius of the circle which 
		% can safely encompass the node textbox. 
		%
		\pgfmathsetlength\pgf@x{\pgfshapeinnerxsep}%
		\advance\pgf@x.5\wd\pgfnodeparttextbox%
		\pgfmathsetlength\pgf@y{\pgfshapeinnerysep}%
		\advance\pgf@y.5\ht\pgfnodeparttextbox%
		\ifdim\pgf@y>\pgf@x%
			\pgf@x\pgf@y%
		\fi%
		\pgfmathveclen@{\pgf@sys@tonumber{\pgf@x}}{\pgf@sys@tonumber{\pgf@x}}%
		\pgf@x\pgfmathresult pt\relax% 		
	}%
	%
	\anchor{center}{\centerpoint}%
	\anchor{mid}{\centerpoint\pgfmathsetlength\pgf@y{.5ex}}%
 	\anchor{base}{\centerpoint\pgf@y=0pt}%
 	\anchor{north}{\pgf@anchor@star@border{\pgfpoint{+0pt}{+\outerpointradius}}}%
 	\anchor{south}{\pgf@anchor@star@border{\pgfpoint{+0pt}{+-\outerpointradius}}}%
 	\anchor{east}{\pgf@anchor@star@border{\pgfpoint{+\outerpointradius}{+0pt}}}%
 	\anchor{west}{\pgf@anchor@star@border{\pgfpoint{+-\outerpointradius}{+0pt}}}%
 	\anchor{north east}{\pgf@anchor@star@border{\pgfpoint{+\outerpointradius}{+\outerpointradius}}}%
 	\anchor{north west}{\pgf@anchor@star@border{\pgfpoint{+-\outerpointradius}{+\outerpointradius}}}%
 	\anchor{south east}{\pgf@anchor@star@border{\pgfpoint{+\outerpointradius}{+-\outerpointradius}}}%
 	\anchor{south west}{\pgf@anchor@star@border{\pgfpoint{+-\outerpointradius}{+-\outerpointradius}}}%
 	%
	\backgroundpath{%
		%
		% Redefine stuff for ease of use.
		%
		\pgf@x\points%
		\c@pgf@counta\pgf@x%
		\divide\c@pgf@counta65536\relax%
		\edef\points{\the\c@pgf@counta}%
		\pgf@x\rotate%
		\edef\rotate{\pgf@sys@tonumber{\pgf@x}}%
		\pgf@x\pointratio%
		\edef\pointratio{\pgf@sys@tonumber{\pgf@x}}%
		%
		% Calculate radii.
		%
		\pgf@x\innerpointradius\relax%
		\edef\innerradius{\the\pgf@x}%
		\pgf@xa\pointheight\relax%
		\ifdim\pgf@xa<0pt\relax%
			\pgf@x\pointratio\pgf@x%
		\else%
			\advance\pgf@x\pgf@xa%
		\fi%
		\pgf@xb\pgf@x%
    	\pgf@xc\minimumsize\relax%
    	\ifdim\pgf@x<.5\pgf@xc%
    		\pgf@x.5\pgf@xc%
    	\fi%
    	\edef\outerradius{\the\pgf@x}%
    	\ifdim\pgf@x>\pgf@xb%
    		\ifdim\pgf@xa<0pt\relax%
    			\pgfmathreciprocal{\pointratio}%
    			\pgf@xc\pgfmathresult\pgf@x\relax%
    			\edef\innerradius{\the\pgf@xc}%
			\else%
				\pgf@xc\pgf@x\relax%
				\advance\pgf@xc-\pointheight%
				\edef\innerradius{\the\pgf@xc}%
			\fi%
		\fi%
		%
		% Get the total number of points (inner + outer)...
		%
		\c@pgf@counta\points%
		\advance\c@pgf@counta\c@pgf@counta%
		\edef\numpoints{\the\c@pgf@counta}%
		%
		% ...and hence the angle between points.
		%
		\pgf@x360pt\relax%
		\divide\pgf@x\c@pgf@counta%
		\edef\staranglestep{\the\pgf@x}%
		%
		% Start at 90 degrees (star always points up)...
		%
		\pgf@x90pt\relax%
		%
		% ...unless rotation is applied.
		%
		\pgf@xa\rotate pt\relax%
		\advance\pgf@x\pgf@xa%
		\edef\starangle{\the\pgf@x}%
		\let\starradius=\outerradius%
		%
		% Move to first point.
		%
		\pgfpathmoveto{%
			\pgfpointadd{\centerpoint}%
				{\pgfpointpolar{+\starangle}{+\starradius}}%
		}%
		\def\staranchorname{pgf@anchor@star@outer point}%
		\pgfmathloop%
			%
			% Create anchors. Manually \xdef as \gdef is normally used by \anchor.
			%
			\c@pgf@counta\pgfmathcounter\relax%
			\advance\c@pgf@counta1\relax%
			\divide\c@pgf@counta2\relax%
			\expandafter\xdef\csname\staranchorname\space\the\c@pgf@counta\endcsname{%
				\noexpand\pgf@lib@shapesstaranchor{\pgfmathcounter}%
			}%
			\ifnum\pgfmathcounter=\numpoints\relax% Stop.
			\else%
			\ifodd\pgfmathcounter%
				\let\starradius\innerradius%
				\def\staranchorname{pgf@anchor@star@inner point}%
			\else%
				\let\starradius\outerradius%
				\def\staranchorname{pgf@anchor@star@outer point}%
			\fi%
			\pgf@x\starangle\relax%
			\advance\pgf@x\staranglestep\relax%
			\edef\starangle{\the\pgf@x}%
			\pgfpathlineto{%
				\pgfpointadd{\centerpoint}%
					{\pgfpointpolar{+\starangle}{+\starradius}}%
			}%
			\repeatpgfmathloop%
		\pgfpathclose%
	}%
	%
	\anchorborder{%
		%
		% Save x and y.
		%
		\pgf@xa\pgf@x%
		\pgf@ya\pgf@y%
		%
		% Redefine stuff for ease of use.
		%
		\pgf@x\points%
		\c@pgf@counta\pgf@x%
		\divide\c@pgf@counta65536\relax%
		\edef\points{\the\c@pgf@counta}%
		\pgf@x\rotate%
		\edef\rotate{\pgf@sys@tonumber{\pgf@x}}%
		\pgf@x\pointratio%
		\edef\pointratio{\pgf@sys@tonumber{\pgf@x}}%
		%
		% Calculate the location of the external 
		% point relative to the node center.
		%
		\centerpoint%
		\advance\pgf@xa\pgf@x%
		\advance\pgf@ya\pgf@y%
		\edef\externalx{\the\pgf@xa}%
		\edef\externaly{\the\pgf@ya}%
		\pgf@process{\pgfpointdiff{\centerpoint}{\pgfpoint{+\externalx}{+\externaly}}}%
		%
		% First approximate the angle of the external point...
		%
		\pgf@xa\pgf@x%
		\pgf@ya\pgf@y%
		\pgf@xb\pgf@x%
		\pgf@yb\pgf@y%
		\ifdim\pgf@xa<0pt\relax%
			\pgf@xa-\pgf@xa%
		\fi%
		\ifdim\pgf@ya<0pt\relax%
			\pgf@ya-\pgf@ya%
		\fi%
		\ifdim\pgf@ya>\pgf@xa%
			\pgf@x\pgf@xa%
			\pgf@y\pgf@ya%
		\else%
			\pgf@x\pgf@ya%
			\pgf@y\pgf@xa%
		\fi%
		\ifdim\pgf@y=0pt\relax%
			\pgf@x0pt%
		\else%
			\pgfmathreciprocal@{\pgf@sys@tonumber{\pgf@y}}%
			\pgf@x\pgfmathresult\pgf@x%
		\fi%
		\multiply\pgf@x1000\relax%
		\afterassignment\pgfmath@gobbletilpgfmath@%
		\expandafter\c@pgf@counta\the\pgf@x\relax\pgfmath@%
		\expandafter\pgf@x\csname pgfmath@atan@\the\c@pgf@counta\endcsname pt\relax%
		\ifdim\pgfmath@ya>\pgfmath@xa\relax%
			\pgf@x-\pgf@x%
			\advance\pgf@x90pt%
		\fi%
		\ifdim\pgf@xb<0pt%
			\ifdim\pgf@yb>0pt%
				\pgf@x-\pgf@x%
			\fi%
			\advance\pgf@x180pt\relax%
		\else%
			\ifdim\pgf@yb<0pt%
			\pgf@x-\pgf@x%
			\advance\pgf@x360pt\relax%
		\fi\fi%		
		%
		% ...then adjust, as star points start at 90 degrees...
		%
		\advance\pgf@x-90pt\relax%
		\ifdim\pgf@x<0pt\relax%
			\advance\pgf@x360pt\relax%
		\fi%
		%
		% ...and also for rotation.
		%
		\advance\pgf@x-\rotate pt\relax%
		\ifdim\pgf@x<0pt\relax%
			\advance\pgf@x360pt\relax%
		\fi%
		%
		% Now, locate the start and end points on the star border segment...
		%
		\c@pgf@counta\points\relax%
		\pgf@y180pt\relax%
		\divide\pgf@y\c@pgf@counta\relax%
		\pgfmathreciprocal@{\pgf@sys@tonumber{\pgf@y}}%
		\pgf@x\pgfmathresult\pgf@x%
		\afterassignment\pgfmath@gobbletilpgfmath@%
		\expandafter\c@pgf@counta\the\pgf@x\relax\pgfmath@%
		%
		% ...and hence, the start and end angles of the star border segment.
		%
		\pgf@x\pgf@y%
		\multiply\pgf@x\c@pgf@counta%
		\advance\pgf@x90pt%
		\advance\pgf@x\rotate pt\relax%
		\edef\firstangle{\the\pgf@x}%
		\advance\c@pgf@counta1\relax%
		\pgf@x\pgf@y%
		\multiply\pgf@x\c@pgf@counta%
		\advance\pgf@x\rotate pt\relax%
		\advance\pgf@x90pt%
		\edef\secondangle{\the\pgf@x}%
		%
		% Get the radii and add the outer sep...
		%
		\pgf@x\innerpointradius\relax%
		\edef\innerradius{\the\pgf@x}%
		\pgf@xa\pointheight\relax%
		\ifdim\pgf@xa<0pt\relax%
			\pgf@x\pointratio\pgf@x%
		\else%
			\advance\pgf@x\pgf@xa%
		\fi%
		\pgf@xb\pgf@x%
    	\pgf@xc\minimumsize\relax%
    	\ifdim\pgf@x<.5\pgf@xc%
    		\pgf@x.5\pgf@xc%
    	\fi%
    	\edef\outerradius{\the\pgf@x}%
    	\ifdim\pgf@x>\pgf@xb%
    		\ifdim\pgf@xa<0pt\relax%
    			\pgfmathreciprocal{\pointratio}%
    			\pgf@xc\pgfmathresult\pgf@x\relax%
    			\edef\innerradius{\the\pgf@xc}%
			\else%
				\pgf@xc\pgf@x\relax%
				\advance\pgf@xc-\pgf@xb%
				\edef\innerradius{\the\pgf@xc}%
			\fi%
		\fi%
		\pgf@xa\outersep\relax%
		\pgf@x\outerradius\relax%
    	\advance\pgf@x\pgf@xa%
		\edef\outerradius{\the\pgf@x}%
		\pgf@x\innerradius\relax%
		\advance\pgf@x\pgf@xa%		
		\edef\innerradius{\the\pgf@x}%		
		\ifodd\c@pgf@counta%
			\let\firstradii\outerradius%
			\let\secondradii\innerradius%
		\else%
			\let\firstradii\innerradius%
			\let\secondradii\outerradius%
		\fi%
		%
		% ...and calculate the point on the intersection of
		% the line from the external point to \centerpoint and
		% the relevant segment of the star border.
		%
		\pgfpointintersectionoflines{\centerpoint}{\pgfpoint{+\externalx}{+\externaly}}%
			{%
				\pgfpointadd{\centerpoint}%
					{\pgfpointpolar{+\firstangle}{+\firstradii}}%
				}%	
				{%
					\pgfpointadd{\centerpoint}%
						{\pgfpointpolar{+\secondangle}{+\secondradii}}%
				}%	
	}%
}%


% \pgf@lib@shapesstaranchor
%
% Used internally to calculate inner point and  
% outer point anchor positions 'on line'.
%
\def\pgf@lib@shapesstaranchor#1{%
	%
	% Redefine stuff for ease of use.
	%
	\pgf@x\points%
	\c@pgf@counta\pgf@x%
	\divide\c@pgf@counta65536\relax%
	\edef\points{\the\c@pgf@counta}%
	\pgf@x\rotate%
	\edef\rotate{\pgf@sys@tonumber{\pgf@x}}%
	\pgf@x\pointratio%
	\edef\pointratio{\pgf@sys@tonumber{\pgf@x}}%
	%
	% Caculate radii.
	%
	\pgf@x\innerpointradius%
	\edef\innerradius{\the\pgf@x}%
	\pgf@xa\pointheight\relax%
	\ifdim\pgf@xa<0pt\relax%
		\pgf@x\pointratio\pgf@x%
	\else%
		\advance\pgf@x\pgf@xa%
	\fi%
	\pgf@xb\pgf@x%
	\pgf@xc\minimumsize\relax%
   \ifdim\pgf@x<.5\pgf@xc%
   	\pgf@x.5\pgf@xc%
   \fi%
   \edef\outerradius{\the\pgf@x}%
   \ifdim\pgf@x>\pgf@xb%
   	\ifdim\pgf@xa<0pt\relax%
   		\pgfmathreciprocal{\pointratio}%
   		\pgf@xc\pgfmathresult\pgf@x\relax%
   		\edef\innerradius{\the\pgf@xc}%
		\else%
			\pgf@xc\pgf@x\relax%
			\advance\pgf@xc-\pgf@xb%
			\edef\innerradius{\the\pgf@xc}%
		\fi%
	\fi%
	%
	% Add the outer sep.
	%
	\pgf@xa\outersep%
	\pgf@x\outerradius\relax%
   \advance\pgf@x\pgf@xa%
	\edef\outerradius{\the\pgf@x}%
	\pgf@x\innerradius\relax%
	\advance\pgf@x\pgf@xa%		
	\edef\innerradius{\the\pgf@x}%
	%
	% Calculate the angle.
	%	
	\c@pgf@counta\points%
	\pgf@x180pt\relax%
	\divide\pgf@x\c@pgf@counta%
	\c@pgf@counta#1\relax%
	\advance\c@pgf@counta-1\relax%
	\multiply\pgf@x\c@pgf@counta%
	\pgf@xa\rotate pt\relax%
	\advance\pgf@x\pgf@xa%
	\advance\pgf@x90pt\relax%
	\edef\starangle{\the\pgf@x}%
	\ifodd\c@pgf@counta%
		\let\starradius\innerradius%
	\else%
		\let\starradius\outerradius%
	\fi%
	\pgfpointadd{\centerpoint}%
			{\pgfpointpolar{\starangle}{\starradius}}%
}%


% \pgfsetpolygonsides
%
% Set the number of sides on a polygon.
%
\def\pgfsetpolygonsides#1{%
	\pgfmathsetcounter{pgf@counta}{#1}%
	\edef\pgfpolygonsides{\the\c@pgfmath@counta}}
\pgfsetpolygonsides{6}

% \pgfsetpolygonrotate
%
% Set the angle of rotation of the polygon
% border. This can be decimal.
%
\def\pgfsetpolygonrotate#1{%
	\pgfmathparse{#1}%
	\edef\pgfpolygonrotate{\pgfmathresult}}%
\pgfsetpolygonrotate{0}


% Regular polygon shape.
% 
%
\pgfdeclareshape{regular polygon}{%
	%
	% Saved dimensions.
	%
	\saveddimen{\sides}{\pgf@x\pgfpolygonsides pt}%
	\saveddimen{\rotate}{\pgf@x\pgfpolygonrotate pt}%
	\saveddimen{\minimumsize}{%
		\pgfmathsetlength\pgf@x{\pgfshapeminwidth}%
		\pgfmathsetlength\pgf@y{\pgfshapeminheight}%
		\ifdim\pgf@y>\pgf@x%
			\pgf@x\pgf@y%
		\fi}%
	\saveddimen{\outersep}{%
		\pgfmathsetlength\pgf@x{\pgfshapeouterxsep}%
		\pgfmathsetlength\pgf@y{\pgfshapeouterysep}%
		\ifdim\pgf@y>\pgf@x%
			\pgf@x\pgf@y%
		\fi}%
	\saveddimen{\radius}{%
		% 
		% The radius calculated here is the radius of the circle which 
		% can safely encompass the node textbox. This corresponds to the 
		% distance from the centre of the polygon to the mid-point of the
		% of the sides of the polygon. The desired radius for the corners 
		% of the polygon has to calculated `on-line' as the saved dimen 
		% \sides is not available here.
		%
		\pgfmathsetlength\pgf@x{\pgfshapeinnerxsep}%
		\advance\pgf@x.5\wd\pgfnodeparttextbox%
		\pgfmathsetlength\pgf@y{\pgfshapeinnerysep}%
		\advance\pgf@y.5\ht\pgfnodeparttextbox%
		\ifdim\pgf@y>\pgf@x%
			\pgf@x\pgf@y%
		\fi%
		\pgfmathveclen@{\pgf@sys@tonumber{\pgf@x}}{\pgf@sys@tonumber{\pgf@x}}%
		\pgf@x\pgfmathresult pt\relax%   
	}%
	
	%
	% Saved anchors.
	%
	\savedanchor{\centerpoint}{%
		\pgf@x.5\wd\pgfnodeparttextbox%
		\pgf@y.5\ht\pgfnodeparttextbox%
		\advance\pgf@y-.5\dp\pgfnodeparttextbox%
	}%
	
	%
	% Other anchors.
	%
	\anchor{center}{\centerpoint}%
	\anchor{mid}{\centerpoint\pgfmathsetlength\pgf@y{.5ex}}%
 	\anchor{base}{\centerpoint\pgf@y=0pt}%
 	\anchor{north}{\csname pgf@anchor@regular polygon@border\endcsname{\pgfpoint{+0pt}{+\radius}}}%
 	\anchor{south}{\csname pgf@anchor@regular polygon@border\endcsname{\pgfpoint{+0pt}{+-\radius}}}%
 	\anchor{east}{\csname pgf@anchor@regular polygon@border\endcsname{\pgfpoint{+\radius}{+0pt}}}%
 	\anchor{west}{\csname pgf@anchor@regular polygon@border\endcsname{\pgfpoint{+-\radius}{+0pt}}}%
 	\anchor{north east}{\csname pgf@anchor@regular polygon@border\endcsname{\pgfpoint{+\radius}{+\radius}}}%
 	\anchor{north west}{\csname pgf@anchor@regular polygon@border\endcsname{\pgfpoint{+-\radius}{+\radius}}}%
 	\anchor{south east}{\csname pgf@anchor@regular polygon@border\endcsname{\pgfpoint{+\radius}{+-\radius}}}%
 	\anchor{south west}{\csname pgf@anchor@regular polygon@border\endcsname{\pgfpoint{+-\radius}{+-\radius}}}%
 	
 	%
	% Background path.
	%
	\backgroundpath{%
		%
		% Redefine some stuff for ease of use.
		%
		\pgf@x\sides%
		\c@pgf@counta\pgf@x%
		\divide\c@pgf@counta65536\relax%
		\edef\sides{\the\c@pgf@counta}%
		\pgf@x\rotate%
		\edef\rotate{\pgf@sys@tonumber{\pgf@x}}%
		%
		% Get the inner angle.
		%
		\pgf@y360pt\relax%
		\divide\pgf@y\sides%
		\edef\polygonanglestep{\the\pgf@y}%
		%
		% Now recalculate the polygon *corner* radius. 
		%
		\pgf@y.5\pgf@y%
		\pgfmathcos@{\pgf@sys@tonumber{\pgf@y}}%
		\pgfmathreciprocal@{\pgfmathresult}%
		\pgf@x\radius\relax%
		\pgf@x\pgfmathresult\pgf@x%
		\pgf@xa\minimumsize\relax%
		\ifdim\pgf@x<.5\pgf@xa%
			\pgf@x.5\pgf@xa%
		\fi%
		\edef\polygonradius{\the\pgf@x}%
		%
		% Every polygon is drawn so that a side is at the bottom...
		%
		\pgf@x90pt\relax%
		\ifodd\sides%
		\else%
			\advance\pgf@x-\pgf@y%
		\fi%
		%
		% ...unless rotation is applied.
		%
		\pgf@xa\rotate pt\relax%
		\advance\pgf@x\pgf@xa%
		\edef\polygonangle{\the\pgf@x}%
		%
		% Move to first point.
		%
		\pgfpathmoveto{%
			\pgfpointadd{\centerpoint}%
				{\pgfpointpolar{+\polygonangle}{+\polygonradius}}%
		}%
		\pgfmathloop%
			%
			% Create anchors. Manually \xdef as \gdef is normally used by \anchor.
			%
			\expandafter\xdef\csname pgf@anchor@regular polygon@corner\space\pgfmathcounter\endcsname{%
				\noexpand\pgf@lib@shapescorneranchor{\pgfmathcounter}%
			}%
			\expandafter\xdef\csname pgf@anchor@regular polygon@side\space\pgfmathcounter\endcsname{%
				\noexpand\pgf@lib@shapessideanchor{\pgfmathcounter}%
			}%
			\ifnum\pgfmathcounter=\sides\relax% Stop.
			\else%
			\pgf@x\polygonangle\relax%
			\advance\pgf@x\polygonanglestep\relax%
			\edef\polygonangle{\the\pgf@x}%
			\pgfpathlineto{%
				\pgfpointadd{\centerpoint}%
					{\pgfpointpolar{+\polygonangle}{+\polygonradius}}%
			}%
			\repeatpgfmathloop%
		\pgfpathclose%
	}%
	
	%
	% Anchor border.
	%
	\anchorborder{%
		%
		% Save the external point.
		%
		\pgf@xa\pgf@x%
		\pgf@ya\pgf@y%
		\centerpoint%
		\advance\pgf@xa\pgf@x%
		\advance\pgf@ya\pgf@y%
		\edef\externalx{\the\pgf@xa}%
		\edef\externaly{\the\pgf@ya}%
		\pgf@process{\pgfpointdiff{\centerpoint}{\pgfpoint{+\externalx}{+\externaly}}}%
		%
		% Approximate the angle of the external point...
		%
		\pgf@xa\pgf@x%
		\pgf@ya\pgf@y%
		\pgf@xb\pgf@x%
		\pgf@yb\pgf@y%
		\ifdim\pgf@xa<0pt\relax%
			\pgf@xa-\pgf@xa%
		\fi%
		\ifdim\pgf@ya<0pt\relax%
			\pgf@ya-\pgf@ya%
		\fi%
		\ifdim\pgf@ya>\pgf@xa%
			\pgf@x\pgf@xa%
			\pgf@y\pgf@ya%
		\else%
			\pgf@x\pgf@ya%
			\pgf@y\pgf@xa%
		\fi%
		\ifdim\pgf@y=0pt\relax%
			\pgf@x0pt%
		\else%
			\pgfmathreciprocal@{\pgf@sys@tonumber{\pgf@y}}%
			\pgf@x\pgfmathresult\pgf@x%
		\fi%
		\multiply\pgf@x1000\relax%
		\afterassignment\pgfmath@gobbletilpgfmath@%
		\expandafter\c@pgf@counta\the\pgf@x\relax\pgfmath@%
		\expandafter\pgf@x\csname pgfmath@atan@\the\c@pgf@counta\endcsname pt\relax%
		\ifdim\pgfmath@ya>\pgfmath@xa\relax%
			\pgf@x-\pgf@x%
			\advance\pgf@x90pt%
		\fi%
		\ifdim\pgf@xb<0pt%
			\ifdim\pgf@yb>0pt%
				\pgf@x-\pgf@x%
			\fi%
			\advance\pgf@x180pt\relax%
		\else%
			\ifdim\pgf@yb<0pt%
			\pgf@x-\pgf@x%
			\advance\pgf@x360pt\relax%
		\fi\fi%
		%
		% ...(redefine stuff for ease of use)...
		%
		\pgf@y\sides%
		\c@pgf@counta\pgf@y%
		\divide\c@pgf@counta65536\relax%
		\edef\sides{\the\c@pgf@counta}%
		\pgf@y\rotate%
		\edef\rotate{\pgf@sys@tonumber{\pgf@y}}%		
		%
		% ...now adjust angle, for the number of polygon sides...
		%
		\advance\pgf@x-90pt\relax%
		\pgf@xa180pt\relax%
		\divide\pgf@xa\sides%
		%
		% ...and for if the there is an even number of sides...
		%
		\ifodd\sides%
		\else%
			\advance\pgf@x\pgf@xa%
		\fi%
		\ifdim\pgf@x<0pt\relax%
			\advance\pgf@x360pt\relax%
		\fi%
		%
		% ...and also for rotation.
		%
		\advance\pgf@x-\rotate pt\relax%
		\ifdim\pgf@x<0pt\relax%
			\advance\pgf@x360pt\relax%
		\fi%
		%
		% Now, locate the start and end points on the polygon border segment...
		%
		\c@pgf@counta\sides\relax%
		\pgf@y360pt\relax%
		\divide\pgf@y\c@pgf@counta\relax%
		\pgfmathreciprocal@{\pgf@sys@tonumber{\pgf@y}}%
		\pgf@x\pgfmathresult\pgf@x%
		\afterassignment\pgfmath@gobbletilpgfmath@%
		\expandafter\c@pgf@counta\the\pgf@x\relax\pgfmath@%
		%
		% ...and hence, the start and end angles of the polygon border segment.
		%
		\pgf@x\pgf@y%
		\multiply\pgf@x\c@pgf@counta%
		\advance\pgf@x90pt%
		\ifodd\sides%
		\else%
			\advance\pgf@x-\pgf@xa%
		\fi%
		\advance\pgf@x\rotate pt\relax%
		\edef\firstangle{\the\pgf@x}%
		\advance\c@pgf@counta1\relax%
		\pgf@x\pgf@y%
		\multiply\pgf@x\c@pgf@counta%
		\advance\pgf@x\rotate pt\relax%
		\advance\pgf@x90pt%
		\ifodd\sides%
		\else%
			\advance\pgf@x-\pgf@xa%
		\fi%
		\edef\secondangle{\the\pgf@x}%
		%
		% Get the inner angle.
		%
		\pgf@y360pt\relax%
		\divide\pgf@y\sides%
		%
		% Now recalculate the polygon *corner* radius... 
		%
		\pgf@y.5\pgf@y%
		\pgfmathcos@{\pgf@sys@tonumber{\pgf@y}}%
		\pgfmathreciprocal@{\pgfmathresult}%
		\pgf@x\radius\relax%
		\pgf@x\pgfmathresult\pgf@x%
		\edef\polygonradius{\the\pgf@x}%
		%
		% ...and add the outer sep to the corner radius...
		%
		\pgf@xa\minimumsize\relax%
    	\ifdim\pgf@x<.5\pgf@xa%
    		\pgf@x.5\pgf@xa%
    	\fi%
    	\pgf@xa\outersep\relax%
    	\advance\pgf@x\pgf@xa%
		\edef\radius{\the\pgf@x}%
		%
		% ...and calculate the point on the intersection of
		% the line from the external point to \centerpoint and
		% the segment of the star border.
		%
		\pgfpointintersectionoflines{\centerpoint}{\pgfpoint{+\externalx}{+\externaly}}%
			{%
				\pgfpointadd{\centerpoint}%
					{\pgfpointpolar{+\firstangle}{+\radius}}%
				}%	
				{%
					\pgfpointadd{\centerpoint}%
						{\pgfpointpolar{+\secondangle}{+\radius}}%
				}%	
	}%
}%


% \pgf@lib@shapespolygoncorneranchor
%
% Used internally to calculate corner anchor positions.  
%
\def\pgf@lib@shapescorneranchor#1{%
	%
	% Redefine stuff for ease of use.
	%
	\pgf@y\sides%
	\c@pgf@counta\pgf@y%
	\divide\c@pgf@counta65536\relax%
	\edef\sides{\the\c@pgf@counta}%
	\pgf@y\rotate%
	\edef\rotate{\pgf@sys@tonumber{\pgf@y}}%
	%
	% Get the inner angle.
	%
	\pgf@y360pt\relax%
	\divide\pgf@y\sides\relax%
	\edef\polgonanglestep{\pgf@sys@tonumber{\pgf@y}}%
	%
	% Recalculate the polygon corner radius...
	%
	\pgf@y.5\pgf@y%
	\pgfmathcos@{\pgf@sys@tonumber{\pgf@y}}%
	\pgfmathreciprocal@{\pgfmathresult}%
	\pgf@x\radius\relax%
	\pgf@x\pgfmathresult\pgf@x%
	\edef\polygonradius{\the\pgf@x}%
	%
	% ...adjust for minimum size...
	%
	\pgf@xa\minimumsize\relax%
   \ifdim\pgf@x<.5\pgf@xa%
   	\pgf@x.5\pgf@xa%
   \fi%
	%
	% ...and add the outer sep.
	%	
	\pgf@xa\outersep\relax%
   \advance\pgf@x\pgf@xa%		
	\edef\polygonradius{\the\pgf@x}%
	%
	% Calculate the angle.
	%	
	\c@pgf@counta#1\relax%
	\advance\c@pgf@counta-1\relax%
	\pgf@x2.0\pgf@y%
	\multiply\pgf@x\c@pgf@counta%
	\pgf@xa\rotate pt\relax%
	\advance\pgf@x\pgf@xa%
	\advance\pgf@x90pt\relax%
	\ifodd\sides%
	\else%
		\advance\pgf@x-\pgf@y%
	\fi%
	\edef\polygonangle{\the\pgf@x}%
	\pgfpointadd{\centerpoint}%
			{\pgfpointpolar{\polygonangle}{\polygonradius}}%
}%

% \pgf@lib@shapespolygonsideanchor
%
% Used internally to calculate side anchor positions.  
%
\def\pgf@lib@shapessideanchor#1{%
	%
	% Redefine stuff for ease of use.
	%
	\pgf@y\sides%
	\c@pgf@counta\pgf@y%
	\divide\c@pgf@counta65536\relax%
	\edef\sides{\the\c@pgf@counta}%
	\pgf@y\rotate%
	\edef\rotate{\pgf@sys@tonumber{\pgf@y}}%
	%
	% Get the inner angle.
	%
	\pgf@y360pt\relax%
	\divide\pgf@y\sides\relax%
	\edef\polygonanglestep{\the\pgf@y}%
	%
	% Recalculate the polygon corner radius...
	%
	\pgf@y.5\pgf@y%
	\pgfmathcos@{\pgf@sys@tonumber{\pgf@y}}%
	\pgfmathreciprocal@{\pgfmathresult}%
	\pgf@x\radius\relax%
	\pgf@x\pgfmathresult\pgf@x%
	%
	% ...adjust for minimum size...
	%
	\pgf@xa\minimumsize\relax%
  	\ifdim\pgf@x<.5\pgf@xa%
   	\pgf@x.5\pgf@xa%
   \fi%
	%
	% and add the outer sep.
	%	
	\pgf@xa\outersep\relax%
   \advance\pgf@x\pgf@xa%		
	\edef\polygonradius{\the\pgf@x}%
	%
	% Calculate the angle.
	%
	\pgf@y\polygonanglestep%
	\c@pgf@counta#1\relax%
	\advance\c@pgf@counta-1\relax%
	\pgf@x\polygonanglestep pt\relax%
	\multiply\pgf@x\c@pgf@counta%
	\pgf@xa\rotate pt\relax%
	\advance\pgf@x\pgf@xa%
	\advance\pgf@x90pt\relax%
	\ifodd\sides%
	\else%
		\advance\pgf@x-.5\pgf@y%
	\fi%
	\edef\firstangle{\the\pgf@x}%
	\advance\pgf@x\pgf@y%
	\edef\secondangle{\the\pgf@x}%
	\pgfpointlineattime{0.5}{%
		\pgfpointadd{\centerpoint}{\pgfpointpolar{+\firstangle}{+\polygonradius}}%
		}{%
			\pgfpointadd{\centerpoint}{\pgfpointpolar{+\secondangle}{+\polygonradius}}%
	}%
}%

% \pgfsettriangleapexangle
%
% Set the apex angle for the triangle.
%
\def\pgfsettriangleapexangle#1{\pgfmathsetmacro\pgftriangleapexangle{#1}}
\pgfsettriangleapexangle{45}

% \pgfsettrianglerotation
%
% Set the border rotation for the triangle.
%
\def\pgfsettrianglerotate#1{\pgfmathsetmacro\pgftrianglerotate{#1}}%
\pgfsettrianglerotate{90}

%
% Shape isosceles triangle
%
\pgfdeclareshape{isosceles triangle}{%
	\savedmacro{\angle}{\let\angle\pgftriangleapexangle}%
	\savedmacro{\angletolowerleftpoint}{%
		\pgf@x\pgftriangleapexangle pt\relax%
		\divide\pgf@x-4\relax%
		\advance\pgf@x135pt%
		\advance\pgf@x\pgftrianglerotate pt\relax%
		\pgfmathmod@{\pgfmath@tonumber{\pgf@x}}{360}%
		\pgf@x\pgfmathresult pt\relax%
		\ifdim\pgf@x<0pt\relax%
		\advance\pgf@x360pt\relax%
		\fi%
		\edef\angletolowerleftpoint{\pgfmath@tonumber{\pgf@x}}%
	}
	\savedmacro{\angletolowerrightpoint}{%
		\pgf@x\pgftriangleapexangle pt\relax%
		\divide\pgf@x4\relax%
		\advance\pgf@x225pt%
		\advance\pgf@x\pgftrianglerotate pt\relax%
		\pgfmathmod@{\pgfmath@tonumber{\pgf@x}}{360}%
		\pgf@x\pgfmathresult pt\relax%
		\ifdim\pgf@x<0pt\relax%
		\advance\pgf@x360pt\relax%
		\fi%
		\edef\angletolowerrightpoint{\pgfmath@tonumber{\pgf@x}}%
	}
	\savedmacro{\angletoapex}{%
		\pgf@x\pgftrianglerotate pt\relax%
		\pgfmathmod@{\pgfmath@tonumber{\pgf@x}}{360}%
		\pgf@x\pgfmathresult pt\relax%
		\ifdim\pgf@x<0pt\relax%
		\advance\pgf@x360pt\relax%
		\fi%
		\edef\angletoapex{\pgfmath@tonumber{\pgf@x}}%
	}
	\saveddimen{\radius}{%
		\pgfmathsetlength\pgf@x{+\pgfshapeinnerxsep}%
		\pgfmathaddtolength\pgf@x{+.5\wd\pgfnodeparttextbox}%
		\pgfmathsetlength\pgf@y{+\pgfshapeinnerysep}%
		\pgfmathaddtolength\pgf@y{+.5\ht\pgfnodeparttextbox}%
		\pgfmathaddtolength\pgf@y{+.5\dp\pgfnodeparttextbox}%
		\ifdim\pgf@x<\pgf@y%
			\pgf@x\pgf@y%
		\fi%
		\pgfmathveclen@{\pgfmath@tonumber{\pgf@x}}{\pgfmath@tonumber{\pgf@x}}%
		\pgf@x\pgfmathresult pt\relax%
		%
		% Now adjust the incircle radius r for minimum height H,
		% and minimum width W. If a is the apex angle, then
		%
		% r >= H * sin(a/2) / (1 + sin(a/2)), and
		% r >= W / 2 * cos(a/2) / (1 + sin(a/2))
		%
		% Adjusting the height changes the width (and vice versa)
		% in order to maintain the apex angle of the triangle.
		%
		\pgfmathsetlength\pgf@ya{+\pgfshapeminheight}%
		\pgfmathsetlength\pgf@yb{+\pgfshapeminwidth}%
		\pgf@xb\pgftriangleapexangle pt\relax%
		\divide\pgf@xb2\relax%
		\pgfmathsin@{\pgfmath@tonumber{\pgf@xb}}%
		\pgf@ya\pgfmathresult\pgf@ya\relax%
		\pgf@xc\pgfmathresult pt\relax%
		\advance\pgf@xc1pt\relax%
		\pgfmathreciprocal@{\pgfmath@tonumber{\pgf@xc}}%
		\pgf@ya\pgfmathresult\pgf@ya%
		\pgf@yb\pgfmathresult\pgf@yb%
		\pgfmathcos@{\pgfmath@tonumber{\pgf@xb}}%
		\pgf@yb\pgfmathresult\pgf@yb%	
		\pgf@yb.5\pgf@yb%	
		%
		% ya is the incircle radius for the minimum height
		% yb is the incircle radius for the minimum width
		%
		\ifdim\pgf@x<\pgf@ya%
			\pgf@x\pgf@ya%
		\fi%
		\ifdim\pgf@x<\pgf@yb%
			\pgf@x\pgf@yb%
		\fi%
	}
	\saveddimen{\apexradius}{%
		%
		% This is the distance from the center of the
		% incircle to the apex of the triangle.
		%
		\pgfmathsetlength\pgf@x{+\pgfshapeinnerxsep}%
		\pgfmathaddtolength\pgf@x{+.5\wd\pgfnodeparttextbox}%
		\pgfmathsetlength\pgf@y{+\pgfshapeinnerysep}%
		\pgfmathaddtolength\pgf@y{+.5\ht\pgfnodeparttextbox}%
		\pgfmathaddtolength\pgf@y{+.5\dp\pgfnodeparttextbox}%
		\ifdim\pgf@x<\pgf@y%
			\pgf@x\pgf@y%
		\fi%
		\pgfmathveclen@{\pgfmath@tonumber{\pgf@x}}{\pgfmath@tonumber{\pgf@x}}%
		\pgf@x\pgfmathresult pt\relax%
		\pgfmathsetlength\pgf@ya{+\pgfshapeminheight}%
		\pgfmathsetlength\pgf@yb{+\pgfshapeminwidth}%
		\pgf@xb\pgftriangleapexangle pt\relax%
		\divide\pgf@xb2\relax%
		\pgfmathsin@{\pgfmath@tonumber{\pgf@xb}}%
		\pgf@ya\pgfmathresult\pgf@ya\relax%
		\pgf@xc\pgfmathresult pt\relax%
		\advance\pgf@xc1pt\relax%
		\pgfmathreciprocal@{\pgfmath@tonumber{\pgf@xc}}%
		\pgf@ya\pgfmathresult\pgf@ya%
		\pgf@yb\pgfmathresult\pgf@yb%
		\pgfmathcos@{\pgfmath@tonumber{\pgf@xb}}%
		\pgf@yb\pgfmathresult\pgf@yb%	
		\pgf@yb.5\pgf@yb%	
		\ifdim\pgf@x<\pgf@ya%
			\pgf@x\pgf@ya%
		\fi%
		\ifdim\pgf@x<\pgf@yb%
			\pgf@x\pgf@yb%
		\fi%
		\pgfmathsetlength\pgf@xa{+\pgfshapeouterxsep}%
		\pgfmathsetlength\pgf@ya{+\pgfshapeouterysep}%
		\ifdim\pgf@xa<\pgf@ya%
			\pgf@xa\pgf@ya%
		\fi%
		\advance\pgf@x\pgf@xa%	
		\pgf@xa\pgftriangleapexangle pt\relax%
		\divide\pgf@xa2\relax%
		\pgfmathsin@{\pgfmath@tonumber{\pgf@xa}}%
		\pgfmathreciprocal@{\pgfmathresult}%
		\pgf@x\pgfmathresult\pgf@x%	
	}
	\saveddimen{\lowerpointradius}{%
		%
		% This is the distance from the center of the
		% incircle to the lower left or right point
		% of the triangle.
		%
		\pgfmathsetlength\pgf@x{+\pgfshapeinnerxsep}%
		\pgfmathaddtolength\pgf@x{+.5\wd\pgfnodeparttextbox}%
		\pgfmathsetlength\pgf@y{+\pgfshapeinnerysep}%
		\pgfmathaddtolength\pgf@y{+.5\ht\pgfnodeparttextbox}%
		\pgfmathaddtolength\pgf@y{+.5\dp\pgfnodeparttextbox}%
		\ifdim\pgf@x<\pgf@y%
			\pgf@x\pgf@y%
		\fi%
		\pgfmathveclen@{\pgfmath@tonumber{\pgf@x}}{\pgfmath@tonumber{\pgf@x}}%
		\pgf@x\pgfmathresult pt\relax%
		\pgfmathsetlength\pgf@ya{+\pgfshapeminheight}%
		\pgfmathsetlength\pgf@yb{+\pgfshapeminwidth}%
		\pgf@xb\pgftriangleapexangle pt\relax%
		\divide\pgf@xb2\relax%
		\pgfmathsin@{\pgfmath@tonumber{\pgf@xb}}%
		\pgf@ya\pgfmathresult\pgf@ya\relax%
		\pgf@xc\pgfmathresult pt\relax%
		\advance\pgf@xc1pt\relax%
		\pgfmathreciprocal@{\pgfmath@tonumber{\pgf@xc}}%
		\pgf@ya\pgfmathresult\pgf@ya%
		\pgf@yb\pgfmathresult\pgf@yb%
		\pgfmathcos@{\pgfmath@tonumber{\pgf@xb}}%
		\pgf@yb\pgfmathresult\pgf@yb%	
		\pgf@yb.5\pgf@yb%	
		\ifdim\pgf@x<\pgf@ya%
			\pgf@x\pgf@ya%
		\fi%
		\ifdim\pgf@x<\pgf@yb%
			\pgf@x\pgf@yb%
		\fi%
		\pgfmathsetlength\pgf@xa{+\pgfshapeouterxsep}%
		\pgfmathsetlength\pgf@ya{+\pgfshapeouterysep}%
		\ifdim\pgf@xa<\pgf@ya%
			\pgf@xa\pgf@ya%
		\fi%
		\advance\pgf@x\pgf@xa%
		\pgf@y\pgftriangleapexangle pt\relax%
		\divide\pgf@y-4\relax%
		\advance\pgf@y45pt\relax%
		\pgfmathsin@{\pgfmath@tonumber{\pgf@y}}%
		\pgfmathreciprocal@{\pgfmathresult}%
		\pgf@x\pgfmathresult\pgf@x%
	}
	\savedanchor{\centerpoint}{%
		\pgfmathsetlength\pgf@x{+.5\wd\pgfnodeparttextbox}%
		\pgfmathsetlength\pgf@y{+.5\ht\pgfnodeparttextbox}%
		\pgfmathaddtolength\pgf@y{+-.5\dp\pgfnodeparttextbox}%
	}
	\anchor{center}{\centerpoint}
	\anchor{base}{\centerpoint\pgf@y0pt\relax}
	\anchor{mid}{\centerpoint\pgfmathsetlength\pgf@y{+.5ex}}
	\anchor{north}{%
		%
		% A teensy bit clumsy, but guarantees the 
		% point is outside the triangle border.
		%
		\pgf@y\apexradius\relax%
		\advance\pgf@y\lowerpointradius%
		\csname pgf@anchor@isosceles triangle@border\endcsname{\pgfqpointpolar{90}{\the\pgf@y}}%
	}
	\anchor{south}{%
		\pgf@y\apexradius\relax%
		\advance\pgf@y\lowerpointradius%
		\csname pgf@anchor@isosceles triangle@border\endcsname{\pgfqpointpolar{270}{\the\pgf@y}}%
	}
	\anchor{east}{%
		\pgf@y\apexradius\relax%
		\advance\pgf@y\lowerpointradius%
		\csname pgf@anchor@isosceles triangle@border\endcsname{\pgfqpointpolar{0}{\the\pgf@y}}%
	}
	\anchor{west}{%
		\pgf@y\apexradius\relax%
		\advance\pgf@y\lowerpointradius%
		\csname pgf@anchor@isosceles triangle@border\endcsname{\pgfqpointpolar{180}{\the\pgf@y}}%
	}	
	\anchor{north west}{%
		\pgf@y\apexradius\relax%
		\advance\pgf@y\lowerpointradius%
		\csname pgf@anchor@isosceles triangle@border\endcsname{\pgfqpointpolar{135}{\the\pgf@y}}%
	}	
	\anchor{north east}{%
		\pgf@y\apexradius\relax%
		\advance\pgf@y\lowerpointradius%
		\csname pgf@anchor@isosceles triangle@border\endcsname{\pgfqpointpolar{45}{\the\pgf@y}}%
	}	
	\anchor{south west}{%
		\pgf@y\apexradius\relax%
		\advance\pgf@y\lowerpointradius%
		\csname pgf@anchor@isosceles triangle@border\endcsname{\pgfqpointpolar{225}{\the\pgf@y}}%
	}	
	\anchor{south east}{%
		\pgf@y\apexradius\relax%
		\advance\pgf@y\lowerpointradius%
		\csname pgf@anchor@isosceles triangle@border\endcsname{\pgfqpointpolar{315}{\the\pgf@y}}%
	}	
	\anchor{apex}{%
		\pgf@process{\pgfqpointpolar{\angletoapex}{\apexradius}}%
		\pgf@xa\pgf@x%
		\pgf@ya\pgf@y%
		\centerpoint%
		\advance\pgf@x\pgf@xa%
		\advance\pgf@y\pgf@ya%
	}
	\anchor{point 1}{%
		\pgf@process{\pgfqpointpolar{\angletoapex}{\apexradius}}%
		\pgf@xa\pgf@x%
		\pgf@ya\pgf@y%
		\centerpoint%
		\advance\pgf@x\pgf@xa%
		\advance\pgf@y\pgf@ya%
	}
	\anchor{point 2}{%
		\pgf@process{\pgfqpointpolar{\angletolowerleftpoint}{\lowerpointradius}}%
		\pgf@xa\pgf@x%
		\pgf@ya\pgf@y%
		\centerpoint%
		\advance\pgf@x\pgf@xa%
		\advance\pgf@y\pgf@ya%
	}
	\anchor{point 3}{%
		\pgf@process{\pgfqpointpolar{\angletolowerrightpoint}{\lowerpointradius}}%
		\pgf@xa\pgf@x%
		\pgf@ya\pgf@y%
		\centerpoint%
		\advance\pgf@x\pgf@xa%
		\advance\pgf@y\pgf@ya%
	}
	\anchor{side 1}{%
		\pgf@process{\pgfqpointpolar{\angletolowerleftpoint}{\lowerpointradius}}%
		\pgf@xa\pgf@x%
		\pgf@ya\pgf@y%
		\centerpoint%
		\advance\pgf@x\pgf@xa%
		\advance\pgf@y\pgf@ya%
		\edef\firstpoint{\noexpand\pgf@x\the\pgf@x\noexpand\pgf@y\the\pgf@y}%
		\pgf@process{\pgfqpointpolar{\angletoapex}{\apexradius}}%
		\pgf@xa\pgf@x%
		\pgf@ya\pgf@y%
		\centerpoint%
		\advance\pgf@x\pgf@xa%
		\advance\pgf@y\pgf@ya%
		\edef\secondpoint{\noexpand\pgf@x\the\pgf@x\noexpand\pgf@y\the\pgf@y}%
		\pgfpointlineattime{0.5}{\firstpoint}{\secondpoint}%
	}
	\anchor{side 2}{%
		\pgf@process{\pgfqpointpolar{\angletolowerleftpoint}{\lowerpointradius}}%
		\pgf@xa\pgf@x%
		\pgf@ya\pgf@y%
		\centerpoint%
		\advance\pgf@x\pgf@xa%
		\advance\pgf@y\pgf@ya%
		\edef\firstpoint{\noexpand\pgf@x\the\pgf@x\noexpand\pgf@y\the\pgf@y}%
		\pgf@process{\pgfqpointpolar{\angletolowerrightpoint}{\lowerpointradius}}%
		\pgf@xa\pgf@x%
		\pgf@ya\pgf@y%
		\centerpoint%
		\advance\pgf@x\pgf@xa%
		\advance\pgf@y\pgf@ya%
		\edef\secondpoint{\noexpand\pgf@x\the\pgf@x\noexpand\pgf@y\the\pgf@y}%
		\pgfpointlineattime{0.5}{\firstpoint}{\secondpoint}%
	}
	\anchor{side 3}{%
		\pgf@process{\pgfqpointpolar{\angletolowerrightpoint}{\lowerpointradius}}%
		\pgf@xa\pgf@x%
		\pgf@ya\pgf@y%
		\centerpoint%
		\advance\pgf@x\pgf@xa%
		\advance\pgf@y\pgf@ya%
		\edef\firstpoint{\noexpand\pgf@x\the\pgf@x\noexpand\pgf@y\the\pgf@y}%
		\pgf@process{\pgfqpointpolar{\angletoapex}{\apexradius}}%
		\pgf@xa\pgf@x%
		\pgf@ya\pgf@y%
		\centerpoint%
		\advance\pgf@x\pgf@xa%
		\advance\pgf@y\pgf@ya%
		\edef\secondpoint{\noexpand\pgf@x\the\pgf@x\noexpand\pgf@y\the\pgf@y}%
		\pgfpointlineattime{0.5}{\firstpoint}{\secondpoint}%
	}
	\backgroundpath{%
		\pgf@x\radius\relax%
		\pgf@y\angle pt\relax%
		\divide\pgf@y2\relax%
		\pgfmathsin@{\pgfmath@tonumber{\pgf@y}}%
		\pgfmathreciprocal@{\pgfmathresult}%
		\pgf@xa\pgfmathresult\pgf@x%
		\edef\apexradius{\the\pgf@xa}%
		\divide\pgf@y-2\relax%
		\advance\pgf@y45pt\relax%
		\pgfmathsin@{\pgfmath@tonumber{\pgf@y}}%
		\pgfmathreciprocal@{\pgfmathresult}%
		\pgf@xa\pgfmathresult\pgf@x%
		\edef\lowerpointradius{\the\pgf@xa}%
		\pgfpathmoveto{\pgfpointadd{\centerpoint}{\pgfqpointpolar{\angletoapex}{\apexradius}}}%
		\pgfpathlineto{\pgfpointadd{\centerpoint}{\pgfqpointpolar{\angletolowerleftpoint}{\lowerpointradius}}}%
		\pgfpathlineto{\pgfpointadd{\centerpoint}{\pgfqpointpolar{\angletolowerrightpoint}{\lowerpointradius}}}%
		\pgfpathclose%
	}
	\anchorborder{%
		%
		% Save x and y.
		%
		\edef\externalx{\the\pgf@x}%
		\edef\externaly{\the\pgf@y}%
		%
		% Adjust the location of the external 
		% point relative to the centerpoint.
		%
		\centerpoint%
		\pgf@xa\externalx\relax%
		\pgf@ya\externaly\relax%
		\advance\pgf@xa\pgf@x%
		\advance\pgf@ya\pgf@y%
		\edef\externalx{\the\pgf@xa}%
		\edef\externaly{\the\pgf@ya}%
		%
		% Get the angle of the external point.
		%
		\pgfmathanglebetweenpoints{\centerpoint}{\pgfqpoint{\externalx}{\externaly}}%
		\let\externalangle\pgfmathresult%
		%
		% Locate the appropriate side on the border...
		%		
		\ifdim\externalangle pt<\angletoapex pt\relax%
			\pgf@process{\pgfpointadd{\centerpoint}{\pgfqpointpolar{\angletolowerrightpoint}{\lowerpointradius}}}%
			\edef\firstpoint{\noexpand\pgf@x\the\pgf@x\noexpand\pgf@y\the\pgf@y}%
			\pgf@process{\pgfpointadd{\centerpoint}{\pgfqpointpolar{\angletoapex}{\apexradius}}}%
			\edef\secondpoint{\noexpand\pgf@x\the\pgf@x\noexpand\pgf@y\the\pgf@y}%
		\else%
			\ifdim\externalangle pt<\angletolowerleftpoint pt\relax%
				\pgf@process{\pgfpointadd{\centerpoint}{\pgfqpointpolar{\angletoapex}{\apexradius}}}%
				\edef\firstpoint{\noexpand\pgf@x\the\pgf@x\noexpand\pgf@y\the\pgf@y}%
				\pgf@process{\pgfpointadd{\centerpoint}{\pgfqpointpolar{\angletolowerleftpoint}{\lowerpointradius}}}%
				\edef\secondpoint{\noexpand\pgf@x\the\pgf@x\noexpand\pgf@y\the\pgf@y}%
			\else%
				\ifdim\externalangle pt<\angletolowerrightpoint pt\relax%
					\pgf@process{\pgfpointadd{\centerpoint}{\pgfqpointpolar{\angletolowerleftpoint}{\lowerpointradius}}}%
					\edef\firstpoint{\noexpand\pgf@x\the\pgf@x\noexpand\pgf@y\the\pgf@y}%
					\pgf@process{\pgfpointadd{\centerpoint}{\pgfqpointpolar{\angletolowerrightpoint}{\lowerpointradius}}}%
					\edef\secondpoint{\noexpand\pgf@x\the\pgf@x\noexpand\pgf@y\the\pgf@y}%
				\else%
					\pgf@process{\pgfpointadd{\centerpoint}{\pgfqpointpolar{\angletolowerrightpoint}{\lowerpointradius}}}%
					\edef\firstpoint{\noexpand\pgf@x\the\pgf@x\noexpand\pgf@y\the\pgf@y}%
					\pgf@process{\pgfpointadd{\centerpoint}{\pgfqpointpolar{\angletoapex}{\apexradius}}}%
					\edef\secondpoint{\noexpand\pgf@x\the\pgf@x\noexpand\pgf@y\the\pgf@y}%
		\fi\fi\fi%
		% ...and hence the point on the border.
		\pgfpointintersectionoflines{\centerpoint}{\pgfqpoint{\externalx}{\externaly}}%
			{\firstpoint}{\secondpoint}%
		}
}

% \pgfsettrapeziumleftextension
%
% Set the extension of the lower left corner of the trapezium. 
% Negative extensions extend the upper left corner.
%
\def\pgfsettrapeziumleftextension#1{%
	\pgfmathparse{#1}%
	\edef\pgftrapeziumleftextension{\pgfmathresult pt}%
}

% \pgfsettrapeziumleftextension
%
% Set the extension of the lower right corner of the trapezium. 
% Negative extensions extend the upper right corner.
%
\def\pgfsettrapeziumrightextension#1{%
	\pgfmathparse{#1}%
	\edef\pgftrapeziumrightextension{\pgfmathresult pt}%
}

 
% \pgfsettrapeziumleftextension
% 
% Set both lower corner extensions. Negative 
% extensions extend the upper corners.
%
\def\pgfsettrapeziumextension#1{%
	\pgfmathparse{#1}%
	\edef\pgftrapeziumleftextension{\pgfmathresult pt}%
	\edef\pgftrapeziumrightextension{\pgfmathresult pt}%
}
\pgfsettrapeziumextension{1.5ex}

\pgfdeclareshape{trapezium}{
	\saveddimen{\leftextension}{\pgf@x\pgftrapeziumleftextension\relax}%
	\saveddimen{\rightextension}{\pgf@x\pgftrapeziumrightextension\relax}%
	\saveddimen{\linewidth}{\pgfmathsetlength\pgf@x{+\pgflinewidth}}%
	\saveddimen{\halfwidth}{%
		\pgfmathsetlength\pgf@x{+\pgfshapeinnerxsep}%
		\pgfmathaddtolength\pgf@x{+.5\wd\pgfnodeparttextbox}
		\pgfmathaddtolength\pgf@x{+\pgfshapeouterxsep}%
	}
	\saveddimen{\halfheight}{%
		\pgfmathsetlength\pgf@x{+\pgfshapeinnerysep}%
		\pgfmathaddtolength\pgf@x{+.5\ht\pgfnodeparttextbox}%
		\pgfmathaddtolength\pgf@x{+.5\dp\pgfnodeparttextbox}%
		\pgfmathsetlength\pgf@y{+\pgfshapeminheight}%
		\ifdim\pgf@x<.5\pgf@y%
			\pgf@x.5\pgf@y
		\fi%
		\pgfmathaddtolength\pgf@x{+\pgfshapeouterysep}%
	}%
	\savedmacro{\rightcosangle}{%
		\pgfmathsetlength\pgf@x{+\pgftrapeziumrightextension}%
		\pgfmathsetlength\pgf@y{+\pgfshapeinnerysep}%
		\pgfmathaddtolength\pgf@y{+.5\ht\pgfnodeparttextbox}%
		\pgfmathaddtolength\pgf@y{+.5\dp\pgfnodeparttextbox}%
		\multiply\pgf@y2\relax%
		\pgfmathveclen@{\pgfmath@tonumber{\pgf@x}}{\pgfmath@tonumber{\pgf@y}}%
		\pgfmathreciprocal@{\pgfmathresult}%
		\pgf@x\pgfmathresult\pgf@y%
		\def\rightcosangle{\pgfmath@tonumber{\pgf@x}}%
	}
	\savedmacro{\leftcosangle}{%
		\pgfmathsetlength\pgf@x{+\pgftrapeziumleftextension}%
		\pgfmathsetlength\pgf@y{+\pgfshapeinnerysep}%
		\pgfmathaddtolength\pgf@y{+.5\ht\pgfnodeparttextbox}%
		\pgfmathaddtolength\pgf@y{+.5\dp\pgfnodeparttextbox}%
		\multiply\pgf@y2\relax%
		\pgfmathveclen@{\pgfmath@tonumber{\pgf@x}}{\pgfmath@tonumber{\pgf@y}}%
		\pgfmathreciprocal@{\pgfmathresult}%
		\pgf@x\pgfmathresult\pgf@y%
		\def\leftcosangle{\pgfmath@tonumber{\pgf@x}}%
	}
	\saveddimen{\outerxsep}{%
		\pgfmathsetlength\pgf@x{+\pgfshapeouterxsep}%
	}%
	\saveddimen{\outerysep}{%
		\pgfmathsetlength\pgf@x{+\pgfshapeouterysep}%
	}%
	\saveddimen{\upperleft}{%
		\pgfmathsetlength\pgf@x{+-\pgfshapeinnerxsep}%
		\pgfmathaddtolength\pgf@x{+-.5\wd\pgfnodeparttextbox}%
		\pgfmathsetlength\pgf@xa{+\pgftrapeziumleftextension}%
		\pgfmathsetlength\pgf@xb{+\pgfshapeminwidth}%
		\ifdim\pgf@xa<0pt\relax%
			\advance\pgf@x\pgf@xa%
		\else%
			\advance\pgf@x-\pgf@xa%
		\fi%
		\ifdim\pgf@x>-.5\pgf@xb%
			\pgf@x-.5\pgf@xb%
		\fi%
		\ifdim\pgf@xa>0pt\relax%
			\advance\pgf@x\pgf@xa%
		\fi%
		\pgfmathsetlength\pgf@xa{+-\pgfshapeouterxsep}%
		\advance\pgf@x\pgf@xa}%
	\saveddimen{\upperright}{%
		\pgfmathsetlength\pgf@x{+\pgfshapeinnerxsep}%
		\pgfmathaddtolength\pgf@x{+.5\wd\pgfnodeparttextbox}%
		\pgfmathsetlength\pgf@xa{+\pgftrapeziumrightextension}%
		\pgfmathsetlength\pgf@xb{+\pgfshapeminwidth}%
		\ifdim\pgf@xa>0pt\relax%
			\advance\pgf@x\pgf@xa%
		\else%
			\advance\pgf@x-\pgf@xa%
		\fi%
		\ifdim\pgf@x<.5\pgf@xb%
			\pgf@x.5\pgf@xb%
		\fi%
		\ifdim\pgf@xa>0pt\relax%
			\advance\pgf@x-\pgf@xa%
		\fi%
		\pgfmathsetlength\pgf@xa{+\pgfshapeouterxsep}%
		\advance\pgf@x\pgf@xa}%
	\saveddimen{\lowerright}{%
		\pgfmathsetlength\pgf@x{+\pgfshapeinnerxsep}%
		\pgfmathaddtolength\pgf@x{+.5\wd\pgfnodeparttextbox}%
		\pgfmathsetlength\pgf@xa{+\pgftrapeziumrightextension}%
		\pgfmathsetlength\pgf@xb{+\pgfshapeminwidth}%
		\ifdim\pgf@xa>0pt\relax%
			\advance\pgf@x\pgf@xa%
		\else%
			\advance\pgf@x-\pgf@xa%
		\fi%
		\ifdim\pgf@x<.5\pgf@xb%
			\pgf@x.5\pgf@xb%
		\fi%
		\ifdim\pgf@xa<0pt\relax%
			\advance\pgf@x\pgf@xa%
		\fi%
		\pgfmathsetlength\pgf@xa{+\pgfshapeouterxsep}%
		\advance\pgf@x\pgf@xa}%
	\saveddimen{\lowerleft}{%
		\pgfmathsetlength\pgf@x{+-\pgfshapeinnerxsep}%
		\pgfmathaddtolength\pgf@x{+-.5\wd\pgfnodeparttextbox}%
		\pgfmathsetlength\pgf@xa{+\pgftrapeziumleftextension}%
		\pgfmathsetlength\pgf@xb{+\pgfshapeminwidth}%
		\ifdim\pgf@xa<0pt\relax%
			\advance\pgf@x\pgf@xa%
		\else%
			\advance\pgf@x-\pgf@xa%
		\fi%
		\ifdim\pgf@x>-.5\pgf@xb%
			\pgf@x-.5\pgf@xb%
		\fi%
		\ifdim\pgf@xa<0pt\relax%
			\advance\pgf@x-\pgf@xa%
		\fi%
		\pgfmathsetlength\pgf@xa{+-\pgfshapeouterxsep}%
		\advance\pgf@x\pgf@xa}%
	\savedanchor{\centerpoint}{%
		\pgfmathsetlength\pgf@x{+.5\wd\pgfnodeparttextbox}%
		\pgfmathsetlength\pgf@y{+.5\ht\pgfnodeparttextbox}%
		\pgfmathaddtolength\pgf@y{-.5\dp\pgfnodeparttextbox}%	
	}
	\anchor{center}{\centerpoint}
	\anchor{mid}{\centerpoint\pgfmathsetlength\pgf@y{+.5ex}}
	\anchor{base}{\centerpoint\pgf@y0pt}
	\anchor{north}{\centerpoint\advance\pgf@y\halfheight\relax}
	\anchor{south}{\centerpoint\advance\pgf@y-\halfheight\relax}
	\anchor{east}{%
		\centerpoint%
		\advance\pgf@x\halfwidth%
		\advance\pgf@x-\outerxsep\relax%
		\pgf@xa\upperright\relax%
		\advance\pgf@xa-\lowerright\relax%
		\pgf@xa.5\pgf@xa%
		\ifdim\pgf@xa<0pt\relax%
			\advance\pgf@x-\pgf@xa%
		\else%
			\advance\pgf@x\pgf@xa%
		\fi%
		\pgf@xa\outerxsep\relax%
		\pgfmathreciprocal@{\rightcosangle}%
		\pgf@xa\pgfmathresult\pgf@xa\relax%
		\advance\pgf@x\pgf@xa%
	}
	\anchor{west}{%
		\centerpoint%
		\advance\pgf@x-\halfwidth%
		\advance\pgf@x\outerxsep\relax%
		\pgf@xa\upperleft\relax%
		\advance\pgf@xa-\lowerleft\relax%
		\pgf@xa.5\pgf@xa%
		\ifdim\pgf@xa<0pt\relax%
			\advance\pgf@x\pgf@xa%
		\else%
			\advance\pgf@x-\pgf@xa%
		\fi%
		\pgf@xa\outerxsep\relax%
		\pgfmathreciprocal@{\leftcosangle}%
		\pgf@xa\pgfmathresult\pgf@xa\relax%
		\advance\pgf@x-\pgf@xa%
	}
	\anchor{north east}{%	
		%
		% To calculate this border point, we need to take into account the
		% mitre length at the join for larger line widths (see Adobe spec). 
		% We use the angle which is the half angle between the joining lines...
		%
		\pgfmathanglebetweenpoints%
			{\pgfpointadd{\centerpoint}{\pgfqpoint{\upperright}{\halfheight}}}%
			{\pgfpointadd{\centerpoint}{\pgfqpoint{\lowerright}{-\halfheight}}}%
		\pgf@xa\pgfmathresult pt%
		\advance\pgf@xa-180pt\relax%
		\divide\pgf@xa2\relax%
		\edef\angle{\the\pgf@xa}%
		\pgfmathsin@{\pgfmath@tonumber{\pgf@xa}}%
		\pgfmathreciprocal@{\pgfmathresult}%
		%
		% ...we then recalculate the outer x and y sep. 
		%
		\pgf@xb\outerxsep\relax%
		\pgf@xb\pgfmathresult\pgf@xb%
		\pgf@yb\outerysep\relax%
		\pgf@yb\pgfmathresult\pgf@yb%
		%
		% Move to the point with no outer sep...
		%
		\centerpoint%
		\advance\pgf@x\upperright\relax%
		\advance\pgf@x-\outerxsep\relax%
		\advance\pgf@y\halfheight\relax%
		\advance\pgf@y-\outerysep\relax%
		%
		% ... and add the outer sep.
		%
		\pgfmathcos@{\pgfmath@tonumber{\pgf@xa}}%
		\pgf@xc\pgfmathresult\pgf@xb
		\pgfmathsin@{\pgfmath@tonumber{\pgf@xa}}%
		\pgf@yc\pgfmathresult\pgf@yb
		\advance\pgf@x\pgf@xc\relax%
		\advance\pgf@y\pgf@yc\relax%
	}
	\anchor{north west}{%
		\pgfmathanglebetweenpoints%
			{\pgfpointadd{\centerpoint}{\pgfqpoint{\upperleft}{\halfheight}}}%
			{\pgfpointadd{\centerpoint}{\pgfqpoint{\lowerleft}{-\halfheight}}}%
		\pgf@xa-\pgfmathresult pt%
		\advance\pgf@xa360pt\relax%
		\divide\pgf@xa2\relax%
		\edef\angle{\the\pgf@xa}%
		\pgfmathsin@{\pgfmath@tonumber{\pgf@xa}}%
		\pgfmathreciprocal@{\pgfmathresult}%
		\pgf@xb\outerxsep\relax%
		\pgf@xb\pgfmathresult\pgf@xb%
		\pgf@yb\outerysep\relax%
		\pgf@yb\pgfmathresult\pgf@yb%
		\centerpoint%
		\advance\pgf@x\upperleft\relax%
		\advance\pgf@x\outerxsep\relax%
		\advance\pgf@y\halfheight\relax%
		\advance\pgf@y-\outerysep\relax%
		\pgfmathcos@{\pgfmath@tonumber{\pgf@xa}}%
		\pgf@xc\pgfmathresult\pgf@xb
		\pgfmathsin@{\pgfmath@tonumber{\pgf@xa}}%
		\pgf@yc\pgfmathresult\pgf@yb
		\advance\pgf@x-\pgf@xc\relax%
		\advance\pgf@y\pgf@yc\relax%
	}	
	\anchor{south west}{%
		\pgfmathanglebetweenpoints%
			{\pgfpointadd{\centerpoint}{\pgfqpoint{\lowerleft}{-\halfheight}}}%
			{\pgfpointadd{\centerpoint}{\pgfqpoint{\upperleft}{\halfheight}}}%
		\pgf@xa\pgfmathresult pt%
		\divide\pgf@xa2\relax%
		\edef\angle{\the\pgf@xa}%
		\pgfmathsin@{\pgfmath@tonumber{\pgf@xa}}%
		\pgfmathreciprocal@{\pgfmathresult}%
		\pgf@xb\outerxsep\relax%
		\pgf@xb\pgfmathresult\pgf@xb%
		\pgf@yb\outerysep\relax%
		\pgf@yb\pgfmathresult\pgf@yb%
		\centerpoint%
		\advance\pgf@x\lowerleft\relax%
		\advance\pgf@x\outerxsep\relax%
		\advance\pgf@y-\halfheight\relax%
		\advance\pgf@y\outerysep\relax%
		\pgfmathcos@{\pgfmath@tonumber{\pgf@xa}}%
		\pgf@xc\pgfmathresult\pgf@xb
		\pgfmathsin@{\pgfmath@tonumber{\pgf@xa}}%
		\pgf@yc\pgfmathresult\pgf@yb
		\advance\pgf@x-\pgf@xc\relax%
		\advance\pgf@y-\pgf@yc\relax%
	}%
	\anchor{south east}{%
		\pgfmathanglebetweenpoints%
			{\pgfpointadd{\centerpoint}{\pgfqpoint{\lowerright}{-\halfheight}}}%
			{\pgfpointadd{\centerpoint}{\pgfqpoint{\upperright}{\halfheight}}}%
		\pgf@xa-\pgfmathresult pt%
		\advance\pgf@xa180pt\relax%
		\divide\pgf@xa2\relax%
		\edef\angle{\the\pgf@xa}%
		\pgfmathsin@{\pgfmath@tonumber{\pgf@xa}}%
		\pgfmathreciprocal@{\pgfmathresult}%
		\pgf@xb\outerxsep\relax%
		\pgf@xb\pgfmathresult\pgf@xb%
		\pgf@yb\outerysep\relax%
		\pgf@yb\pgfmathresult\pgf@yb%
		\centerpoint%
		\advance\pgf@x\lowerright\relax%
		\advance\pgf@x-\outerxsep\relax%
		\advance\pgf@y-\halfheight\relax%
		\advance\pgf@y\outerysep\relax%
		\pgfmathcos@{\pgfmath@tonumber{\pgf@xa}}%
		\pgf@xc\pgfmathresult\pgf@xb
		\pgfmathsin@{\pgfmath@tonumber{\pgf@xa}}%
		\pgf@yc\pgfmathresult\pgf@yb
		\advance\pgf@x\pgf@xc\relax%
		\advance\pgf@y-\pgf@yc\relax%
	}		
	\backgroundpath{%
		%
		% Remove the outer sep from the parameters...
		%
		\pgf@x\upperleft\relax%
		\advance\pgf@x\pgfshapeouterxsep\relax%
		\edef\upperleft{\the\pgf@x}%
		\pgf@x\upperright\relax%
		\advance\pgf@x-\pgfshapeouterxsep\relax%
		\edef\upperright{\the\pgf@x}%
		\pgf@x\lowerleft\relax%
		\advance\pgf@x\pgfshapeouterxsep\relax%
		\edef\lowerleft{\the\pgf@x}%
		\pgf@x\lowerright\relax%
		\advance\pgf@x-\pgfshapeouterxsep\relax%
		\edef\lowerright{\the\pgf@x}%
		\pgf@x\halfheight\relax%
		\advance\pgf@x-\pgfshapeouterysep\relax%
		\edef\halfheight{\the\pgf@x}%
		%
		% ...and create path.
		%
		\pgfpathmoveto{\pgfpointadd{\centerpoint}{\pgfqpoint{\upperleft}{\halfheight}}}%
		\pgfpathlineto{\pgfpointadd{\centerpoint}{\pgfqpoint{\upperright}{\halfheight}}}%
		\pgfpathlineto{\pgfpointadd{\centerpoint}{\pgfqpoint{\lowerright}{-\halfheight}}}%
		\pgfpathlineto{\pgfpointadd{\centerpoint}{\pgfqpoint{\lowerleft}{-\halfheight}}}%
		\pgfpathclose}
	\anchorborder{%
		%
		% Save x and y.
		%
		\edef\externalx{\the\pgf@x}%
		\edef\externaly{\the\pgf@y}%
		%
		% Adjust the location of the external 
		% point relative to the centerpoint.
		%
		\centerpoint%
		\pgf@xa\externalx\relax%
		\pgf@ya\externaly\relax%
		\advance\pgf@xa\pgf@x%
		\advance\pgf@ya\pgf@y%
		\edef\externalx{\the\pgf@xa}%
		\edef\externaly{\the\pgf@ya}%
		%
		% Get the angle of the external point.
		%
		\pgfmathanglebetweenpoints{\centerpoint}{\pgfqpoint{\externalx}{\externaly}}%
		\let\externalangle\pgfmathresult%
		\pgfmathanglebetweenpoints{\pgf@x0pt\pgf@y0pt}{\pgfqpoint{\upperright}{\halfheight}}
		\let\upperrightangle\pgfmathresult%
		\pgfmathanglebetweenpoints{\pgf@x0pt\pgf@y0pt}{\pgfqpoint{\upperleft}{\halfheight}}
		\let\upperleftangle\pgfmathresult%
		\pgfmathanglebetweenpoints{\pgf@x0pt\pgf@y0pt}{\pgfqpoint{\lowerleft}{-\halfheight}}
		\let\lowerleftangle\pgfmathresult%
		\pgfmathanglebetweenpoints{\pgf@x0pt\pgf@y0pt}{\pgfqpoint{\lowerright}{-\halfheight}}
		\let\lowerrightangle\pgfmathresult%
		\ifdim\externalangle pt<\upperrightangle pt\relax%
			\pgf@process{\pgfpointadd{\centerpoint}{\pgfqpoint{\upperright}{\halfheight}}}%
			\edef\firstpoint{\noexpand\pgf@x\the\pgf@x\noexpand\pgf@y\the\pgf@y}%
			\pgf@process{\pgfpointadd{\centerpoint}{\pgfqpoint{\lowerright}{-\halfheight}}}%
			\edef\secondpoint{\noexpand\pgf@x\the\pgf@x\noexpand\pgf@y\the\pgf@y}%
		\else%
			\ifdim\externalangle pt<\upperleftangle pt\relax%
				\pgf@process{\pgfpointadd{\centerpoint}{\pgfqpoint{\upperleft}{\halfheight}}}%
				\edef\firstpoint{\noexpand\pgf@x\the\pgf@x\noexpand\pgf@y\the\pgf@y}%
				\pgf@process{\pgfpointadd{\centerpoint}{\pgfqpoint{\upperright}{\halfheight}}}%
				\edef\secondpoint{\noexpand\pgf@x\the\pgf@x\noexpand\pgf@y\the\pgf@y}%
			\else%
				\ifdim\externalangle pt<\lowerleftangle pt\relax%
					\pgf@process{\pgfpointadd{\centerpoint}{\pgfqpoint{\lowerleft}{-\halfheight}}}%
					\edef\firstpoint{\noexpand\pgf@x\the\pgf@x\noexpand\pgf@y\the\pgf@y}%
					\pgf@process{\pgfpointadd{\centerpoint}{\pgfqpoint{\upperleft}{\halfheight}}}%
					\edef\secondpoint{\noexpand\pgf@x\the\pgf@x\noexpand\pgf@y\the\pgf@y}%
				\else%
					\ifdim\externalangle pt<\lowerrightangle pt\relax%
						\pgf@process{\pgfpointadd{\centerpoint}{\pgfqpoint{\lowerleft}{-\halfheight}}}%
						\edef\firstpoint{\noexpand\pgf@x\the\pgf@x\noexpand\pgf@y\the\pgf@y}%
						\pgf@process{\pgfpointadd{\centerpoint}{\pgfqpoint{\lowerright}{-\halfheight}}}%
						\edef\secondpoint{\noexpand\pgf@x\the\pgf@x\noexpand\pgf@y\the\pgf@y}%
					\else%
							\pgf@process{\pgfpointadd{\centerpoint}{\pgfqpoint{\upperright}{\halfheight}}}%
							\edef\firstpoint{\noexpand\pgf@x\the\pgf@x\noexpand\pgf@y\the\pgf@y}%
							\pgf@process{\pgfpointadd{\centerpoint}{\pgfqpoint{\lowerright}{-\halfheight}}}%
							\edef\secondpoint{\noexpand\pgf@x\the\pgf@x\noexpand\pgf@y\the\pgf@y}%
		\fi\fi\fi\fi%
		\pgfpointintersectionoflines{\centerpoint}{\pgfqpoint{\externalx}{\externaly}}%
			{\firstpoint}{\secondpoint}%
		}
}

% Shape simple isosceles triangle
%
\pgfdeclareshape{simple isosceles triangle}{
	\savedmacro{\rotate}{%
		\pgfmathsetcount\c@pgf@counta{+\pgftrianglerotate}%
		\advance\c@pgf@counta45\relax%
		\divide\c@pgf@counta90\relax%
		\multiply\c@pgf@counta90\relax%
		\ifnum\c@pgf@counta>270\relax%
			\c@pgf@counta0\relax%
		\fi%
		\edef\rotate{\the\c@pgf@counta}%
	}
	\savedmacro\installtriangleparameters{%
		%
		% Round the rotation to the nearest 90 degrees.
		%
		\pgfmathsetcount\c@pgf@counta{+\pgftrianglerotate}%
		\advance\c@pgf@counta45\relax%
		\divide\c@pgf@counta90\relax%
		\multiply\c@pgf@counta90\relax%
		\ifnum\c@pgf@counta>270\relax%
			\c@pgf@counta0\relax%
		\fi%
		\edef\rotate{\the\c@pgf@counta}%
		%
		% Get the centre of the node tex box.
		%
		\pgfmathsetlength\pgf@x{+.5\wd\pgfnodeparttextbox}%
		\pgfmathsetlength\pgf@y{+.5\ht\pgfnodeparttextbox}%
		\pgfmathaddtolength\pgf@y{+-.5\dp\pgfnodeparttextbox}%
		\edef\centerpoint{\noexpand\pgf@x\the\pgf@x\noexpand\pgf@y\the\pgf@y}%
		%
		% Now get the text box dimensions required for calculating
		% thw dimensions of the isosceles triangle.
		%
		\pgfmathaddtolength\pgf@x{+\pgfshapeinnerxsep}%
		\pgfmathaddtolength\pgf@y{+\pgfshapeinnerysep}%
		\pgfmathaddtolength\pgf@y{+\dp\pgfnodeparttextbox}%
		\ifdim\pgftrianglerotate pt<45pt\relax%
			\pgf@xa\pgf@x\pgf@x\pgf@y\pgf@y\pgf@xa%
		\else%
			\ifdim\pgftrianglerotate pt<135pt\relax%
			\else%
				\ifdim\pgftrianglerotate pt<225pt\relax%
					\pgf@xa\pgf@x\pgf@x\pgf@y\pgf@y\pgf@xa%
				\else%
					\ifdim\pgftrianglerotate pt<315pt\relax%
					\else%
						\pgf@xa\pgf@x\pgf@x\pgf@y\pgf@y\pgf@xa%
		\fi\fi\fi\fi%
		%
		% Calculate some useful angles.
		%
		\pgf@xa\pgftriangleapexangle pt\relax%
		\divide\pgf@xa2\relax%
		\pgfmathtan@{\pgfmath@tonumber{\pgf@xa}}%
		\let\tanhalfapexangle\pgfmathresult%
		\pgfmathreciprocal@{\pgfmathresult}%
		\let\reciprocaltanhalfapexangle\pgfmathresult%
		\pgfmathsin@{\pgfmath@tonumber{\pgf@xa}}%
		\pgfmathreciprocal@{\pgfmathresult}%
		\let\reciprocalsinhalfapexangle\pgfmathresult%
		\pgfmathcos@{\pgfmath@tonumber{\pgf@xa}}%
		\pgfmathreciprocal@{\pgfmathresult}%
		\let\reciprocalcoshalfapexangle\pgfmathresult%
		\divide\pgf@xa-2\relax%
		\advance\pgf@xa45pt\relax%
		\pgfmathtan@{\pgfmath@tonumber{\pgf@xa}}%
		\pgfmathreciprocal@{\pgfmathresult}%
		\let\reciprocaltanhalfbaseangle\pgfmathresult%
		%
		% Now the triangle dimensions.
		%
		\pgf@ya\pgf@y%
		\advance\pgf@ya\pgf@y%
		\pgf@xa\tanhalfapexangle\pgf@ya%
		\pgfmathsetlength\pgf@xb{+\pgfshapeminwidth}%
		\ifdim\pgf@xa<.5\pgf@xb%
			\pgf@xa.5\pgf@xb%
		\fi%
		\pgf@ya\reciprocaltanhalfapexangle\pgf@xa%
		\pgfmathsetlength\pgf@yb{+\pgfshapeminheight}%
		\ifdim\pgf@ya<\pgf@yb%
			\pgf@ya\pgf@yb%
			\pgf@xa\tanhalfapexangle\pgf@ya%
		\fi%
		\pgf@yb\reciprocaltanhalfapexangle\pgf@x%
		\advance\pgf@yb\pgf@y%
		\advance\pgf@yb\pgf@y%
		\ifdim\pgf@yb>\pgf@ya%
			\pgf@ya\pgf@yb%
			\pgf@xa\tanhalfapexangle\pgf@ya%
		\fi%
		\edef\trianglehalfbase{\the\pgf@xa}%
		\edef\triangletotalheight{\the\pgf@ya}%
		\pgf@yb-\pgf@yb%
		\advance\pgf@yb\pgf@ya%
		\pgf@yb.33333\pgf@yb%
		\advance\pgf@yb\pgf@y%
		\edef\triangledepth{\the\pgf@yb}%
		\advance\pgf@ya-\pgf@yb%
		\edef\triangleheight{\the\pgf@ya}%
		%
		% Now calcualte the outer sep (taking into account the 
		% miter which is different at the apex than at the
		% triangle base).
		%
		\pgfmathsetlength\pgf@ya{+\pgfshapeouterysep}%
		\pgfmathsetlength\pgf@xa{+\pgfshapeouterxsep}%
		\ifdim\pgf@ya>\pgf@xa%
			\pgf@xa\pgf@ya%
		\fi%
		\edef\outersep{\the\pgf@xa}%
		\pgf@ya\outersep\relax%
		\edef\bottomsep{\the\pgf@ya}%
		\pgf@ya\reciprocalsinhalfapexangle\pgf@ya%
		\edef\topsep{\the\pgf@ya}%
		\pgf@xa\outersep\relax%
		\pgf@xa\reciprocaltanhalfbaseangle\pgf@xa%
		\edef\basesep{\the\pgf@xa}%
		\pgf@xa\outersep\relax%
		\pgf@xa\reciprocalcoshalfapexangle\pgf@xa%
		\edef\sidesep{\the\pgf@xa}%
		%
		% Now the points of the triangle are created on the
		% basis of the rotation (0, 90, 180 or 270 degrees).
		%
		% \pointone is always the apex of the triangle.
		% \pointtwo is the next clockwise angle from \pointone.
		% \pointthree is the next clockwise angle from \pointtwo.
		%
		% Also the point vector for the relevant outer sep is 
		% computed for each point.
		%
		\ifnum\rotate=0\relax%
			\pgf@process{\pgfpointadd{\centerpoint}{\pgfqpoint{\triangleheight}{0pt}}}%
			\edef\pointone{\noexpand\pgf@x\the\pgf@x\noexpand\pgf@y\the\pgf@y}%
			\pgf@process{\pgfpointadd{\centerpoint}{\pgfqpoint{-\triangledepth}{\trianglehalfbase}}}%
			\edef\pointtwo{\noexpand\pgf@x\the\pgf@x\noexpand\pgf@y\the\pgf@y}%
			\pgf@process{\pgfpointadd{\centerpoint}{\pgfqpoint{-\triangledepth}{-\trianglehalfbase}}}%
			\edef\pointthree{\noexpand\pgf@x\the\pgf@x\noexpand\pgf@y\the\pgf@y}%
			%
			\pgf@process{\pgfqpoint{\topsep}{0pt}}%
			\edef\pointonesep{\noexpand\pgf@x\the\pgf@x\noexpand\pgf@y\the\pgf@y}%
			\pgf@process{\pgfqpoint{-\bottomsep}{\basesep}}%
			\edef\pointtwosep{\noexpand\pgf@x\the\pgf@x\noexpand\pgf@y\the\pgf@y}%
			\pgf@process{\pgfqpoint{-\bottomsep}{-\basesep}}%
			\edef\pointthreesep{\noexpand\pgf@x\the\pgf@x\noexpand\pgf@y\the\pgf@y}%
			%
		\else%
			\ifnum\rotate=90\relax%
				\pgf@process{\pgfpointadd{\centerpoint}{\pgfqpoint{0pt}{\triangleheight}}}%
				\edef\pointone{\noexpand\pgf@x\the\pgf@x\noexpand\pgf@y\the\pgf@y}%
				\pgf@process{\pgfpointadd{\centerpoint}{\pgfqpoint{-\trianglehalfbase}{-\triangledepth}}}%
				\edef\pointtwo{\noexpand\pgf@x\the\pgf@x\noexpand\pgf@y\the\pgf@y}%
				\pgf@process{\pgfpointadd{\centerpoint}{\pgfqpoint{\trianglehalfbase}{-\triangledepth}}}%
				\edef\pointthree{\noexpand\pgf@x\the\pgf@x\noexpand\pgf@y\the\pgf@y}%
				%
				\pgf@process{\pgfqpoint{0pt}{\topsep}}%
				\edef\pointonesep{\noexpand\pgf@x\the\pgf@x\noexpand\pgf@y\the\pgf@y}%
				\pgf@process{\pgfqpoint{-\basesep}{-\bottomsep}}%
				\edef\pointtwosep{\noexpand\pgf@x\the\pgf@x\noexpand\pgf@y\the\pgf@y}%
				\pgf@process{\pgfqpoint{\basesep}{-\bottomsep}}%
				\edef\pointthreesep{\noexpand\pgf@x\the\pgf@x\noexpand\pgf@y\the\pgf@y}%
				%
			\else%
				\ifnum\rotate=180\relax%
					\pgf@process{\pgfpointadd{\centerpoint}{\pgfqpoint{-\triangleheight}{0pt}}}%
					\edef\pointone{\noexpand\pgf@x\the\pgf@x\noexpand\pgf@y\the\pgf@y}%
					\pgf@process{\pgfpointadd{\centerpoint}{\pgfqpoint{\triangledepth}{-\trianglehalfbase}}}%
					\edef\pointtwo{\noexpand\pgf@x\the\pgf@x\noexpand\pgf@y\the\pgf@y}%
					\pgf@process{\pgfpointadd{\centerpoint}{\pgfqpoint{\triangledepth}{\trianglehalfbase}}}%
					\edef\pointthree{\noexpand\pgf@x\the\pgf@x\noexpand\pgf@y\the\pgf@y}%
					%
					\pgf@process{\pgfqpoint{-\topsep}{0pt}}%
					\edef\pointonesep{\noexpand\pgf@x\the\pgf@x\noexpand\pgf@y\the\pgf@y}%
					\pgf@process{\pgfqpoint{\bottomsep}{-\basesep}}%
					\edef\pointtwosep{\noexpand\pgf@x\the\pgf@x\noexpand\pgf@y\the\pgf@y}%
					\pgf@process{\pgfqpoint{\bottomsep}{\basesep}}%
					\edef\pointthreesep{\noexpand\pgf@x\the\pgf@x\noexpand\pgf@y\the\pgf@y}%
					%
				\else%
					\ifnum\rotate=270\relax%
						\pgf@process{\pgfpointadd{\centerpoint}{\pgfqpoint{0pt}{-\triangleheight}}}%
						\edef\pointone{\noexpand\pgf@x\the\pgf@x\noexpand\pgf@y\the\pgf@y}%
						\pgf@process{\pgfpointadd{\centerpoint}{\pgfqpoint{\trianglehalfbase}{\triangledepth}}}%
						\edef\pointtwo{\noexpand\pgf@x\the\pgf@x\noexpand\pgf@y\the\pgf@y}%
						\pgf@process{\pgfpointadd{\centerpoint}{\pgfqpoint{-\trianglehalfbase}{\triangledepth}}}%
						\edef\pointthree{\noexpand\pgf@x\the\pgf@x\noexpand\pgf@y\the\pgf@y}%
						%
						\pgf@process{\pgfqpoint{0pt}{-\topsep}}%
						\edef\pointonesep{\noexpand\pgf@x\the\pgf@x\noexpand\pgf@y\the\pgf@y}%
						\pgf@process{\pgfqpoint{\basesep}{\bottomsep}}%
						\edef\pointtwosep{\noexpand\pgf@x\the\pgf@x\noexpand\pgf@y\the\pgf@y}%
						\pgf@process{\pgfqpoint{-\basesep}{\bottomsep}}%
						\edef\pointthreesep{\noexpand\pgf@x\the\pgf@x\noexpand\pgf@y\the\pgf@y}%
		\fi\fi\fi\fi%
		%
		% Add the outer sep to the points for the anchors...
		%
		\pgf@process{\pgfpointadd{\pointone}{\pointonesep}}%
		\edef\pointone{\noexpand\pgf@x\the\pgf@x\noexpand\pgf@y\the\pgf@y}%
		\pgf@process{\pgfpointadd{\pointtwo}{\pointtwosep}}%
		\edef\pointtwo{\noexpand\pgf@x\the\pgf@x\noexpand\pgf@y\the\pgf@y}%
		\pgf@process{\pgfpointadd{\pointthree}{\pointthreesep}}%
		\edef\pointthree{\noexpand\pgf@x\the\pgf@x\noexpand\pgf@y\the\pgf@y}%
		%
		% ...but reverse the outer sep vectors for drawing the border.
		%
		\pgf@process{\pointonesep}%
		\pgf@x-\pgf@x\pgf@y-\pgf@y%
		\edef\pointonesep{\noexpand\pgf@x\the\pgf@x\noexpand\pgf@y\the\pgf@y}%
		\pgf@process{\pointtwosep}%
		\pgf@x-\pgf@x\pgf@y-\pgf@y%
		\edef\pointtwosep{\noexpand\pgf@x\the\pgf@x\noexpand\pgf@y\the\pgf@y}%
		\pgf@process{\pointthreesep}%
		\pgf@x-\pgf@x\pgf@y-\pgf@y%
		\edef\pointthreesep{\noexpand\pgf@x\the\pgf@x\noexpand\pgf@y\the\pgf@y}%
		%
		% Now calculate the angles for each point.
		%
		\pgfmathanglebetweenpoints{\centerpoint}{\pointone}%
		\let\angletofirstpoint\pgfmathresult%
		\pgfmathanglebetweenpoints{\centerpoint}{\pointtwo}%
		\let\angletosecondpoint\pgfmathresult%
		\pgfmathanglebetweenpoints{\centerpoint}{\pointthree}%
		\let\angletothirdpoint\pgfmathresult%
		%
		% Oh, the power of saved macros! Lots of things defined at once!
		%
		\def\installtriangleparameters{%
			\noexpand\def\noexpand\pointone{\pointone}%
			\noexpand\def\noexpand\pointtwo{\pointtwo}%
			\noexpand\def\noexpand\pointthree{\pointthree}%
			\noexpand\def\noexpand\pointonesep{\pointonesep}%
			\noexpand\def\noexpand\pointtwosep{\pointtwosep}%
			\noexpand\def\noexpand\pointthreesep{\pointthreesep}%
			\noexpand\def\noexpand\triangletotalheight{\triangletotalheight}%
			\noexpand\def\noexpand\angletofirstpoint{\angletofirstpoint}%
			\noexpand\def\noexpand\angletosecondpoint{\angletosecondpoint}%
			\noexpand\def\noexpand\angletothirdpoint{\angletothirdpoint}%
		}%	
	}
	\savedanchor\centerpoint{%
		\pgfmathsetlength\pgf@x{+.5\wd\pgfnodeparttextbox}%
		\pgfmathsetlength\pgf@y{+.5\ht\pgfnodeparttextbox}%
		\pgfmathaddtolength\pgf@y{+-.5\dp\pgfnodeparttextbox}%
	}
	\anchor{center}{\centerpoint}
	\anchor{base}{\centerpoint\pgf@y0pt}
	\anchor{mid}{\centerpoint\pgfmathsetlength\pgf@y{+0.5ex}}%
	\anchor{point 1}{%
		\installtriangleparameters%
		\pointone}
	\anchor{apex}{%
		\installtriangleparameters%
		\pointone}
	\anchor{point 2}{%
		\installtriangleparameters%
		\pointtwo}
	\anchor{point 3}{%
		\installtriangleparameters%
		\pointthree}
	\anchor{side 1}{%
		\installtriangleparameters%
		\pgfpointlineattime{0.5}{\pointone}{\pointtwo}%
		}
	\anchor{side 2}{%
		\installtriangleparameters%
		\pgfpointlineattime{0.5}{\pointtwo}{\pointthree}%
	}
	\anchor{side 3}{%
		\installtriangleparameters%
		\pgfpointlineattime{0.5}{\pointthree}{\pointone}%
	}
	\anchor{north}{%
		%
		% A teensy bit clumsy, but guarantees the 
		% point is outside the triangle border.
		%
		\installtriangleparameters%
		\csname pgf@anchor@simple isosceles triangle@border\endcsname{\pgfqpointpolar{90}{\triangletotalheight}}%
	}
	\anchor{south}{%
		\installtriangleparameters%
		\csname pgf@anchor@simple isosceles triangle@border\endcsname{\pgfqpointpolar{270}{\triangletotalheight}}%
	}
	\anchor{east}{%
		\installtriangleparameters%
		\csname pgf@anchor@simple isosceles triangle@border\endcsname{\pgfqpointpolar{0}{\triangletotalheight}}%
	}
	\anchor{west}{%
		\installtriangleparameters%
		\csname pgf@anchor@simple isosceles triangle@border\endcsname{\pgfqpointpolar{180}{\triangletotalheight}}%
	}	
	\anchor{north west}{%
		\installtriangleparameters%
		\csname pgf@anchor@simple isosceles triangle@border\endcsname{\pgfqpointpolar{135}{\triangletotalheight}}%
	}	
	\anchor{north east}{%
		\installtriangleparameters%
		\csname pgf@anchor@simple isosceles triangle@border\endcsname{\pgfqpointpolar{45}{\triangletotalheight}}%
	}	
	\anchor{south west}{%
		\installtriangleparameters%
		\csname pgf@anchor@simple isosceles triangle@border\endcsname{\pgfqpointpolar{225}{\triangletotalheight}}%
	}	
	\anchor{south east}{%
		\installtriangleparameters%
		\csname pgf@anchor@simple isosceles triangle@border\endcsname{\pgfqpointpolar{315}{\triangletotalheight}}%
	}	
	\backgroundpath{%
		\installtriangleparameters%
		\pgfpathmoveto{\pgfpointadd{\pointone}{\pointonesep}}%
		\pgfpathlineto{\pgfpointadd{\pointtwo}{\pointtwosep}}%
		\pgfpathlineto{\pgfpointadd{\pointthree}{\pointthreesep}}%
		\pgfpathclose%
	}
	\anchorborder{%
		%
		% Save x and y.
		%
		\edef\externalx{\the\pgf@x}%
		\edef\externaly{\the\pgf@y}%
		%
		% Adjust the location of the external 
		% point relative to the centerpoint.
		%
		\centerpoint%
		\pgf@xa\externalx\relax%
		\pgf@ya\externaly\relax%
		\advance\pgf@xa\pgf@x%
		\advance\pgf@ya\pgf@y%
		\edef\externalx{\the\pgf@xa}%
		\edef\externaly{\the\pgf@ya}%
		%
		% Get the angle of the external point.
		%
		\pgfmathanglebetweenpoints{\centerpoint}{\pgfqpoint{\externalx}{\externaly}}%
		\let\externalangle\pgfmathresult%
		%
		% Locate the appropriate side on the border...
		%	
		\installtriangleparameters%
		\ifnum\rotate=0\relax%
			\ifdim\externalangle pt<\angletosecondpoint pt\relax%
				\let\firstpoint\pointone%
				\let\secondpoint\pointtwo%
			\else%
				\ifdim\externalangle pt<\angletothirdpoint pt\relax%
					\let\firstpoint\pointtwo%
					\let\secondpoint\pointthree%
				\else%
					\let\firstpoint\pointone%
					\let\secondpoint\pointthree%
			\fi\fi%
		\else
			\ifnum\rotate=90\relax%			
				\ifdim\externalangle pt<\angletofirstpoint pt\relax%
					\let\firstpoint\pointone%
					\let\secondpoint\pointthree%
				\else%
					\ifdim\externalangle pt<\angletosecondpoint pt\relax%
						\let\firstpoint\pointone%
						\let\secondpoint\pointtwo%
					\else%
						\ifdim\externalangle pt<\angletothirdpoint pt\relax%
							\let\firstpoint\pointtwo%
							\let\secondpoint\pointthree%
						\else%
							\let\firstpoint\pointone%
							\let\secondpoint\pointthree%
				\fi\fi\fi%
			\else%
				\ifnum\rotate=180\relax%
					\ifdim\externalangle pt<\angletothirdpoint pt\relax%
						\let\firstpoint\pointtwo%
						\let\secondpoint\pointthree%
					\else%
						\ifdim\externalangle pt<\angletofirstpoint pt\relax%
							\let\firstpoint\pointone%
							\let\secondpoint\pointthree%
						\else%
							\ifdim\externalangle pt<\angletosecondpoint pt\relax%
								\let\firstpoint\pointone%
								\let\secondpoint\pointtwo%
							\else%
								\let\firstpoint\pointtwo%
								\let\secondpoint\pointthree%
					\fi\fi\fi%
				\else%
					\ifnum\rotate=270\relax%
						\ifdim\externalangle pt<\angletosecondpoint pt\relax%
							\let\firstpoint\pointone%
							\let\secondpoint\pointtwo%
						\else%
							\ifdim\externalangle pt<\angletothirdpoint pt\relax%
								\let\firstpoint\pointtwo%
								\let\secondpoint\pointthree%
							\else%
								\ifdim\externalangle pt<\angletofirstpoint pt\relax%
									\let\firstpoint\pointone%
									\let\secondpoint\pointthree%
								\else%
									\let\firstpoint\pointone%
									\let\secondpoint\pointtwo%
						\fi\fi\fi%
		\fi\fi\fi\fi%
		% ...and hence the point on the border.
		\pgfpointintersectionoflines{\centerpoint}{\pgfqpoint{\externalx}{\externaly}}%
			{\firstpoint}{\secondpoint}%
	}
}




% \pgfsetsemicirclerotate
% 
% Set the rotation of the semicircle border.
%
\def\pgfsetsemicirclerotate#1{\pgfmathsetmacro\pgfsemicirclerotate{#1}}
\pgfsetsemicirclerotate{90}

% \pgfsavepgf@process
%
% Little `helper' macro.
%
\def\pgfsavepgf@process#1#2{\pgf@process{#2}\edef#1{\noexpand\pgf@x\the\pgf@x\noexpand\pgf@y\the\pgf@y}}

% Shape semicircle
%
%
\pgfdeclareshape{semicircle}{
	\savedmacro\rotate{%
		\pgfmathsetcount\c@pgf@counta{+\pgfsemicirclerotate}%
		\advance\c@pgf@counta45\relax%
		\divide\c@pgf@counta90\relax%
		\multiply\c@pgf@counta90\relax%
		\ifnum\c@pgf@counta>270\relax%
			\c@pgf@counta0\relax%
		\fi%
		\edef\rotate{\the\c@pgf@counta}%
	}	
	\savedmacro\installsemicircleparameters{%
		%
		% Round the rotation to the nearest 90 degrees.
		%
		\pgfmathsetcount\c@pgf@counta{+\pgfsemicirclerotate}%
		\advance\c@pgf@counta45\relax%
		\divide\c@pgf@counta90\relax%
		\multiply\c@pgf@counta90\relax%
		\ifnum\c@pgf@counta>270\relax%
			\c@pgf@counta0\relax%
		\fi%
		\edef\rotate{\the\c@pgf@counta}%
		%
		% Calculate the radius of the semi-circle, and the
		% 'offset' which is the distance from the center of
		% the node to the distance of the semicircle.
		%
		\pgfmathsetlength\pgf@x{+\pgfshapeinnerxsep}%
		\pgfmathaddtolength\pgf@x{+\wd\pgfnodeparttextbox}%
		\pgfmathsetlength\pgf@y{+\pgfshapeinnerysep}%
		\pgfmathaddtolength\pgf@y{+\ht\pgfnodeparttextbox}%
		\pgfmathaddtolength\pgf@y{+\dp\pgfnodeparttextbox}%
		%
		% xa is the radius
		% xb and yb are the minimum width and height.
		% xc is the offset
		%
		\ifnum\rotate=0\relax%
			\pgf@ya.5\pgf@y%
			\pgfmathveclen@{\pgfmath@tonumber{\pgf@x}}{\pgfmath@tonumber{\pgf@ya}}%
			\pgf@xa\pgfmathresult pt\relax%
			\pgfmathsetlength\pgf@xb{+\pgfshapeminheight}%
			\pgfmathsetlength\pgf@yb{+\pgfshapeminwidth}%
			\pgf@yb.5\pgf@yb% half as we compare to the radius.
			\pgf@xc.5\pgf@x%
		\else%
			\ifnum\rotate=90\relax%
				\pgf@xa.5\pgf@x%
				\pgfmathveclen@{\pgfmath@tonumber{\pgf@xa}}{\pgfmath@tonumber{\pgf@y}}%
				\pgf@xa\pgfmathresult pt\relax%
				\pgfmathsetlength\pgf@xb{+\pgfshapeminwidth}%
				\pgf@xb.5\pgf@xb%
				\pgfmathsetlength\pgf@yb{+\pgfshapeminheight}%
				\pgf@xc.5\pgf@y%
			\else%
				\ifnum\rotate=180\relax%
					\pgf@ya.5\pgf@y%
					\pgfmathveclen@{\pgfmath@tonumber{\pgf@x}}{\pgfmath@tonumber{\pgf@ya}}%
					\pgf@xa\pgfmathresult pt\relax%
					\pgfmathsetlength\pgf@xb{+\pgfshapeminheight}%
					\pgfmathsetlength\pgf@yb{+\pgfshapeminwidth}%
					\pgf@yb.5\pgf@yb%
					\pgf@xc.5\pgf@x%
				\else%
					\pgf@xa.5\pgf@x%
					\pgfmathveclen@{\pgfmath@tonumber{\pgf@xa}}{\pgfmath@tonumber{\pgf@y}}%
					\pgf@xa\pgfmathresult pt\relax%
					\pgfmathsetlength\pgf@xb{+\pgfshapeminwidth}%
					\pgf@xb.5\pgf@xb%
					\pgfmathsetlength\pgf@yb{+\pgfshapeminheight}%
					\pgf@xc.5\pgf@y%
		\fi\fi\fi%
		\ifdim\pgf@xb<\pgf@yb%
			\pgf@xb\pgf@yb%
		\fi%
		\ifdim\pgf@xa<\pgf@xb%
			\pgf@ya-\pgf@xa%
			\pgf@xa\pgf@xb%
			\advance\pgf@ya\pgf@xa%
			\pgf@ya.5\pgf@ya%
			\advance\pgf@xc\pgf@ya%
		\fi%
		\pgfmathsetlength\pgf@xb{+\pgfshapeouterxsep}%
		\pgfmathsetlength\pgf@yb{+\pgfshapeouterysep}%
		\ifdim\pgf@xb>\pgf@yb%
			\pgf@xb\pgf@yb%
		\fi%
		\edef\outersep{\the\pgf@xb}%
		\advance\pgf@xa\pgf@xb%
		\edef\radius{\the\pgf@xa}%
		%\advance\pgf@xc\pgf@xb%
		\edef\offset{\the\pgf@xc}%
		%
		% Get the centre of the node tex box.
		%
		\pgfmathsetlength\pgf@x{+.5\wd\pgfnodeparttextbox}%
		\pgfmathsetlength\pgf@y{+.5\ht\pgfnodeparttextbox}%
		\pgfmathaddtolength\pgf@y{+-.5\dp\pgfnodeparttextbox}%
		\edef\centerpoint{\noexpand\pgf@x\the\pgf@x\noexpand\pgf@y\the\pgf@y}%
		%
		% Calculate the center of the semi-circle, and the angle
		% from the node center to the ends of the semi-circle arc.
		%
		\ifnum\rotate=0\relax%
			\pgfsavepgf@process\semicirclecenter{%
				\centerpoint%
				\advance\pgf@x-\offset}%
			\pgfsavepgf@process\semicircleendpoint{%
				\semicirclecenter%
				\advance\pgf@y\radius\relax%
			}%
			\pgfsavepgf@process\semicircleouterendpoint{%
				\semicircleendpoint%
				\advance\pgf@x-\outersep%
			}%
			\pgfsavepgf@process\semicirclestartpoint{%
				\semicirclecenter%
				\advance\pgf@y-\radius\relax%
			}%
			\pgfsavepgf@process\semicircleouterstartpoint{%
				\semicirclestartpoint%
				\advance\pgf@x-\outersep\relax%
			}%
		\else%
			\ifnum\rotate=90\relax%
				\pgfsavepgf@process\semicirclecenter{%
					\centerpoint%
					\advance\pgf@y-\offset}%
				\pgfsavepgf@process\semicircleendpoint{%
					\semicirclecenter%
					\advance\pgf@x-\radius\relax%
				}%
				\pgfsavepgf@process\semicircleouterendpoint{%
					\semicircleendpoint%
					\advance\pgf@y-\outersep%
				}%
				\pgfsavepgf@process\semicirclestartpoint{%
					\semicirclecenter%
					\advance\pgf@x\radius\relax%
				}%
				\pgfsavepgf@process\semicircleouterstartpoint{%
					\semicirclestartpoint%
					\advance\pgf@y-\outersep\relax%
				}%
			\else%
				\ifnum\rotate=180\relax%
					\pgfsavepgf@process\semicirclecenter{%
						\centerpoint%
						\advance\pgf@x\offset}%
					\pgfsavepgf@process\semicircleendpoint{%
						\semicirclecenter%
						\advance\pgf@y-\radius\relax%
					}%
					\pgfsavepgf@process\semicircleouterendpoint{%
						\semicircleendpoint%
						\advance\pgf@x\outersep%
					}%
					\pgfsavepgf@process\semicirclestartpoint{%
						\semicirclecenter%
					\advance\pgf@y\radius\relax%
					}%
					\pgfsavepgf@process\semicircleouterstartpoint{%
						\semicirclestartpoint%
						\advance\pgf@x\outersep\relax%
					}%
				\else%
					\pgfsavepgf@process\semicirclecenter{%
						\centerpoint%
						\advance\pgf@y\offset}%
					\pgfsavepgf@process\semicircleendpoint{%
						\semicirclecenter%
						\advance\pgf@x\radius\relax%
					}%
					\pgfsavepgf@process\semicircleouterendpoint{%
						\semicircleendpoint%
						\advance\pgf@y\outersep%
					}%
					\pgfsavepgf@process\semicirclestartpoint{%
						\semicirclecenter%
					\advance\pgf@x-\radius\relax%
					}%
					\pgfsavepgf@process\semicircleouterstartpoint{%
						\semicirclestartpoint%
						\advance\pgf@y\outersep\relax%
					}%
		\fi\fi\fi%
		%
		% Calculate the angles between the center of the node
		% and various points on the semi-circle border.
		%
		\pgfmathanglebetweenpoints{\centerpoint}{\semicirclestartpoint}%
		\let\angletoarcstart\pgfmathresult%
		\pgfmathanglebetweenpoints{\centerpoint}{\semicircleouterstartpoint}%
		\let\angletoouterstartpoint\pgfmathresult%
		\pgfmathanglebetweenpoints{\centerpoint}{\semicircleendpoint}%
		\let\angletoarcend\pgfmathresult%
		\pgfmathanglebetweenpoints{\centerpoint}{\semicircleouterendpoint}%
		\let\angletoouterendpoint\pgfmathresult%
		%
		% Now save the stuff...
		%
		\def\installsemicircleparameters{%
			\noexpand\def\noexpand\semicirclecenter{\semicirclecenter}%
			\noexpand\def\noexpand\radius{\radius}%
			\noexpand\def\noexpand\offset{\offset}%	
			\noexpand\def\noexpand\outersep{\outersep}%	
			\noexpand\def\noexpand\angletoarcstart{\angletoarcstart}%
			\noexpand\def\noexpand\angletoarcend{\angletoarcend}%	
			\noexpand\def\noexpand\angletoouterstartpoint{\angletoouterstartpoint}%
			\noexpand\def\noexpand\angletoouterendpoint{\angletoouterendpoint}%	
			\noexpand\def\noexpand\semicircleendpoint{\semicircleendpoint}%
			\noexpand\def\noexpand\semicircleouterendpoint{\semicircleouterendpoint}%
			\noexpand\def\noexpand\semicirclestartpoint{\semicirclestartpoint}%
			\noexpand\def\noexpand\semicircleouterstartpoint{\semicircleouterstartpoint}%
		}%
	}
	\savedanchor\centerpoint{%
		\pgfmathsetlength\pgf@x{+.5\wd\pgfnodeparttextbox}%
		\pgfmathsetlength\pgf@y{+.5\ht\pgfnodeparttextbox}%
		\pgfmathaddtolength\pgf@y{+-.5\dp\pgfnodeparttextbox}%	
	}
	\anchor{center}{\centerpoint}
	\anchor{base}{\centerpoint\pgf@y0pt\relax}
	\anchor{mid}{\centerpoint\pgfmathsetlength\pgf@y{0.5ex}}
	\anchor{apex}{%
		\installsemicircleparameters%
		\pgfpointadd{\semicirclecenter}{\pgfqpointpolar{\rotate}{\radius}}%
	}
	\anchor{arc start}{%
		\installsemicircleparameters%
		\semicircleouterstartpoint%
	}
	\anchor{arc end}{%
		\installsemicircleparameters%
		\semicircleouterendpoint%
	}
	\anchor{chord center}{%
		\installsemicircleparameters%
		\semicirclecenter%
		\advance\pgf@y-\outersep\relax%
	}
	\anchor{north}{%
		\installsemicircleparameters%
		\csname pgf@anchor@semicircle@border\endcsname{\pgfqpointpolar{90}{\radius}}%
	}
	\anchor{south}{%
		\installsemicircleparameters%
		\csname pgf@anchor@semicircle@border\endcsname{\pgfqpointpolar{270}{\radius}}%
	}
	\anchor{east}{%
		\installsemicircleparameters%
		\csname pgf@anchor@semicircle@border\endcsname{\pgfqpointpolar{0}{\radius}}%
	}
	\anchor{west}{%
		\installsemicircleparameters%
		\csname pgf@anchor@semicircle@border\endcsname{\pgfqpointpolar{180}{\radius}}%
	}
	\anchor{north west}{%
		\installsemicircleparameters%
		\csname pgf@anchor@semicircle@border\endcsname{\pgfqpointpolar{135}{\radius}}%
	}
	\anchor{south west}{%
		\installsemicircleparameters%
		\csname pgf@anchor@semicircle@border\endcsname{\pgfqpointpolar{225}{\radius}}%
	}
	\anchor{north east}{%
		\installsemicircleparameters%
		\csname pgf@anchor@semicircle@border\endcsname{\pgfqpointpolar{45}{\radius}}%
	}
	\anchor{south east}{%
		\installsemicircleparameters%
		\csname pgf@anchor@semicircle@border\endcsname{\pgfqpointpolar{315}{\radius}}%
	}
	\backgroundpath{%
		\installsemicircleparameters%
		%
		% Remove the outer sep.
		%
		\pgf@x\radius\relax%
		\advance\pgf@x-\outersep%
		\edef\radius{\the\pgf@x}%
		\pgf@x\offset\relax%
		\edef\offset{\the\pgf@x}%
		%
		% Draw the semi-circle.
		%
		\ifnum\rotate=0\relax%
				\pgfpathmoveto{\pgfpointadd{\centerpoint}{\pgfqpoint{-\offset}{-\radius}}}%
				\pgfpatharc{-90}{90}{\radius}%	
		\else%
			\ifnum\rotate=90\relax%
				\pgfpathmoveto{\pgfpointadd{\centerpoint}{\pgfqpoint{\radius}{-\offset}}}%
				\pgfpatharc{0}{180}{\radius}%
			\else%
				\ifnum\rotate=180\relax%
					\pgfpathmoveto{\pgfpointadd{\centerpoint}{\pgfqpoint{\offset}{\radius}}}%
					\pgfpatharc{90}{270}{\radius}%
				\else%
					\pgfpathmoveto{\pgfpointadd{\centerpoint}{\pgfqpoint{-\radius}{\offset}}}%
					\pgfpatharc{180}{360}{\radius}%
		\fi\fi\fi%
		\pgfpathclose%
	}
	\anchorborder{%
		%
		% Save x and y.
		%
		\edef\externalx{\the\pgf@x}%
		\edef\externaly{\the\pgf@y}%
		%
		% Adjust the location of the external 
		% point relative to the centerpoint.
		%
		\centerpoint%
		\pgf@xa\externalx\relax%
		\pgf@ya\externaly\relax%
		\advance\pgf@xa\pgf@x%
		\advance\pgf@ya\pgf@y%
		\edef\externalx{\the\pgf@xa}%
		\edef\externaly{\the\pgf@ya}%
		%
		% Get the angle of the external point.
		%
		\pgfmathanglebetweenpoints{\centerpoint}{\pgfqpoint{\externalx}{\externaly}}%
		\let\externalangle\pgfmathresult%
		%
		% The border point is either
		%
		% (a) on the chord of the semi-circle (easy)
	 	% (b) on the semi-circle arc (tricky)
		%
		% (a) is only *relatively* easy as the outer sep may add some
		% extra tricksyness.
		%
		% (b) is tricky because the center of the node `N' is not the center
		% of the semi-circle `O'. Assuming the rotation of the border is 90
		% degrees, `N' is a distance `x' above `O'.
		% The border point `B' is where the line from the external point `E' 
		% to `N' crosses the arc of the semi-circle, so we need to find the 
		% angle `u' such that a line from `O' at angle `u' passes through `B'.
		%	
		% Is (b) possible? You bet!
		%
		% Can it be explained without a diagram? No, but...
		%
		% Let `r' be the radius of the semi-circle.
		% Let `s' be the angle from `N' to `E
		%
		% The points `O' `C' and `B' form a triangle, so let `t' be the angle OBC.
		%
		% Then r/sin(90+s) = x/sin(t)               
		% so             t = asin(sin(90+s) * x / r)
		%
		% Now, if we had a diagram it would be obvious that
		%
		%               90 = s + t + (90 - u)
		% thus           u = s + t 
		%	                = s + asin(sin(90+s) * x / r)
		%
		% The argument can be extended to the other rotations.
		%
		\installsemicircleparameters%
		%
		% 180 is a special case as the chord crosses the 0 angle.
		%
		\ifnum\rotate=180\relax
			\ifdim\externalangle pt>\angletoarcstart pt\relax%
				\ifdim\externalangle pt<\angletoarcend pt\relax%
					\let\firstpoint\pgfutil@empty%
					\let\secondpoint\pgfutil@empty%
				\else%
					\ifdim\externalangle pt<\angletoouterendpoint pt\relax%
						\let\firstpoint\semicircleendpoint%
						\let\secondpoint\semicircleouterendpoint%
					\else%
						\let\firstpoint\semicircleouterstartpoint%
						\let\secondpoint\semicircleouterendpoint%
					\fi%
				\fi%
			\else%
				\ifdim\externalangle pt>\angletoouterstartpoint pt\relax%
					\let\firstpoint\semicirclestartpoint%
					\let\secondpoint\semicircleouterstartpoint%
				\else%
					\let\firstpoint\semicircleouterstartpoint%
					\let\secondpoint\semicircleouterendpoint%
				\fi%
			\fi%					
		\else%
			\ifdim\externalangle pt>\angletoarcend pt\relax%
				\ifdim\externalangle pt>\angletoouterendpoint pt\relax%
					\ifdim\externalangle pt>\angletoouterstartpoint pt\relax%
						\ifdim\externalangle pt<\angletoarcstart pt \relax%
							\let\firstpoint\semicirclestartpoint%
							\let\secondpoint\semicircleouterstartpoint%
						\else%
							\let\firstpoint\pgfutil@empty%
							\let\secondpoint\pgfutil@empty%
						\fi%
					\else%
						\let\firstpoint\semicircleouterendpoint%
						\let\secondpoint\semicircleouterstartpoint%
					\fi%
				\else%
						\let\firstpoint\semicircleendpoint%
						\let\secondpoint\semicircleouterendpoint%
				\fi%
			\else%
				\let\firstpoint\pgfutil@empty%
				\let\secondpoint\pgfutil@empty%
			\fi%	
		\fi%
		\ifx\firstpoint\pgfutil@empty
			%
			% Oh no! The tricky way...
			%
			\pgf@x\externalangle pt\relax%
			\ifnum\rotate=0\relax%
				\pgf@x-\pgf@x%
				\advance\pgf@x180pt\relax%
				\edef\offset{-\offset}%
			\else%
				\ifnum\rotate=90\relax%
					\advance\pgf@x90pt\relax%
				\else
					\ifnum\rotate=180\relax%
						\pgf@x-\pgf@x%
						\advance\pgf@x180pt\relax%
					\else%
						\advance\pgf@x90pt\relax%
						\edef\offset{-\offset}%
			\fi\fi\fi%
			\pgfmathsin@{\pgfmath@tonumber{\pgf@x}}%
			\let\sineangle\pgfmathresult%
			\pgf@x\radius\relax%
			\pgfmathreciprocal@{\pgfmath@tonumber{\pgf@x}}%
			\let\reciprocalradius\pgfmathresult%
			\pgf@x\offset\relax%
			\pgf@x\sineangle\pgf@x%
			\pgf@x\reciprocalradius\pgf@x%
			\pgfmathasin@{\pgfmath@tonumber{\pgf@x}}%
			\pgf@x\pgfmathresult pt\relax%
			\advance\pgf@x\externalangle pt\relax%
			\edef\angle{\pgfmath@tonumber{\pgf@x}}%
			\pgfpointadd{\semicirclecenter}{\pgfqpointpolar{\angle}{\radius}}%
		\else%
			%
			% Great! The easy way...
			%
			\pgfpointintersectionoflines{\centerpoint}{\pgfqpoint{\externalx}{\externaly}}%
				{\firstpoint}{\secondpoint}%
		\fi%						
	}
}

\endinput
