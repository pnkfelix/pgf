%--------------------------------------------
%
% TeX profiling library
% 
% Copyright 2010 by Christian Feuers√§nger.
%
% This program is free software: you can redistribute it and/or modify
% it under the terms of the GNU General Public License as published by
% the Free Software Foundation, either version 3 of the License, or
% (at your option) any later version.
% 
% This program is distributed in the hope that it will be useful,
% but WITHOUT ANY WARRANTY; without even the implied warranty of
% MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
% GNU General Public License for more details.
% 
% You should have received a copy of the GNU General Public License
% along with this program.  If not, see <http://www.gnu.org/licenses/>.
%
%--------------------------------------------

\pgfutil@ifundefined{pdfelapsedtime}{%
	\PackageError{pgf}{library 'profiler' can only be used with pdftex Rev. >= 1.671 because it needs the \string\pdfelapsedtime\space command}{}%
	\global\let\pdfelapsedtime=\c@pgf@counta
}{}

% Defines a new profiler entry named `#1'.
%
% This allocates a set of counters.
\def\pgfprofilenew#1{%
	\pgfutil@ifundefined{c@pgfprofile@elapsedtotal@#1}{%
		\expandafter\gdef\csname c@pgfprofile@elapsedtotal@#1\endcsname{0}%
		\expandafter\gdef\csname c@pgfprofile@elapsedself@#1\endcsname{0}%
		\expandafter\gdef\csname c@pgfprofile@subtractforself@#1\endcsname{0}%
		\expandafter\gdef\csname c@pgfprofile@semaphor@#1\endcsname{0}%
		\expandafter\gdef\csname c@pgfprofile@elapsed@at@start@#1\endcsname{0}%
		\pgfprofile@all@registered@list@add{#1}%
	}{%
		% it is already defined and registered. Shouldn't hurt, might
		% even be a good feature.
	}%
}%

\def\pgfprofile@TeX@DIALECT@toenvironment@begin#1{\csname #1\endcsname}%
\def\pgfprofile@TeX@DIALECT@toenvironment@end#1{\csname end#1\endcsname}%

\def\pgfprofile@@to@pgfretval#1{%
	\expandafter\let\expandafter\pgfretval#1%
}%

% Defines a new profiler entry for the environment `#1'.
%
% This calls \pgfprofilenew and handles the begin/end of the
% environment automatically.
%
% #1 the environment name (a string)
%
% Optionally in square brackets: the profiler entry name
% \pgfprofilenewforenvironment{<environment name>}
% \pgfprofilenewforenvironment[<profiler entry name>]{<environment name>}
\def\pgfprofilenewforenvironment{\pgfutil@ifnextchar[{\pgfprofilenewforenvironment@}{\pgfprofilenewforenvironment@[]}}%
\def\pgfprofilenewforenvironment@[#1]#2{%
	\expandafter\pgfprofile@@to@pgfretval\pgfprofile@TeX@DIALECT@toenvironment@begin{#2}%
	\ifx\pgfretval\relax
		\PackageError{pgf}{\string\pgfprofilenewforenvironment{#2} doesn't work: the environment `#2' is (not yet?) known or not known in this context}{}%
	\else
		\expandafter\global\expandafter\let\csname pgfprofile@orig@begin@#2\endcsname=\pgfretval
		\expandafter\pgfprofile@@to@pgfretval\pgfprofile@TeX@DIALECT@toenvironment@end{#2}%
		\expandafter\global\expandafter\let\csname pgfprofile@orig@end@#2\endcsname=\pgfretval
		%
		\def\pgfprofile@temp{#1}%
		\ifx\pgfprofile@temp\pgfutil@empty
			\pgfprofilenewforenvironment@@{\pgfprofileenv #2}{#2}%
		\else
			\pgfprofilenewforenvironment@@{#1}{#2}%
		\fi
	\fi
}%
\def\pgfprofilenewforenvironment@@#1#2{%
	\pgfprofilenew{#1}%
	\expandafter\expandafter\expandafter\gdef\pgfprofile@TeX@DIALECT@toenvironment@begin{#2}{%
		\pgfprofilestart{#1}%
		\csname pgfprofile@orig@begin@#2\endcsname
	}%
	\expandafter\expandafter\expandafter\gdef\pgfprofile@TeX@DIALECT@toenvironment@end{#2}{%
		\csname pgfprofile@orig@end@#2\endcsname
		\pgfprofileend{#1}%
	}%
}


\def\pgfprofilecs{<CS>}%
\def\pgfprofileenv{<ENV>}%

% Defines a new profiler entry for the control sequence '#1'.
%
% This calls \pgfprofilenew and enhances the control sequence with
% support for timings.
% 
% #1: the control sequence (with backslash!)
% #2: the number of arguments (see below).
% 
% The following commands are supported:
% - commands which take one (optional) argument in square brackets,
% - commands which take one (optional) argument in square brackets
%   followed by one optional argument which has to be delimited with
%   curly braces (use an empty argument for '#2' in this case),
% - commands which take one (optional) argument in square brackets
%   and *exactly* #2 arguments afterwards.
\def\pgfprofilenewforcommand{\pgfutil@ifnextchar[{\pgfprofilenewforcommand@}{\pgfprofilenewforcommand@[]}}
\def\pgfprofilenewforcommand@[#1]#2#3{%
	\ifx#2\undefined
		\PackageError{pgf}{\string\pgfprofilenewforcommand{\string#2} doesn't work: the command `\string#2' is (not yet?) known or not known in this context}{}%
	\else
	\begingroup
	\pgfprofile@cs@to@name{#2}%
	\let\pgfprofilenew@cmdname=\pgfretval
	%
	\def\pgfprofile@temp{#1}%
	\ifx\pgfprofile@temp\pgfutil@empty
		\edef\pgfprofilenew@profilerentryname{\pgfprofilecs\pgfprofilenew@cmdname}%
	\else
		\edef\pgfprofilenew@profilerentryname{#1}%
	\fi
	\expandafter\global\expandafter\let\csname pgfprofile@name@for@\pgfprofilenew@cmdname\endcsname=\pgfprofilenew@profilerentryname
	\pgfprofilenew{\pgfprofilenew@profilerentryname}%
	%
	\expandafter\global\expandafter\let\csname pgfprofile@orig@\pgfprofilenew@cmdname\endcsname=#2%
	\def\pgfprofile@temp{#3}%
	\ifx\pgfprofile@temp\pgfutil@empty
		\let\pgfprofile@temp@replacement=\pgfprofileinvokecommand@uptoonearg
	\else
		\ifcase#3\relax
			\let\pgfprofile@temp@replacement=\pgfprofileinvokecommand@noarg
		\or
			\let\pgfprofile@temp@replacement=\pgfprofileinvokecommand@onearg
		\or
			\def\pgfprofile@temp@replacement##1[##2]##3##4{%
				\pgfprofile@invokeorig{##1}[##2]{{##3}{##4}}%
			}%
		\or
			\def\pgfprofile@temp@replacement##1[##2]##3##4##5{%
				\pgfprofile@invokeorig{##1}[##2]{{##3}{##4}{##5}}%
			}%
		\or
			\def\pgfprofile@temp@replacement##1[##2]##3##4##5##6{%
				\pgfprofile@invokeorig{##1}[##2]{{##3}{##4}{##5}{##6}}%
			}%
		\or
			\def\pgfprofile@temp@replacement##1[##2]##3##4##5##6##7{%
				\pgfprofile@invokeorig{##1}[##2]{{##3}{##4}{##5}{##6}{##7}}%
			}%
		\or
			\def\pgfprofile@temp@replacement##1[##2]##3##4##5##6##7##8{%
				\pgfprofile@invokeorig{##1}[##2]{{##3}{##4}{##5}{##6}{##7}{##8}}%
			}%
		\or
			\def\pgfprofile@temp@replacement##1[##2]##3##4##5##6##7##8##9{%
				\pgfprofile@invokeorig{##1}[##2]{{##3}{##4}{##5}{##6}{##7}{##8}{##9}}%
			}%
		\else
			\PackageError{pgf}{library 'profiler' can't replace control sequences with '#3' arguments automatically, sorry.}%
		\fi
	\fi
	\expandafter\global\expandafter\let\csname pgfprofile@repl@\pgfprofilenew@cmdname\endcsname=\pgfprofile@temp@replacement
	\xdef#2{\noexpand\pgfprofileinvokecommand{\pgfprofilenew@cmdname}}%
	\endgroup
	\fi
}%

\def\pgfprofile@no@optional@arg@text{<noarg>}
\def\pgfprofileinvokecommand#1{%
	\pgfutil@ifnextchar[{\pgfprofileinvokecommand@{#1}}{\pgfprofileinvokecommand@{#1}[<noarg>]}%
}%
\def\pgfprofileinvokecommand@#1[#2]{%
	\csname pgfprofile@repl@#1\endcsname{#1}[#2]%
}%

% #3 contains ALL arguments, including any braces.
\def\pgfprofile@invokeorig#1[#2]#3{%
	\edef\pgfprofile@invokeorig@profilerentryname{\csname pgfprofile@name@for@#1\endcsname}%
	\expandafter\pgfprofilestart\expandafter{\pgfprofile@invokeorig@profilerentryname}%
	%
	\def\pgfprofile@temp{#2}%
	\ifx\pgfprofile@temp\pgfprofile@no@optional@arg@text
		\csname pgfprofile@orig@#1\endcsname#3%
	\else
		\csname pgfprofile@orig@#1\endcsname[#2]#3%
	\fi
	%
	\edef\pgfprofile@invokeorig@profilerentryname{\csname pgfprofile@name@for@#1\endcsname}%
	\expandafter\pgfprofileend\expandafter{\pgfprofile@invokeorig@profilerentryname}%
}%


\def\pgfprofileinvokecommand@uptoonearg#1[#2]{%
	\pgfutil@ifnextchar\bgroup{\pgfprofileinvokecommand@onearg{#1}[#2]}{\pgfprofileinvokecommand@noarg{#1}[#2]}%
}%
\def\pgfprofileinvokecommand@onearg#1[#2]#3{%
	\pgfprofile@invokeorig{#1}[#2]{{#3}}%
}%
\def\pgfprofileinvokecommand@noarg#1[#2]{%
	\pgfprofile@invokeorig{#1}[#2]{}%
}%



% Starts / Resumes timing of the profiler entry named `#1'.
%
% The timing will continue until \pgfprofileend{#1} is called.
%
% Nested calls of \pgfprofilestart{#1} (with the same argument) will
% result in the same result as if just one \pgfprofilestart command
% has been issued.
\def\pgfprofilestart#1{%
	\pgfprofileifisrunning{#1}{%
		\relax
	}{%
		\expandafter\xdef\csname c@pgfprofile@elapsed@at@start@#1\endcsname{\the\pdfelapsedtime}%
		\expandafter\gdef\csname c@pgfprofile@subtractforself@#1\endcsname{0}%
		\pgfprofilestackpush{#1}%
	}%
	\pgfprofile@advance{c@pgfprofile@semaphor@#1}{1}%
}%

% Stops / Interrupts timing of the profiler entry named `#1'.
\def\pgfprofileend#1{%
	\pgfprofile@advance{c@pgfprofile@semaphor@#1}{-1}%
	\pgfprofileifisrunning{#1}{%
		\relax
	}{%
		\begingroup
			\c@pgf@countb=\pdfelapsedtime\relax
			\advance\c@pgf@countb by-\csname c@pgfprofile@elapsed@at@start@#1\endcsname\relax
			%
			\pgfprofilestackpop\pgfretval
			\edef\pgfprofile@temp{#1}%
			\ifx\pgfprofile@temp\pgfretval
			\else
				\immediate\write16{pgflibraryprofiler WARNING: possible error in self time computation...}%
			\fi
			\pgfprofilestackifempty{%
				\relax
			}{%
				\pgfprofilestacktop\pgfretval
				\pgfprofile@advance{c@pgfprofile@subtractforself@\pgfretval}{\c@pgf@countb}%
			}%
			%
			\pgfprofile@advance{c@pgfprofile@elapsedtotal@#1}{\c@pgf@countb}%
			\advance\c@pgf@countb by-\csname c@pgfprofile@subtractforself@#1\endcsname\relax
			\pgfprofile@advance{c@pgfprofile@elapsedself@#1}{\c@pgf@countb}%
		\endgroup
	}%
}%

% invokes '#2' if '#1' is currently running and '#3' if not.
\def\pgfprofileifisrunning#1#2#3{%
	\ifnum\csname c@pgfprofile@semaphor@#1\endcsname=0 #3\else #2\fi
}%

% Stops all running timings and postprocesses them.
\def\pgfprofilepostprocess{%
	\begingroup
	%
	% prepare files.
	\immediate\openout\w@pgf@writea=\jobname.profiler.dat
	\immediate\write\w@pgf@writea{%
		profilerentry\pgfprofile@TAB 
		totaltime[s]\pgfprofile@TAB 
		totaltime[percent]\pgfprofile@TAB
		selftime[s]\pgfprofile@TAB
		selftime[percent]\pgfprofile@TAB}%
	%
	%
	% compute main time and prepare computation of relative times:
	\pgfprofileifisrunning{main job}{%
		\pgfprofileend{main job}%
	}{}%
	\pgf@xa=\csname c@pgfprofile@elapsedtotal@main job\endcsname sp
	\edef\pgfprofiletotaltime{\pgf@sys@tonumber\pgf@xa}%
	\pgfmath@basic@reciprocal@{\pgfprofiletotaltime}%
	\let\pgfprofiletotaltime@inv=\pgfmathresult
	%
	% postprocess each of them:
	\pgfprofile@all@registered@list@foreach{%
		\pgfprofileifisrunning{##1}{%
			\pgfprofileend{##1}%
		}{}%
		\pgfprofilepostprocess@single{##1}%
	}%
	\immediate\write\w@pgf@writea{%
		\pgfprofile@percent\space vim: ts=40 nowrap nostartofline
	}%
	\immediate\closeout\w@pgf@writea
	\endgroup
}%

{%
\catcode`\[=1 %
\catcode`\]=2 %
\catcode`\{=12 %
\catcode`\}=12 %
\catcode`\^^I=12
\gdef\pgfprofile@lbrace[{]%
\gdef\pgfprofile@rbrace[}]%
\gdef\pgfprofile@TAB[^^I]%
]
{
\catcode`\%=12 \gdef\pgfprofile@percent{%}}

\def\pgfprofilepostprocess@single#1{%
	\begingroup
	\pgf@xa=\csname c@pgfprofile@elapsedtotal@#1\endcsname sp
	\pgf@xb=\csname c@pgfprofile@elapsedself@#1\endcsname sp
	\pgf@ya=\pgfprofiletotaltime@inv\pgf@xa
	\pgf@yb=\pgfprofiletotaltime@inv\pgf@xb
	\multiply\pgf@ya by100
	\multiply\pgf@yb by100
	\edef\pgfprofilecur@total{\pgf@sys@tonumber\pgf@xa}%
	\edef\pgfprofilecur@self{\pgf@sys@tonumber\pgf@xb}%
	\edef\pgfprofilecur@total@rel{\pgf@sys@tonumber\pgf@ya}%
	\edef\pgfprofilecur@self@rel{\pgf@sys@tonumber\pgf@yb}%
	\immediate\write16{
		pgflibraryprofiler(#1) 
		\pgfprofile@lbrace 
			total time=\pgfprofilecur@total sec; (\pgfprofilecur@total@rel\pgfprofile@percent)
			self time=\pgfprofilecur@self sec; (\pgfprofilecur@self@rel\pgfprofile@percent)
		\pgfprofile@rbrace
	}%
	\immediate\write\w@pgf@writea{%
		#1\pgfprofile@TAB 
		\pgfprofilecur@total\pgfprofile@TAB 
		\pgfprofilecur@total@rel\pgfprofile@TAB
		\pgfprofilecur@self\pgfprofile@TAB
		\pgfprofilecur@self@rel\pgfprofile@TAB}%
	\endgroup
}%
% Invokes '#2' for each element of the command separated list '#1'.
% the current list element is available as '#1' inside of '#2'.
\long\def\pgfprofileforeachentryinCSV#1#2{%
	\long\def\pgfprofileinvokeforeach@@##1{#2}%
	\pgfprofileforeachentryinCSVisterminated@loop#1,\pgfeov
}%
\long\def\pgfprofileforeachentryinCSVisterminated@loop{%
	\pgfutil@ifnextchar\pgfeov{\pgfutil@gobble}{\pgfprofileforeachentryinCSV@next}%
}%
\long\def\pgfprofileforeachentryinCSV@next#1,{%
	\pgfprofileinvokeforeach@@{#1}%
	\pgfprofileforeachentryinCSVisterminated@loop%
}%

\xdef\pgfprofile@all@registered@list{}
\xdef\pgfprofile@currently@running@list{}

\def\pgfprofile@all@registered@list@add#1{%
	\ifx\pgfprofile@all@registered@list\pgfutil@empty
		\xdef\pgfprofile@all@registered@list{#1}%
	\else
		\xdef\pgfprofile@all@registered@list{\pgfprofile@all@registered@list,#1}%
	\fi
}%

\def\pgfprofile@all@registered@list@foreach#1{%
	\expandafter\pgfprofileforeachentryinCSV\expandafter{\pgfprofile@all@registered@list}{#1}%
}%

\def\pgfprofile@advance#1#2{%
	\begingroup
		\c@pgf@counta=\csname #1\endcsname\relax
		\advance\c@pgf@counta by#2\relax
		\expandafter\xdef\csname #1\endcsname{\the\c@pgf@counta}%
	\endgroup
}%

\def\pgfprofile@cs@to@name@#1#2\relax{\def\pgfretval{#2}}

% defines '\pgfretval' to be the control sequences name of '#1' *without* the backslash.
\def\pgfprofile@cs@to@name#1{%
	\expandafter\pgfprofile@cs@to@name@\string#1\relax
}%

\newcount\c@pgfprofile@stacktop

\c@pgfprofile@stacktop=-1
\def\pgfprofilestackpush#1{%
	\global\advance\c@pgfprofile@stacktop by1
	\expandafter\xdef\csname pgfprofile@stack@\the\c@pgfprofile@stacktop\endcsname{#1}%
}%
% pops the current stack top to macro #1
\def\pgfprofilestackpop#1{%
	\pgfprofilestacktop#1%
	\global\advance\c@pgfprofile@stacktop by-1
}%
% returns the stack's top to macro #1
\def\pgfprofilestacktop#1{%
	\expandafter\let\expandafter#1\csname pgfprofile@stack@\the\c@pgfprofile@stacktop\endcsname
}%
\def\pgfprofilestackifempty#1#2{%
	\ifnum\c@pgfprofile@stacktop<0 #1\else #2\fi
}%

\pgfutil@ifundefined{AtEndDocument}{}{\AtEndDocument{\pgfprofilepostprocess}}%

\pgfprofilenew{main job}
\pgfprofilestart{main job}
\expandafter\xdef\csname c@pgfprofile@elapsed@at@start@main job\endcsname{0}%

\endinput
