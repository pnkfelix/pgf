% Copyright 2006 by Till Tantau
%
% This file may be distributed and/or modified
%
% 1. under the LaTeX Project Public License and/or
% 2. under the GNU Public License.
%
% See the file doc/generic/pgf/licenses/LICENSE for more details.

\ProvidesFileRCS[v\pgfversion] $Header: /cvsroot/pgf/pgf/generic/pgf/libraries/Attic/pgflibraryshapes.misc.code.tex,v 1.5 2007/09/18 08:39:16 vibrovski Exp $


\pgfdeclareshape{cross out}
{
  \inheritsavedanchors[from=rectangle] % this is nearly a rectangle
  \inheritanchorborder[from=rectangle]
  \inheritanchor[from=rectangle]{north}
  \inheritanchor[from=rectangle]{north west}
  \inheritanchor[from=rectangle]{north east}
  \inheritanchor[from=rectangle]{center}
  \inheritanchor[from=rectangle]{west}
  \inheritanchor[from=rectangle]{east}
  \inheritanchor[from=rectangle]{mid}
  \inheritanchor[from=rectangle]{mid west}
  \inheritanchor[from=rectangle]{mid east}
  \inheritanchor[from=rectangle]{base}
  \inheritanchor[from=rectangle]{base west}
  \inheritanchor[from=rectangle]{base east}
  \inheritanchor[from=rectangle]{south}
  \inheritanchor[from=rectangle]{south west}
  \inheritanchor[from=rectangle]{south east}
  \foregroundpath{
    % store lower right in xa/ya and upper right in xb/yb
    \southwest \pgf@xa=\pgf@x \pgf@ya=\pgf@y
    \northeast \pgf@xb=\pgf@x \pgf@yb=\pgf@y
    \pgfpathmoveto{\pgfqpoint{\pgf@xa}{\pgf@ya}}
    \pgfpathlineto{\pgfqpoint{\pgf@xb}{\pgf@yb}}
    \pgfpathmoveto{\pgfqpoint{\pgf@xa}{\pgf@yb}}
    \pgfpathlineto{\pgfqpoint{\pgf@xb}{\pgf@ya}}
 }
}


\pgfdeclareshape{strike out}
{
  \inheritsavedanchors[from=rectangle] % this is nearly a rectangle
  \inheritanchorborder[from=rectangle]
  \inheritanchor[from=rectangle]{north}
  \inheritanchor[from=rectangle]{north west}
  \inheritanchor[from=rectangle]{north east}
  \inheritanchor[from=rectangle]{center}
  \inheritanchor[from=rectangle]{west}
  \inheritanchor[from=rectangle]{east}
  \inheritanchor[from=rectangle]{mid}
  \inheritanchor[from=rectangle]{mid west}
  \inheritanchor[from=rectangle]{mid east}
  \inheritanchor[from=rectangle]{base}
  \inheritanchor[from=rectangle]{base west}
  \inheritanchor[from=rectangle]{base east}
  \inheritanchor[from=rectangle]{south}
  \inheritanchor[from=rectangle]{south west}
  \inheritanchor[from=rectangle]{south east}
  \foregroundpath{
    \pgfpathmoveto{\southwest}
    \pgfpathlineto{\northeast}
 }
}


\pgfdeclareshape{rounded rectangle}{%
	\saveddimen\halfwidth{%
		\pgfmathsetlength\pgf@x{+\pgfkeysvalueof{/pgf/inner xsep}}%
		\pgfmathaddtolength\pgf@x{+\pgfkeysvalueof{/pgf/outer xsep}}%
		\advance\pgf@x.5\wd\pgfnodeparttextbox%
		\advance\pgf@x.5\pgflinewidth%
	}
	\saveddimen\halfheight{%
		\pgfmathsetlength\pgf@x{+\pgfkeysvalueof{/pgf/inner ysep}}%
		\advance\pgf@x.5\ht\pgfnodeparttextbox%
		\advance\pgf@x.5\dp\pgfnodeparttextbox%
		\advance\pgf@x.5\pgflinewidth%
		\pgfmathsetlength\pgf@xa{+\pgfkeysvalueof{/pgf/minimum height}}%
		\ifdim\pgf@x<.5\pgf@xa%
			\pgf@x.5\pgf@xa%
		\fi%
		\pgfmathaddtolength\pgf@x{+\pgfkeysvalueof{/pgf/outer ysep}}%
	}
	\savedanchor\southwest{%
		\pgfmathsetlength\pgf@y{+\pgfkeysvalueof{/pgf/inner ysep}}%
		\advance\pgf@y.5\ht\pgfnodeparttextbox%
		\advance\pgf@y.5\dp\pgfnodeparttextbox%
		\advance\pgf@y.5\pgflinewidth%
		\pgfmathsetlength\pgf@ya{+\pgfkeysvalueof{/pgf/minimum height}}%
		\ifdim\pgf@y>.5\pgf@ya%
			\pgf@yb\pgf@y%
		\else%
			\pgf@yb.5\pgf@ya%
		\fi%
		% 
		% Calculate the distance xc that the node extends into the semicircle.
		%
		\pgfmathaddtolength\pgf@y{+-\pgfkeysvalueof{/pgf/inner ysep}}%
		\pgfmathdivide@{\pgfmath@tonumber{\pgf@y}}{\pgfmath@tonumber{\pgf@yb}}%
		\pgfmathacos@{\pgfmathresult}%
		\pgfmathtan@{\pgfmathresult}%
		\pgf@xc\pgfmathresult\pgf@y%
		\pgf@y\pgf@yb%
		\pgfmathsetlength\pgf@x{+\pgfkeysvalueof{/pgf/inner xsep}}%
		\advance\pgf@x.5\wd\pgfnodeparttextbox%
		\pgf@xb\pgf@x%
		\advance\pgf@xb-\pgf@xc%
		\advance\pgf@xb\pgf@y\relax%
		\pgfmathsetlength\pgf@xa{+\pgfkeysvalueof{/pgf/minimum width}}%
		\ifdim\pgf@xb<.5\pgf@xa%
			\pgf@xc.5\pgf@xa%
			\advance\pgf@xc-\pgf@x%
			\advance\pgf@xc-\pgf@y%
			\pgf@x-\pgf@xc%
		\else%
			\pgf@x\pgf@xc%
		\fi%	
		\pgfmathaddtolength\pgf@x{+-\pgfkeysvalueof{/pgf/inner xsep}}%
		\pgf@y-\pgf@y%
		\advance\pgf@y.5\ht\pgfnodeparttextbox%
		\advance\pgf@y-.5\dp\pgfnodeparttextbox%
		\pgfmathaddtolength\pgf@y{+-\pgfkeysvalueof{/pgf/outer ysep}}%
	}
	\savedanchor\northeast{%
		\pgfmathsetlength\pgf@y{+\pgfkeysvalueof{/pgf/inner ysep}}%
		\advance\pgf@y.5\ht\pgfnodeparttextbox%
		\advance\pgf@y.5\dp\pgfnodeparttextbox%
		\advance\pgf@y.5\pgflinewidth%
		\pgfmathsetlength\pgf@ya{+\pgfkeysvalueof{/pgf/minimum height}}%
		\ifdim\pgf@y>.5\pgf@ya%
			\pgf@yb\pgf@y%
		\else%
			\pgf@yb.5\pgf@ya%
		\fi%
		% 
		% Calculate the distance xc that the node extends into the semicircle.
		%
		\pgfmathaddtolength\pgf@y{+-\pgfkeysvalueof{/pgf/inner ysep}}%
		\pgfmathdivide@{\pgfmath@tonumber{\pgf@y}}{\pgfmath@tonumber{\pgf@yb}}%
		\pgfmathacos@{\pgfmathresult}%
		\pgfmathtan@{\pgfmathresult}%
		\pgf@xc\pgfmathresult\pgf@y%
		\pgf@y\pgf@yb%
		\pgfmathsetlength\pgf@x{+\pgfkeysvalueof{/pgf/inner xsep}}%
		\advance\pgf@x.5\wd\pgfnodeparttextbox%
		\pgf@xb\pgf@x%
		\advance\pgf@xb-\pgf@xc%
		\advance\pgf@xb\pgf@y\relax%
		\pgfmathsetlength\pgf@xa{+\pgfkeysvalueof{/pgf/minimum width}}%
		\ifdim\pgf@xb<.5\pgf@xa%
			\pgf@xc.5\pgf@xa%
			\advance\pgf@xc-\pgf@x%
			\advance\pgf@xc-\pgf@y%
			\pgf@x\pgf@xc%
		\else%
			\pgf@x-\pgf@xc%
		\fi%	
		\advance\pgf@x\wd\pgfnodeparttextbox%
		\pgfmathaddtolength\pgf@x{+\pgfkeysvalueof{/pgf/inner xsep}}%
		\advance\pgf@y.5\ht\pgfnodeparttextbox%
		\advance\pgf@y-.5\dp\pgfnodeparttextbox%
		\pgfmathaddtolength\pgf@y{+\pgfkeysvalueof{/pgf/outer ysep}}%
	}
	\savedanchor\centerpoint{%
		\pgf@x.5\wd\pgfnodeparttextbox%
		\pgf@y.5\ht\pgfnodeparttextbox%
		\advance\pgf@y-.5\dp\pgfnodeparttextbox%
	}
	\savedanchor\basepoint{%
		\pgf@x.5\wd\pgfnodeparttextbox%
		\pgf@y0pt\relax%
	}
	\savedanchor\midpoint{%
		\pgf@x.5\wd\pgfnodeparttextbox%
		\pgfmathsetlength\pgf@y{+.5ex}%
	}
	\anchor{center}{\centerpoint}%
	\anchor{base}{\basepoint}
	\anchor{base west}{%
		\pgfmathpointintersectionoflineandarc%
			{\basepoint\pgf@ya\pgf@y\southwest\pgf@y\pgf@ya\advance\pgf@x\halfheight}%
			{\basepoint}%
			{\centerpoint\pgf@ya\pgf@y\southwest\pgf@y\pgf@ya}{90}{270}{\halfheight}%
	}%
	\anchor{base east}{%
		\pgfmathpointintersectionoflineandarc%
			{\basepoint\pgf@ya\pgf@y\northeast\pgf@y\pgf@ya\advance\pgf@x\halfheight}%
			{\basepoint}%
			{\centerpoint\pgf@ya\pgf@y\northeast\pgf@y\pgf@ya}{270}{450}{\halfheight}%
	}
	\anchor{mid}{\midpoint}
	\anchor{mid west}{%
		\pgfmathpointintersectionoflineandarc%
			{\midpoint\pgf@ya\pgf@y\southwest\pgf@y\pgf@ya\advance\pgf@x\halfheight}%
			{\midpoint}%
			{\centerpoint\pgf@ya\pgf@y\southwest\pgf@y\pgf@ya}{90}{270}{\halfheight}%
	}
	\anchor{mid east}{%
		\pgfmathpointintersectionoflineandarc%
			{\midpoint\pgf@ya\pgf@y\northeast\pgf@y\pgf@ya\advance\pgf@x\halfheight}%
			{\midpoint}%
			{\centerpoint\pgf@ya\pgf@y\northeast\pgf@y\pgf@ya}{270}{450}{\halfheight}%
	}
	\anchor{north}{%
		\centerpoint%
		\advance\pgf@y\halfheight\relax%
	}%
	\anchor{south}{%
		\centerpoint%
		\advance\pgf@y-\halfheight\relax%
	}%
	\anchor{west}{%
		\centerpoint%
		\pgf@ya\pgf@y%
		\southwest%
		\pgf@y\pgf@ya%
		\advance\pgf@x-\halfheight\relax%	
	}%
	\anchor{east}{%
		\centerpoint%
		\pgf@ya\pgf@y%
		\northeast%
		\pgf@y\pgf@ya%
		\advance\pgf@x\halfheight\relax%	
	}%
	\anchor{north east}{%
		\northeast%
	}%
	\anchor{south east}{%
		\northeast%
		\pgf@xa\pgf@x%
		\southwest%
		\pgf@x\pgf@xa%
	}%
	\anchor{north west}{%
		\northeast%
		\pgf@ya\pgf@y%
		\southwest%
		\pgf@y\pgf@ya%
	}%
	\anchor{south west}{%
		\southwest%
	}%
	\backgroundpath{%
		{%
			\pgfsetcornersarced{\pgfpoint{0pt}{0pt}}%
			\pgfsavepgf@process\southwest{%
				\southwest%
				\pgfmathaddtolength\pgf@y{+\pgfkeysvalueof{/pgf/outer ysep}}%
			}%
			\pgfsavepgf@process\northeast{%
				\northeast%
				\pgfmathaddtolength\pgf@y{+-\pgfkeysvalueof{/pgf/outer ysep}}%
			}%
			\pgf@y\halfheight\relax%
			\pgfmathaddtolength\pgf@y{+-\pgfkeysvalueof{/pgf/outer ysep}}%
			\edef\halfheight{\the\pgf@y}%
			\pgfpathmoveto{\southwest}
			\pgfpatharc{270}{90}{\halfheight}%
			\pgfpathlineto{\northeast}
			\pgfpatharc{90}{0}{\halfheight}%
			\pgfpatharc{360}{270}{\halfheight}%
			\pgfpathclose%
		}%
	}	
	\anchorborder{%
		%
		% Save x and y.
		%
		\edef\externalx{\the\pgf@x}%
		\edef\externaly{\the\pgf@y}%
	 	\pgfsavepgf@process\externalpoint{%
			\centerpoint%
			\advance\pgf@x\externalx\relax%
			\advance\pgf@y\externaly\relax%
		}%
		\pgfmathanglebetweenpoints{\centerpoint}{\externalpoint}%
		\let\externalangle\pgfmathresult%
		%
		% Locate the point on the border.
		%
		\pgfmathanglebetweenpoints{\centerpoint}{\northeast}%
		\ifdim\externalangle pt<\pgfmathresult pt\relax%
			\pgfsavepgf@process\circlecenterpoint{%
				\centerpoint\pgf@ya\pgf@y\northeast\pgf@y\pgf@ya%
			}%
			\pgfmathpointintersectionoflineandarc{\externalpoint}{\centerpoint}{\circlecenterpoint}{0}{90}{\halfheight}%	
		\else%
			\pgfmathanglebetweenpoints{\centerpoint}{\northeast\pgf@ya\pgf@y\southwest\pgf@y\pgf@ya}%
			\ifdim\externalangle pt<\pgfmathresult pt\relax%
				\pgfpointintersectionoflines{\externalpoint}{\centerpoint}%
					{\northeast}{\northeast\pgf@ya\pgf@y\southwest\pgf@y\pgf@ya}%
			\else%
				\pgfmathanglebetweenpoints{\centerpoint}{\southwest}%
				\ifdim\externalangle pt<\pgfmathresult pt\relax%
					\pgfsavepgf@process\circlecenterpoint{%
						\centerpoint\pgf@ya\pgf@y\southwest\pgf@y\pgf@ya%
					}%
					\pgfmathpointintersectionoflineandarc{\externalpoint}{\centerpoint}%
						{\circlecenterpoint}{90}{270}{\halfheight}%
				\else%
					\pgfmathanglebetweenpoints{\centerpoint}{\southwest\pgf@ya\pgf@y\northeast\pgf@y\pgf@ya}%
					\ifdim\externalangle pt<\pgfmathresult pt\relax%
						\pgfpointintersectionoflines{\externalpoint}{\centerpoint}%
							{\southwest}{\southwest\pgf@ya\pgf@y\northeast\pgf@y\pgf@ya}%
					\else%
						\pgfsavepgf@process\circlecenterpoint{%
							\centerpoint\pgf@ya\pgf@y\northeast\pgf@y\pgf@ya%
						}%
						\pgfmathpointintersectionoflineandarc{\externalpoint}{\centerpoint}%
							{\circlecenterpoint}{270}{360}{\halfheight}%			
					\fi%
				\fi%			
			\fi%			
		\fi%
	}%
}%




% Keys for bevelled rectangle
%
% /pgf/bevelled rectangle corners : specify the corners to bevel.
% /pgf/bevelled rectangle angle   : set the angle of the bevel.
% /pgf/bevelled rectangle xsep    : set the extent of the x bevelling.
% /pgf/bevelled rectangle ysep    : set the extent of the y bevelling.

\pgfkeys{/pgf/bevelled rectangle/.cd, @bevel/.initial=1, @no bevel/.initial=0}%
\pgfkeys{/pgf/bevelled rectangle/north east/.cd,
	.code={%
		\edef\pgf@temp{\pgfkeysvalueof{/pgf/bevelled rectangle/@#1}}%
		\pgfkeyslet{/pgf/bevelled rectangle/north east}{\pgf@temp}%
	},%
	.default=bevel%
}

\pgfkeys{/pgf/bevelled rectangle/north west/.cd,
	.code={%
		\edef\pgf@temp{\pgfkeysvalueof{/pgf/bevelled rectangle/@#1}}%
		\pgfkeyslet{/pgf/bevelled rectangle/north west}{\pgf@temp}%
	},%
	.default=bevel%
}

\pgfkeys{/pgf/bevelled rectangle/south west/.cd,
	.code={%
		\edef\pgf@temp{\pgfkeysvalueof{/pgf/bevelled rectangle/@#1}}%
		\pgfkeyslet{/pgf/bevelled rectangle/south west}{\pgf@temp}%
	},%
	.default=bevel%
}

\pgfkeys{/pgf/bevelled rectangle/south east/.cd,
	.code={%
		\edef\pgf@temp{\pgfkeysvalueof{/pgf/bevelled rectangle/@#1}}%
		\pgfkeyslet{/pgf/bevelled rectangle/south east}{\pgf@temp}%
	},%
	.default=bevel%
}

\pgfkeys{/pgf/bevelled rectangle/bevel all/.style={%
		/pgf/bevelled rectangle corners={north east, north west, south west, south east}%
	}%
}

\pgfkeys{/pgf/bevelled rectangle/bevel none/.style={%
		/pgf/bevelled rectangle corners={%
			north east=no bevel, north west=no bevel, 
			south west=no bevel, south east=no bevel}%
	}%
}

\pgfkeys{/pgf/bevelled rectangle corners/.code={%
		\pgfkeysalso{/pgf/bevelled rectangle/.cd,%
			north east=no bevel, north west=no bevel,%
			south east=no bevel, south west=no bevel, #1}%
	}%
}
\pgfkeys{/pgf/bevelled rectangle corners=bevel all}

\pgfkeys{/pgf/bevelled rectangle angle/.code={%
		\pgfmathparse{#1}%
		\pgfkeyslet{/pgf/bevelled rectangle angle}{\pgfmathresult}%
	}%
}
\pgfkeys{/pgf/bevelled rectangle angle=45}

\pgfkeys{/pgf/bevelled rectangle xsep/.code={%
		\pgfmathparse{#1}%
		\edef\pgfmathresult{\pgfmathresult pt}%
		\pgfkeyslet{/pgf/bevelled rectangle xsep}{\pgfmathresult}%
	}%
}


\pgfkeys{/pgf/bevelled rectangle ysep/.code={%
		\pgfmathparse{#1}%
		\edef\pgfmathresult{\pgfmathresult pt}%
		\pgfkeyslet{/pgf/bevelled rectangle ysep}{\pgfmathresult}%
	}%
}

\pgfkeys{/pgf/bevelled rectangle sep/.style={%
	/pgf/bevelled rectangle xsep=#1,/pgf/bevelled rectangle ysep=#1}%
}
\pgfkeys{/pgf/bevelled rectangle sep=.666ex}



% Shape bevelled rectangle.
%
%
\pgfdeclareshape{bevelled rectangle}{%
	\savedmacro\getbevelledrectanglepoints{%
		%
		% Get the node dimensions.
		%
		\pgfmathsetlength\pgf@xa{+\pgfkeysvalueof{/pgf/inner xsep}}%
		\advance\pgf@xa.5\wd\pgfnodeparttextbox%
		\pgfmathsetlength\pgf@ya{+\pgfkeysvalueof{/pgf/inner ysep}}%
		\advance\pgf@ya.5\ht\pgfnodeparttextbox%
		\advance\pgf@ya.5\dp\pgfnodeparttextbox%
		%
		% Get bevel stuff. 
		%
		\pgfutil@tempdima\pgfkeysvalueof{/pgf/bevelled rectangle angle}pt\relax%
		\ifdim\pgfutil@tempdima<89pt\relax%
			\ifdim\pgfutil@tempdima<1pt\relax%
				\pgfutil@tempdima1pt\relax%
			\fi%
		\else%		
			\pgfutil@tempdima89pt\relax%
		\fi%
		\pgfutil@tempdima-\pgfutil@tempdima%
		\advance\pgfutil@tempdima90pt\relax%
		\pgfmathtan@{\pgfmath@tonumber{\pgfutil@tempdima}}%
		\let\tanangle\pgfmathresult%
		\pgfmathcot@{\pgfmath@tonumber{\pgfutil@tempdima}}%
		\let\cotangle\pgfmathresult%
		\pgf@xb\pgfkeysvalueof{/pgf/bevelled rectangle xsep}\relax%
		\pgf@yc\tanangle\pgf@xb%
		\ifdim\pgf@yc>\pgf@ya%
			\pgf@yc\pgf@ya%
			\pgf@xb\cotangle\pgf@yc%
		\fi%
		\pgfmathcot@{\pgfmath@tonumber{\pgfutil@tempdima}}%
		\pgf@yb\pgfkeysvalueof{/pgf/bevelled rectangle ysep}\relax%
		\pgf@xc\cotangle\pgf@yb%
			\ifdim\pgf@xc>\pgf@xa%
			\pgf@xc\pgf@xa%
			\pgf@yb\tanangle\pgf@xc%
		\fi%
		%
		% Check for minimum width and height%
		%
		\pgfutil@tempdima\pgf@xa%
		\advance\pgfutil@tempdima\pgf@xb%
		\pgfmathsetlength\pgfutil@tempdimb{+\pgfkeysvalueof{/pgf/minimum width}}%
		\ifdim\pgfutil@tempdima<.5\pgfutil@tempdimb%
			\pgf@xa.5\pgfutil@tempdimb%
			\advance\pgf@xa-\pgf@xb%
		\fi%
		\pgfutil@tempdima\pgf@ya%
		\advance\pgfutil@tempdima\pgf@yb%
		\pgfmathsetlength\pgfutil@tempdimb{+\pgfkeysvalueof{/pgf/minimum height}}%
		\ifdim\pgfutil@tempdima<.5\pgfutil@tempdimb%
			\pgf@ya.5\pgfutil@tempdimb%
			\advance\pgf@ya-\pgf@yb%
		\fi%		
		%
		% Define the background path points.
		%
		\pgfsavepgf@process\centerpoint{%
			\pgfmathsetlength\pgf@x{+.5\wd\pgfnodeparttextbox}%
			\pgfmathsetlength\pgf@y{+.5\ht\pgfnodeparttextbox}%
			\pgfmathaddtolength\pgf@y{+-.5\dp\pgfnodeparttextbox}%
		}%
		\pgfsavepgf@process\beforenortheast{%
			\centerpoint%
			\advance\pgf@x\pgf@xa%
			\advance\pgf@x\pgf@xb%
			\advance\pgf@y\pgf@ya%
			\advance\pgf@y-\pgf@yc%
		}%
		\pgfsavepgf@process\northeast{%
			\centerpoint%
			\advance\pgf@x\pgf@xa%
			\advance\pgf@y\pgf@ya%
			\ifnum\pgfkeysvalueof{/pgf/bevelled rectangle/north east}=%
				\pgfkeysvalueof{/pgf/bevelled rectangle/@no bevel}\relax%
				\advance\pgf@x\pgf@xb%
				\advance\pgf@y\pgf@yb%
			\fi%
		}%
		\pgfsavepgf@process\afternortheast{%
			\centerpoint%
			\advance\pgf@x\pgf@xa%
			\advance\pgf@x-\pgf@xc%
			\advance\pgf@y\pgf@ya%
			\advance\pgf@y\pgf@yb%
		}%	
		\pgfsavepgf@process\northwest{%
			\centerpoint%
			\advance\pgf@x-\pgf@xa%
			\advance\pgf@y\pgf@ya%
			\ifnum\pgfkeysvalueof{/pgf/bevelled rectangle/north west}=%
				\pgfkeysvalueof{/pgf/bevelled rectangle/@no bevel}\relax%
				\advance\pgf@x-\pgf@xb%
				\advance\pgf@y\pgf@yb%
			\fi%
		}%
		\pgfsavepgf@process\beforesouthwest{%
			\centerpoint%
			\advance\pgf@x-\pgf@xa%
			\advance\pgf@x-\pgf@xb%
			\advance\pgf@y-\pgf@ya%
			\advance\pgf@y\pgf@yc%
		}%
		\pgfsavepgf@process\southwest{%
			\centerpoint%
			\advance\pgf@x-\pgf@xa%
			\advance\pgf@y-\pgf@ya%
			\ifnum\pgfkeysvalueof{/pgf/bevelled rectangle/south west}=%
				\pgfkeysvalueof{/pgf/bevelled rectangle/@no bevel}\relax%
				\advance\pgf@x-\pgf@xb%
				\advance\pgf@y-\pgf@yb%
			\fi%
		}%
		\pgfsavepgf@process\aftersouthwest{%
			\centerpoint%
			\advance\pgf@x-\pgf@xa%
			\advance\pgf@x\pgf@xc%
			\advance\pgf@y-\pgf@ya%
			\advance\pgf@y-\pgf@yb%
		}%
		\pgfsavepgf@process\southeast{%
			\centerpoint%
			\advance\pgf@x\pgf@xa%
			\advance\pgf@y-\pgf@ya%
			\ifnum\pgfkeysvalueof{/pgf/bevelled rectangle/south east}=%
				\pgfkeysvalueof{/pgf/bevelled rectangle/@no bevel}\relax%
				\advance\pgf@x\pgf@xb%
				\advance\pgf@y-\pgf@yb%
			\fi%
		}%
		%
		% Calculate the `miter' vectors.
		%
		\pgfmathanglebetweenlines{\beforenortheast}{\afternortheast}{\beforenortheast}%
			{\beforesouthwest\pgf@ya\pgf@y\beforenortheast\pgf@y\pgf@ya}%
		\pgfutil@tempdima\pgfmathresult pt\relax%
		\ifdim\pgfutil@tempdima>180pt\relax%
			\advance\pgfutil@tempdima-180pt\relax%
		\fi%
		\pgfmathsetlength\pgfutil@tempdimb{+\pgfkeysvalueof{/pgf/outer xsep}}%
		\ifdim\pgfutil@tempdima<90pt\relax%
			\pgfmathcosec@{\pgfmath@tonumber{\pgfutil@tempdima}}%
			\pgfutil@tempdimb\pgfmathresult\pgfutil@tempdimb%
			\pgfutil@tempdima0pt\relax%
		\else%
			\pgfutil@tempdima.5\pgfutil@tempdima%
			\pgfmathcosec@{\pgfmath@tonumber{\pgfutil@tempdima}}%
			\pgfutil@tempdimb\pgfmathresult\pgfutil@tempdimb%
			\pgfutil@tempdima-\pgfutil@tempdima%
			\advance\pgfutil@tempdima90pt\relax%
		\fi%
		\pgfsavepgf@process\before@ne@anchor{%
			\beforenortheast%
			\pgf@xa\pgf@x%
			\pgf@ya\pgf@y%
			\pgfqpointpolar{\pgfmath@tonumber{\pgfutil@tempdima}}{\the\pgfutil@tempdimb}%
			\advance\pgf@x\pgf@xa%
			\advance\pgf@y\pgf@ya%
		}%
		\pgfutil@tempdima-\pgfutil@tempdima%
		\advance\pgfutil@tempdima180pt\relax%
		\pgfsavepgf@process\before@sw@anchor{%
			\beforesouthwest%
			\pgf@xa\pgf@x%
			\pgf@ya\pgf@y%
			\pgfqpointpolar{-\pgfmath@tonumber{\pgfutil@tempdima}}{\the\pgfutil@tempdimb}%
			\advance\pgf@x\pgf@xa%
			\advance\pgf@y\pgf@ya%
		}%
		%
		\pgfmathanglebetweenlines{\afternortheast}{\aftersouthwest\pgf@xa\pgf@x\afternortheast\pgf@x\pgf@xa}%
			{\afternortheast}{\beforenortheast}%
		\pgfutil@tempdima\pgfmathresult pt\relax%
		\ifdim\pgfutil@tempdima>270pt\relax%
			\advance\pgfutil@tempdima-270pt\relax%
		\fi%
		\pgfmathsetlength\pgfutil@tempdimb{+\pgfkeysvalueof{/pgf/outer ysep}}%
		\ifdim\pgfutil@tempdima<90pt\relax%
			\pgfmathcosec@{\pgfmath@tonumber{\pgfutil@tempdima}}%
			\pgfutil@tempdimb\pgfmathresult\pgfutil@tempdimb%
			\pgfutil@tempdima90pt\relax%
		\else%
			\pgfutil@tempdima.5\pgfutil@tempdima%
			\pgfmathcosec@{\pgfmath@tonumber{\pgfutil@tempdima}}%
			\pgfutil@tempdimb\pgfmathresult\pgfutil@tempdimb%
		\fi%		
		%
		\pgfsavepgf@process\after@ne@anchor{%
			\afternortheast%
			\pgf@xa\pgf@x%
			\pgf@ya\pgf@y%
			\pgfqpointpolar{\pgfmath@tonumber{\pgfutil@tempdima}}{\the\pgfutil@tempdimb}%
			\advance\pgf@x\pgf@xa%
			\advance\pgf@y\pgf@ya%
		}%
		\pgfutil@tempdima-\pgfutil@tempdima%
		\advance\pgfutil@tempdima180pt\relax%
		\pgfsavepgf@process\after@sw@anchor{%
			\aftersouthwest
			\pgf@xa\pgf@x%
			\pgf@ya\pgf@y%
			\pgfqpointpolar{-\pgfmath@tonumber{\pgfutil@tempdima}}{\the\pgfutil@tempdimb}%
			\advance\pgf@x\pgf@xa%
			\advance\pgf@y\pgf@ya%
		}%
		\addtosavedmacro\before@ne@anchor%
		\addtosavedmacro\after@ne@anchor%
		\addtosavedmacro\before@sw@anchor%
		\addtosavedmacro\after@sw@anchor%
		\pgfsavepgf@process\ne@anchor{%
			\ifnum\pgfkeysvalueof{/pgf/bevelled rectangle/north east}=%
				\pgfkeysvalueof{/pgf/bevelled rectangle/@no bevel}\relax%
				\northeast%
				\pgfmathaddtolength\pgf@x{+\pgfkeysvalueof{/pgf/outer xsep}}%
				\pgfmathaddtolength\pgf@y{+\pgfkeysvalueof{/pgf/outer ysep}}%
			\else%
				\pgfpointlineattime{0.5}{\before@ne@anchor}{\after@ne@anchor}%
			\fi%
		}%
		\pgfsavepgf@process\nw@anchor{%
			\ifnum\pgfkeysvalueof{/pgf/bevelled rectangle/north west}=%
				\pgfkeysvalueof{/pgf/bevelled rectangle/@no bevel}\relax%
				\northwest%
				\pgfmathaddtolength\pgf@x{+-\pgfkeysvalueof{/pgf/outer xsep}}%
				\pgfmathaddtolength\pgf@y{+\pgfkeysvalueof{/pgf/outer ysep}}%
			\else%
				\pgfpointlineattime{0.5}{%
					\before@ne@anchor%
					\pgf@ya\pgf@y
					\before@sw@anchor%
					\pgf@y\pgf@ya%
				}{%
					\after@ne@anchor%
					\pgf@ya\pgf@y
					\after@sw@anchor%
					\pgf@y\pgf@ya%
				}%
			\fi%
		}%
		\pgfsavepgf@process\sw@anchor{%
			\ifnum\pgfkeysvalueof{/pgf/bevelled rectangle/south west}=%
				\pgfkeysvalueof{/pgf/bevelled rectangle/@no bevel}\relax%
				\southwest%
				\pgfmathaddtolength\pgf@x{+-\pgfkeysvalueof{/pgf/outer xsep}}%
				\pgfmathaddtolength\pgf@y{+-\pgfkeysvalueof{/pgf/outer ysep}}%
			\else%
				\pgfpointlineattime{0.5}{\before@sw@anchor}{\after@sw@anchor}%
			\fi%
		}%
		\pgfsavepgf@process\se@anchor{%
			\ifnum\pgfkeysvalueof{/pgf/bevelled rectangle/south east}=%
				\pgfkeysvalueof{/pgf/bevelled rectangle/@no bevel}\relax%
				\southeast%
				\pgfmathaddtolength\pgf@x{+\pgfkeysvalueof{/pgf/outer xsep}}%
				\pgfmathaddtolength\pgf@y{+-\pgfkeysvalueof{/pgf/outer ysep}}%
			\else%
				\pgfpointlineattime{0.5}{%
					\before@ne@anchor%
					\pgf@xa\pgf@x
					\before@sw@anchor%
					\pgf@x\pgf@xa%
				}{%
					\after@ne@anchor%
					\pgf@xa\pgf@x
					\after@sw@anchor%
					\pgf@x\pgf@xa%
				}%
			\fi%
		}%
		\addtosavedmacro\ne@anchor%
		\addtosavedmacro\nw@anchor%
		\addtosavedmacro\sw@anchor%
		\addtosavedmacro\se@anchor%
	}%
	\savedanchor\centerpoint{%
		\pgf@x.5\wd\pgfnodeparttextbox%
		\pgf@y.5\ht\pgfnodeparttextbox%
		\advance\pgf@y-.5\dp\pgfnodeparttextbox%
	}%
	\savedanchor\midpoint{%
		\pgf@x.5\wd\pgfnodeparttextbox%
		\pgfmathsetlength\pgf@y{+.5ex}%
	}%
	\savedanchor\basepoint{%
		\pgf@x.5\wd\pgfnodeparttextbox%
		\pgf@y0pt%
	}%
	\anchor{center}{\centerpoint}%
	\anchor{mid}{\midpoint}%
	\anchor{mid east}{%
		\getbevelledrectanglepoints%
		\midpoint%
		\pgf@ya\pgf@y%
		\pgf@process{%
			\before@sw@anchor%
			\pgf@ya\pgf@y%
			\before@ne@anchor%
			\pgf@y\pgf@ya		
		}%
		\ifdim\pgf@ya<\pgf@y%
			\pgfpointintersectionoflines{\midpoint}{\midpoint\pgf@ya\pgf@y\before@ne@anchor\pgf@y\pgf@ya}%
				{\before@sw@anchor\pgf@ya\pgf@y\before@ne@anchor\pgf@y\pgf@ya}%
				{\after@sw@anchor\pgf@ya\pgf@y\after@ne@anchor\pgf@y\pgf@ya}%
		\else%
			\pgf@process{\before@ne@anchor}%
			\ifdim\pgf@ya<\pgf@y%
				\pgfpointintersectionoflines{\midpoint}{\midpoint\pgf@ya\pgf@y\before@ne@anchor\pgf@y\pgf@ya}%
					{\before@sw@anchor\pgf@ya\pgf@y\before@ne@anchor\pgf@y\pgf@ya}%
					{\before@ne@anchor}%
			\else%
				\pgfpointintersectionoflines{\midpoint}{\midpoint\pgf@ya\pgf@y\before@ne@anchor\pgf@y\pgf@ya}%
					{\before@ne@anchor}%
					{\after@ne@anchor}%
			\fi%
		\fi%			
	}%
	\anchor{mid west}{%
		\getbevelledrectanglepoints%
		\midpoint%
		\pgf@ya\pgf@y%
		\pgf@process{\before@sw@anchor}%
		\ifdim\pgf@ya<\pgf@y%
			\pgfpointintersectionoflines{\midpoint}{\midpoint\pgf@ya\pgf@y\before@sw@anchor\pgf@y\pgf@ya}%
				{\before@sw@anchor}{\after@sw@anchor}%
		\else%
			\pgf@process{\before@ne@anchor\pgf@ya\pgf@y\before@sw@anchor\pgf@y\pgf@ya}%
			\ifdim\pgf@ya<\pgf@y%
				\pgfpointintersectionoflines{\midpoint}{\midpoint\pgf@ya\pgf@y\before@sw@anchor\pgf@y\pgf@ya}%
					{\before@ne@anchor\pgf@ya\pgf@y\before@sw@anchor\pgf@y\pgf@ya}%
					{\before@sw@anchor}%
			\else%
				\pgfpointintersectionoflines{\midpoint}{\midpoint\pgf@ya\pgf@y\before@sw@anchor\pgf@y\pgf@ya}%
					{\before@ne@anchor\pgf@ya\pgf@y\before@sw@anchor\pgf@y\pgf@ya}%
					{\after@ne@anchor\pgf@ya\pgf@y\after@sw@anchor\pgf@y\pgf@ya}%
			\fi%
		\fi%			
	}%
	\anchor{base}{\basepoint}%
	\anchor{base east}{%
		\getbevelledrectanglepoints%
		\basepoint%
		\pgf@ya\pgf@y%
		\pgf@process{%
			\before@sw@anchor%
			\pgf@ya\pgf@y%
			\before@ne@anchor%
			\pgf@y\pgf@ya		
		}%
		\ifdim\pgf@ya<\pgf@y%
			\pgfpointintersectionoflines{\basepoint}{\basepoint\pgf@ya\pgf@y\before@ne@anchor\pgf@y\pgf@ya}%
				{\before@sw@anchor\pgf@ya\pgf@y\before@ne@anchor\pgf@y\pgf@ya}%
				{\after@sw@anchor\pgf@ya\pgf@y\after@ne@anchor\pgf@y\pgf@ya}%
		\else%
			\pgf@process{\before@ne@anchor}%
			\ifdim\pgf@ya<\pgf@y%
				\pgfpointintersectionoflines{\basepoint}{\basepoint\pgf@ya\pgf@y\before@ne@anchor\pgf@y\pgf@ya}%
					{\before@sw@anchor\pgf@ya\pgf@y\before@ne@anchor\pgf@y\pgf@ya}%
					{\before@ne@anchor}%
			\else%
				\pgfpointintersectionoflines{\basepoint}{\basepoint\pgf@ya\pgf@y\before@ne@anchor\pgf@y\pgf@ya}%
					{\before@ne@anchor}%
					{\after@ne@anchor}%
			\fi%
		\fi%			
	}%
	\anchor{base west}{%
		\getbevelledrectanglepoints%
		\basepoint%
		\pgf@ya\pgf@y%
		\pgf@process{\before@sw@anchor}%
		\ifdim\pgf@ya<\pgf@y%
			\pgfpointintersectionoflines{\basepoint}{\basepoint\pgf@ya\pgf@y\before@sw@anchor\pgf@y\pgf@ya}%
				{\before@sw@anchor}{\after@sw@anchor}%
		\else%
			\pgf@process{\before@ne@anchor\pgf@ya\pgf@y\before@sw@anchor\pgf@y\pgf@ya}%
			\ifdim\pgf@ya<\pgf@y%
				\pgfpointintersectionoflines{\basepoint}{\basepoint\pgf@ya\pgf@y\before@sw@anchor\pgf@y\pgf@ya}%
					{\before@ne@anchor\pgf@ya\pgf@y\before@sw@anchor\pgf@y\pgf@ya}%
					{\before@sw@anchor}%
			\else%
				\pgfpointintersectionoflines{\basepoint}{\basepoint\pgf@ya\pgf@y\before@sw@anchor\pgf@y\pgf@ya}%
					{\before@ne@anchor\pgf@ya\pgf@y\before@sw@anchor\pgf@y\pgf@ya}%
					{\after@ne@anchor\pgf@ya\pgf@y\after@sw@anchor\pgf@y\pgf@ya}%
			\fi%
		\fi%			
	}%
	\anchor{before north east}{\getbevelledrectanglepoints\before@ne@anchor}%
	\anchor{north east}{\getbevelledrectanglepoints\ne@anchor}%
	\anchor{after north east}{\getbevelledrectanglepoints\after@ne@anchor}%
	\anchor{north}{%
		\getbevelledrectanglepoints%
		\centerpoint%
		\pgf@xa\pgf@x%
		\after@ne@anchor%
		\pgf@x\pgf@xa}%	
	\anchor{before north west}{%
		\getbevelledrectanglepoints%
		\after@sw@anchor%
		\pgf@xa\pgf@x%
		\after@ne@anchor%
		\pgf@x\pgf@xa}%
	\anchor{north west}{\getbevelledrectanglepoints\nw@anchor}%
	\anchor{after north west}{%
		\getbevelledrectanglepoints%
		\before@sw@anchor%
		\pgf@xa\pgf@x%
		\before@ne@anchor%
		\pgf@x\pgf@xa}%
	\anchor{west}{%
		\getbevelledrectanglepoints%
		\centerpoint%
		\pgf@ya\pgf@y%
		\before@sw@anchor%
		\pgf@y\pgf@ya}%	
	\anchor{before south west}{\getbevelledrectanglepoints\before@sw@anchor}%
	\anchor{south west}{\getbevelledrectanglepoints\sw@anchor}%
	\anchor{after south west}{\getbevelledrectanglepoints\after@sw@anchor}%
		\anchor{south}{%
		\getbevelledrectanglepoints%
		\centerpoint%
		\pgf@xa\pgf@x%
		\after@sw@anchor%
		\pgf@x\pgf@xa}%	
	\anchor{before south east}{%
		\getbevelledrectanglepoints%
		\after@sw@anchor%
		\pgf@ya\pgf@y%
		\after@ne@anchor%
		\pgf@y\pgf@ya}%
	\anchor{south east}{\getbevelledrectanglepoints\se@anchor}%
	\anchor{after south east}{%
		\getbevelledrectanglepoints%
		\before@sw@anchor%
		\pgf@ya\pgf@y%
		\before@ne@anchor%
		\pgf@y\pgf@ya}%
	\anchor{east}{%
		\getbevelledrectanglepoints%
		\centerpoint%
		\pgf@ya\pgf@y%
		\before@ne@anchor%
		\pgf@y\pgf@ya}%	
	\backgroundpath{%
		\pgfpathmoveto{\beforenortheast}%
		\pgfpathlineto{\northeast}%
		\pgfpathlineto{\afternortheast}%
		\pgfpathlineto{\aftersouthwest\pgf@xa\pgf@x\afternortheast\pgf@x\pgf@xa}%
		\pgfpathlineto{\northwest}%
		\pgfpathlineto{\beforesouthwest\pgf@xa\pgf@x\beforenortheast\pgf@x\pgf@xa}%
		\pgfpathlineto{\beforesouthwest}%
		\pgfpathlineto{\southwest}%
		\pgfpathlineto{\aftersouthwest}%
		\pgfpathlineto{\aftersouthwest\pgf@ya\pgf@y\afternortheast\pgf@y\pgf@ya}%
		\pgfpathlineto{\southeast}%
		\pgfpathlineto{\beforesouthwest\pgf@ya\pgf@y\beforenortheast\pgf@y\pgf@ya}%		
		\pgfpathclose%
	}
	\anchorborder{%
		\pgfsavepgf@process\externalpoint{%
			\pgf@xa\pgf@x%
			\pgf@ya\pgf@y%
			\centerpoint%
			\advance\pgf@x\pgf@xa%
			\advance\pgf@y\pgf@ya%
		}%
		\pgfmathanglebetweenpoints{\centerpoint}{\externalpoint}%
		\let\externalangle\pgfmathresult%
		\getbevelledrectanglepoints%
		\pgfmathanglebetweenpoints{\centerpoint}{\centerpoint\pgf@ya\pgf@y\before@sw@anchor\pgf@y\pgf@ya}%
		\ifdim\externalangle pt<\pgfmathresult pt\relax% west.
			\pgfmathanglebetweenpoints{\centerpoint}{\centerpoint\pgf@xa\pgf@x\after@ne@anchor\pgf@x\pgf@xa}%
			\ifdim\externalangle pt<\pgfmathresult pt\relax% north.
				\pgfmathanglebetweenpoints{\centerpoint}{\ne@anchor}%
				\ifdim\externalangle pt<\pgfmathresult pt\relax% north east.
					\pgfmathanglebetweenpoints{\centerpoint}{\before@ne@anchor}%
					\ifdim\externalangle pt<\pgfmathresult pt\relax% before north east.
						\pgfpointintersectionoflines{\centerpoint}{\externalpoint}%
							{\centerpoint\pgf@ya\pgf@y\before@ne@anchor\pgf@y\pgf@ya}{\before@ne@anchor}%
					\else% 
						\pgfpointintersectionoflines{\centerpoint}{\externalpoint}%
							{\before@ne@anchor}{\ne@anchor}%
					\fi%
				\else%
					\pgfmathanglebetweenpoints{\centerpoint}{\after@ne@anchor}%
					\ifdim\externalangle pt<\pgfmathresult pt\relax% after north east.
							\pgfpointintersectionoflines{\centerpoint}{\externalpoint}%
							{\ne@anchor}{\after@ne@anchor}%
					\else% 
						\pgfpointintersectionoflines{\centerpoint}{\externalpoint}%
							{\after@ne@anchor}{\centerpoint\pgf@xa\pgf@x\after@ne@anchor\pgf@x\pgf@xa}%
					\fi%
				\fi%
			\else%
				\pgfmathanglebetweenpoints{\centerpoint}{\nw@anchor}%
				\ifdim\externalangle pt<\pgfmathresult pt\relax% north west.
					\pgfmathanglebetweenpoints{\centerpoint}{\after@sw@anchor\pgf@xa\pgf@x\after@ne@anchor\pgf@x\pgf@xa}%
					\ifdim\externalangle pt<\pgfmathresult pt\relax% before north west.
						\pgfpointintersectionoflines{\centerpoint}{\externalpoint}%
							{\centerpoint\pgf@xa\pgf@x\after@ne@anchor\pgf@x\pgf@xa}%
							{\after@sw@anchor\pgf@xa\pgf@x\after@ne@anchor\pgf@x\pgf@xa}%
					\else%
						\pgfpointintersectionoflines{\centerpoint}{\externalpoint}%
							{\after@sw@anchor\pgf@xa\pgf@x\after@ne@anchor\pgf@x\pgf@xa}%
							{\nw@anchor}%
					\fi%
				\else%
					\pgfmathanglebetweenpoints{\centerpoint}{\before@sw@anchor\pgf@xa\pgf@x\before@ne@anchor\pgf@x\pgf@xa}%
					\ifdim\externalangle pt<\pgfmathresult pt\relax% after north west.
						\pgfpointintersectionoflines{\centerpoint}{\externalpoint}%
							{\nw@anchor}{\before@sw@anchor\pgf@xa\pgf@x\before@ne@anchor\pgf@x\pgf@xa}%
					\else%
						\pgfpointintersectionoflines{\centerpoint}{\externalpoint}%
							{\before@sw@anchor\pgf@xa\pgf@x\before@ne@anchor\pgf@x\pgf@xa}%
							{\before@sw@anchor\pgf@xa\pgf@x\centerpoint\pgf@x\pgf@xa}%
					\fi%
				\fi%
			\fi%
		\else%
			\pgfmathanglebetweenpoints{\centerpoint}{\centerpoint\pgf@xa\pgf@x\after@sw@anchor\pgf@x\pgf@xa}%
			\ifdim\externalangle pt<\pgfmathresult pt\relax% south.
				\pgfmathanglebetweenpoints{\centerpoint}{\sw@anchor}%
				\ifdim\externalangle pt<\pgfmathresult pt\relax% south west.
					\pgfmathanglebetweenpoints{\centerpoint}{\before@sw@anchor}%
					\ifdim\externalangle pt<\pgfmathresult pt\relax% before south west.
						\pgfpointintersectionoflines{\centerpoint}{\externalpoint}%
							{\before@sw@anchor\pgf@xa\pgf@x\centerpoint\pgf@x\pgf@xa}%
							{\before@sw@anchor}%
					\else%
						\pgfpointintersectionoflines{\centerpoint}{\externalpoint}%
							{\before@sw@anchor}{\sw@anchor}%
					\fi%
				\else%
					\pgfmathanglebetweenpoints{\centerpoint}{\after@sw@anchor}%
					\ifdim\externalangle pt<\pgfmathresult pt\relax% after south west.
						\pgfpointintersectionoflines{\centerpoint}{\externalpoint}%
							{\before@sw@anchor}{\after@sw@anchor}%
					\else%
						\pgfpointintersectionoflines{\centerpoint}{\externalpoint}%
							{\after@sw@anchor}{\centerpoint\pgf@xa\pgf@x\after@sw@anchor\pgf@x\pgf@xa}%
					\fi%
				\fi%
			\else%
				\pgfmathanglebetweenpoints{\centerpoint}{\se@anchor}%
				\ifdim\externalangle pt<\pgfmathresult pt\relax% south east.
					\pgfmathanglebetweenpoints{\centerpoint}{\after@ne@anchor\pgf@xa\pgf@x\after@sw@anchor\pgf@x\pgf@xa}%
					\ifdim\externalangle pt<\pgfmathresult pt\relax% before south east.
						\pgfpointintersectionoflines{\centerpoint}{\externalpoint}%
							{\after@ne@anchor\pgf@xa\pgf@x\after@sw@anchor\pgf@x\pgf@xa}%
							{\centerpoint\pgf@xa\pgf@x\after@sw@anchor\pgf@x\pgf@xa}%
					\else%
						\pgfpointintersectionoflines{\centerpoint}{\externalpoint}%
							{\after@ne@anchor\pgf@xa\pgf@x\after@sw@anchor\pgf@x\pgf@xa}{\se@anchor}
					\fi%
				\else%
					\pgfmathanglebetweenpoints{\centerpoint}{\before@ne@anchor\pgf@xa\pgf@x\before@sw@anchor\pgf@x\pgf@xa}%
					\ifdim\externalangle pt<\pgfmathresult pt\relax% after south east.
						\pgfpointintersectionoflines{\centerpoint}{\externalpoint}%
							{\se@anchor}{\before@ne@anchor\pgf@xa\pgf@x\before@sw@anchor\pgf@x\pgf@xa}%					
					\else%
						\pgfpointintersectionoflines{\centerpoint}{\externalpoint}%
							{\before@ne@anchor\pgf@xa\pgf@x\before@sw@anchor\pgf@x\pgf@xa}%
							{\centerpoint\pgf@ya\pgf@y\before@ne@anchor\pgf@y\pgf@ya}%
					\fi%
				\fi%
			\fi%			
		\fi%
	}%			
}


\endinput
