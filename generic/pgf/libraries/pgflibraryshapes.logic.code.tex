% Copyright 2008 by Mark Wibrow
%
% This file may be distributed and/or modified
%
% 1. under the LaTeX Project Public License and/or
% 2. under the GNU Public License.
%
% See the file doc/generic/pgf/licenses/LICENSE for more details.


\pgfkeys{/pgf/.cd,%
	logic gate inputs/.initial={normal,normal},%
	logic gate inverted radius/.initial=2pt,%
	logic gate anchors use bounding box/.is if=pgfgateanchorsuseboundingrectangle%
}

\def\pgf@lib@sh@logicgates@dimensions{%
	\pgfmathsetlength\pgf@x{\pgfkeysvalueof{/pgf/inner xsep}}%
	\advance\pgf@x.5\wd\pgfnodeparttextbox%
	\pgfmathsetlength\pgf@y{\pgfkeysvalueof{/pgf/inner ysep}}%
	\advance\pgf@y.5\ht\pgfnodeparttextbox%
	\advance\pgf@y.5\dp\pgfnodeparttextbox%
	%
	% Adjust the height for the number of inputs.
	%
	\c@pgf@counta\pgf@lib@sh@logicgate@numinputs%
	\advance\c@pgf@counta1\relax%
	\pgfmathsetlength\pgf@ya{\pgfkeysvalueof{/pgf/logic gate inverted radius}}%
	\advance\pgf@ya\pgflinewidth%
	\multiply\pgf@ya\c@pgf@counta%
	\ifdim\pgf@y<\pgf@ya%
		\pgf@y\pgf@ya%
	\fi%
	%
	\ifdim\pgf@x>\pgf@y%
		\pgf@y\pgf@x%
	\else%
		\pgf@x\pgf@y%
	\fi%
	%
	% Adjust for minimum height and width.
	%
	\pgfmathsetlength\pgf@xa{\pgfkeysvalueof{/pgf/minimum width}}%
	\pgfmathsetlength\pgf@ya{\pgfkeysvalueof{/pgf/minimum height}}%
	\ifdim\pgf@y<.5\pgf@ya%
		\pgf@y.5\pgf@ya%
	\fi%
	\pgf@xb\pgf@x%
	\advance\pgf@xb1.732051\pgf@y% 2y*cos(30)
	\ifdim\pgf@xb<\pgf@xa%
		\pgf@xb\pgf@xa%
		\pgf@x0.366025\pgf@xb% xb / (1 + 2*cos(30))
	\fi%
	%
	\ifdim\pgf@x>\pgf@y%
		\pgf@y\pgf@x%
	\else%
		\pgf@x\pgf@y%
	\fi%
	\edef\halfside{\the\pgf@x}%
	\addtosavedmacro\halfside%
	%
	% Take into account the outer sep.
	%
	\pgfmathsetlength\pgf@xa{\pgfkeysvalueof{/pgf/outer xsep}}%
	\pgfmathsetlength\pgf@ya{\pgfkeysvalueof{/pgf/outer ysep}}%
	\edef\outerxsep{\the\pgf@xa}%
	\edef\outerysep{\the\pgf@ya}%
	\addtosavedmacro\outerxsep%
	\addtosavedmacro\outerysep%
	\advance\pgf@x\pgf@xa%
	\advance\pgf@y\pgf@ya%
	%
	\edef\halfwidth{\the\pgf@x}%
	\edef\halfheight{\the\pgf@y}%
	\addtosavedmacro\halfwidth%
	\addtosavedmacro\halfheight%
	%
	\pgfextract@process\tipanchor{%
		\advance\pgf@x-\pgf@xa%
		\advance\pgf@y-\pgf@ya%	
		\pgf@x-.16666\pgf@x%
		\pgf@yb2.0\pgf@y%
		\advance\pgf@x.866025\pgf@yb%	
		\advance\pgf@x1.154701\pgf@xa%
		\pgf@y0pt%
	}%
	\addtosavedmacro\tipanchor%		
}%


\def\pgf@lib@sh@logicgate@parseinputs#1{%
	\edef\pgf@lib@sh@temp{\pgfkeysvalueof{/pgf/logic gate inputs}}%
	\c@pgf@counta#1\relax%
	\c@pgf@countb0\relax%
	\expandafter\pgfutil@in@\expandafter,\expandafter{\pgf@lib@sh@temp}%
	\ifpgfutil@in@%
		\let\pgf@lib@sh@next\pgf@lib@sh@logicgate@parseinputs@long%
	\else%
		\let\pgf@lib@sh@next\pgf@lib@sh@logicgate@parseinputs@short%
	\fi%
	\pgf@lib@sh@next}
	
\def\pgf@lib@sh@itext{i}
\def\pgf@lib@sh@invertedtext{inverted}


%
%	The `short' version for input specifcation is an extension of
%	ideas due to Juergen Werber and Christoph Bartoschek.
%
\def\pgf@lib@sh@logicgate@parseinputs@short{%
	\expandafter\pgf@lib@sh@logicgate@parseinputs@@short\pgf@lib@sh@temp\pgf@stop%
}

\def\pgf@lib@sh@logicgate@parseinputs@@short#1{%
	\ifx#1\pgf@stop%
		\edef\pgf@lib@sh@logicgate@numinputs{\the\c@pgf@countb}%
		\let\pgf@lib@sh@next\relax%
	\else%
		\ifnum\c@pgf@countb=\c@pgf@counta%
			\edef\pgf@lib@sh@logicgate@numinputs{\the\c@pgf@countb}%
			\let\pgf@lib@sh@next\relax%
		\else%
			\advance\c@pgf@countb1\relax%
			\expandafter\ifx\pgf@lib@sh@itext#1%
				\expandafter\pgf@sh@resavedmacro\expandafter{\csname input-\the\c@pgf@countb\endcsname}{%
					\expandafter\def\csname input-\the\c@pgf@countb\endcsname{i}}%
			\else%
				\expandafter\pgf@sh@resavedmacro\expandafter{\csname input-\the\c@pgf@countb\endcsname}{%
					\expandafter\def\csname input-\the\c@pgf@countb\endcsname{n}}%
			\fi%		
			\let\pgf@lib@sh@next\pgf@lib@sh@logicgate@parseinputs@@short%
		\fi%
	\fi%
	\pgf@lib@sh@next%
}

\def\pgf@lib@sh@logicgate@parseinputs@long{%
	\expandafter\pgf@lib@sh@logicgate@parseinputs@@long\pgf@lib@sh@temp,\pgf@stop,%
}

\def\pgf@lib@sh@logicgate@parseinputs@@long#1,{%
	\ifx#1\pgf@stop%
		\edef\pgf@lib@sh@logicgate@numinputs{\the\c@pgf@countb}%
		\let\pgf@lib@sh@next\relax%
	\else%
		\ifnum\c@pgf@countb=\c@pgf@counta%
			\edef\pgf@lib@sh@logicgate@numinputs{\the\c@pgf@countb}%
			\let\pgf@lib@sh@next\relax%
		\else%
			\advance\c@pgf@countb1\relax%
			\def\pgf@lib@sh@temp{#1}%
			\ifx\pgf@lib@sh@invertedtext\pgf@lib@sh@temp%
				\expandafter\pgf@sh@resavedmacro\expandafter{\csname input-\the\c@pgf@countb\endcsname}{%
					\expandafter\def\csname input-\the\c@pgf@countb\endcsname{i}}%
			\else%
				\expandafter\pgf@sh@resavedmacro\expandafter{\csname input-\the\c@pgf@countb\endcsname}{%
					\expandafter\def\csname input-\the\c@pgf@countb\endcsname{n}}%
			\fi%		
			\let\pgf@lib@sh@next\pgf@lib@sh@logicgate@parseinputs@@@long%
		\fi%
	\fi%
	\pgf@lib@sh@next%
}
\def\pgf@lib@sh@logicgate@parseinputs@@@long{%
	\pgfutil@ifnextchar x{\pgf@lib@sh@logicgate@parseinputs@@long}%
		{\pgf@lib@sh@logicgate@parseinputs@@long}%
}


\def\pgf@lib@sh@logicgate@AND@inputanchor#1{%
	\dimensions%
	\centerpoint%
	\pgf@xa\halfside%
	\advance\pgf@x-.166666\pgf@xa%
	\advance\pgf@x-\halfwidth%
	\expandafter\ifx\expandafter\pgf@lib@sh@itext\csname input-#1\endcsname%
		\advance\pgf@x-\invertedradius%
		\advance\pgf@x-\outerinvertedradius%
	\fi%
	%
	\pgfutil@tempdima\halfside%
	\multiply\pgfutil@tempdima2\relax%
	\c@pgf@counta\numinputs%
	\advance\c@pgf@counta1\relax%
	\divide\pgfutil@tempdima\c@pgf@counta%
	\multiply\pgfutil@tempdima#1\relax%
	\advance\pgf@y\halfside%
	\advance\pgf@y-\pgfutil@tempdima%
}


\newif\ifpgfgateanchorsuseboundingrectangle

\pgfdeclareshape{AND gate}{%
	\expandafter\pgfutil@g@addto@macro\csname pgf@sh@s@AND gate\endcsname{%
		\pgf@lib@sh@logicgate@parseinputs{1024}% Maximum 1024 (!) inputs.
		%
		\pgfmathloop%
		\ifnum\pgfmathcounter>\pgf@lib@sh@logicgate@numinputs%
		\else%
			\pgfutil@ifundefined{pgf@anchor@AND gate@input \pgfmathcounter}{%
				\expandafter\xdef\csname pgf@anchor@AND gate@input \pgfmathcounter\endcsname{%
					\noexpand\pgf@lib@sh@logicgate@AND@inputanchor{\pgfmathcounter}%
				}%
			}{}%
		\repeatpgfmathloop%
		\ifnum\pgf@lib@sh@logicgate@numinputs<2\relax%
			\PackageError{PGF}{An AND gate must have at least two inputs}{}%
		\fi%
	}%
	\savedmacro\numinputs{\let\numinputs\pgf@lib@sh@logicgate@numinputs}%
	\saveddimen\invertedradius{%
		\pgfmathsetlength\pgf@x{\pgfkeysvalueof{/pgf/logic gate inverted radius}}%
	}%
	\saveddimen\outerinvertedradius{%
		\pgfmathsetlength\pgf@x{\pgfkeysvalueof{/pgf/logic gate inverted radius}}%
		\advance\pgf@x.5\pgflinewidth%
	}
	\savedmacro\dimensions{\pgf@lib@sh@logicgates@dimensions}
	\savedanchor\centerpoint{%
		\pgf@x.5\wd\pgfnodeparttextbox%
		\pgf@y.5\ht\pgfnodeparttextbox%
		\advance\pgf@y-.5\dp\pgfnodeparttextbox%
	}
	\savedanchor\midpoint{%
		\pgf@x.5\wd\pgfnodeparttextbox%
		\pgfmathsetlength\pgf@y{+0.5ex}%
	}
	\savedanchor\basepoint{%
		\pgf@x.5\wd\pgfnodeparttextbox%
		\pgf@y0pt%
	}
	\anchor{center}{\centerpoint}%
	\anchor{mid}{\midpoint}%
	\anchor{mid east}{%
		\csname pgf@anchor@AND gate@east\endcsname%
		\pgf@xa\pgf@x%
		\midpoint%
		\pgf@x\pgf@xa}
	\anchor{mid west}{%
		\csname pgf@anchor@AND gate@west\endcsname%
		\pgf@xa\pgf@x%
		\midpoint%
		\pgf@x\pgf@xa}
	\anchor{base}{\basepoint}%
	\anchor{base east}{%
		\csname pgf@anchor@AND gate@east\endcsname%
		\pgf@xa\pgf@x%
		\basepoint%
		\pgf@x\pgf@xa}
	\anchor{base west}{%
		\csname pgf@anchor@AND gate@west\endcsname%
		\pgf@xa\pgf@x%
		\basepoint%
		\pgf@x\pgf@xa}
	\anchor{east}{%
		\dimensions%
		\pgfpointadd{\centerpoint}{\tipanchor}%
	}
	\anchor{output}{\csname pgf@anchor@AND gate@east\endcsname}
	\anchor{north east}{%
		\dimensions%
		\ifpgfgateanchorsuseboundingrectangle%
			\tipanchor%
			\pgf@xa\pgf@x%
			\centerpoint%
			\advance\pgf@x\pgf@xa%
			\advance\pgf@y\halfheight%
		\else%
			\centerpoint%
			\pgf@xa\halfwidth%
			\pgf@ya\halfheight%
			\pgf@xb\halfside%
			\advance\pgf@x-.166666\pgf@xb%
			\advance\pgf@xa\pgf@xb%
			\advance\pgf@x.5\pgf@xa%
			\advance\pgf@y-\pgf@xb%
			\advance\pgf@ya\pgf@xb%
			\advance\pgf@y.866025\pgf@ya%
		\fi%
	}
	\anchor{south east}{%
		\dimensions%
		\ifpgfgateanchorsuseboundingrectangle%
			\tipanchor%
			\pgf@xa\pgf@x%
			\centerpoint%
			\advance\pgf@x\pgf@xa%
			\advance\pgf@y-\halfheight%
		\else
			\centerpoint%
			\pgf@xa\halfwidth%
			\pgf@ya\halfheight%
			\pgf@xb\halfside%
			\advance\pgf@x-.166666\pgf@xb%
			\advance\pgf@xa\pgf@xb%
			\advance\pgf@x.5\pgf@xa%
			\advance\pgf@y\pgf@xb%
			\advance\pgf@ya\pgf@xb%
			\advance\pgf@y-.866025\pgf@ya%
		\fi%
	}
	\anchor{north}{%
		\dimensions%
		\centerpoint%
		\ifpgfgateanchorsuseboundingrectangle%
			\advance\pgf@y\halfheight%
		\else%
			\pgf@ya\halfheight%
			\advance\pgf@y.993043\pgf@ya%
		\fi%	
	}
	\anchor{south}{%
		\dimensions%
		\centerpoint%
		\ifpgfgateanchorsuseboundingrectangle%
			\advance\pgf@y-\halfheight%
		\else%
			\pgf@ya\halfheight%
			\advance\pgf@y-.993043\pgf@ya%
		\fi%	
	}
	\anchor{south west}{%
		\dimensions%
		\centerpoint%
		\pgf@xa\halfside%
		\advance\pgf@x-1.16666\pgf@xa%
		\advance\pgf@x-\outerxsep%
		\advance\pgf@y-\halfheight%
	}
	\anchor{north west}{%
		\dimensions%
		\centerpoint%
		\pgf@xa\halfside%
		\advance\pgf@x-1.16666\pgf@xa%
		\advance\pgf@x-\outerxsep%
		\advance\pgf@y\halfheight%
	}
	\anchor{west}{%
		\dimensions%
		\centerpoint%
		\pgf@xa\halfside%
		\advance\pgf@x-1.16666\pgf@xa%
		\advance\pgf@x-\outerxsep%
	}
	\backgroundpath{%
		\dimensions%
		\pgf@xc\halfwidth%
		\pgf@yc\halfheight%
		\advance\pgf@xc-\outerxsep%
		\advance\pgf@yc-\outerysep%
		{%
			\pgftransformshift{\centerpoint}%
			\pgfpathmoveto{\pgfqpoint{-.16666\pgf@xc}{\pgf@yc}}%
			{%
				\pgf@yc2.0\pgf@yc%
				\edef\pgf@marshal{%
					\noexpand\pgfpatharc{90}{30}{\the\pgf@yc}%
				}%
				\pgf@marshal%
			}
			{%
				\pgf@yc2.0\pgf@yc%
				\edef\pgf@marshal{%
					\noexpand\pgfpatharc{-30}{-90}{\the\pgf@yc}%
				}%
				\pgf@marshal%
			}
			\pgfpathlineto{\pgfqpoint{-1.16666\pgf@xc}{-\pgf@yc}}%
			\pgfpathlineto{\pgfqpoint{-1.16666\pgf@xc}{\pgf@yc}}%
			\pgfpathclose%
			%
			% Draw the inputs.
			%
			\pgfutil@tempdima2.0\pgf@yc%
			\c@pgf@counta\numinputs%
			\advance\c@pgf@counta1\relax%
			\divide\pgfutil@tempdima\c@pgf@counta%
			\pgfmathloop%
			\ifnum\pgfmathcounter>\numinputs%
			\else%
				\advance\pgf@yc-\pgfutil@tempdima%
				\expandafter\ifx\expandafter\pgf@lib@sh@itext\csname input-\pgfmathcounter\endcsname%
					{%
						\pgfpathcircle{%
							\pgf@xa\halfside%
							\pgf@x-1.16666\pgf@xa%
							\advance\pgf@x-.5\pgflinewidth%
							\advance\pgf@x-\invertedradius%
							\pgf@y\pgf@yc%
						}{+\invertedradius}%				
					}%
				\fi%				
			\repeatpgfmathloop%
		}%
	}%
	\anchorborder{%
		\pgfextract@process\externalpoint{}%
		\pgf@xa\pgf@x%
		\pgf@ya\pgf@y%
		\dimensions%
		\pgf@xb\halfside%
		%
		\pgf@xb-.166666\pgf@xb%
		\ifdim\pgf@xa<\pgf@xb%
			\pgfpointadd{\centerpoint}{%
				\pgfpointborderrectangle{\externalpoint}{%
					\pgf@xc\halfside%
					\pgf@xc.166666\pgf@xc%
					\advance\pgf@xc\halfwidth%
					\pgfqpoint{\pgf@xc}{\halfheight}%
				}%
			}%
		\else%
			\ifdim\pgf@y=0pt\relax%
				\csname pgf@anchor@AND gate@east\endcsname%
			\else%
				\pgfextract@process\externalpoint{\pgfpointadd{\centerpoint}{\externalpoint}}%
				\pgf@xc\halfwidth%
				\advance\pgf@xc\halfside%
				\pgf@yc\halfheight%
				\advance\pgf@yc\halfside%
				\ifdim\pgf@ya<0pt%
					\pgfmathpointintersectionoflineandarc{\externalpoint}{\centerpoint}%
					{%
						\centerpoint%
						\advance\pgf@y\halfside%	
						\advance\pgf@x\pgf@xb%		
					}%
					{270}{330}{+\pgf@yc}%
				\else%
					\pgfmathpointintersectionoflineandarc{\externalpoint}{\centerpoint}%
					{%
						\centerpoint%
						\advance\pgf@y-\halfside%	
						\advance\pgf@x\pgf@xb%
					}%
					{30}{90}{+\pgf@xc and +\pgf@yc}%
				\fi%
			\fi%
		\fi%
	}
}


\pgfdeclareshape{NAND gate}{%
	\expandafter\pgfutil@g@addto@macro\csname pgf@sh@s@NAND gate\endcsname{%
		\pgf@lib@sh@logicgate@parseinputs{1024}% Maximum 1024 (!) inputs.
		%
		\pgfmathloop%
		\ifnum\pgfmathcounter>\pgf@lib@sh@logicgate@numinputs%
		\else%
			\pgfutil@ifundefined{pgf@anchor@NAND gate@input \pgfmathcounter}{%
				\expandafter\xdef\csname pgf@anchor@NAND gate@input \pgfmathcounter\endcsname{%
					\noexpand\pgf@lib@sh@logicgate@AND@inputanchor{\pgfmathcounter}%
				}%
			}{}%
		\repeatpgfmathloop%
		\ifnum\pgf@lib@sh@logicgate@numinputs<2\relax%
			\PackageError{PGF}{A NAND gate must have at least two inputs}{}%
		\fi%
	}%
	\savedmacro\numinputs{\let\numinputs\pgf@lib@sh@logicgate@numinputs}%
	\saveddimen\invertedradius{%
		\pgfmathsetlength\pgf@x{\pgfkeysvalueof{/pgf/logic gate inverted radius}}%
	}%
	\saveddimen\outerinvertedradius{%
		\pgfmathsetlength\pgf@x{\pgfkeysvalueof{/pgf/logic gate inverted radius}}%
		\advance\pgf@x.5\pgflinewidth%
	}
	\savedmacro\dimensions{\pgf@lib@sh@logicgates@dimensions}
	\savedanchor\centerpoint{%
		\pgf@x.5\wd\pgfnodeparttextbox%
		\pgf@y.5\ht\pgfnodeparttextbox%
		\advance\pgf@y-.5\dp\pgfnodeparttextbox%
	}
	\savedanchor\midpoint{%
		\pgf@x.5\wd\pgfnodeparttextbox%
		\pgfmathsetlength\pgf@y{+0.5ex}%
	}
	\savedanchor\basepoint{%
		\pgf@x.5\wd\pgfnodeparttextbox%
		\pgf@y0pt%
	}
	\anchor{center}{\centerpoint}%
	\anchor{mid}{\midpoint}%
	\inheritanchor[from=AND gate]{mid east}
	\inheritanchor[from=AND gate]{mid west}
	\anchor{base}{\basepoint}%
	\inheritanchor[from=AND gate]{base east}
	\inheritanchor[from=AND gate]{base west}
	\anchor{output}{%
		\dimensions
		\pgfpointadd{\centerpoint}{%
			\pgf@xa\halfside%
			\pgf@x-.166666\pgf@xa%
			\pgf@xb2.0\pgf@xa%
			\advance\pgf@x.866025\pgf@xb%
			\advance\pgf@x\invertedradius%
			\advance\pgf@x\outerinvertedradius%
			\advance\pgf@x\outerxsep%
			\pgf@y0pt%
		}%
	}
	\inheritanchor[from=AND gate]{east}
	\inheritanchor[from=AND gate]{north east}
	\inheritanchor[from=AND gate]{south east}
	\inheritanchor[from=AND gate]{north}
	\inheritanchor[from=AND gate]{south}
	\inheritanchor[from=AND gate]{south west}
	\inheritanchor[from=AND gate]{north west}
	\inheritanchor[from=AND gate]{west}
	\backgroundpath{%
		\dimensions%
		\pgf@xc\halfwidth%
		\pgf@yc\halfheight%
		\advance\pgf@xc-\outerxsep%
		\advance\pgf@yc-\outerysep%
		{%
			\pgftransformshift{\centerpoint}%
			\pgfpathmoveto{\pgfqpoint{-.16666\pgf@xc}{\pgf@yc}}%
			{%
				\pgf@yc2.0\pgf@yc%
				\edef\pgf@marshal{%
					\noexpand\pgfpatharc{90}{30}{\the\pgf@yc}%
				}%
				\pgf@marshal%
			}
			{%
				\pgf@yc2.0\pgf@yc%
				\edef\pgf@marshal{%
					\noexpand\pgfpatharc{-30}{-90}{\the\pgf@yc}%
				}%
				\pgf@marshal%
			}
			\pgfpathlineto{\pgfqpoint{-1.16666\pgf@xc}{-\pgf@yc}}%
			\pgfpathlineto{\pgfqpoint{-1.16666\pgf@xc}{\pgf@yc}}%
			\pgfpathclose%
			%
			% Draw the output inverter.
			%
			{%
				\pgfpathcircle{%
					\pgf@x-.166666\pgf@xc%
					\pgf@yc2.0\pgf@yc%
					\advance\pgf@x.866025\pgf@yc%
					\advance\pgf@x\outerinvertedradius%
					\pgf@y0pt%
				}{+\invertedradius}%			
			}%
			%
			% Draw the inputs.
			%
			\pgfutil@tempdima2.0\pgf@yc%
			\c@pgf@counta\numinputs%
			\advance\c@pgf@counta1\relax%
			\divide\pgfutil@tempdima\c@pgf@counta%
			\pgfmathloop%
			\ifnum\pgfmathcounter>\numinputs%
			\else%
				\advance\pgf@yc-\pgfutil@tempdima%
				\expandafter\ifx\expandafter\pgf@lib@sh@itext\csname input-\pgfmathcounter\endcsname%
					{%
						\pgfpathcircle{%
							\pgf@xa\halfside%
							\pgf@x-1.16666\pgf@xa%
							\advance\pgf@x-.5\pgflinewidth%
							\advance\pgf@x-\invertedradius%
							\pgf@y\pgf@yc%
						}{+\invertedradius}%				
					}%
				\fi%				
			\repeatpgfmathloop%
		}%
	}%
	\inheritanchorborder[from=AND gate]
}


\def\pgf@lib@sh@logicgate@OR@inputanchor#1{%
	\dimensions%
	\pgf@ya\halfside%
	\pgf@yb2.0\pgf@ya%
	%
	\pgfutil@tempdima\halfside%
	\multiply\pgfutil@tempdima2\relax%
	\c@pgf@counta\numinputs%
	\advance\c@pgf@counta1\relax%
	\divide\pgfutil@tempdima\c@pgf@counta%
	\multiply\pgfutil@tempdima#1\relax%
	\pgf@yc\pgf@ya%
	\advance\pgf@yc-\pgfutil@tempdima%
	%
	\pgf@xb\pgf@yb%
	\advance\pgf@yb-\halflinewidth%
	\pgfmathdivide@{\pgfmath@tonumber{\pgf@yc}}{\pgfmath@tonumber{\pgf@yb}}%
	\pgfmathasin@{\pgfmathresult}%
	\pgfmathcos@{\pgfmathresult}%
	%
	\pgf@xc-1.166666\pgf@ya%
	\advance\pgf@xc-.866025\pgf@xb%
	\advance\pgf@xc\pgfmathresult\pgf@yb%
	\advance\pgf@xc\halflinewidth%
	\advance\pgf@xc-\outerxsep%
	%
	\expandafter\ifx\expandafter\pgf@lib@sh@itext\csname input-#1\endcsname%
		\advance\pgf@xc-\invertedradius%
		\advance\pgf@xc-\outerinvertedradius%
	\fi%
	%
	\centerpoint%
	\advance\pgf@x\pgf@xc%
	\advance\pgf@y\pgf@yc%
}

\pgfdeclareshape{OR gate}{%
	\expandafter\pgfutil@g@addto@macro\csname pgf@sh@s@OR gate\endcsname{%
		\pgf@lib@sh@logicgate@parseinputs{1024}% Maximum 1024 (!) inputs.
		%
		\pgfmathloop%
		\ifnum\pgfmathcounter>\pgf@lib@sh@logicgate@numinputs%
		\else%
			\pgfutil@ifundefined{pgf@anchor@OR gate@input \pgfmathcounter}{%
				\expandafter\xdef\csname pgf@anchor@OR gate@input \pgfmathcounter\endcsname{%
					\noexpand\pgf@lib@sh@logicgate@OR@inputanchor{\pgfmathcounter}%
				}%
			}{}%
		\repeatpgfmathloop%
		\ifnum\pgf@lib@sh@logicgate@numinputs<2\relax%
			\PackageError{PGF}{An OR gate must have at least two inputs}{}%
		\fi%
	}%
	\savedmacro\numinputs{\let\numinputs\pgf@lib@sh@logicgate@numinputs}%
	\saveddimen\invertedradius{%
		\pgfmathsetlength\pgf@x{\pgfkeysvalueof{/pgf/logic gate inverted radius}}%
	}%
	\saveddimen\halflinewidth{%
		\pgf@x.5\pgflinewidth%
	}%
	\saveddimen\outerinvertedradius{%
		\pgfmathsetlength\pgf@x{\pgfkeysvalueof{/pgf/logic gate inverted radius}}%
		\advance\pgf@x.5\pgflinewidth%
	}
	\savedmacro\dimensions{\pgf@lib@sh@logicgates@dimensions}
	\savedanchor\centerpoint{%
		\pgf@x.5\wd\pgfnodeparttextbox%
		\pgf@y.5\ht\pgfnodeparttextbox%
		\advance\pgf@y-.5\dp\pgfnodeparttextbox%
	}
	\savedanchor\midpoint{%
		\pgf@x.5\wd\pgfnodeparttextbox%
		\pgfmathsetlength\pgf@y{+0.5ex}%
	}
	\savedanchor\basepoint{%
		\pgf@x.5\wd\pgfnodeparttextbox%
		\pgf@y0pt%
	}
	\anchor{center}{\centerpoint}%
	\anchor{mid}{\midpoint}%
	\inheritanchor[from=AND gate]{mid east}
	\anchor{mid west}{%
		\csname pgf@anchor@OR gate@north west\endcsname%
		\pgf@xa\pgf@x%
		\midpoint%
		\pgf@x\pgf@xa}
	\anchor{base}{\basepoint}%
	\inheritanchor[from=AND gate]{base east}
	\anchor{base west}{%
		\csname pgf@anchor@OR gate@north west\endcsname%
		\pgf@xa\pgf@x%
		\basepoint%
		\pgf@x\pgf@xa}
	\inheritanchor[from=AND gate]{base}
	\inheritanchor[from=AND gate]{output}
	\inheritanchor[from=AND gate]{east}
	\inheritanchor[from=AND gate]{north east}
	\inheritanchor[from=AND gate]{south east}
	\inheritanchor[from=AND gate]{north}
	\inheritanchor[from=AND gate]{south}
	\anchor{south west}{%
		\dimensions%
		\centerpoint%
		\pgf@xa\halfside%
		\advance\pgf@x-1.16666\pgf@xa%
		\pgf@xa\outerxsep%
		\advance\pgf@x-1.732051\pgf@xa%
		\advance\pgf@y-\halfheight%
	}
	\anchor{north west}{%
		\dimensions%
		\centerpoint%
		\pgf@xa\halfside%
		\advance\pgf@x-1.16666\pgf@xa%
		\pgf@xa\outerxsep%
		\advance\pgf@x-1.732051\pgf@xa%
		\advance\pgf@y\halfheight%
	}
	\anchor{west}{%
		\ifpgfgateanchorsuseboundingrectangle%
			\centerpoint%
			\pgf@ya\pgf@y%
			\csname pgf@anchor@OR gate@north west\endcsname%
			\pgf@y\pgf@ya%
		\else%
			\dimensions%
			\pgf@ya\halfside%
			\pgf@yb2.0\pgf@ya%
			%
			\pgf@xb\pgf@yb%
			\advance\pgf@yb-\halflinewidth%
			\pgfmathdivide@{0}{\pgfmath@tonumber{\pgf@yb}}%
			\pgfmathasin@{\pgfmathresult}%
			\pgfmathcos@{\pgfmathresult}%
			%
			\pgf@xc-1.166666\pgf@ya%
			\advance\pgf@xc-.866025\pgf@xb%
			\advance\pgf@xc\pgfmathresult\pgf@yb%
			\advance\pgf@xc\halflinewidth%
			\advance\pgf@xc-\outerxsep%
			%
			\centerpoint%
			\advance\pgf@x\pgf@xc%
		\fi%
	}
	\backgroundpath{%
		\dimensions%
		\pgf@xc\halfwidth%
		\pgf@yc\halfheight%
		\advance\pgf@xc-\outerxsep%
		\advance\pgf@yc-\outerysep%
		{%
			\pgftransformshift{\centerpoint}%
			\pgfpathmoveto{\pgfqpoint{-.16666\pgf@xc}{\pgf@yc}}%
			{%
				\pgf@yc2.0\pgf@yc%
				\edef\pgf@marshal{%
					\noexpand\pgfpatharc{90}{30}{\the\pgf@yc}%
				}%
				\pgf@marshal%
			}
			{%
				\pgf@yc2.0\pgf@yc%
				\edef\pgf@marshal{%
					\noexpand\pgfpatharc{-30}{-90}{\the\pgf@yc}%
				}%
				\pgf@marshal%
			}
			\pgfpathlineto{\pgfqpoint{-1.16666\pgf@xc}{-\pgf@yc}}%
			{%
				\pgf@yc2.0\pgf@yc%
				\pgfpatharc{-30}{0}{+\pgf@yc}%			
			}
			{%
				\pgf@yc2.0\pgf@yc%
				\pgfpatharc{0}{30}{+\pgf@yc}%			
			}%
			\pgfpathclose%
			%
			% Draw the inputs.
			%
			\pgfutil@tempdima2.0\pgf@yc%
			\c@pgf@counta\numinputs%
			\advance\c@pgf@counta1\relax%
			\divide\pgfutil@tempdima\c@pgf@counta%
			\pgfmathloop%
			\ifnum\pgfmathcounter>\numinputs%
			\else%
				\advance\pgf@yc-\pgfutil@tempdima%
				\expandafter\ifx\expandafter\pgf@lib@sh@itext\csname input-\pgfmathcounter\endcsname%
					{%
						\pgfpathcircle{%
							\pgf@ya\halfside%
							\pgf@yb2.0\pgf@ya%
							\pgf@xa\pgf@yb%
							\advance\pgf@yb-\halflinewidth%
							\pgfmathdivide@{\pgfmath@tonumber{\pgf@yc}}{\pgfmath@tonumber{\pgf@yb}}%
							\let\sineangle\pgfmathresult%
							\pgfmathasin@{\pgfmathresult}%
							\pgfmathcos@{\pgfmathresult}%
							%
							\pgf@x-1.166666\pgf@ya%
							\advance\pgf@x-.866025\pgf@xa%
							\advance\pgf@x\pgfmathresult\pgf@yb%
							\advance\pgf@x-\invertedradius%
							\pgf@y\pgf@yc%
						}{+\invertedradius}%				
					}%
				\fi%				
			\repeatpgfmathloop%
		}%
	}%
	\anchorborder{%
		\pgfextract@process\externalpoint{}%
		\pgfextract@process\externalpoint{\pgfpointadd{\centerpoint}{\externalpoint}}%
		\pgf@xa\pgf@x%
		\pgf@ya\pgf@y%
		\centerpoint%
		\pgf@xb\pgf@x%
		\pgf@yb\pgf@y%
		\pgfmathanglebetweenpoints{\centerpoint}{\externalpoint}%
		\let\externalangle\pgfmathresult%
		\dimensions%
		\pgf@xc\halfside%
		%
		\pgf@xc-.166666\pgf@xc%
		\ifdim\pgf@xa<\pgf@xc%
			\pgfmathanglebetweenpoints{\centerpoint}{\csname pgf@anchor@OR gate@north west\endcsname}%
			\ifdim\externalangle pt<\pgfmathresult pt\relax%
				\pgfpointintersectionoflines{\externalpoint}{\centerpoint}%
					{%
						\pgfgateanchorsuseboundingrectangletrue%
						\csname pgf@anchor@OR gate@north\endcsname%
					}%
					{\csname pgf@anchor@OR gate@north west\endcsname}%
			\else%
				\pgfmathsubtract@{360}{\pgfmathresult}%
				\ifdim\externalangle pt>\pgfmathresult pt\relax%
					\pgfpointintersectionoflines{\externalpoint}{\centerpoint}%
					{%
						\pgfgateanchorsuseboundingrectangletrue%
						\csname pgf@anchor@OR gate@south\endcsname%
					}%
					{\csname pgf@anchor@OR gate@south west\endcsname}%
				\else%
					\ifdim\pgf@ya>\pgf@yb%
						\pgf@yc\halfheight%
						\advance\pgf@yc\halfside%
						\advance\pgf@yc-\outerxsep%
						\pgfextract@process\point{%
							\pgfmathpointintersectionoflineandarc{\centerpoint}{\externalpoint}%
							{%
								\centerpoint%
								\pgf@xa\halfside%
								\advance\pgf@x-1.166666\pgf@xa%
								\pgf@xa2.0\pgf@xa%
								\advance\pgf@x-.866025\pgf@xa%
								\advance\pgf@x-\outerxsep%
							}%
							{0}{90}{+\pgf@yc}%
						}%
					\else%
						\pgf@yc\halfheight%
						\advance\pgf@yc\halfside%
						\advance\pgf@yc-\outerxsep%
						\pgfextract@process\point{%
							\pgfmathpointintersectionoflineandarc{\centerpoint}{\externalpoint}%
							{%
								\centerpoint%
								\pgf@xa\halfside%
								\advance\pgf@x-1.166666\pgf@xa%
								\pgf@xa2.0\pgf@xa%
								\advance\pgf@x-.866025\pgf@xa%
								\advance\pgf@x-\outerxsep%
							}%
							{270}{360}{+\pgf@yc}%
						}%
					\fi%
				\fi%
			\fi%
		\else%
			\ifdim\pgf@y=0pt\relax%
				\csname pgf@anchor@AND gate@east\endcsname%
			\else%
				\pgf@xc\halfwidth%
				\advance\pgf@xc\halfside%
				\pgf@yc\halfheight%
				\advance\pgf@yc\halfside%
				\pgf@xb\halfside%
				\pgf@xb-.166666\pgf@xb%
				\ifdim\pgf@ya<0pt%
					\pgfmathpointintersectionoflineandarc{\externalpoint}{\centerpoint}%
					{%
						\centerpoint%
						\advance\pgf@y\halfside%	
						\advance\pgf@x\pgf@xb%		
					}%
					{270}{330}{+\pgf@yc}%
				\else%
					\pgfmathpointintersectionoflineandarc{\externalpoint}{\centerpoint}%
					{%
						\centerpoint%
						\advance\pgf@y-\halfside%	
						\advance\pgf@x\pgf@xb%
					}%
					{30}{90}{+\pgf@xc and +\pgf@yc}%
				\fi%
			\fi%
		\fi%
	}%
}


\pgfdeclareshape{NOR gate}{%
	\expandafter\pgfutil@g@addto@macro\csname pgf@sh@s@NOR gate\endcsname{%
		\pgf@lib@sh@logicgate@parseinputs{1024}% Maximum 1024 (!) inputs.
		%
		\pgfmathloop%
		\ifnum\pgfmathcounter>\pgf@lib@sh@logicgate@numinputs%
		\else%
			\pgfutil@ifundefined{pgf@anchor@NOR gate@input \pgfmathcounter}{%
				\expandafter\xdef\csname pgf@anchor@NOR gate@input \pgfmathcounter\endcsname{%
					\noexpand\pgf@lib@sh@logicgate@OR@inputanchor{\pgfmathcounter}%
				}%
			}{}%
		\repeatpgfmathloop%
		\ifnum\pgf@lib@sh@logicgate@numinputs<2\relax%
			\PackageError{PGF}{A NOR gate must have at least two inputs}{}%
		\fi%
	}%
	\savedmacro\numinputs{\let\numinputs\pgf@lib@sh@logicgate@numinputs}%
	\saveddimen\invertedradius{%
		\pgfmathsetlength\pgf@x{\pgfkeysvalueof{/pgf/logic gate inverted radius}}%
	}%
	\saveddimen\halflinewidth{%
		\pgf@x.5\pgflinewidth%
	}%
	\saveddimen\outerinvertedradius{%
		\pgfmathsetlength\pgf@x{\pgfkeysvalueof{/pgf/logic gate inverted radius}}%
		\advance\pgf@x.5\pgflinewidth%
	}
	\savedmacro\dimensions{\pgf@lib@sh@logicgates@dimensions}
	\savedanchor\centerpoint{%
		\pgf@x.5\wd\pgfnodeparttextbox%
		\pgf@y.5\ht\pgfnodeparttextbox%
		\advance\pgf@y-.5\dp\pgfnodeparttextbox%
	}
	\savedanchor\midpoint{%
		\pgf@x.5\wd\pgfnodeparttextbox%
		\pgfmathsetlength\pgf@y{+0.5ex}%
	}
	\savedanchor\basepoint{%
		\pgf@x.5\wd\pgfnodeparttextbox%
		\pgf@y0pt%
	}
	\inheritanchor[from=OR gate]{center}
	\inheritanchor[from=OR gate]{mid}
	\inheritanchor[from=OR gate]{mid east}
	\inheritanchor[from=OR gate]{mid west}
	\inheritanchor[from=OR gate]{base}
	\inheritanchor[from=OR gate]{base east}
	\inheritanchor[from=OR gate]{base west}
	\inheritanchor[from=OR gate]{east}
	\inheritanchor[from=OR gate]{north east}
	\inheritanchor[from=OR gate]{south east}
	\inheritanchor[from=OR gate]{north}
	\inheritanchor[from=OR gate]{south}
	\inheritanchor[from=OR gate]{south west}
	\inheritanchor[from=OR gate]{north west}
	\inheritanchor[from=OR gate]{west}
	\inheritanchor[from=NAND gate]{output}
	\backgroundpath{%
		\dimensions%
		\pgf@xc\halfwidth%
		\pgf@yc\halfheight%
		\advance\pgf@xc-\outerxsep%
		\advance\pgf@yc-\outerysep%
		{%
			\pgftransformshift{\centerpoint}%
			\pgfpathmoveto{\pgfqpoint{-.16666\pgf@xc}{\pgf@yc}}%
			{%
				\pgf@yc2.0\pgf@yc%
				\edef\pgf@marshal{%
					\noexpand\pgfpatharc{90}{30}{\the\pgf@yc}%
				}%
				\pgf@marshal%
			}
			{%
				\pgf@yc2.0\pgf@yc%
				\edef\pgf@marshal{%
					\noexpand\pgfpatharc{-30}{-90}{\the\pgf@yc}%
				}%
				\pgf@marshal%
			}
			\pgfpathlineto{\pgfqpoint{-1.16666\pgf@xc}{-\pgf@yc}}%
			{%
				\pgf@yc2.0\pgf@yc%
				\pgfpatharc{-30}{0}{+\pgf@yc}%			
			}
			{%
				\pgf@yc2.0\pgf@yc%
				\pgfpatharc{0}{30}{+\pgf@yc}%			
			}%
			\pgfpathclose%
			% Draw the output inverter.
			%
			{%
				\pgfpathcircle{%
					\pgf@x-.166666\pgf@xc%
					\pgf@yc2.0\pgf@yc%
					\advance\pgf@x.866025\pgf@yc%
					\advance\pgf@x\outerinvertedradius%
					\pgf@y0pt%
				}{+\invertedradius}%			
			}%
			%
			% Draw the inputs.
			%
			\pgfutil@tempdima2.0\pgf@yc%
			\c@pgf@counta\numinputs%
			\advance\c@pgf@counta1\relax%
			\divide\pgfutil@tempdima\c@pgf@counta%
			\pgfmathloop%
			\ifnum\pgfmathcounter>\numinputs%
			\else%
				\advance\pgf@yc-\pgfutil@tempdima%
				\expandafter\ifx\expandafter\pgf@lib@sh@itext\csname input-\pgfmathcounter\endcsname%
					{%
						\pgfpathcircle{%
							\pgf@ya\halfside%
							\pgf@yb2.0\pgf@ya%
							\pgf@xa\pgf@yb%
							\advance\pgf@yb-\halflinewidth%
							\pgfmathdivide@{\pgfmath@tonumber{\pgf@yc}}{\pgfmath@tonumber{\pgf@yb}}%
							\let\sineangle\pgfmathresult%
							\pgfmathasin@{\pgfmathresult}%
							\pgfmathcos@{\pgfmathresult}%
							%
							\pgf@x-1.166666\pgf@ya%
							\advance\pgf@x-.866025\pgf@xa%
							\advance\pgf@x\pgfmathresult\pgf@yb%
							\advance\pgf@x-\invertedradius%
							\pgf@y\pgf@yc%
						}{+\invertedradius}%				
					}%
				\fi%				
			\repeatpgfmathloop%
		}%
	}%
	\inheritanchorborder[from=OR gate]
}



\def\pgf@lib@sh@logicgate@XOR@inputanchor#1{%
	\dimensions%
	\pgf@ya\halfside%
	\pgf@yb2.0\pgf@ya%
	%
	\pgfutil@tempdima\halfside%
	\multiply\pgfutil@tempdima2\relax%
	\c@pgf@counta\numinputs%
	\advance\c@pgf@counta1\relax%
	\divide\pgfutil@tempdima\c@pgf@counta%
	\multiply\pgfutil@tempdima#1\relax%
	\pgf@yc\pgf@ya%
	\advance\pgf@yc-\pgfutil@tempdima%
	%
	\pgf@xb\pgf@yb%
	\advance\pgf@yb-\halflinewidth%
	\pgfmathdivide@{\pgfmath@tonumber{\pgf@yc}}{\pgfmath@tonumber{\pgf@yb}}%
	\pgfmathasin@{\pgfmathresult}%
	\pgfmathcos@{\pgfmathresult}%
	%
	\pgf@xc-1.166666\pgf@ya%
	\advance\pgf@xc-.866025\pgf@xb%
	\advance\pgf@xc\pgfmathresult\pgf@yb%
	\advance\pgf@xc\halflinewidth%
	\advance\pgf@xc-\outerxsep%
	%
	\expandafter\ifx\expandafter\pgf@lib@sh@itext\csname input-#1\endcsname%
		\advance\pgf@xc-\invertedradius%
		\advance\pgf@xc-\outerinvertedradius%
	\fi%
	%
	\centerpoint%
	\advance\pgf@x\pgf@xc%
	\advance\pgf@y\pgf@yc%
	\pgf@xa\halfside%
	\advance\pgf@x-.333333\pgf@xa%
}


\pgfdeclareshape{XOR gate}{%
	\expandafter\pgfutil@g@addto@macro\csname pgf@sh@s@XOR gate\endcsname{%
		\pgf@lib@sh@logicgate@parseinputs{2}% 
		%
		\pgfmathloop%
		\ifnum\pgfmathcounter>\pgf@lib@sh@logicgate@numinputs%
		\else%
			\pgfutil@ifundefined{pgf@anchor@XOR gate@input \pgfmathcounter}{%
				\expandafter\xdef\csname pgf@anchor@XOR gate@input \pgfmathcounter\endcsname{%
					\noexpand\pgf@lib@sh@logicgate@XOR@inputanchor{\pgfmathcounter}%
				}%
			}{}%
		\repeatpgfmathloop%
		\ifnum\pgf@lib@sh@logicgate@numinputs<2\relax%
			\PackageError{PGF}{An XOR gate must have at two inputs}{}%
		\fi%
	}%
	\savedmacro\numinputs{\let\numinputs\pgf@lib@sh@logicgate@numinputs}%
	\saveddimen\invertedradius{%
		\pgfmathsetlength\pgf@x{\pgfkeysvalueof{/pgf/logic gate inverted radius}}%
	}%
	\saveddimen\halflinewidth{%
		\pgf@x.5\pgflinewidth%
	}%
	\saveddimen\outerinvertedradius{%
		\pgfmathsetlength\pgf@x{\pgfkeysvalueof{/pgf/logic gate inverted radius}}%
		\advance\pgf@x.5\pgflinewidth%
	}
	\savedmacro\dimensions{\pgf@lib@sh@logicgates@dimensions}
	\savedanchor\centerpoint{%
		\pgf@x.5\wd\pgfnodeparttextbox%
		\pgf@y.5\ht\pgfnodeparttextbox%
		\advance\pgf@y-.5\dp\pgfnodeparttextbox%
	}
	\savedanchor\midpoint{%
		\pgf@x.5\wd\pgfnodeparttextbox%
		\pgfmathsetlength\pgf@y{+0.5ex}%
	}
	\savedanchor\basepoint{%
		\pgf@x.5\wd\pgfnodeparttextbox%
		\pgf@y0pt%
	}
	\anchor{center}{\centerpoint}%
	\anchor{mid}{\midpoint}%
	\inheritanchor[from=OR gate]{mid east}
	\anchor{mid west}{%
		\csname pgf@anchor@XOR gate@north west\endcsname%
		\pgf@xa\pgf@x%
		\midpoint%
		\pgf@x\pgf@xa}
	\anchor{base}{\basepoint}%
	\inheritanchor[from=AND gate]{base east}
	\anchor{base west}{%
		\csname pgf@anchor@XOR gate@north west\endcsname%
		\pgf@xa\pgf@x%
		\basepoint%
		\pgf@x\pgf@xa}
	\inheritanchor[from=OR gate]{base}
	\inheritanchor[from=OR gate]{output}
	\inheritanchor[from=OR gate]{east}
	\inheritanchor[from=OR gate]{north east}
	\inheritanchor[from=OR gate]{south east}
	\inheritanchor[from=OR gate]{north}
	\inheritanchor[from=OR gate]{south}
	\anchor{south west}{%
		\dimensions%
		\pgf@xa\halfside%
		\pgf@xa-3.232051\pgf@xa% (7/6 + 2*cos(30) + 1/3) * x
		\pgf@xb\halfside%
		\pgf@xb2.0\pgf@xb%
		\advance\pgf@xb-\halflinewidth%
		\advance\pgf@xa.866025\pgf@xb%
		\pgf@ya.5\pgf@xb%
		\centerpoint%
		\advance\pgf@x\pgf@xa%
		\ifpgfgateanchorsuseboundingrectangle%
			\advance\pgf@y-\halfheight%
		\else%
			\advance\pgf@y-\pgf@ya%
		\fi%
	}
	\anchor{north west}{%
		\dimensions%
		\pgf@xa\halfside%
		\pgf@xa-3.232051\pgf@xa% (7/6 + 2*cos(30) + 1/3) * x
		\pgf@xb\halfside%
		\pgf@xb2.0\pgf@xb%
		\advance\pgf@xb-\halflinewidth%
		\advance\pgf@xa.866025\pgf@xb%
		\pgf@ya.5\pgf@xb%
		\centerpoint%
		\advance\pgf@x\pgf@xa%
		\ifpgfgateanchorsuseboundingrectangle%
			\advance\pgf@y\halfheight%
		\else%
			\advance\pgf@y\pgf@ya%
		\fi%
	}
	\anchor{west}{%
		\dimensions%
		\pgf@ya\halfside%
		\pgf@yb2.0\pgf@ya%
		%
		\pgf@xb\pgf@yb%
		\advance\pgf@yb-\halflinewidth%
		\pgfmathdivide@{0}{\pgfmath@tonumber{\pgf@yb}}%
		\pgfmathasin@{\pgfmathresult}%
		\pgfmathcos@{\pgfmathresult}%
		%
		\pgf@xc-1.166666\pgf@ya%
		\advance\pgf@xc-.866025\pgf@xb%
		\advance\pgf@xc\pgfmathresult\pgf@yb%
		\advance\pgf@xc\halflinewidth%
		\advance\pgf@xc-\outerxsep%
		%
		\centerpoint%
		\advance\pgf@x\pgf@xc%
		\pgf@xa\halfside%
		\advance\pgf@x-.333333\pgf@xa%
		\ifpgfgateanchorsuseboundingrectangle%
			\pgf@xa2.0\pgf@xa%
			\advance\pgf@x-0.133974\pgf@xa%
		\fi%
	}
	\backgroundpath{%
		\dimensions%
		\pgf@xc\halfwidth%
		\pgf@yc\halfheight%
		\advance\pgf@xc-\outerxsep%
		\advance\pgf@yc-\outerysep%
		{%
			\pgftransformshift{\centerpoint}%
			\pgfpathmoveto{\pgfqpoint{-.16666\pgf@xc}{\pgf@yc}}%
			{%
				\pgf@yc2.0\pgf@yc%
				\edef\pgf@marshal{%
					\noexpand\pgfpatharc{90}{30}{\the\pgf@yc}%
				}%
				\pgf@marshal%
			}
			{%
				\pgf@yc2.0\pgf@yc%
				\edef\pgf@marshal{%
					\noexpand\pgfpatharc{-30}{-90}{\the\pgf@yc}%
				}%
				\pgf@marshal%
			}
			\pgfpathlineto{\pgfqpoint{-1.16666\pgf@xc}{-\pgf@yc}}%
			{%
				\pgf@yc2.66666\pgf@yc%
				\pgfpatharc{-22}{0}{+1.166666\pgf@yc and +\pgf@yc}%			
			}
			{%
				\pgf@yc2.66666\pgf@yc%
				\pgfpatharc{0}{22}{+1.166666\pgf@yc and +\pgf@yc}%			
			}%
			\pgfpathclose%
			%
			% Draw the inputs.
			%
			\pgfutil@tempdima2.0\pgf@yc%
			\c@pgf@counta\numinputs%
			\advance\c@pgf@counta1\relax%
			\divide\pgfutil@tempdima\c@pgf@counta%
			\pgfmathloop%
			\ifnum\pgfmathcounter>\numinputs%
			\else%
				\advance\pgf@yc-\pgfutil@tempdima%
				\expandafter\ifx\expandafter\pgf@lib@sh@itext\csname input-\pgfmathcounter\endcsname%
					{%
						\pgfpathcircle{%
							\pgf@ya\halfside%
							\pgf@yb2.0\pgf@ya%
							\pgf@xa\pgf@yb%
							\advance\pgf@yb-\halflinewidth%
							\pgfmathdivide@{\pgfmath@tonumber{\pgf@yc}}{\pgfmath@tonumber{\pgf@yb}}%
							\pgfmathasin@{\pgfmathresult}%
							\pgfmathcos@{\pgfmathresult}%
							%
							\pgf@x-1.5\pgf@ya%
							\advance\pgf@x-.866025\pgf@xa%
							\advance\pgf@x\pgfmathresult\pgf@yb%
							\advance\pgf@x-\invertedradius%
							\pgf@y\pgf@yc%
						}{+\invertedradius}%				
					}%
				\fi%				
			\repeatpgfmathloop%
			%
			% Now, some fooling around to stop the `tail' being filled.
			% Technically it still is, but it isn't visible.
			%
			\pgf@xc\halfside%
			\pgf@yc\halfside%
			\pgfpathmoveto{\pgfqpoint{-1.5\pgf@xc}{-\pgf@yc}}%
			\pgf@yc2.0\pgf@yc%
			\pgfmathloop%
			\ifnum\pgfmathcounter<61\relax%
				{%
					\pgfextract@process\point{%
						\pgfpointadd{%
							\pgf@x\halfside%
							\pgf@x-3.232051\pgf@x% (7/6 + 2*cos(30) + 1/3) * x
							\pgf@y0pt%
						}{%
							\pgfpointpolar{\pgfmathcounter-30}{+\pgf@yc}%
						}%
					}%
					\pgfpathlineto{\point}%
					\pgfpathmoveto{\point}%
				}
			\repeatpgfmathloop%
		}%
	}%
	\anchorborder{%
		\pgfextract@process\externalpoint{}%
		\pgfextract@process\externalpoint{\pgfpointadd{\centerpoint}{\externalpoint}}%
		\pgf@xa\pgf@x%
		\pgf@ya\pgf@y%
		\centerpoint%
		\pgf@xb\pgf@x%
		\pgf@yb\pgf@y%
		\pgfmathanglebetweenpoints{\centerpoint}{\externalpoint}%
		\let\externalangle\pgfmathresult%
		\dimensions%
		\pgf@xc\halfside%
		%
		\pgf@xc-.166666\pgf@xc%
		\ifdim\pgf@xa<\pgf@xc%
			\pgfmathanglebetweenpoints{\centerpoint}%
			{%
				\pgfgateanchorsuseboundingrectangletrue%
				\csname pgf@anchor@XOR gate@north west\endcsname%
			}%
			\ifdim\externalangle pt<\pgfmathresult pt\relax%
				\pgfpointintersectionoflines{\externalpoint}{\centerpoint}%
					{%
						\pgfgateanchorsuseboundingrectangletrue%
						\csname pgf@anchor@XOR gate@north\endcsname%
					}%
					{%
						\pgfgateanchorsuseboundingrectangletrue%
						\csname pgf@anchor@XOR gate@north west\endcsname%
					}%
			\else%
				\pgfmathsubtract@{360}{\pgfmathresult}%
				\ifdim\externalangle pt>\pgfmathresult pt\relax%
					\pgfpointintersectionoflines{\externalpoint}{\centerpoint}%
					{%
						\pgfgateanchorsuseboundingrectangletrue%
						\csname pgf@anchor@XOR gate@south\endcsname%
					}%
					{%
						\pgfgateanchorsuseboundingrectangletrue%
						\csname pgf@anchor@XOR gate@south west\endcsname%
					}%
				\else%
					\ifdim\pgf@ya>\pgf@yb%
						\pgf@yc\halfheight%
						\advance\pgf@yc\halfside%
						\advance\pgf@yc-\outerxsep%
						\pgf@process{%
							\pgfmathpointintersectionoflineandarc{\centerpoint}{\externalpoint}%
							{%
								\centerpoint%
								\pgf@xa\halfside%
								\advance\pgf@x-1.166666\pgf@xa%
								\pgf@xa2.0\pgf@xa%
								\advance\pgf@x-.866025\pgf@xa%
								\advance\pgf@x-\outerxsep%
								\advance\pgf@x-.166666\pgf@xa%
							}%
							{0}{90}{+\pgf@yc}%
						}%
					\else%
						\pgf@yc\halfheight%
						\advance\pgf@yc\halfside%
						\advance\pgf@yc-\outerxsep%
						\pgf@process{%
							\pgfmathpointintersectionoflineandarc{\centerpoint}{\externalpoint}%
							{%
								\centerpoint%
								\pgf@xa\halfside%
								\advance\pgf@x-1.166666\pgf@xa%
								\pgf@xa2.0\pgf@xa%
								\advance\pgf@x-.866025\pgf@xa%
								\advance\pgf@x-\outerxsep%
								\advance\pgf@x-.166666\pgf@xa%
							}%
							{270}{360}{+\pgf@yc}%
						}%
					\fi%
				\fi%
			\fi%
		\else%
			\ifdim\pgf@y=0pt\relax%
				\csname pgf@anchor@AND gate@east\endcsname%
			\else%
				\pgf@xc\halfwidth%
				\advance\pgf@xc\halfside%
				\pgf@yc\halfheight%
				\advance\pgf@yc\halfside%
				\pgf@xb\halfside%
				\pgf@xb-.166666\pgf@xb%
				\ifdim\pgf@ya<0pt%
					\pgfmathpointintersectionoflineandarc{\externalpoint}{\centerpoint}%
					{%
						\centerpoint%
						\advance\pgf@y\halfside%	
						\advance\pgf@x\pgf@xb%		
					}%
					{270}{330}{+\pgf@yc}%
				\else%
					\pgfmathpointintersectionoflineandarc{\externalpoint}{\centerpoint}%
					{%
						\centerpoint%
						\advance\pgf@y-\halfside%	
						\advance\pgf@x\pgf@xb%
					}%
					{30}{90}{+\pgf@xc and +\pgf@yc}%
				\fi%
			\fi%
		\fi%
	}%
}



\pgfdeclareshape{XNOR gate}{%
	\expandafter\pgfutil@g@addto@macro\csname pgf@sh@s@XNOR gate\endcsname{%
		\pgf@lib@sh@logicgate@parseinputs{2}% 
		%
		\pgfmathloop%
		\ifnum\pgfmathcounter>\pgf@lib@sh@logicgate@numinputs%
		\else%
			\pgfutil@ifundefined{pgf@anchor@XNOR gate@input \pgfmathcounter}{%
				\expandafter\xdef\csname pgf@anchor@XNOR gate@input \pgfmathcounter\endcsname{%
					\noexpand\pgf@lib@sh@logicgate@XOR@inputanchor{\pgfmathcounter}%
				}%
			}{}%
		\repeatpgfmathloop%
		\ifnum\pgf@lib@sh@logicgate@numinputs<2\relax%
			\PackageError{PGF}{An XNOR gate must have two inputs}{}%
		\fi%
	}%
	\savedmacro\numinputs{\let\numinputs\pgf@lib@sh@logicgate@numinputs}%
	\saveddimen\invertedradius{%
		\pgfmathsetlength\pgf@x{\pgfkeysvalueof{/pgf/logic gate inverted radius}}%
	}%
	\saveddimen\halflinewidth{%
		\pgf@x.5\pgflinewidth%
	}%
	\saveddimen\outerinvertedradius{%
		\pgfmathsetlength\pgf@x{\pgfkeysvalueof{/pgf/logic gate inverted radius}}%
		\advance\pgf@x.5\pgflinewidth%
	}
	\savedmacro\dimensions{\pgf@lib@sh@logicgates@dimensions}
	\savedanchor\centerpoint{%
		\pgf@x.5\wd\pgfnodeparttextbox%
		\pgf@y.5\ht\pgfnodeparttextbox%
		\advance\pgf@y-.5\dp\pgfnodeparttextbox%
	}
	\savedanchor\midpoint{%
		\pgf@x.5\wd\pgfnodeparttextbox%
		\pgfmathsetlength\pgf@y{+0.5ex}%
	}
	\savedanchor\basepoint{%
		\pgf@x.5\wd\pgfnodeparttextbox%
		\pgf@y0pt%
	}
	\anchor{center}{\centerpoint}%
	\anchor{mid}{\midpoint}%
	\inheritanchor[from=AND gate]{mid east}
	\inheritanchor[from=XOR gate]{mid west}
	\anchor{base}{\basepoint}%
	\inheritanchor[from=AND gate]{base east}
	\inheritanchor[from=XOR gate]{base west}
	\inheritanchor[from=AND gate]{base}
	\inheritanchor[from=NAND gate]{output}
	\inheritanchor[from=AND gate]{east}
	\inheritanchor[from=AND gate]{north east}
	\inheritanchor[from=AND gate]{south east}
	\inheritanchor[from=AND gate]{north}
	\inheritanchor[from=AND gate]{south}
	\inheritanchor[from=XOR gate]{south west}
	\inheritanchor[from=XOR gate]{north west}
	\inheritanchor[from=XOR gate]{west}
	\backgroundpath{%
		\dimensions%
		\pgf@xc\halfwidth%
		\pgf@yc\halfheight%
		\advance\pgf@xc-\outerxsep%
		\advance\pgf@yc-\outerysep%
		{%
			\pgftransformshift{\centerpoint}%
			\pgfpathmoveto{\pgfqpoint{-.16666\pgf@xc}{\pgf@yc}}%
			{%
				\pgf@yc2.0\pgf@yc%
				\edef\pgf@marshal{%
					\noexpand\pgfpatharc{90}{30}{\the\pgf@yc}%
				}%
				\pgf@marshal%
			}
			{%
				\pgf@yc2.0\pgf@yc%
				\edef\pgf@marshal{%
					\noexpand\pgfpatharc{-30}{-90}{\the\pgf@yc}%
				}%
				\pgf@marshal%
			}
			\pgfpathlineto{\pgfqpoint{-1.16666\pgf@xc}{-\pgf@yc}}%
			{%
				\pgf@yc2.66666\pgf@yc%
				\pgfpatharc{-22}{0}{+1.166666\pgf@yc and +\pgf@yc}%			
			}
			{%
				\pgf@yc2.66666\pgf@yc%
				\pgfpatharc{0}{22}{+1.166666\pgf@yc and +\pgf@yc}%			
			}%
			\pgfpathclose%
			%
			% Draw the output inverter.
			%
			{%
				\pgfpathcircle{%
					\pgf@x-.166666\pgf@xc%
					\pgf@yc2.0\pgf@yc%
					\advance\pgf@x.866025\pgf@yc%
					\advance\pgf@x\outerinvertedradius%
					\pgf@y0pt%
				}{+\invertedradius}%			
			}%
			%
			% Draw the inputs.
			%
			\pgfutil@tempdima2.0\pgf@yc%
			\c@pgf@counta\numinputs%
			\advance\c@pgf@counta1\relax%
			\divide\pgfutil@tempdima\c@pgf@counta%
			\pgfmathloop%
			\ifnum\pgfmathcounter>\numinputs%
			\else%
				\advance\pgf@yc-\pgfutil@tempdima%
				\expandafter\ifx\expandafter\pgf@lib@sh@itext\csname input-\pgfmathcounter\endcsname%
					{%
						\pgfpathcircle{%
							\pgf@ya\halfside%
							\pgf@yb2.0\pgf@ya%
							\pgf@xa\pgf@yb%
							\advance\pgf@yb-\halflinewidth%
							\pgfmathdivide@{\pgfmath@tonumber{\pgf@yc}}{\pgfmath@tonumber{\pgf@yb}}%
							\pgfmathasin@{\pgfmathresult}%
							\pgfmathcos@{\pgfmathresult}%
							%
							\pgf@x-1.5\pgf@ya%
							\advance\pgf@x-.866025\pgf@xa%
							\advance\pgf@x\pgfmathresult\pgf@yb%
							\advance\pgf@x-\invertedradius%
							\pgf@y\pgf@yc%
						}{+\invertedradius}%				
					}%
				\fi%				
			\repeatpgfmathloop%
			%
			% Now, some fooling around to stop the `tail' being filled.
			%
			\pgf@xc\halfside%
			\pgf@yc\halfside%
			\pgfpathmoveto{\pgfqpoint{-1.5\pgf@xc}{-\pgf@yc}}%
			\pgf@yc2.0\pgf@yc%
			\pgfmathloop%
			\ifnum\pgfmathcounter<61\relax%
				{%
					\pgfextract@process\point{%
						\pgfpointadd{%
							\pgf@x\halfside%
							\pgf@x-3.232051\pgf@x% (7/6 + 2*cos(30) + 1/3) * x
							\pgf@y0pt%
						}{%
							\pgfpointpolar{\pgfmathcounter-30}{+\pgf@yc}%
						}%
					}%
					\pgfpathlineto{\point}%
					\pgfpathmoveto{\point}%
				}
			\repeatpgfmathloop%
		}%
	}%
	\inheritanchorborder[from=XOR gate]
}





\pgfdeclareshape{NOT gate}{%
	\expandafter\pgfutil@g@addto@macro\csname pgf@sh@s@NOT gate\endcsname{%
		\pgf@lib@sh@logicgate@parseinputs{1}% 
		\ifnum\pgf@lib@sh@logicgate@numinputs=0\relax%
			\PackageError{PGF}{A NOT gate must have one input}{}%
		\fi%
	}%
	\savedmacro\numinputs{\let\numinputs\pgf@lib@sh@logicgate@numinputs}%
	\saveddimen\invertedradius{%
		\pgfmathsetlength\pgf@x{\pgfkeysvalueof{/pgf/logic gate inverted radius}}%
	}%
	\saveddimen\halflinewidth{%
		\pgf@x.5\pgflinewidth%
	}%
	\saveddimen\outerinvertedradius{%
		\pgfmathsetlength\pgf@x{\pgfkeysvalueof{/pgf/logic gate inverted radius}}%
		\advance\pgf@x.5\pgflinewidth%
	}
	\savedmacro\dimensions{\pgf@lib@sh@logicgates@dimensions}
	\savedanchor\centerpoint{%
		\pgf@x.5\wd\pgfnodeparttextbox%
		\pgf@y.5\ht\pgfnodeparttextbox%
		\advance\pgf@y-.5\dp\pgfnodeparttextbox%
	}
	\savedanchor\midpoint{%
		\pgf@x.5\wd\pgfnodeparttextbox%
		\pgfmathsetlength\pgf@y{+0.5ex}%
	}
	\savedanchor\basepoint{%
		\pgf@x.5\wd\pgfnodeparttextbox%
		\pgf@y0pt%
	}
	\anchor{center}{\centerpoint}%
	\anchor{mid}{\midpoint}%
	\inheritanchor[from=AND gate]{mid east}
	\anchor{mid west}{%
		\dimensions%
		\pgf@xc\halfside%
		\pgf@xc-.833333\pgf@xc%
		\advance\pgf@xc-\outerxsep%
		\midpoint%
		\advance\pgf@x\pgf@xc%	
	}%
	\anchor{base}{\basepoint}%
	\inheritanchor[from=AND gate]{base east}
	\anchor{base west}{%
		\dimensions%
		\pgf@xc\halfside%
		\pgf@xc-.833333\pgf@xc%
		\advance\pgf@xc-\outerxsep%
		\basepoint%
		\advance\pgf@x\pgf@xc%	
	}%
	\inheritanchor[from=AND gate]{base}
	\inheritanchor[from=NAND gate]{output}
	\anchor{east}{%
		\dimensions%
		\tipanchor%
		\pgf@xa\pgf@x%
		\centerpoint%
		\advance\pgf@x\pgf@xa%
	}%
	\anchor{north}{%
		\dimensions%
		\ifpgfgateanchorsuseboundingrectangle%
			\csname pgf@anchor@NOT gate@north west\endcsname%
			\pgf@ya\pgf@y%
			\centerpoint%
			\pgf@y\pgf@ya%
		\else%
			\pgfpointintersectionoflines{\centerpoint}{\centerpoint\advance\pgf@y1pt}%
				{\csname pgf@anchor@NOT gate@north west\endcsname}%
				{%
					\pgfpointadd{\centerpoint}{%
						\tipanchor%
						\pgf@xa\outerxsep%
						\advance\pgf@x2.350943\pgf@xa%	
					}%
				}%	
		\fi%
	}
	\anchor{south}{%
		\dimensions%
		\ifpgfgateanchorsuseboundingrectangle%
			\csname pgf@anchor@NOT gate@south west\endcsname%
			\pgf@ya\pgf@y%
			\centerpoint%
			\pgf@y\pgf@ya%
		\else%
			\pgfpointintersectionoflines{\centerpoint}{\centerpoint\advance\pgf@y-1pt}%
				{\csname pgf@anchor@NOT gate@south west\endcsname}%
				{%
					\pgfpointadd{\centerpoint}{%
						\tipanchor%
						\pgf@xa\outerxsep%
						\advance\pgf@x2.350943\pgf@xa%	
					}%
				}%	
		\fi%
	}
	\anchor{south east}{%
		\dimensions%
		\ifpgfgateanchorsuseboundingrectangle%
			\csname pgf@anchor@NOT gate@south west\endcsname%
			\pgf@ya\pgf@y%
			\pgf@process{%	
				\dimensions%
				\tipanchor%
				\pgf@xa\pgf@x%
				\centerpoint%
				\advance\pgf@x\pgf@xa%
			}%
			\pgf@y\pgf@ya%
		\else%
			\pgfpointintersectionoflines{\centerpoint}{\centerpoint\advance\pgf@x1pt\advance\pgf@y-1pt}%
				{\csname pgf@anchor@NOT gate@south west\endcsname}%
				{%
					\pgfpointadd{\centerpoint}{%
						\tipanchor%
						\pgf@xa\outerxsep%
						\advance\pgf@x2.350943\pgf@xa%	
					}%
				}%	
		\fi%
	}
	\anchor{north east}{%
		\dimensions%
		\ifpgfgateanchorsuseboundingrectangle%
			\csname pgf@anchor@NOT gate@north west\endcsname%
			\pgf@ya\pgf@y%
			\pgf@process{%	
				\dimensions%
				\tipanchor%
				\pgf@xa\pgf@x%
				\centerpoint%
				\advance\pgf@x\pgf@xa%
			}%
			\pgf@y\pgf@ya%
		\else%
			\pgfpointintersectionoflines{\centerpoint}{\centerpoint\advance\pgf@x1pt\advance\pgf@y1pt}%
				{\csname pgf@anchor@NOT gate@north west\endcsname}%
				{%
					\pgfpointadd{\centerpoint}{%
						\tipanchor%
						\pgf@xa\outerxsep%
						\advance\pgf@x2.350943\pgf@xa%	
					}%
				}%	
		\fi%
	}
	\anchor{south west}{%
		\dimensions%
		\pgf@xa\halfside%
		\centerpoint%
		\advance\pgf@x-.833333\pgf@xa
		\advance\pgf@x-\outerxsep%
		\advance\pgf@y-1.166666\pgf@xa%
		\pgf@ya\outerysep%
		\advance\pgf@y-1.565\pgf@ya% Selected by trial and error.	
	}%
	\anchor{north west}{%
		\dimensions%
		\pgf@xa\halfside%
		\centerpoint%
		\advance\pgf@x-.833333\pgf@xa
		\advance\pgf@x-\outerxsep%
		\advance\pgf@y1.166666\pgf@xa%
		\pgf@ya\outerysep%
		\advance\pgf@y1.565\pgf@ya% Selected by trial and error.	
	}%
	\anchor{input}{%
		\dimensions%
		\pgf@lib@sh@logicgate@AND@inputanchor{1}%
		\pgf@xc\halfside%
		\advance\pgf@x.333333\pgf@xc%
	}%
	\anchor{west}{%
		\dimensions%
		\pgf@xc\halfside%
		\pgf@xc-.833333\pgf@xc%
		\advance\pgf@xc-\outerxsep%
		\centerpoint%
		\advance\pgf@x\pgf@xc%
	}
	\backgroundpath{%
		\dimensions%
		\pgf@xc\halfwidth%
		\pgf@yc\halfheight%
		\advance\pgf@xc-\outerxsep%
		\advance\pgf@yc-\outerysep%
		{%
			\pgftransformshift{\centerpoint}%
			\pgfpathmoveto{\tipanchor}%
			\pgfpathlineto{\pgfqpoint{-.833333\pgf@xc}{1.166666\pgf@yc}}%
			\pgfpathlineto{\pgfqpoint{-.833333\pgf@xc}{-1.166666\pgf@yc}}%
			\pgfpathlineto{\tipanchor}%
			%
			% Draw the output inverter.
			%
			{%
				\pgfpathcircle{%
					\pgf@x-.166666\pgf@xc%
					\pgf@yc2.0\pgf@yc%
					\advance\pgf@x.866025\pgf@yc%
					\advance\pgf@x\outerinvertedradius%
					\pgf@y0pt%
				}{+\invertedradius}%			
			}%
			%
			% Draw the input.
			%
			\expandafter\ifx\expandafter\pgf@lib@sh@itext\csname input-1\endcsname%
				{%
					\pgfpathcircle{%
						\pgf@xa\halfside%
						\pgf@x-.833333\pgf@xa%
						\advance\pgf@x-.5\pgflinewidth%
						\advance\pgf@x-\invertedradius%
						\pgf@y0pt%
					}{+\invertedradius}%				
				}%
			\fi%				
		}%
	}%
	\anchorborder{%
		\pgfextract@process\externalpoint{}%
		\pgfextract@process\externalpoint{\pgfpointadd{\centerpoint}{\externalpoint}}%
		\pgfmathanglebetweenpoints{\centerpoint}{\externalpoint}%
		\let\externalangle\pgfmathresult%
		\dimensions%
		\pgfmathanglebetweenpoints{\centerpoint}{\csname pgf@anchor@NOT gate@north west\endcsname}%
		\ifdim\externalangle pt<\pgfmathresult pt%
			\pgfpointintersectionoflines{\centerpoint}{\externalpoint}%
				{\csname pgf@anchor@NOT gate@north west\endcsname}%
				{%
					\pgfpointadd{\centerpoint}{%
						\tipanchor%
						\pgf@xa\outerxsep%
						\advance\pgf@x2.350943\pgf@xa%	
					}%
				}%	
		\else%
			\pgfmathanglebetweenpoints{\centerpoint}{\csname pgf@anchor@NOT gate@south west\endcsname}%
			\ifdim\externalangle pt<\pgfmathresult pt%
				\pgfpointintersectionoflines{\externalpoint}{\centerpoint}%
					{\csname pgf@anchor@NOT gate@north west\endcsname}%
					{\csname pgf@anchor@NOT gate@south west\endcsname}%
			\else%
				\pgfpointintersectionoflines{\centerpoint}{\externalpoint}%
				{\csname pgf@anchor@NOT gate@south west\endcsname}%
				{%
					\pgfpointadd{\centerpoint}{%
						\tipanchor%
						\pgf@xa\outerxsep%
						\advance\pgf@x2.350943\pgf@xa%	
					}%
				}%	
			\fi%
		\fi%		
	}%
}