% Copyright 2008 by Mark Wibrow
%
% This file may be distributed and/or modified
%
% 1. under the LaTeX Project Public License and/or
% 2. under the GNU Public License.
%
% See the file doc/generic/pgf/licenses/LICENSE for more details.

\usepgfmodule{decorations}

\newdimen\pgfdecorationsegmentamplitude
\newdimen\pgfdecorationsegmentlength
\def\pgfdecorationsegmentangle{45}
\def\pgfdecorationsegmentobjectlength{\pgfdecorationsegmentamplitude}
\def\pgfdecorationsegmentaspect{0.5}

\pgfdecorationsegmentamplitude2.5pt
\pgfdecorationsegmentlength10pt

\pgfkeys{%
  /pgf/decoration options/.code={\pgfkeys{/pgf/decoration options/.cd,#1}},
  /pgf/decoration options/segment amplitude/.code={\pgfmathsetlength\pgfdecorationsegmentamplitude{#1}},
  /pgf/decoration options/segment length/.code={\pgfmathsetlength\pgfdecorationsegmentlength{#1}},
  /pgf/decoration options/segment angle/.code={\pgfmathparse{#1}\let\pgfdecorationsegmentangle\pgfmathresult},
  /pgf/decoration options/segment aspect/.code={\pgfmathparse{#1}\let\pgfdecorationsegmentaspect\pgfmathresult},
  /pgf/decoration options/segment object length/.code={\pgfmathparse{#1}\edef\pgfdecorationsegmentobjectlength{\pgfmathresult pt}}}  




%
%
% Kind 1: Path deforming decorations
%
% These decorations "deform" paths. That means that the
% orginal characteristic of the path is kept and the number of
% subpaths remains the same -- only, the lines are slightly offset or
% changed by the decoration. For instance a line might be turned into
% a squiggly line or a snaking line or a bumping line.
%

%
%
% Kind 1.1: Path deforming straight line decorations
%
%


% zigzag decoration.
%
\pgfdeclaredecoration{zigzag}{up from center}{
  \state{up from center}[width=+.5\pgfdecorationsegmentlength, next state=big down]
  {
    \pgfpathlineto{\pgfqpoint{.25\pgfdecorationsegmentlength}{\pgfdecorationsegmentamplitude}}
  }
  \state{big down}[switch if less than=+.5\pgfdecorationsegmentlength to center finish,
                   width=+.5\pgfdecorationsegmentlength,
                   next state=big up]
  {
    \pgfpathlineto{\pgfqpoint{.25\pgfdecorationsegmentlength}{-\pgfdecorationsegmentamplitude}}
  }
  \state{big up}[switch if less than=+.5\pgfdecorationsegmentlength to center finish,
                 width=+.5\pgfdecorationsegmentlength,
                 next state=big down]
  {
    \pgfpathlineto{\pgfqpoint{.25\pgfdecorationsegmentlength}{\pgfdecorationsegmentamplitude}}
  }
  \state{center finish}[width=0pt, next state=final]{
    \pgfpathlineto{\pgfpointorigin}
  }
  \state{final}
  {
    \pgfpathlineto{\pgfpointdecoratedpathlast}
  }
}




% saw decoration
%
% Parameters: \pgfdecorationsegmentamplitude, \pgfdecorationsegmentlength

\pgfdeclaredecoration{saw}{initial}
{
  \state{initial}[width=+\pgfdecorationsegmentlength]
  {
    \pgfpathlineto{\pgfqpoint{\pgfdecorationsegmentlength}{\pgfdecorationsegmentamplitude}}
    \pgfpathlineto{\pgfqpoint{\pgfdecorationsegmentlength}{0pt}}
  }
  \state{final}
  {
    \pgfpathlineto{\pgfpointdecoratedpathlast}
  }
}




% random steps decoration
%
% A decoration that consists of random steps heading towards the target
%
% Parameters: \pgfdecorationsegmentamplitude, \pgfdecorationsegmentlength

\pgfdeclaredecoration{random steps}{step}
{
  \state{step}[width=+\pgfdecorationsegmentlength,next state=step]
  {
    \pgfpathlineto{
      \pgfpointadd
      {\pgfqpoint{\pgfdecorationsegmentlength}{0pt}}
      {\pgfpoint{rand*\pgfdecorationsegmentamplitude}{rand*\pgfdecorationsegmentamplitude}}
    }
  }

  \state{final}
  {
    \pgfpathlineto{\pgfpointdecoratedpathlast}
  }
}


% Fractal decorations. They should be replied repeatedly

\pgfdeclaredecoration{Koch curve type 1}{init}
{
  \state{init}[width=\pgfdecoratedsubpathremainingdistance]
  {
    \pgfpathlineto{\pgfpoint{.33333\pgfdecoratedsubpathremainingdistance}{0pt}}
    \pgfpathlineto{\pgfpoint{.33333\pgfdecoratedsubpathremainingdistance}{.33333\pgfdecoratedsubpathremainingdistance}}
    \pgfpathlineto{\pgfpoint{.66666\pgfdecoratedsubpathremainingdistance}{.33333\pgfdecoratedsubpathremainingdistance}}
    \pgfpathlineto{\pgfpoint{.66666\pgfdecoratedsubpathremainingdistance}{0pt}}
    \pgfpathlineto{\pgfpoint{\pgfdecoratedsubpathremainingdistance}{0pt}}
  }
}

\pgfdeclaredecoration{Koch curve type 2}{init}
{
  \state{init}[width=\pgfdecoratedsubpathremainingdistance]
  {
    \pgfpathlineto{\pgfpoint{.25\pgfdecoratedsubpathremainingdistance}{0pt}}
    \pgfpathlineto{\pgfpoint{.25\pgfdecoratedsubpathremainingdistance}{.25\pgfdecoratedsubpathremainingdistance}}
    \pgfpathlineto{\pgfpoint{.5\pgfdecoratedsubpathremainingdistance}{.25\pgfdecoratedsubpathremainingdistance}}
    \pgfpathlineto{\pgfpoint{.5\pgfdecoratedsubpathremainingdistance}{0pt}}
    \pgfpathlineto{\pgfpoint{.5\pgfdecoratedsubpathremainingdistance}{-.25\pgfdecoratedsubpathremainingdistance}}
    \pgfpathlineto{\pgfpoint{.75\pgfdecoratedsubpathremainingdistance}{-.25\pgfdecoratedsubpathremainingdistance}}
    \pgfpathlineto{\pgfpoint{.75\pgfdecoratedsubpathremainingdistance}{0pt}}
    \pgfpathlineto{\pgfpoint{\pgfdecoratedsubpathremainingdistance}{0pt}}
  }
}

\pgfdeclaredecoration{Koch snowflake}{init}
{
  \state{init}[width=\pgfdecoratedsubpathremainingdistance]
  {
    \pgfpathlineto{\pgfpoint{.3333\pgfdecoratedsubpathremainingdistance}{0pt}}
    \pgfpathlineto{\pgfpoint{.5\pgfdecoratedsubpathremainingdistance}{0.2886751347\pgfdecoratedsubpathremainingdistance}}
    \pgfpathlineto{\pgfpoint{.6666\pgfdecoratedsubpathremainingdistance}{0pt}}
    \pgfpathlineto{\pgfpoint{\pgfdecoratedsubpathremainingdistance}{0pt}}
  }
}



%
%
% Kind 1.2: Path deforming curved decorations
%
%



% bent decoration
%
% A decoration that looks like someone bent the line a bit.
%
% Parameters: \pgfdecorationsegmentamplitude, \pgfdecorationsegmentaspect

\pgfdeclaredecoration{bent}{bent}
{
  \state{bent}[width=+\pgfdecoratedremainingdistance,next state=final]
  {
    \pgfpathcurveto
    {\pgfqpoint{\pgfdecorationsegmentaspect\pgfdecoratedremainingdistance}{\pgfdecorationsegmentamplitude}}
    {\pgfpointadd{\pgfqpoint{\pgfdecoratedremainingdistance}{0pt}}
       {\pgfqpoint{-\pgfdecorationsegmentaspect\pgfdecoratedremainingdistance}{\pgfdecorationsegmentamplitude}}}
    {\pgfqpoint{\pgfdecoratedremainingdistance}{0pt}}
  }
  \state{final}
  {}
}



% decoration snake
%
% This decoration produces a hopefully optically pleasing squiggly snake. 
%
% Parameters: \pgfdecorationsegmentamplitude, \pgfdecorationsegmentlength

\pgfdeclaredecoration{snake}{initial}
{
  \state{initial}[switch if less than=+.625\pgfdecorationsegmentlength to final,
                  width=+.3125\pgfdecorationsegmentlength,
                  next state=down]
  { 
    \pgfpathcurveto
    {\pgfqpoint{.125\pgfdecorationsegmentlength}{0pt}}
    {\pgfqpoint{.1875\pgfdecorationsegmentlength}{\pgfdecorationsegmentamplitude}}
    {\pgfqpoint{.3125\pgfdecorationsegmentlength}{\pgfdecorationsegmentamplitude}}
  }
  \state{down}[switch if less than=+.8125\pgfdecorationsegmentlength to end down,
               width=+.5\pgfdecorationsegmentlength,
               next state=up]
  {
    \pgfpathcosine{\pgfqpoint{.25\pgfdecorationsegmentlength}{-1\pgfdecorationsegmentamplitude}}
    \pgfpathsine{\pgfqpoint{.25\pgfdecorationsegmentlength}{-1\pgfdecorationsegmentamplitude}}
  }               
  \state{up}[switch if less than=+.8125\pgfdecorationsegmentlength to end up,
             width=+.5\pgfdecorationsegmentlength,
             next state=down]
  {
    \pgfpathcosine{\pgfqpoint{.25\pgfdecorationsegmentlength}{\pgfdecorationsegmentamplitude}}
    \pgfpathsine{\pgfqpoint{.25\pgfdecorationsegmentlength}{\pgfdecorationsegmentamplitude}}
  }               
  \state{end down}[width=+.3125\pgfdecorationsegmentlength,
                   next state=final]
  {
    \pgfpathcurveto
    {\pgfqpoint{.125\pgfdecorationsegmentlength}{\pgfdecorationsegmentamplitude}}
    {\pgfqpoint{.1875\pgfdecorationsegmentlength}{0pt}}
    {\pgfqpoint{.3125\pgfdecorationsegmentlength}{0pt}}
  }  
  \state{end up}[width=+.3125\pgfdecorationsegmentlength,
                 next state=final]
  {
    \pgfpathcurveto
    {\pgfqpoint{.125\pgfdecorationsegmentlength}{-\pgfdecorationsegmentamplitude}}
    {\pgfqpoint{.1875\pgfdecorationsegmentlength}{0pt}}
    {\pgfqpoint{.3125\pgfdecorationsegmentlength}{0pt}}
  }  
  \state{final}
  {
    \pgfpathlineto{\pgfpointdecoratedpathlast}
  }
}


% coil decoration
%
% Parameters: \pgfdecorationsegmentamplitude, \pgfdecorationsegmentlength,

\pgfdeclaredecoration{coil}{coil}
{
  \state{coil}[switch if less than=%
    1.5\pgfdecorationsegmentlength+%
    \pgfdecorationsegmentaspect\pgfdecorationsegmentamplitude+%
    \pgfdecorationsegmentaspect\pgfdecorationsegmentamplitude to last,
               width=+\pgfdecorationsegmentlength]
  {
    \pgfpathcurveto
    {\pgfpoint@oncoil{0    }{ 0.555}{1}}
    {\pgfpoint@oncoil{0.445}{ 1    }{2}}
    {\pgfpoint@oncoil{1    }{ 1    }{3}}
    \pgfpathcurveto
    {\pgfpoint@oncoil{1.555}{ 1    }{4}}
    {\pgfpoint@oncoil{2    }{ 0.555}{5}}
    {\pgfpoint@oncoil{2    }{ 0    }{6}}
    \pgfpathcurveto
    {\pgfpoint@oncoil{2    }{-0.555}{7}}
    {\pgfpoint@oncoil{1.555}{-1    }{8}}
    {\pgfpoint@oncoil{1    }{-1    }{9}}
    \pgfpathcurveto
    {\pgfpoint@oncoil{0.445}{-1    }{10}}
    {\pgfpoint@oncoil{0    }{-0.555}{11}}
    {\pgfpoint@oncoil{0    }{ 0    }{12}}
  }
  \state{last}[width=.5\pgfdecorationsegmentlength+%
    \pgfdecorationsegmentaspect\pgfdecorationsegmentamplitude+%
    \pgfdecorationsegmentaspect\pgfdecorationsegmentamplitude,next state=final]
  {
    \pgfpathcurveto
    {\pgfpoint@oncoil{0    }{ 0.555}{1}}
    {\pgfpoint@oncoil{0.445}{ 1    }{2}}
    {\pgfpoint@oncoil{1    }{ 1    }{3}}
    \pgfpathcurveto
    {\pgfpoint@oncoil{1.555}{ 1    }{4}}
    {\pgfpoint@oncoil{2    }{ 0.555}{5}}
    {\pgfpoint@oncoil{2    }{ 0    }{6}}
  }
  \state{final}
  {
    \pgfpathlineto{\pgfpointdecoratedpathlast}
  }
}

\def\pgfpoint@oncoil#1#2#3{%
  \pgf@x=#1\pgfdecorationsegmentamplitude%
  \pgf@x=\pgfdecorationsegmentaspect\pgf@x%
  \pgf@y=#2\pgfdecorationsegmentamplitude%
  \pgf@xa=0.083333333333\pgfdecorationsegmentlength%
  \advance\pgf@x by#3\pgf@xa%
}


% bumps decoration
%
% Parameters: \pgfdecorationsegmentamplitude, \pgfdecorationsegmentlength

\pgfdeclaredecoration{bumps}{initial}
{
  \state{initial}[width=+.5\pgfdecorationsegmentlength]
  {
    \pgfpathcurveto
    {\pgfqpoint{0pt}{.555\pgfdecorationsegmentamplitude}}
    {\pgfqpoint{0.11125\pgfdecorationsegmentlength}{\pgfdecorationsegmentamplitude}}
    {\pgfqpoint{.25\pgfdecorationsegmentlength}{\pgfdecorationsegmentamplitude}}
    \pgfpathcurveto
    {\pgfqpoint{.38875\pgfdecorationsegmentlength}{\pgfdecorationsegmentamplitude}}
    {\pgfqpoint{.5\pgfdecorationsegmentlength}{.5\pgfdecorationsegmentamplitude}}
    {\pgfqpoint{.5\pgfdecorationsegmentlength}{0\pgfdecorationsegmentamplitude}}
  }
  \state{final}
  {
    \pgfpathlineto{\pgfpointdecoratedpathlast}
  }
}








%
% Kind 2: Path chopping decorations
%
% These decorations change the path by chopping it into smaller
% parts. For instance, a line in the path might be replaced by small
% ticks or unconnected curves or crosses. Applying a chopping
% decoration to a path means that the path can no longer be used for
% filling in the original manner.
%



%
%
% Kind 2.1: Path chopping with open subpaths
%
%


% ticks decoration
%
% Parameters: \pgfdecorationsegmentlength, \pgfdecorationsegmentamplitude

\pgfdeclaredecoration{ticks}{ticks}
{
  \state{ticks}[width=+\pgfdecorationsegmentlength]
  {
    \pgfpathmoveto{\pgfqpoint{0pt}{\pgfdecorationsegmentamplitude}}
    \pgfpathlineto{\pgfqpoint{0pt}{-\pgfdecorationsegmentamplitude}}
  }
  \state{final}
  {
    \pgfpathmoveto{\pgfqpoint{0pt}{\pgfdecorationsegmentamplitude}}
    \pgfpathlineto{\pgfqpoint{0pt}{-\pgfdecorationsegmentamplitude}}
    \pgfpathmoveto{\pgfpointdecoratedpathlast}
  }
}



% expanding waves decoration
%
% Parameters: \pgfdecorationsegmentangle, \pgfdecorationsegmentlength

\pgfdeclaredecoration{expanding waves}{initial}
{
  \state{initial}[width=+\pgfdecorationsegmentlength,next state=wave]
  {}

  \state{wave}[switch if less than=+\pgfdecorationsegmentlength to last,
               width=+\pgfdecorationsegmentlength]
  {
    \pgfpathmoveto{
      \pgfpointadd
      {\pgfqpoint{-\pgfdecoratedcompleteddistance}{0pt}}%
      {\pgfpointpolar{\pgfdecorationsegmentangle}{+\pgfdecoratedcompleteddistance}}}%
    \pgfpatharc{\pgfdecorationsegmentangle}{-\pgfdecorationsegmentangle}{+\pgfdecoratedcompleteddistance}%
  }
  \state{last}[width=+0pt,next state=final]
  {
    \pgfpathmoveto{
      \pgfpointadd
      {\pgfqpoint{-\pgfdecoratedcompleteddistance}{0pt}}%
      {\pgfpointpolar{\pgfdecorationsegmentangle}{+\pgfdecoratedcompleteddistance}}}%
    \pgfpatharc{\pgfdecorationsegmentangle}{-\pgfdecorationsegmentangle}{+\pgfdecoratedcompleteddistance}%
  }
  \state{final}
  {
    \pgfpathmoveto{\pgfpointdecoratedpathlast}
  }
}



% waves decoration
%
% Parameters: \pgfdecorationsegmentangle, \pgfdecorationsegmentlength

\pgfdeclaredecoration{waves}{wave}
{
  \state{wave}[width=\pgfdecorationsegmentlength]
  {
    \pgftransformxshift{+\pgfdecorationsegmentlength}
    \pgfpathmoveto{
      \pgfpointadd
      {\pgfqpoint{-\pgfdecorationsegmentobjectlength}{0pt}}%
      {\pgfpointpolar{\pgfdecorationsegmentangle}{+\pgfdecorationsegmentobjectlength}}}%
    \pgfpatharc{\pgfdecorationsegmentangle}{-\pgfdecorationsegmentangle}{+\pgfdecorationsegmentobjectlength}%
  }
  \state{final}
  {
    \pgfpathmoveto{\pgfpointdecoratedpathlast}
  }
}



% border decoration
%
% Parameters: \pgfdecorationsegmentlength, \pgfdecorationsegmentamplitude, \pgfdecorationsegmentangle

\pgfdeclaredecoration{border}{tick}
{
  \state{tick}[switch if less than=+\pgfdecorationsegmentlength to last,
               width=+\pgfdecorationsegmentlength]
  {
    \pgfpathmoveto{\pgfpointorigin}
    \pgfpathlineto{\pgfpointpolar{\pgfdecorationsegmentangle}{+\pgfdecorationsegmentamplitude}}
  }
  \state{last}[width=+\pgfdecorationsegmentamplitude,next state=final]
  {
    \pgfpathmoveto{\pgfpointorigin}
    \pgfpathlineto{\pgfpointpolar{\pgfdecorationsegmentangle}{+\pgfdecorationsegmentamplitude}}
  }  
  \state{final}
  {
    \pgfpathmoveto{\pgfpointdecoratedpathlast}
  }
}




% crosses decoration
%
% Parameters: \pgfdecorationsegmentlength, \pgfdecorationobjectsize, \pgfdecorationsegmentamplitude

\pgfdeclaredecoration{crosses}{crosses}
{
  \state{crosses}[switch if less than=+\pgfdecorationsegmentlength to last,
                   width=+\pgfdecorationsegmentlength]
  {
    \pgfpathmoveto{\pgfqpoint{0pt}{\pgfdecorationsegmentamplitude}}
    \pgfpathlineto{\pgfqpoint{\pgfdecorationsegmentobjectlength}{-\pgfdecorationsegmentamplitude}}
    \pgfpathmoveto{\pgfqpoint{0pt}{-\pgfdecorationsegmentamplitude}}
    \pgfpathlineto{\pgfqpoint{\pgfdecorationsegmentobjectlength}{\pgfdecorationsegmentamplitude}}
  }
  \state{last}[width=\pgfdecorationsegmentobjectlength,next state=final]
  {
    \pgfpathmoveto{\pgfqpoint{0pt}{\pgfdecorationsegmentamplitude}}
    \pgfpathlineto{\pgfqpoint{\pgfdecorationsegmentobjectlength}{-1\pgfdecorationsegmentamplitude}}
    \pgfpathmoveto{\pgfqpoint{0pt}{-\pgfdecorationsegmentamplitude}}
    \pgfpathlineto{\pgfqpoint{\pgfdecorationsegmentobjectlength}{\pgfdecorationsegmentamplitude}}
  }
  \state{final}
  {
    \pgfpathmoveto{\pgfpointdecoratedpathlast}
  }
}






% brace decorations
%
% Parameters: \pgfdecorationsegmentamplitude

\pgfdeclaredecoration{brace}{brace}
{
  \state{brace}[width=+\pgfdecoratedremainingdistance,next state=final]
  {
    \pgfpathmoveto{\pgfpointorigin}
    \pgfpathcurveto
    {\pgfqpoint{.15\pgfdecorationsegmentamplitude}{.3\pgfdecorationsegmentamplitude}}
    {\pgfqpoint{.5\pgfdecorationsegmentamplitude}{.5\pgfdecorationsegmentamplitude}}
    {\pgfqpoint{\pgfdecorationsegmentamplitude}{.5\pgfdecorationsegmentamplitude}}
    {
      \pgftransformxshift{+\pgfdecorationsegmentaspect\pgfdecoratedremainingdistance}
      \pgfpathlineto{\pgfqpoint{-\pgfdecorationsegmentamplitude}{.5\pgfdecorationsegmentamplitude}}
      \pgfpathcurveto
      {\pgfqpoint{-.5\pgfdecorationsegmentamplitude}{.5\pgfdecorationsegmentamplitude}}
      {\pgfqpoint{-.15\pgfdecorationsegmentamplitude}{.7\pgfdecorationsegmentamplitude}}
      {\pgfqpoint{0\pgfdecorationsegmentamplitude}{1\pgfdecorationsegmentamplitude}}
      \pgfpathcurveto
      {\pgfqpoint{.15\pgfdecorationsegmentamplitude}{.7\pgfdecorationsegmentamplitude}}
      {\pgfqpoint{.5\pgfdecorationsegmentamplitude}{.5\pgfdecorationsegmentamplitude}}
      {\pgfqpoint{\pgfdecorationsegmentamplitude}{.5\pgfdecorationsegmentamplitude}}
    }
    {
      \pgftransformxshift{+\pgfdecoratedremainingdistance}
      \pgfpathlineto{\pgfqpoint{-\pgfdecorationsegmentamplitude}{.5\pgfdecorationsegmentamplitude}}
      \pgfpathcurveto
      {\pgfqpoint{-.5\pgfdecorationsegmentamplitude}{.5\pgfdecorationsegmentamplitude}}
      {\pgfqpoint{-.15\pgfdecorationsegmentamplitude}{.3\pgfdecorationsegmentamplitude}}
      {\pgfqpoint{0pt}{0pt}}
    }
  }
  \state{final}
  {}
}


% Fractal decoration, should be applied repeatedly

\pgfdeclaredecoration{Cantor set}{init}
{
  \state{init}[width=\pgfdecoratedsubpathremainingdistance]
  {
    \pgfpathlineto{\pgfpoint{.3333\pgfdecoratedsubpathremainingdistance}{0pt}}
    \pgfpathmoveto{\pgfpoint{.6666\pgfdecoratedsubpathremainingdistance}{0pt}}
    \pgfpathlineto{\pgfpoint{\pgfdecoratedsubpathremainingdistance}{0pt}}
  }
}



%
%
% Kind 2.2: Path chopping with closed subpaths
%
%




% triangle decoration
%
% Parameters: \pgfdecorationsegmentlength, \pgfdecorationobjectsize, \pgfdecorationsegmentamplitude

\pgfdeclaredecoration{triangles}{triangle}
{
  \state{triangle}[switch if less than=+\pgfdecorationsegmentlength to last,
                   width=+\pgfdecorationsegmentlength]
  {
    \pgfpathmoveto{\pgfqpoint{0pt}{\pgfdecorationsegmentamplitude}}
    \pgfpathlineto{\pgfqpoint{\pgfdecorationsegmentobjectlength}{0pt}}
    \pgfpathlineto{\pgfqpoint{0pt}{-\pgfdecorationsegmentamplitude}}
    \pgfpathclose
  }
  \state{last}[width=+\pgfdecorationsegmentobjectlength,next state=final]
  {
    \pgfpathmoveto{\pgfqpoint{0pt}{\pgfdecorationsegmentamplitude}}
    \pgfpathlineto{\pgfqpoint{\pgfdecorationsegmentobjectlength}{0pt}}
    \pgfpathlineto{\pgfqpoint{0pt}{-\pgfdecorationsegmentamplitude}}
    \pgfpathclose
  }
  \state{final}
  {
    \pgfpathmoveto{\pgfpointdecoratedpathlast}
  }
}





%
%
% Kind 2.3: Path chopping with other subpaths
%
%






%
% Kind 3: Path destroying decorations
%
% These decorations destroy the path. After the decoration has been
% used, the path will be empty. The effect of the decoration is
% to draw/fill/whatever other paths or to draw some text.
%

















%
% Old snakes code:
%

% Alias for old snakes:

\let\pgfsnakesegmentamplitude=\pgfdecorationsegmentamplitude
\let\pgfsnakesegmentlength=\pgfdecorationsegmentlength
\def\pgfsnakesegmentangle{\pgfdecorationsegmentangle}
\def\pgfsnakesegmentobjectlength{\pgfdecorationsegmentobjectlength}
\def\pgfsnakesegmentaspect{\pgfdecorationsegmentaspect}

\pgfset{%
  /pgf/segment amplitude/.style={/pgf/decoration options/segment amplitude=#1},
  /pgf/segment length/.style={/pgf/decoration options/segment length=#1},
  /pgf/segment angle/.style={/pgf/decoration options/segment angle=#1},
  /pgf/segment aspect/.style={/pgf/decoration options/segment aspect=#1},
  /pgf/segment object length/.style={/pgf/decoration options/segment object length=#1}}









%%%%%%%%%%%%%%% Old STUFF %%%%%%%%%%%%





  




% Keys for text decoration:
%
\pgfkeys{pgf/.cd,%
	decoration text format delimiters/.code={\expandafter\pgfsetdecoratetextformatdelimiters#1},%
	decoration text/.store in=\pgfdecorationtext,%
	decoration text color/.store in=\pgf@lib@decorationtextcolor%
}
\def\pgf@lib@decorationtextcolor{black}

% \pgfsetdecoratetextformatdelimiters
% 
% Set the delimiters for formatting in the text decoration.
% NB: Catcodes for delimiters should be 11 or 12.
%
% Examples:
%
% \pgfsetdecoratetextformatdelimiters{|}{}% 2nd argument can be empty.
%
% \def\pgfdecoratetext{A big |\color{red}|red|| apple.}
%
% \pgfsetdecoratetextformatdelimiters{[}{]}
%
% \def\pgfdecoratetext{The [\it]very[+\color{green}]green[] sprouts.}
%
\def\pgfsetdecoratetextformatdelimiters#1#2{%
	\def\pgf@lib@decorations@text@formatchar{#1}%
	\def\pgf@test{#2}%
	\ifx\pgf@test\pgfutil@empty%
		\def\pgf@lib@decorations@text@collectformat##1#1{%
		\pgf@lib@decorations@text@@collectformat##1\pgf@stop}%
	\else%
		\def\pgf@lib@decorations@text@collectformat##1#2{%
			\pgf@lib@decorations@text@@collectformat##1\pgf@stop}%
	\fi%
}

\pgfsetdecoratetextformatdelimiters{|}{}

\newbox\pgf@lib@decorations@text@box
\newif\ifpgf@lib@decorate@textmathmode

\let\pgfdecorationtext\pgfutil@empty
\let\pgfdecorationrestoftext\pgfutil@empty%
\let\pgf@lib@decorations@text@format\pgfutil@empty

\def\pgf@lib@decorations@text@scanchar{%
	\ifx\pgfdecorationrestoftext\pgfutil@empty%
		\let\pgf@lib@decorations@text@char\pgfutil@empty%
		\setbox\pgf@lib@decorations@text@box\box\voidb@x%
		\let\pgf@next\relax%
	\else%
		\let\pgf@next\pgf@lib@decorations@text@@scanchar%
	\fi%
	\pgf@next}

\def\pgf@lib@decorations@text@@scanchar{%
	\expandafter\pgf@lib@decorations@text@@@scanchar\pgfdecorationrestoftext\pgf@stop}

\def\pgf@lib@decorations@text@@@scanchar{%
	\futurelet\pgf@lib@decorations@lettoken%
	\pgf@lib@decorations@text@@@@scanchar}
	
\def\pgf@lib@decorations@text@@@@scanchar{%
	\ifx\pgf@lib@decorations@lettoken\pgfutil@sptoken%
		\let\pgf@next\pgf@lib@decorations@text@insertspace%
	\else%
		\let\pgf@next\pgf@lib@decorations@text@@@@@scanchar%
	\fi%
	\pgf@next}

\def\pgf@lib@decorations@text@@@@@scanchar{%
	\pgfutil@ifnextchar\bgroup{\pgf@lib@decorations@text@collectgroup}%
		{\pgf@lib@decorations@text@@@@@@scanchar}}
		
\def\pgf@lib@decorations@text@collectgroup#1{%
	\def\pgf@lib@decorations@text@char{#1}%
	\pgf@lib@decorations@text@collectrestoftext}
	
\def\pgf@lib@decorations@text@@@@@@scanchar#1{%
	\ifx#1\pgf@stop%
		\pgf@lib@decorations@text@box\box\voidb@x%
		\let\pgf@next\pgf@lib@decorations@text@endoftext%
	\else%
		\def\pgf@lib@decorations@text@char{#1}%
		\ifx#1\space%
			\let\pgf@next\pgf@lib@decorations@text@collectrestoftext%
		\else%
			\ifx#1\ %
				\let\pgf@next\pgf@lib@decorations@text@collectrestoftext%
			\else%
				\ifx\pgf@lib@decorations@text@char\pgf@lib@decorations@text@formatchar%
					\let\pgf@next\pgf@lib@decorations@text@collectformat%
				\else%
					\expandafter\ifcat\noexpand#1\relax%
						\let\pgf@next\pgf@lib@decorations@text@expandcs%
					\else%
						\ifnum\catcode`#1=3\relax%
							\ifpgf@lib@decorate@textmathmode%
								\pgf@lib@decorate@textmathmodefalse%
							\else%
								\pgf@lib@decorate@textmathmodetrue%
							\fi%
							\let\pgf@next\pgf@lib@decorations@text@@@scanchar%
						\else%
							\let\pgf@next\pgf@lib@decorations@text@collectrestoftext%
						\fi%
					\fi%
				\fi%
			\fi%
		\fi%
	\fi%
	\pgf@next%
}

\def\pgf@lib@decorations@text@@collectformat{%
	\pgfutil@ifnextchar+{\pgf@lib@decorations@text@addtoformat}{\pgf@lib@decorations@text@setformat}}
	
\def\pgf@lib@decorations@text@setformat#1\pgf@stop{%
	\def\pgf@lib@decorations@text@format{#1}%
	\pgf@lib@decorations@text@@@scanchar%
}

\def\pgf@lib@decorations@text@addtoformat+#1\pgf@stop{%
	\expandafter\def\expandafter\pgf@lib@decorations@text@format\expandafter{\pgf@lib@decorations@text@format#1}%
	\pgf@lib@decorations@text@@@scanchar%
}

\def\pgf@lib@decorations@text@insertspace{%
	\pgfutil@ifnextchar\bgroup{\pgf@lib@decorations@text@@insertspacegrp}%
		{\pgf@lib@decorations@text@@insertspace}}
		
\def\pgf@lib@decorations@text@@insertspacegrp#1{%
	\pgf@lib@decorations@text@@@@@@scanchar\space{#1}}
	
\def\pgf@lib@decorations@text@@insertspace#1{%
	\pgf@lib@decorations@text@@@@@@scanchar\space#1}
	
\def\pgf@lib@decorations@text@expandcs{%
	\expandafter\expandafter\expandafter\pgf@lib@decorations@text@@@@@scanchar%
		\pgf@lib@decorations@text@char}

\def\pgf@lib@decorations@text@endoftext{%
	\let\pgfdecoraterestoftext\pgfutil@empty%
	\let\pgf@lib@decorations@text@char\pgfutil@empty%
}
\def\pgf@lib@decorations@text@collectrestoftext{%
	\pgf@lib@decorations@text@dobox%
	\futurelet\pgf@lib@decorations@text@lettoken%
	\pgf@lib@decorations@text@@collectrestoftext}

\def\pgf@lib@decorations@text@@collectrestoftext{%
	\ifx\bgroup\pgf@lib@decorations@text@lettoken%
		\let\pgf@next\pgf@lib@decorations@text@@@collectrestoftextgrp%
	\else%
		\let\pgf@next\pgf@lib@decorations@text@@@collectrestoftext%
	\fi%
	\pgf@next}
	
\def\pgf@lib@decorations@text@@@collectrestoftextgrp#1#2\pgf@stop{\def\pgfdecorationrestoftext{{#1}#2}%
}

\def\pgf@lib@decorations@text@@@collectrestoftext#1\pgf@stop{\def\pgfdecorationrestoftext{#1}}

{%
	\catcode`\$3 %
	\gdef\pgf@lib@decorations@mathshift{$}%
	\catcode`\$9 $% For editors with annoying syntax highlighting.
}%

\def\pgf@lib@decorations@text@dobox{%
	\setbox\pgf@lib@decorations@text@box\hbox{%
		\pgfinterruptpicture%
		\begingroup%
			\pgfsetcolor{\pgf@lib@decorationtextcolor}%
			\ifpgf@lib@decorate@textmathmode\pgf@lib@decorations@mathshift\fi%
				\pgf@lib@decorations@text@format\relax%
				\pgf@lib@decorations@text@char%
			\ifpgf@lib@decorate@textmathmode\pgf@lib@decorations@mathshift\fi%
		\endgroup%
		\endpgfinterruptpicture%
	}%
}

\pgfdeclaredecoration{text}{initial}{
	\state{initial}[width=0pt, next state=scan]
	{
			\egroup%
		\let\pgfdecorationrestoftext\pgfdecorationtext%
			\bgroup%
	}
	\state{scan}[width=0pt, next state=before typeset]
	{
			\egroup%
		\pgf@lib@decorations@text@scanchar%
		\ifvoid\pgf@lib@decorations@text@box%
			\setbox\pgf@lib@decorations@text@box\hbox{}%
			\wd\pgf@lib@decorations@text@box16383pt\relax%
		\fi%
			\bgroup%
	}
	\state{before typeset}[width=+.5\wd\pgf@lib@decorations@text@box, next state=typeset]{}
	\state{typeset}[width=0pt, next state=after typeset]
	{
		\pgftransformxshift{+-.5\wd\pgf@lib@decorations@text@box}%
		\setbox\pgf@hbox\hbox{\copy\pgf@lib@decorations@text@box}%
		\pgfqboxsynced\pgf@hbox%
	}
	\state{after typeset}[width=+.5\wd\pgf@lib@decorations@text@box, next state=scan]{}
	\state{final}{}
}


\pgfkeys{%
  /pgf/meta-decoration segment amplitude/.store in=\pgfmetadecorationsegmentamplitude,
  /pgf/meta-decoration segment length/.store in=\pgfmetadecorationsegmentlength,
} 
  
% Meta-decoration lineto zigzag
%
\pgfdeclaremetadecoration{lineto zigzag}{line to}{
	\state{line to}[width=\pgfmetadecorationsegmentlength, next state=zigzag]
	{
		\decoration{line along}
	}
	\state{zigzag}[width=\pgfmetadecorationsegmentlength, next state=line to]
	{
		\decoration{zigzag}	
	}
	\state{final}
	{
		\decoration{line along}
	}
}




%	The Shape Snake
%	
%	The shape snake is snake that consists of repeated instances of 
%	the path of a specified shape. The shape must have been declared 
%	by \pgfdeclareshape. If a shape has specialized keys (e.g. the
%	number of points on a star, or the apex angle the isosceles
%	triangle), these can be specified in the usual manner. 
%	
%	The sepatation between shapes in the path can be specified and can 
%	be between the center of the shape or the border of the shape. 
%	
%	The height and width of the shape can be independently or
%	simultaneously scaled (linearly) along the path. It is also
% possible to prevent the shapes being sloped parallel to the
% path.

% Keys for snake: shape snake
%
% /pgf/shape snake shape        : the shape used in the snake.
% /pgf/shape snake sep          : the distance between shape borders.
% /pgf/shape snake scaled       : scale the shapes in the snake along the path.
% /pgf/shape snake start width  : recommended starting width.
% /pgf/shape snake start height : recommended starting height.
% /pgf/shape snake start size
% /pgf/shape snake end width    : recommended ending width.
% /pgf/shape snake end height   : recommended ending height.
% /pgf/shape snake end size
% /pgf/shape snake sloped       : make the shapes slope parallel to the path.

\pgfkeys{/pgf/.cd,
	shape snake shape/.initial=circle,
	shape snake sep/.initial={.25cm, between centers},
	%
	shape snake start width/.initial=.25cm,
	shape snake start height/.initial=.25cm,
	shape snake start size/.style={%
		/pgf/shape snake start width=#1,
		/pgf/shape snake start height=#1%
	},%
	shape snake end width/.initial=.125cm,
	shape snake end height/.initial=.125cm,
	shape snake end size/.style={%
		/pgf/shape snake end width=#1,
		/pgf/shape snake end height=#1%
	},%
	shape snake sep/.store in=\pgf@lib@shapesnake@sep
}%

\def\pgf@lib@shapesnake@sep{.25cm, between centers}

\newif\ifpgfshapesnakesloped
\pgfshapesnakeslopedtrue
\newif\ifpgfshapesnakescaled

\pgfkeys{/pgf/.cd,
	shape snake sloped/.is if=pgfshapesnakesloped,
	shape snake scaled/.is if=pgfshapesnakescaled,
	shape snake evenly spread/.store in=\pgf@lib@shapesnake@spread}

\let\pgf@lib@shapesnake@spread\pgfutil@empty%

% internal if
\newif\ifpgf@lib@shapesnake@betweenborders

\edef\pgf@lib@shapesnake@initialise{0pt}%

\pgfdeclaresnake{shape snake}{initialise}
{
	\state{initialise}[width=+\pgf@lib@shapesnake@initialise,next state=shape]
	{
		%
		% \egroup ends the group started by the automaton before executing
		% a snake state. This prevents the need for (most) \global variables. 
		%
		\egroup% 
			%
			% Check the shape exists.
			%
			\pgfutil@ifundefined{pgf@sh@bg@\pgfkeysvalueof{/pgf/shape snake shape}}{%
				\PackageError{PGF}{I do not know the shape `\pgfkeysvalueof{/pgf/shape snake shape}',
				so I cannot use it in a snake. Check if its library been loaded or if you 
				simply mistyped the name}{}}{}%
			%
		  % Calculate a `default' path size.
		  %
		  \pgfinterruptpath%
				\pgfinterruptboundingbox%
					\pgftransformreset%
					\pgf@relevantforpicturesizetrue%
					%
					% This size of this shape is unimportant, but it should
					% be just large/small enough to avoid huge errors when
					% calculting the scaling factors later on.
					%			
					\pgfkeys{/pgf/inner sep=50pt, /pgf/minimum size=1pt}% Arbitrary lengths.
					\setbox\pgfnodeparttextbox\hbox{}% Assume shape does nothing special if box is empty.
					\let\pgf@sh@savedmacros\pgfutil@empty% 
				  \let\pgf@sh@savedpoints\pgfutil@empty%
				  \csname pgf@sh@s@\pgfkeysvalueof{/pgf/shape snake shape}\endcsname%
				  \pgf@sh@savedpoints%
				  \pgf@sh@savedmacros%
				  %
				  % Save the macros and pionts.
				  %
				  \expandafter\gdef\expandafter\pgf@lib@shapesnake@points\expandafter{\pgf@sh@savedpoints}%
				  \expandafter\gdef\expandafter\pgf@lib@shapesnake@macros\expandafter{\pgf@sh@savedmacros}%
					\csname pgf@sh@bg@\pgfkeysvalueof{/pgf/shape snake shape}\endcsname% 
					%
					% Save the dimensions of the shape path.
					%
					\pgf@x\pgf@picmaxx%
					\pgf@y\pgf@picmaxy%
					\advance\pgf@x-\pgf@picminx%
					\advance\pgf@y-\pgf@picminy%
					\xdef\pgf@lib@shapesnake@shapepathsize{%
						\noexpand\pgf@x\the\pgf@x%
						\noexpand\pgf@y\the\pgf@y%
					}%
				\endpgfinterruptboundingbox%
			\endpgfinterruptpath%
			%
			\edef\pgf@lib@shapesnake@beforeshape{0pt}%
			\edef\pgf@lib@shapesnake@aftershape{0pt}%
			%
			\pgfmathsetlength\pgf@x{\pgfkeysvalueof{/pgf/shape snake start width}}%
			\edef\pgf@lib@shapesnake@startwidth{\the\pgf@x}%
			\edef\pgf@lib@shapesnake@width{\the\pgf@x}%
			\pgf@x-\pgf@x%
			\pgfmathaddtolength\pgf@x{\pgfkeysvalueof{/pgf/shape snake end width}}%
			\edef\pgf@lib@shapesnake@widthchange{\the\pgf@x}%
			%
			\pgfmathsetlength\pgf@y{\pgfkeysvalueof{/pgf/shape snake start height}}%
			\edef\pgf@lib@shapesnake@initialheight{\the\pgf@y}%
			\edef\pgf@lib@shapesnake@height{\the\pgf@y}%
			\pgf@y-\pgf@y%
			\pgfmathaddtolength\pgf@y{\pgfkeysvalueof{/pgf/shape snake end height}}%
			\edef\pgf@lib@shapesnake@heightchange{\the\pgf@y}%		
			%
			% Calculate the sep.
			%
			\ifx\pgf@lib@shapesnake@spread\pgfutil@empty%
				% 
				% Not spreading, so easy:
				%
				\def\pgf@lib@shapesnake@borderstext{between borders}%
				\afterassignment\pgf@lib@shapesnake@setkeyword%
				\expandafter\pgf@x\pgf@lib@shapesnake@sep,\pgf@stop%
				\edef\pgf@lib@shapesnake@sep{\the\pgf@x}%
			\else%
				%
				% Spreading (a bit of a nuiscence actually).
				%
				\def\pgf@lib@shapesnake@borderstext{by borders}%
				\afterassignment\pgf@lib@shapesnake@setkeyword%
				\expandafter\c@pgf@counta\pgf@lib@shapesnake@spread,\pgf@stop%
				\ifpgf@lib@shapesnake@betweenborders%
					%
					% Ok. The required sep between borders is:
					% 
					% (r -(n-1)((a+b)/2))/(n-1)
					%
					% r = snake length (here, the remaining distance)
					% a = initial width
					% b = end width
					% n = the number of shapes
					%
					\ifnum\c@pgf@counta>1\relax%
						\advance\c@pgf@counta-1\relax%
						\pgfmathsetlength\pgf@x{\pgfkeysvalueof{/pgf/shape snake start width}}%
						\ifpgfshapesnakescaled%
							\pgfmathaddtolength\pgf@x{\pgfkeysvalueof{/pgf/shape snake end width}}%
						\else%
							\advance\pgf@x\pgf@x%
						\fi%
						\pgf@x.5\pgf@x% (a+b)/2
						\multiply\pgf@x-\c@pgf@counta% -(n-1)((a+b)/2)
						\advance\pgf@x\pgfsnakeremainingdistance%
						\divide\pgf@x\c@pgf@counta%
						\pgf@x.9999\pgf@x% Hackery to control some native TeX inaccuracies.
						%
						% Unfortunately if the shape is scaled, and evenly spread by borders,
						% it is necessary to do something a bit different to control for 
						% (most) inaccuracies.
						% 
						\ifpgfshapesnakescaled%
							\pgf@xa\pgf@lib@shapesnake@widthchange\relax%
							\divide\pgf@xa\c@pgf@counta%
							\edef\pgf@lib@shapesnake@specialwidth{\the\pgf@xa}%		
						\fi%
					\else%
						\pgf@lib@shapesnake@betweenbordersfalse%
						\pgf@x\pgfsnakeremainingdistance%
						\ifnum\c@pgf@counta=1\relax%
							\pgf@y.5\pgf@x%
							\edef\pgf@lib@shapesnake@initialise{\the\pgf@y}%
						\else%
							\advance\pgf@x5pt\relax% An arbitrary value >0pt.
							\edef\pgf@lib@shapesnake@initialise{\the\pgf@x}%
						\fi%
					\fi%	
				\else%
					%
					% Between centers.
					%
					\pgf@x\pgfsnakeremainingdistance%
					\ifnum\c@pgf@counta>1\relax%
						\advance\c@pgf@counta-1\relax%
						\divide\pgf@x\c@pgf@counta\relax%
					\else%
						\ifnum\c@pgf@counta=1\relax%
							\pgf@y.5\pgf@x%
							\edef\pgf@lib@shapesnake@initialise{\the\pgf@y}%
						\else%
							\advance\pgf@x5pt\relax% An arbitrary value >0pt.
							\edef\pgf@lib@shapesnake@initialise{\the\pgf@x}%
						\fi%
					\fi%
				\fi%
				\edef\pgf@lib@shapesnake@sep{\the\pgf@x}%
			\fi%
		%
		% \bgroup starts the group ended at the beginning of the state.
		%
		\bgroup%
	}
	\state{before shape}[width=+\pgf@lib@shapesnake@beforeshape,next state=shape]
	{
		\egroup%
			\ifpgfshapesnakescaled%
				\ifpgf@lib@shapesnake@betweenborders%
					\ifx\pgf@lib@shapesnake@spread\pgfutil@empty%
						%
						% Not so straightforward. The required ratio is given by
						%
						% R = (c+W/2)/(c+r-.5*w)
						%
						% c = completed distance
						% r = remaining distance
						% W = initial width
						% w = the change in width (i.e., end - start)
						%
						\pgf@x\pgfsnakecompleteddistance%
						\advance\pgf@x\pgfsnakeremainingdistance%
						\pgf@xa\pgf@lib@shapesnake@startwidth\relax%
						\pgf@xa.5\pgf@xa%
						\advance\pgf@xa\pgfsnakecompleteddistance% c+W/2
						%
						\pgf@xb\pgf@lib@shapesnake@widthchange\relax%
						\pgf@xb-.5\pgf@xb%
						\advance\pgf@xb\pgf@x% c+r-.5*w
						%
						\pgfmathdivide@{\pgfmath@tonumber{\pgf@xa}}{\pgfmath@tonumber{\pgf@xb}}%
					\fi%
				\else%
					%
					% Easy peasy. The required ratio is 
					%
					% R = c / (c+r)
					%
					\pgf@x\pgfsnakecompleteddistance%
					\advance\pgf@x\pgfsnakeremainingdistance%
					\pgfmathdivide@{\pgfmath@tonumber{\pgfsnakecompleteddistance}}{\pgfmath@tonumber{\pgf@x}}%			
				\fi%
				%
				% Get the new width.
				%
				\ifx\pgf@lib@shapesnake@spread\pgfutil@empty%
					\pgf@x\pgf@lib@shapesnake@widthchange\relax%
					\pgf@x\pgfmathresult\pgf@x%
					\advance\pgf@x\pgf@lib@shapesnake@startwidth\relax%
				\else%
					\ifpgf@lib@shapesnake@betweenborders%
						%
						% Specical case when snake is scaled, and evenly spread by borders.
						%
						\pgf@x\pgf@lib@shapesnake@width\relax%
						\advance\pgf@x\pgf@lib@shapesnake@specialwidth\relax%
						\pgf@xa\pgf@x%
						\advance\pgf@xa-\pgf@lib@shapesnake@startwidth\relax%
						\pgf@xb\pgf@lib@shapesnake@widthchange\relax%
						\pgfmathdivide@{\pgfmath@tonumber{\pgf@xa}}{\pgfmath@tonumber{\pgf@xb}}%
					\else%
						\pgf@x\pgf@lib@shapesnake@widthchange\relax%
						\pgf@x\pgfmathresult\pgf@x%
						\advance\pgf@x\pgf@lib@shapesnake@startwidth\relax%
					\fi%
				\fi%		
				\edef\pgf@lib@shapesnake@width{\the\pgf@x}%		
				%
				% New height = R*h + H
				%
				\pgf@y\pgf@lib@shapesnake@heightchange\relax%
				\pgf@y\pgfmathresult\pgf@y%
				\advance\pgf@y\pgf@lib@shapesnake@initialheight\relax%
				\edef\pgf@lib@shapesnake@height{\the\pgf@y}%
			\fi%
			%
			\ifpgf@lib@shapesnake@betweenborders%
				\pgf@x\pgf@lib@shapesnake@width\relax%
				\pgf@x.5\pgf@x%
				\edef\pgf@lib@shapesnake@beforeshape{\the\pgf@x}%
			\else%
				\def\pgf@lib@shapesnake@beforeshape{0pt}%
			\fi%	
		\bgroup%
	}
	\state{shape}[width=+1sp,next state=after shape]
	{
		\ifpgfshapesnakesloped%
		\else%
			\pgftransformrotate{-\pgfsnakeangle}%
		\fi%
		%
	  % Scale the path when it is actually drawn.
	  %
	  \pgf@lib@shapesnake@shapepathsize%
	  \pgfutil@tempdima\pgf@x%
	  \pgfutil@tempdimb\pgf@y%
	  \pgf@xa\pgf@lib@shapesnake@width\relax%
	  \pgf@xb\pgfutil@tempdima%
	  \pgfmathdivide@{\pgfmath@tonumber{\pgf@xa}}{\pgfmath@tonumber{\pgf@xb}}%
	  \expandafter\pgftransformxscale\expandafter{\pgfmathresult}%
	  %
	  \pgf@ya\pgf@lib@shapesnake@height\relax%
	  \pgf@yb\pgfutil@tempdimb%
	  \pgfmathdivide@{\pgfmath@tonumber{\pgf@ya}}{\pgfmath@tonumber{\pgf@yb}}%
	  \expandafter\pgftransformyscale\expandafter{\pgfmathresult}%
	  %
	  % Move to the center anchor.
	  %
	  \pgf@lib@shapesnake@points%
	  \pgf@lib@shapesnake@macros%
	  \pgftransformshift{%
	  	\pgf@sh@reanchor{\pgfkeysvalueof{/pgf/shape snake shape}}{center}%
	  	\pgf@x-\pgf@x%
	   	\pgf@y-\pgf@y%
	  }%
	  %
	  % And draw the shape path.
	  %
	 	\csname pgf@sh@bg@\pgfkeysvalueof{/pgf/shape snake shape}\endcsname%	
	}
	\state{after shape}[width=+\pgf@lib@shapesnake@aftershape,next state=sep]
	{
		\egroup%
			\ifpgf@lib@shapesnake@betweenborders%
				\pgf@x\pgf@lib@shapesnake@width\relax%
				\pgf@x.5\pgf@x%
				\edef\pgf@lib@shapesnake@aftershape{\the\pgf@x}%
			\else%
				\edef\pgf@lib@shapesnake@aftershape{0pt}%
			\fi%	
		\bgroup%
	}
	\state{sep}[width=\pgf@lib@shapesnake@sep,next state=before shape]
	{
		\egroup%
			\def\pgf@lib@shapesnake@beforeshape{0pt}%
		\bgroup%
	}
	\state{final}
	{
		\pgfpathmoveto{\pgfpointdecoratedpathlast}%
	}
}

\def\pgf@lib@shapesnake@setkeyword,{%
	\pgfutil@ifnextchar\pgf@stop{\def\pgf@temp{}\pgf@lib@@@shapesnake@setkeyword}{\pgf@lib@@shapesnake@setkeyword}%
}
\def\pgf@lib@@shapesnake@setkeyword#1,{\def\pgf@temp{#1}\pgf@lib@@@shapesnake@setkeyword}
\def\pgf@lib@@@shapesnake@setkeyword\pgf@stop{%
	\ifx\pgf@temp\pgf@lib@shapesnake@borderstext%
		\pgf@lib@shapesnake@betweenborderstrue%
	\else%
		\pgf@lib@shapesnake@betweenbordersfalse%
	\fi%
}


\endinput