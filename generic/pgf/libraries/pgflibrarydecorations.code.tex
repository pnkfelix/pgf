% Copyright 2008 by Mark Wibrow
%
% This file may be distributed and/or modified
%
% 1. under the LaTeX Project Public License and/or
% 2. under the GNU Public License.
%
% See the file doc/generic/pgf/licenses/LICENSE for more details.

\newdimen\pgfdecorationsegmentamplitude
\newdimen\pgfdecorationsegmentlength
\def\pgfdecorationsegmentangle{45}
\def\pgfdecorationsegmentobjectlength{\pgfdecorationsegmentamplitude}
\def\pgfdecorationsegmentaspect{0.5}

\pgfdecorationsegmentamplitude2.5pt
\pgfdecorationsegmentlength10pt



\pgfkeys{%
  /pgf/decoration segment amplitude/.code={\pgfmathsetlength\pgfdecorationsegmentamplitude{#1}},
  /pgf/decoration segment length/.code={\pgfmathsetlength\pgfdecorationsegmentlength{#1}},
  /pgf/decoration segment angle/.code={\pgfmathparse{#1}\let\pgfdecorationsegmentangle\pgfmathresult},
  /pgf/decoration segment aspect/.code={\pgfmathparse{#1}\let\pgfdecorationsegmentaspect\pgfmathresult},
  /pgf/decoration segment object length/.code={\pgfmathparse{#1}\edef\pgfdecorationsegmentobjectlength{\pgfmathresult pt}}}  

  
% zigzag decoration.
%
\pgfdeclaredecoration{zigzag}{up from center}{
	\state{up from center}[width=+.5\pgfdecorationsegmentlength, next state=big down]
	{
		\pgfpathlineto{\pgfqpoint{.25\pgfdecorationsegmentlength}{\pgfdecorationsegmentamplitude}}
	}
	\state{big down}[%
	  switch if less than=+.5\pgfdecorationsegmentlength to center finish,
	  width=+.5\pgfdecorationsegmentlength,
	  next state=big up]
	{
		\pgfpathlineto{\pgfqpoint{.25\pgfdecorationsegmentlength}{-\pgfdecorationsegmentamplitude}}
	}
	\state{big up}[%
		switch if less than=+.5\pgfdecorationsegmentlength to center finish,
		width=+.5\pgfdecorationsegmentlength,
		next state=big down]
	{
		\pgfpathlineto{\pgfqpoint{.25\pgfdecorationsegmentlength}{\pgfdecorationsegmentamplitude}}
	}
	\state{center finish}[width=0pt, next state=final]{
		\pgfpathlineto{\pgfpointorigin}
	}
	\state{final}
	{
		\pgfpathlineto{\pgfpointdecoratedpathlast}
	}
}




% saw decoration
%
% Parameters: \pgfsnakesegmentamplitude, \pgfsnakesegmentlength

\pgfdeclaredecoration{saw}{initial}
{
  \state{initial}[width=+\pgfdecorationsegmentlength]
  {
    \pgfpathlineto{\pgfqpoint{\pgfdecorationsegmentlength}{\pgfdecorationsegmentamplitude}}
    \pgfpathlineto{\pgfqpoint{\pgfdecorationsegmentlength}{0pt}}
  }
  \state{final}
  {
    \pgfpathlineto{\pgfpointdecoratedpathlast}
  }
}




% triangle decoration
%
% Parameters: \pgfdecorationsegmentlength, \pgfdecorationobjectsize, \pgfdecorationsegmentamplitude

\pgfdeclaredecoration{triangles}{triangle}
{
  \state{triangle}[switch if less than=+\pgfdecorationsegmentlength to last,
                   width=+\pgfdecorationsegmentlength]
  {
    \pgfpathmoveto{\pgfqpoint{0pt}{\pgfdecorationsegmentamplitude}}
    \pgfpathlineto{\pgfqpoint{\pgfdecorationsegmentobjectlength}{0pt}}
    \pgfpathlineto{\pgfqpoint{0pt}{-\pgfdecorationsegmentamplitude}}
    \pgfpathclose
  }
  \state{last}[width=+\pgfdecorationsegmentobjectlength,next state=final]
  {
    \pgfpathmoveto{\pgfqpoint{0pt}{\pgfdecorationsegmentamplitude}}
    \pgfpathlineto{\pgfqpoint{\pgfdecorationsegmentobjectlength}{0pt}}
    \pgfpathlineto{\pgfqpoint{0pt}{-\pgfdecorationsegmentamplitude}}
    \pgfpathclose
  }
  \state{final}
  {
    \pgfpathmoveto{\pgfpointdecoratedpathlast}
  }
}



% crosses decoration
%
% Parameters: \pgfdecorationsegmentlength, \pgfdecorationobjectsize, \pgfdecorationsegmentamplitude

\pgfdeclaredecoration{crosses}{crosses}
{
  \state{crosses}[switch if less than=+\pgfdecorationsegmentlength to last,
                   width=+\pgfdecorationsegmentlength]
  {
    \pgfpathmoveto{\pgfqpoint{0pt}{\pgfdecorationsegmentamplitude}}
    \pgfpathlineto{\pgfqpoint{\pgfdecorationsegmentobjectlength}{-\pgfdecorationsegmentamplitude}}
    \pgfpathmoveto{\pgfqpoint{0pt}{-\pgfdecorationsegmentamplitude}}
    \pgfpathlineto{\pgfqpoint{\pgfdecorationsegmentobjectlength}{\pgfdecorationsegmentamplitude}}
  }
  \state{last}[width=\pgfdecorationsegmentobjectlength,next state=final]
  {
    \pgfpathmoveto{\pgfqpoint{0pt}{\pgfdecorationsegmentamplitude}}
    \pgfpathlineto{\pgfqpoint{\pgfdecorationsegmentobjectlength}{-1\pgfdecorationsegmentamplitude}}
    \pgfpathmoveto{\pgfqpoint{0pt}{-\pgfdecorationsegmentamplitude}}
    \pgfpathlineto{\pgfqpoint{\pgfdecorationsegmentobjectlength}{\pgfdecorationsegmentamplitude}}
  }
  \state{final}
  {
    \pgfpathmoveto{\pgfpointdecoratedpathlast}
  }
}




% ticks decoration
%
% Parameters: \pgfdecorationsegmentlength, \pgfdecorationsegmentamplitude

\pgfdeclaredecoration{ticks}{ticks}
{
  \state{ticks}[width=+\pgfdecorationsegmentlength]
  {
    \pgfpathmoveto{\pgfqpoint{0pt}{\pgfdecorationsegmentamplitude}}
    \pgfpathlineto{\pgfqpoint{0pt}{-\pgfdecorationsegmentamplitude}}
  }
  \state{final}
  {
    \pgfpathmoveto{\pgfqpoint{0pt}{\pgfdecorationsegmentamplitude}}
    \pgfpathlineto{\pgfqpoint{0pt}{-\pgfdecorationsegmentamplitude}}
    \pgfpathmoveto{\pgfpointdecoratedpathlast}
  }
}



% Keys for text decoration:
%
\pgfkeys{pgf/.cd,%
	decoration text format delimiters/.code={\expandafter\pgfsetdecoratetextformatdelimiters#1},%
	decoration text/.store in=\pgfdecorationtext%
}

% \pgfsetdecoratetextformatdelimiters
% 
% Set the delimiters for formatting in the text decoration.
% NB: Catcodes for delimiters should be 11 or 12.
%
% Examples:
%
% \pgfsetdecoratetextformatdelimiters{|}{}% 2nd argument can be empty.
%
% \def\pgfdecoratetext{A big |\color{red}|red|| apple.}
%
% \pgfsetdecoratetextformatdelimiters{[}{]}
%
% \def\pgfdecoratetext{The [\it]very[+\color{green}]green[] sprouts.}
%
\def\pgfsetdecoratetextformatdelimiters#1#2{%
	\def\pgf@lib@decorations@text@formatchar{#1}%
	\def\pgf@test{#2}%
	\ifx\pgf@test\pgfutil@empty%
		\def\pgf@lib@decorations@text@collectformat##1#1{%
		\pgf@lib@decorations@text@@collectformat##1\pgf@stop}%
	\else%
		\def\pgf@lib@decorations@text@collectformat##1#2{%
			\pgf@lib@decorations@text@@collectformat##1\pgf@stop}%
	\fi%
}

\pgfsetdecoratetextformatdelimiters{|}{}

\newbox\pgf@lib@decorations@text@box
\newif\ifpgf@lib@decorate@textmathmode

\let\pgfdecorationtext\pgfutil@empty
\let\pgfdecorationrestoftext\pgfutil@empty%
\let\pgf@lib@decorations@text@format\pgfutil@empty

\def\pgf@lib@decorations@text@scanchar{%
	\ifx\pgfdecorationrestoftext\pgfutil@empty%
		\let\pgf@lib@decorations@text@char\pgfutil@empty%
		\setbox\pgf@lib@decorations@text@box\box\voidb@x%
		\let\pgf@next\relax%
	\else%
		\let\pgf@next\pgf@lib@decorations@text@@scanchar%
	\fi%
	\pgf@next}

\def\pgf@lib@decorations@text@@scanchar{%
	\expandafter\pgf@lib@decorations@text@@@scanchar\pgfdecorationrestoftext\pgf@stop}

\def\pgf@lib@decorations@text@@@scanchar{%
	\futurelet\pgf@lib@decorations@lettoken%
	\pgf@lib@decorations@text@@@@scanchar}
	
\def\pgf@lib@decorations@text@@@@scanchar{%
	\ifx\pgf@lib@decorations@lettoken\pgfutil@sptoken%
		\let\pgf@next\pgf@lib@decorations@text@insertspace%
	\else%
		\let\pgf@next\pgf@lib@decorations@text@@@@@scanchar%
	\fi%
	\pgf@next}

\def\pgf@lib@decorations@text@@@@@scanchar{%
	\pgfutil@ifnextchar\bgroup{\pgf@lib@decorations@text@collectgroup}%
		{\pgf@lib@decorations@text@@@@@@scanchar}}
		
\def\pgf@lib@decorations@text@collectgroup#1{%
	\def\pgf@lib@decorations@text@char{#1}%
	\pgf@lib@decorations@text@collectrestoftext}
	
\def\pgf@lib@decorations@text@@@@@@scanchar#1{%
	\ifx#1\pgf@stop%
		\pgf@lib@decorations@text@box\box\voidb@x%
		\let\pgf@next\pgf@lib@decorations@text@endoftext%
	\else%
		\def\pgf@lib@decorations@text@char{#1}%
		\ifx#1\space%
			\let\pgf@next\pgf@lib@decorations@text@collectrestoftext%
		\else%
			\ifx#1\ %
				\let\pgf@next\pgf@lib@decorations@text@collectrestoftext%
			\else%
				\ifx\pgf@lib@decorations@text@char\pgf@lib@decorations@text@formatchar%
					\let\pgf@next\pgf@lib@decorations@text@collectformat%
				\else%
					\expandafter\ifcat\noexpand#1\relax%
						\let\pgf@next\pgf@lib@decorations@text@expandcs%
					\else%
						\ifnum\catcode`#1=3\relax%
							\ifpgf@lib@decorate@textmathmode%
								\pgf@lib@decorate@textmathmodefalse%
							\else%
								\pgf@lib@decorate@textmathmodetrue%
							\fi%
							\let\pgf@next\pgf@lib@decorations@text@@@scanchar%
						\else%
							\let\pgf@next\pgf@lib@decorations@text@collectrestoftext%
						\fi%
					\fi%
				\fi%
			\fi%
		\fi%
	\fi%
	\pgf@next%
}

\def\pgf@lib@decorations@text@@collectformat{%
	\pgfutil@ifnextchar+{\pgf@lib@decorations@text@addtoformat}{\pgf@lib@decorations@text@setformat}}
	
\def\pgf@lib@decorations@text@setformat#1\pgf@stop{%
	\def\pgf@lib@decorations@text@format{#1}%
	\pgf@lib@decorations@text@@@scanchar%
}

\def\pgf@lib@decorations@text@addtoformat+#1\pgf@stop{%
	\expandafter\def\expandafter\pgf@lib@decorations@text@format\expandafter{\pgf@lib@decorations@text@format#1}%
	\pgf@lib@decorations@text@@@scanchar%
}

\def\pgf@lib@decorations@text@insertspace{%
	\pgfutil@ifnextchar\bgroup{\pgf@lib@decorations@text@@insertspacegrp}%
		{\pgf@lib@decorations@text@@insertspace}}
		
\def\pgf@lib@decorations@text@@insertspacegrp#1{%
	\pgf@lib@decorations@text@@@@@@scanchar\space{#1}}
	
\def\pgf@lib@decorations@text@@insertspace#1{%
	\pgf@lib@decorations@text@@@@@@scanchar\space#1}
	
\def\pgf@lib@decorations@text@expandcs{%
	\expandafter\expandafter\expandafter\pgf@lib@decorations@text@@@@@scanchar%
		\pgf@lib@decorations@text@char}

\def\pgf@lib@decorations@text@endoftext{%
	\let\pgfdecoraterestoftext\pgfutil@empty%
	\let\pgf@lib@decorations@text@char\pgfutil@empty%
}
\def\pgf@lib@decorations@text@collectrestoftext{%
	\pgf@lib@decorations@text@dobox%
	\futurelet\pgf@lib@decorations@text@lettoken%
	\pgf@lib@decorations@text@@collectrestoftext}

\def\pgf@lib@decorations@text@@collectrestoftext{%
	\ifx\bgroup\pgf@lib@decorations@text@lettoken%
		\let\pgf@next\pgf@lib@decorations@text@@@collectrestoftextgrp%
	\else%
		\let\pgf@next\pgf@lib@decorations@text@@@collectrestoftext%
	\fi%
	\pgf@next}
	
\def\pgf@lib@decorations@text@@@collectrestoftextgrp#1#2\pgf@stop{\def\pgfdecorationrestoftext{{#1}#2}%
}

\def\pgf@lib@decorations@text@@@collectrestoftext#1\pgf@stop{\def\pgfdecorationrestoftext{#1}}

{%
	\catcode`\$3 %
	\gdef\pgf@lib@decorations@mathshift{$}%
	\catcode`\$9 $% For editors with annoying syntax highlighting.
}%

\def\pgf@lib@decorations@text@dobox{%
	\setbox\pgf@lib@decorations@text@box\hbox{%
		\pgfinterruptpicture%
		\begingroup%
			\ifpgf@lib@decorate@textmathmode\pgf@lib@decorations@mathshift\fi%
				\pgf@lib@decorations@text@format\relax%
				\pgf@lib@decorations@text@char%
			\ifpgf@lib@decorate@textmathmode\pgf@lib@decorations@mathshift\fi%
		\endgroup%
		\endpgfinterruptpicture%
	}%
}

\pgfdeclaredecoration{text}{initial}{
	\state{initial}[width=0pt, next state=scan]
	{
			\egroup%
		\let\pgfdecorationrestoftext\pgfdecorationtext%
			\bgroup%
	}
	\state{scan}[width=0pt, next state=before typeset]
	{
			\egroup%
		\pgf@lib@decorations@text@scanchar%
		\ifvoid\pgf@lib@decorations@text@box%
			\setbox\pgf@lib@decorations@text@box\hbox{}%
			\wd\pgf@lib@decorations@text@box16383pt\relax%
		\fi%
			\bgroup%
	}
	\state{before typeset}[width=+.5\wd\pgf@lib@decorations@text@box, next state=typeset]{}
	\state{typeset}[width=0pt, next state=after typeset]
	{
		\pgftransformxshift{+-.5\wd\pgf@lib@decorations@text@box}%
		\setbox\pgf@hbox\hbox{\copy\pgf@lib@decorations@text@box}%
		\pgfqboxsynced\pgf@hbox%
	}
	\state{after typeset}[width=+.5\wd\pgf@lib@decorations@text@box, next state=scan]{}
	\state{final}{}
}


\endinput