\documentclass[a4paper]{article}

\usepackage[intlimits]{amsmath}
\usepackage{amssymb}
\usepackage{amsfonts}
\usepackage{ifpdf}

\ifpdf
	\usepackage{hyperref}
\else
	\def\pgfsysdriver{pgfsys-dvipdfm.def}
	\usepackage[dvipdfm]{hyperref}
\fi
\usepackage{pgf}

\parindent=0pt


\author{Christian Feuers\"anger}
\title{Test cases for pgffloatmath.code.tex}

\def\testsection#1{\message{---------- STARTING TEST SECTION '#1'}\section{#1}}
\def\testsubsection#1{\message{-------STARTING TEST SUBSECTION '#1'}\subsection{#1}}
\def\testsubsubsection#1{\message{------STARTING TEST SUBSUBSECTION '#1'}\subsubsection{#1}}


\def\compare#1#2{%
	\begingroup
	\message{COMPUTING LOG(#1)}%
	\pgfmathlog{#1}%
	\let\actual=\pgfmathresult
	\def\expected{#2}%
	\pgfmathsubtract\actual\expected%
	\let\abserr=\pgfmathresult
	\pgfmathdivide\abserr\expected
	\let\relerr=\pgfmathresult
	\noindent
	log(#1)\hfill=
	\expected;\hfill%
	actual=\actual;\hfill%
	abserr=\abserr;\hfill%
	relerr=\relerr;\hfill%
	\endgroup
	\par
}%
\def\showlowlevelfloat#1#2e#3\relax{%
	\ensuremath{[#1] \cdot #2 \cdot 10^{#3}}%
}%
\def\showlowlevelfloatmacro#1{%
	\expandafter\showlowlevelfloat#1\relax
}%

\def\showsinglenumberparsing#1{%
%\tracingmacros=2\tracingcommands=2
	\begingroup
	\message{PARSING NUMBER #1...}%
	\pgfmathfloatparsenumber{#1}%
	\[ #1 \mapsto \pgfmathresult = \showlowlevelfloatmacro\pgfmathresult \]
	\endgroup
%\tracingmacros=0\tracingcommands=0
}

\def\pretty#1{%
	\message{Pretty-printing #1...}%
	\[ #1 \mapsto \pgfmathprintnumber{#1} \]
}

\begin{document}
\maketitle


%--------------------------------------------------
% \showit{2.8128}
% log(12)=\pgfmathlog{1.2}\pgfmathadd{\pgfmathresult}{2.30258}\pgfmathresult\par
% \showit{1.2}
% \showit{4.0}
% log(1200)=\pgfmathlog{1.2}\pgfmathadd{\pgfmathresult}{6.9077}\pgfmathresult\par
% log(6.241e-7)=\pgfmathlog{6.241}\pgfmathadd{\pgfmathresult}{-16.11809}\pgfmathresult\par
%-------------------------------------------------- 

\testsection{Conversion to normalised floating point numbers basis 10}
\showsinglenumberparsing{123.41251}%
\showsinglenumberparsing{1023.52}
\showsinglenumberparsing{123412.51}%
\showsinglenumberparsing{12341251.0}%
\tracingmacros=2\tracingcommands=2
\showsinglenumberparsing{-12341251.0}%
\tracingmacros=0\tracingcommands=0
\showsinglenumberparsing{1.2341251}%
\showsinglenumberparsing{8.02410024}
\showsinglenumberparsing{8.024100}
\showsinglenumberparsing{0001234.3100}
\showsinglenumberparsing{0001234.00001}
\showsinglenumberparsing{0001000.00001}
\showsinglenumberparsing{0001000.00001000}
\showsinglenumberparsing{0.12341251}%
\showsinglenumberparsing{0.0012341251}%
\showsinglenumberparsing{0.00000012341251}%
\showsinglenumberparsing{-0.00000012341251}%
\showsinglenumberparsing{10}
\showsinglenumberparsing{100}
\showsinglenumberparsing{99999}
\showsinglenumberparsing{999.000}

\showsinglenumberparsing{8.31160034e-02}%
\showsinglenumberparsing{2.54685628e-02}%
\showsinglenumberparsing{7.40715288e-03}%
\showsinglenumberparsing{2.10192154e-03}%
\showsinglenumberparsing{5.87352989e-04}%
\showsinglenumberparsing{-1.62269942e-04}%
\showsinglenumberparsing{4.44248889e-05}%
\showsinglenumberparsing{1.20714122e-05}%
\showsinglenumberparsing{3.26101452e-06}%
\showsinglenumberparsing{3261.01452e-06}%
\showsinglenumberparsing{0.000326101452e-06}%

\message{SPECIAL CASE 0}%
\showsinglenumberparsing{0}
\showsinglenumberparsing{-0}
\showsinglenumberparsing{-0.000}
\showsinglenumberparsing{+0.000}
\showsinglenumberparsing{+0}
\showsinglenumberparsing{-1}
\showsinglenumberparsing{1.0e1}
\tracingmacros=2\tracingcommands=2
\showsinglenumberparsing{1e1}
\tracingmacros=0\tracingcommands=0
\showsinglenumberparsing{1141}
\showsinglenumberparsing{-53e-5}


\testsection{logarithms, compared with PGF arithmetics}

\compare{0.1}{-2.30259}
\compare{0.12}{-2.12026}
\compare{0.2}{-1.60944}
\compare{0.3}{-1.20397}
\compare{0.4}{-0.916291}
\compare{0.5}{-0.693147}
\compare{0.6}{-0.510826}
\compare{0.7}{-0.356675}
\compare{0.75}{-0.287682}
\compare{0.8}{-0.223144}
\compare{0.823}{-0.194799}
\compare{0.9}{-0.105361}
\compare{0.96}{-0.040822}
\compare{1.2}{0.182322}
\compare{1.5}{0.405465}
\compare{1.6}{0.470004}
\compare{9.0}{2.1972245773}
\compare{9.2}{2.2192034}
\compare{9.3}{2.23001440}
\compare{9.7}{2.27212588}
\compare{10.0}{2.302585092}
\compare{100.0}{4.605170185}
\compare{1351.0}{7.208600337}
\compare{9752.0}{9.185227671}
\compare{9600.0}{9.169518377}

\vskip1cm
\compare{0.000142}{-8.8596835}
\compare{0.0054124}{-5.219062661}
\compare{0.000912697124}{-6.9991064}

\vskip1cm
\compare{8.31160034e-02}{-2.48751801563782}%
\compare{2.54685628e-02}{-3.67031041875206}%
\compare{7.40715288e-03}{-4.90530914022879}%
\compare{2.10192154e-03}{-6.16490333357987}%
\compare{5.87352989e-04}{-7.43988457474844}%
\compare{1.62269942e-04}{-8.72624930084187}%
\compare{4.44248889e-05}{-10.0217106847708}%
\compare{1.20714122e-05}{-11.3246705288704}%
\compare{3.26101452e-06}{-12.6334722085451}%

\vskip1cm
\compare{5}{1.6094379124341}%
\compare{17}{2.83321334405622}%
\compare{39}{3.66356164612965}%
\compare{49}{3.89182029811063}%
\compare{129}{4.85981240436167}%
\compare{321}{5.77144112313002}%
\compare{769}{6.64509096950564}%
\compare{1793}{7.49164547360513}%
\compare{4097}{8.31801027754687}%
\compare{9217}{9.12880488399366}%


\testsection{Test for prettyprinter}
\message{PRETTY PRINTING}
{
\twocolumn
\def\prettytest{%
	\pretty{1}
	\pretty{1.0}
	\pretty{-1.02311}
	\pretty{-11241.02311}
	\pretty{-11241}
	\pretty{8124.99999}
	\pretty{8124.849999}
	\pretty{8124.843333}
	\pretty{8.82}
	\pretty{8.5}
	\pretty{9.}
	\pretty{-0.559}
	\pretty{-0.554}
	\pretty{-0.00000141}
	\pretty{1.234e10}
	\pretty{123456781}
	\pretty{1234}
	\pretty{8}
	\pretty{-9.995}
	\pretty{-0.015}
	\pretty{-0.1}
	\pretty{-0.15}
	\pretty{0.15}
	\pretty{-0}
	\pretty{9.00}
	\pretty{200.01}
	\pretty{200.0000}
	\pretty{1.5e-7}
	\pretty{0.00035}
	\pretty{0.00005}
	\pretty{nan}
	\pretty{inf}
	\pretty{-inf}
	\pretty{10}
	\pretty{100}
	\pretty{200}
	\pretty{500}
	\pretty{1000}
}

\testsubsection{STD format}
\pgfkeys{/pgf/number format/std}
\prettytest

{
\testsubsection{FIXED format}
\testsubsubsection{with period}
\pgfkeys{/pgf/number format/fixed,/pgf/number format/use period}
\prettytest

\testsubsubsection{with comma}
\pgfkeys{/pgf/number format/fixed,/pgf/number format/use comma}
\prettytest
}


{
\testsubsection{FIXED ZEROFILL format}
\testsubsubsection{with period}
\pgfkeys{/pgf/number format/fixed zerofill,/pgf/number format/use period}
\prettytest

\testsubsubsection{with comma}
\pgfkeys{/pgf/number format/fixed zerofill,/pgf/number format/use comma}
\tracingmacros=2\tracingcommands=2
\prettytest
\tracingmacros=0\tracingcommands=0
}

{
\testsubsection{sci format}
\testsubsubsection{with period}
\pgfkeys{/pgf/number format/sci,/pgf/number format/use period}
\prettytest

\testsubsubsection{with comma}
\pgfkeys{/pgf/number format/sci,/pgf/number format/use comma}
\prettytest

%\testsubsection{may skip mantisse}
%\pgfkeys{/pgf/number format/sci may skip mantisse=true}
%\prettytest

}{
\testsubsection{sci format zerofill}
\testsubsubsection{with period}
\pgfkeys{/pgf/number format/sci zerofill,/pgf/number format/use period}
\prettytest

\testsubsubsection{with comma}
\pgfkeys{/pgf/number format/sci zerofill,/pgf/number format/use comma}
\prettytest

\testsubsubsection{e-style}
\pgfkeys{/pgf/number format/sci e}
\prettytest

\testsubsubsection{subscript-style}
\pgfkeys{/pgf/number format/sci subscript}
\prettytest

\testsubsubsection{subscript-style + period + no zero fill}
\pgfkeys{/pgf/number format/sci subscript,/pgf/number format/use period,/pgf/number format/sci}
\prettytest

\testsubsubsection{subscript-style precision 4}
\pgfkeys{/pgf/number format/sci subscript,/pgf/number format/precision=4}
\prettytest
}

\testsubsection{int trunc format}
\pgfkeys{/pgf/number format/int trunc}
\prettytest

\testsubsection{int detect format}
\pgfkeys{/pgf/number format/int detect}
\prettytest
}
\onecolumn

\testsection{testing pgfmathfloatlessthan}
\def\testfloatlessthan#1#2{%
	\pgfmathfloatparsenumber{#1}%
	\let\first=\pgfmathresult
	\pgfmathfloatparsenumber{#2}%
	\let\second=\pgfmathresult
	\message{checking #1 <= #2;  \first <= \second}%
	\pgfmathfloatlessthan\first\second
	\ifpgfmathfloatcomparison
		\def\result{<}%
	\else
		\def\result{\ge}%
	\fi
	\[ \text{pgfmathfloatlessthan: } \bigl( \showlowlevelfloatmacro\first \bigr)\; = #1 \result #2\; \bigl( = \showlowlevelfloatmacro\second \big). \]
}%

\testfloatlessthan{4}{5}
\testfloatlessthan{0}{2}
\testfloatlessthan{91751123}{241924}
\testfloatlessthan{-1}{-1}
\testfloatlessthan{-1231}{0}
\testfloatlessthan{10}{-5}
\testfloatlessthan{0}{0}
\testfloatlessthan{-0}{-0}
\testfloatlessthan{0}{14}
\testfloatlessthan{114812}{-123124123}
\testfloatlessthan{114812}{1241231451}
\testfloatlessthan{-141285}{29}
\testfloatlessthan{-141285}{0}
\testfloatlessthan{-141285}{-50}
\testfloatlessthan{-141285}{-12498149012}

\testsection{float to fixed test}
\def\testpgfmathfloattofixed#1{%
	\pgfmathfloatparsenumber{#1}%
%\tracingmacros=2\tracingcommands=2
	\let\argument=\pgfmathresult
	\message{converting #1 = \argument\  to fixed point}%
	\pgfmathfloattofixed\argument
	\let\result=\pgfmathresult
	\message{-> \result}%
%\tracingmacros=0\tracingcommands=0
	\[ \bigl( \showlowlevelfloatmacro\argument \bigr)\; = #1 \mapsto \result \]
}%
\testpgfmathfloattofixed{0}
\testpgfmathfloattofixed{5}
\testpgfmathfloattofixed{5.520241}
\testpgfmathfloattofixed{124.10241}
\testpgfmathfloattofixed{-121.248}
\testpgfmathfloattofixed{-12e-5}
\testpgfmathfloattofixed{412e3}
\testpgfmathfloattofixed{0.0001}
\testpgfmathfloattofixed{0.0}
\testpgfmathfloattofixed{-0.012125}
\testpgfmathfloattofixed{1.2e-1}
\testpgfmathfloattofixed{1.2e-2}
\testpgfmathfloattofixed{1.2e4}
\testpgfmathfloattofixed{1.2345e4}
\testpgfmathfloattofixed{1.234567e4}
\testpgfmathfloattofixed{1.51234e0}
\testpgfmathfloattofixed{15}
\testpgfmathfloattofixed{-20}

\testsection{Testing pgfmathfloatmin and pgfmathfloatmax}
\def\testfloatminmax#1#2{%
	\pgfmathfloatparsenumber{#1}%
	\let\first=\pgfmathresult
	\pgfmathfloatparsenumber{#2}%
	\let\second=\pgfmathresult
%\tracingmacros=2\tracingcommands=2
	\message{computing min/max #1 and #2}%
	\pgfmathfloatmin\first\second
	\let\result=\pgfmathresult
	\pgfmathfloattofixed\result
	\[ \min\{#1,#2\} = \min\{ \showlowlevelfloatmacro\first, \showlowlevelfloatmacro\second \} \; = \showlowlevelfloatmacro\result = \pgfmathresult \]
	%
	\pgfmathfloatmax\first\second
	\let\result=\pgfmathresult
	\pgfmathfloattofixed\result
	\[ \max\{#1,#2\} = \max\{ \showlowlevelfloatmacro\first, \showlowlevelfloatmacro\second \} \; = \showlowlevelfloatmacro\result = \pgfmathresult \]
}%
\testfloatminmax{42}{56}
\testfloatminmax{-4122}{1256}
\testfloatminmax{1e12}{5.235412e24}
\testfloatminmax{-12}{-145}

\testsection{Testing pgfmathfloatshift}
\def\pgfmathfloatshifttest#1#2{%
	\pgfmathfloatparsenumber{#1}%
	\let\argument=\pgfmathresult
\tracingmacros=2\tracingcommands=2
	\message{computing mathshift #1 by #2}%
	\pgfmathfloatshift\argument{#2}%
	\let\result=\pgfmathresult
	\pgfmathfloattofixed\result
\tracingmacros=0\tracingcommands=0
	\[ #1 \cdot 10^{#2} = \showlowlevelfloatmacro\argument \cdot 10^{#2} = \showlowlevelfloatmacro\result = \pgfmathresult \]
}%
\pgfmathfloatshifttest{4}{1}
\pgfmathfloatshifttest{4}{2}
\pgfmathfloatshifttest{4}{-1}
\pgfmathfloatshifttest{4}{-2}
\pgfmathfloatshifttest{0}{-2}
\pgfmathfloatshifttest{1.1415130}{-2}
\pgfmathfloatshifttest{1.1415130}{5}

\end{document}
