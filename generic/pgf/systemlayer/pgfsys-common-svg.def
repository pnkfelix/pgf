\ProvidesFileRCS $Header: /cvsroot/pgf/pgf/generic/pgf/systemlayer/pgfsys-common-svg.def,v 1.5 2005/07/11 19:52:31 tantau Exp $

% Copyright 2005 by Till Tantau <tantau@cs.tu-berlin.de>.
%
% This program can be redistributed and/or modified under the terms
% of the GNU Public License, version 2.




% Driver commands for svg


% Helping functions:
\let\pgf@sys@svgpath=\@empty
\def\pgf@sys@svgnum#1{%
  {%
    \pgf@x=#1\relax%
    \edef\temp{\expandafter\Pgf@geT\the\pgf@x\space}%
    \toks@\expandafter\expandafter\expandafter{\expandafter\pgf@sys@svgpath\temp}%
    \xdef\pgf@sys@svgpath{\the\toks@}%
  }%
}
\def\pgf@sys@addtosvgpath#1{\g@addto@macro\pgf@sys@svgpath{#1\space}}
\def\pgf@sys@flushsvgpath{\pgfsysprotocol@literal{\pgf@sys@svgpath}\global\let\pgf@sys@svgpath=\@empty}
\def\pgf@sys@svg@gs#1{%
  {\pgfsysprotocol@literal{<g #1>}}\global\advance\pgf@sys@svg@scopecount by1\relax%
}
\newcount\pgf@sys@svg@objectcount

\newif\ifpgf@sys@svg@strokecolor
\newif\ifpgf@sys@svg@fillcolor

\def\pgf@sys@svg@preparefillcolor{%
  \ifpgf@sys@svg@fillcolor%
    \expandafter\pgf@sys@svg@extractcolor\pgf@sys@svg@fillcolor\relax%
  \else%
    \expandafter\expandafter\expandafter\pgf@sys@svg@extractcolor\csname\string\color@.\endcsname%
  \fi%  
}
\def\pgf@sys@svg@preparestrokecolor{%
  \ifpgf@sys@svg@strokecolor%
    \expandafter\pgf@sys@svg@extractcolor\pgf@sys@svg@strokecolor\relax%
  \else%
    \expandafter\expandafter\expandafter\pgf@sys@svg@extractcolor\csname\string\color@.\endcsname%
  \fi%  
}

\def\pgf@sys@svg@extractcolor\xcolor@#1#2#3#4{%
  \csname pgf@sys@svg@extractcolor@#3\endcsname#4\relax%
}
\def\pgf@sys@svg@extractcolor@rgb#1,#2,#3\relax{%
 {%
    \pgf@xa=#1pt%
    \pgf@xa=100\pgf@xa%
    \pgf@xb=#2pt%
    \pgf@xb=100\pgf@xb%
    \pgf@xc=#3pt%
    \pgf@xc=100\pgf@xc%
    \xdef\pgf@sys@svg@prepared{rgb(\pgf@sys@tonumber\pgf@xa\%,\pgf@sys@tonumber\pgf@xb\%,\pgf@sys@tonumber\pgf@xc\%)}%
  }%
}
\def\pgf@sys@svg@extractcolor@cmy#1,#2,#3\relax{%
  {%
    \pgf@xa=1pt%
    \advance\pgf@xa by-#1pt%
    \pgf@xa=100\pgf@xa%
    \pgf@xb=1pt%
    \advance\pgf@xb by-#2pt%
    \pgf@xb=100\pgf@xb%
    \pgf@xc=1pt%
    \advance\pgf@xc by-#3pt%
    \pgf@xc=100\pgf@xc%
    \xdef\pgf@sys@svg@prepared{rgb(\pgf@sys@tonumber\pgf@xa\%,\pgf@sys@tonumber\pgf@xb\%,\pgf@sys@tonumber\pgf@xc\%)}%
  }%
}
\def\pgf@sys@svg@extractcolor@cmyk#1,#2,#3,#4\relax{%
  {%
    \pgf@xa=1pt%
    \advance\pgf@xa by-#4pt%
    \pgf@xa=#1\pgf@xa%
    \advance\pgf@xa by#4pt%
    \advance\pgf@xa by-1pt%
    \pgf@xa=-100\pgf@xa%
    \pgf@xb=1pt%
    \advance\pgf@xb by-#4pt%
    \pgf@xb=#2\pgf@xb%
    \advance\pgf@xb by#4pt%
    \advance\pgf@xb by-1pt%
    \pgf@xb=-100\pgf@xb%
    \pgf@xc=1pt%
    \advance\pgf@xc by-#4pt%
    \pgf@xc=#3\pgf@xc%
    \advance\pgf@xc by#4pt%
    \advance\pgf@xc by-1pt%
    \pgf@xc=-100\pgf@xc%
    \xdef\pgf@sys@svg@prepared{rgb(\pgf@sys@tonumber\pgf@xa\%,\pgf@sys@tonumber\pgf@xb\%,\pgf@sys@tonumber\pgf@xc\%)}%
  }%
}
\def\pgf@sys@svg@extractcolor@gray#1\relax{%
 {%
    \pgf@xa=#1pt%
    \pgf@xa=100\pgf@xa%
    \xdef\pgf@sys@svg@prepared{rgb(\pgf@sys@tonumber\pgf@xa\%,\pgf@sys@tonumber\pgf@xa\%,\pgf@sys@tonumber\pgf@xa\%)}%
  }%
}



% Path construction:
\def\pgfsys@lineto#1#2{\pgf@sys@addtosvgpath{L }\pgf@sys@svgnum{#1}\pgf@sys@svgnum{#2}}
\def\pgfsys@moveto#1#2{\pgf@sys@addtosvgpath{M }\pgf@sys@svgnum{#1}\pgf@sys@svgnum{#2}}
\def\pgfsys@curveto#1#2#3#4#5#6{%
  \pgf@sys@addtosvgpath{C }%
  \pgf@sys@svgnum{#1}\pgf@sys@svgnum{#2}%
  \pgf@sys@svgnum{#3}\pgf@sys@svgnum{#4}%
  \pgf@sys@svgnum{#5}\pgf@sys@svgnum{#6}}
\def\pgfsys@rect#1#2#3#4{%
  \pgfsys@moveto{#1}{#2}%
  \pgf@sys@addtosvgpath{h }\pgf@sys@svgnum{#3}%
  \pgf@sys@addtosvgpath{v }\pgf@sys@svgnum{#4}%
  \pgf@sys@addtosvgpath{h }{\pgf@x=#3\pgf@x=-\pgf@x\pgf@sys@svgnum{\pgf@x}}%
  \pgfsys@closepath}
\def\pgfsys@closepath{\pgf@sys@addtosvgpath{Z}}

% Path usage:
\newif\ifpgf@sys@svg@clipnext
\def\pgf@sys@svg@possiblyclippedpath#1{%
  \ifpgf@sys@svg@clipnext%
    \global\advance\pgf@sys@svg@objectcount by1\relax%
    \pgfsysprotocol@literal{<clipPath id="pgfcp\the\pgf@sys@svg@objectcount">
      <path id="pgfpath\the\pgf@sys@svg@objectcount" d="}%
    \pgf@sys@flushsvgpath%
    \pgfsysprotocol@literal{"/> </clipPath>}
    \pgfsysprotocol@literal{<use xlink:href="\#pgfpath\the\pgf@sys@svg@objectcount" #1/>}%
    \pgf@sys@svg@gs{clip-path="url(\#pgfcp\the\pgf@sys@svg@objectcount)"}
    \pgf@sys@svg@clipnextfalse%
  \else%
    \pgfsysprotocol@literal{<path d="}%
    \pgf@sys@flushsvgpath%
    \pgfsysprotocol@literal{" #1/>}
  \fi%
}
\def\pgfsys@stroke{%
  \pgf@sys@svg@preparestrokecolor%
  \pgf@sys@svg@possiblyclippedpath{style="stroke:\pgf@sys@svg@prepared"}}
\def\pgfsys@fill{%
  \pgf@sys@svg@preparefillcolor%
  \pgf@sys@svg@possiblyclippedpath{style="fill:\pgf@sys@svg@prepared"}}
\def\pgfsys@fillstroke{
  \pgf@sys@svg@preparestrokecolor%
  \let\pgf@sys@svg@temp=\pgf@sys@svg@prepared%
  \pgf@sys@svg@preparefillcolor%
  \pgf@sys@svg@possiblyclippedpath{style="stroke:\pgf@sys@svg@temp; fill:\pgf@sys@svg@prepared"}}
\def\pgfsys@clipnext{\pgf@sys@svg@clipnexttrue}
\def\pgfsys@discardpath{%
  \ifpgf@sys@svg@clipnext%
    \global\advance\pgf@sys@svg@objectcount by1\relax%
    \pgfsysprotocol@literal{<clipPath id="pgfcp\the\pgf@sys@svg@objectcount">
      <path d="}%
    \pgf@sys@flushsvgpath%
    \pgfsysprotocol@literal{"/> </clipPath>}
    \pgf@sys@svg@gs{clip-path="url(\#pgfcp\the\pgf@sys@svg@objectcount)"}
    \pgf@sys@svg@clipnextfalse%
  \else%
    \global\let\pgf@sys@svgpath=\@empty
  \fi}

% Fill rules:
\def\pgfsys@eoruletrue{\pgf@sys@svg@gs{fill-rule="evenodd"}}
\def\pgfsys@eorulefalse{\pgf@sys@svg@gs{fill-rule="nonzero"}}

% Transformation:
\def\pgfsys@transformcm#1#2#3#4#5#6{%
  {\pgf@x=#5\pgf@y=#6%
  \pgf@sys@svg@gs{transform="matrix(#1,#2,#3,#4,\pgf@sys@tonumber{\pgf@x},\pgf@sys@tonumber{\pgf@y})"}}}

% Scopes
\newcount\pgf@sys@svg@scopecount
\def\pgfsys@beginscope{%
  \edef\pgf@sys@svg@thescopecount{\the\pgf@sys@svg@scopecount}%
  \let\pgf@sys@svg@prestrokecolor=\pgf@sys@svg@strokecolor%
  \let\pgf@sys@svg@prefillcolor=\pgf@sys@svg@fillcolor%
  \begingroup%
    \pgf@sys@svg@scopecount=1\relax%
    \pgfsysprotocol@literal{<g>}%
  }
\def\pgfsys@endscope{%
    \loop%
      \pgfsysprotocol@literal{</g>}%
      \advance\pgf@sys@svg@scopecount by-1\relax%
    \ifnum\pgf@sys@svg@scopecount>0\relax%
    \repeat%  
  \endgroup%
  \global\pgf@sys@svg@scopecount=\pgf@sys@svg@thescopecount\relax%  
  \global\let\pgf@sys@svg@strokecolor=\pgf@sys@svg@prestrokecolor%  
  \global\let\pgf@sys@svg@fillcolor=\pgf@sys@svg@prefillcolor%  
}
\def\pgf@sys@svg@strokecolor{\xcolor@{}{}{gray}{0}}
\def\pgf@sys@svg@fillcolor{\xcolor@{}{}{gray}{0}}

% Graphics state
\def\pgfsys@setdash#1#2{\pgf@sys@svg@gs{stroke-dasharray="#1" stroke-dashoffset="#2"}}
\def\pgfsys@setlinewidth#1{\pgf@sys@svg@gs{stroke-width="#1"}}
\def\pgfsys@setmiterlimit#1{\pgf@sys@svg@gs{stroke-miterlimit="#1"}}
\def\pgfsys@buttcap{\pgf@sys@svg@gs{stroke-linecap="butt"}}
\def\pgfsys@roundcap{\pgf@sys@svg@gs{stroke-linecap="round"}}
\def\pgfsys@rectcap{\pgf@sys@svg@gs{stroke-linecap="square"}}
\def\pgfsys@miterjoin{\pgf@sys@svg@gs{stroke-linejoin="miter"}}
\def\pgfsys@roundjoin{\pgf@sys@svg@gs{stroke-linejoin="round"}}
\def\pgfsys@beveljoin{\pgf@sys@svg@gs{stroke-linejoin="bevel"}}

\def\pgfsys@color@reset{\pgf@sys@svg@strokecolorfalse\pgf@sys@svg@fillcolorfalse}

\def\pgfsys@color@rgb@stroke#1#2#3{%
  \xdef\pgf@sys@svg@strokecolor{\noexpand\xcolor@{}{}{rgb}{#1,#2,#3}}
  \pgf@sys@svg@strokecolortrue%
}
\def\pgfsys@color@rgb@fill#1#2#3{%
  \xdef\pgf@sys@svg@fillcolor{\noexpand\xcolor@{}{}{rgb}{#1,#2,#3}}
  \pgf@sys@svg@fillcolortrue%
}
\def\pgfsys@color@cmyk@stroke#1#2#3#4{%
  \xdef\pgf@sys@svg@strokecolor{\noexpand\xcolor@{}{}{cmyk}{#1,#2,#3,#4}}
  \pgf@sys@svg@strokecolortrue%
}
\def\pgfsys@color@cmyk@fill#1#2#3#4{%
  \xdef\pgf@sys@svg@fillcolor{\noexpand\xcolor@{}{}{cmyk}{#1,#2,#3,#4}}
  \pgf@sys@svg@fillcolortrue%
}
\def\pgfsys@color@cmy@stroke#1#2#3{%
  \xdef\pgf@sys@svg@strokecolor{\noexpand\xcolor@{}{}{cmy}{#1,#2,#3}}
  \pgf@sys@svg@strokecolortrue%
}
\def\pgfsys@color@cmy@fill#1#2#3{%
  \xdef\pgf@sys@svg@fillcolor{\noexpand\xcolor@{}{}{cmy}{#1,#2,#3}}
  \pgf@sys@svg@fillcolortrue%
}
\def\pgfsys@color@gray@stroke#1{%
  \xdef\pgf@sys@svg@strokecolor{\noexpand\xcolor@{}{}{gray}{#1}}
  \pgf@sys@svg@strokecolortrue%
}
\def\pgfsys@color@gray@fill#1{%
  \xdef\pgf@sys@svg@fillcolor{\noexpand\xcolor@{}{}{gray}{#1}}
  \pgf@sys@svg@fillcolortrue%
}

\endinput


%%% Local Variables: 
%%% mode: latex
%%% End: 
