\ProvidesFileRCS $Header: /cvsroot/pgf/pgf/generic/pgf/systemlayer/pgfsys-tex4ht.def,v 1.5 2005/07/12 07:28:54 tantau Exp $

% Copyright 2005 by Till Tantau <tantau@cs.tu-berlin.de>.
%
% This program can be redistributed and/or modified under the terms
% of the GNU Public License, version 2.


\RequirePackage{xcolor}


% Driver commands for tex4ht

%
% Load common pdf commands:
%
\input pgfsys-common-svg.def

%
% tex4ht-specific stuff:
%
\def\pgfsys@invoke#1{\HCode{#1}}

\newcount\pgf@sys@svg@picnum

\newdimen\pgfsvgextraborder
\pgfsvgextraborder=.5pt

\def\pgfsys@beginpicture#1#2#3#4{%
  \global\advance\pgf@sys@svg@picnum by 1\relax%
  % Ok, compute width/height
  \pgf@xa=#1%
  \advance\pgf@xa by-\pgfsvgextraborder%
  \pgf@ya=#2%
  \advance\pgf@ya by-\pgfsvgextraborder%
  \pgf@xb=#3%
  \advance\pgf@xb by\pgfsvgextraborder%
  \pgf@yb=#4%
  \advance\pgf@yb by\pgfsvgextraborder%
  \pgf@x=\pgf@xb%
  \advance\pgf@x by-\pgf@xa%
  \pgf@y=\pgf@yb%
  \advance\pgf@y by-\pgf@ya%
  \HCode{<object data="\jobname-\the\pgf@sys@svg@picnum.svg"
    width="\the\pgf@x" height="\the\pgf@y"
  type="image/svg+xml"><p>SVG-Viewer needed.</p></object>\Hnewline }%
  \special{t4ht>\jobname-\the\pgf@sys@svg@picnum.svg}%
  \pgfsys@invoke{<svg width="\the\pgf@x" height="\the\pgf@y" viewBox="}
  \pgf@sys@pt{\pgf@xa}\pgf@sys@pt{\pgf@ya}\pgf@sys@pt{\pgf@x}\pgf@sys@pt{\pgf@y}%
  \pgfsysprotocol@flushcurrentprotocol%
  \pgf@ya=-\pgf@ya%
  \pgfsys@invoke{">\Hnewline  <g transform="translate(0,\the\pgf@yb) scale(1,-1)
    translate(0,\the\pgf@ya)">\Hnewline }
  \edef\pgf@sys@svg@savedpicnum{\the\pgf@sys@svg@picnum}%
}
\def\pgfsys@endpicture{%
  \pgfsys@invoke{</g>\Hnewline </svg>\Hnewline }%
  \special{t4ht<\jobname-\pgf@sys@svg@savedpicnum.svg}%
}

\def\pgfsys@beginhbox{%
  \ifx\tikz@textcolor\@empty\else\pgfsetfillcolor{\tikz@textcolor}\fi% tweak for TikZ
  \HCode{<text style="stroke:none" transform="scale(1,-1)">\Hnewline }}
\def\pgfsys@endhbox{\HCode{</text>\Hnewline }}

\def\pgfsys@outerinvoke{\ifpgfpicture\expandafter\pgfsys@invoke\else\expandafter\@gobble\fi}

% Protect against color.4ht evil meddling with xcolor:
\let\pgf@xcolor@declaredcolor=\@declaredcolor
\let\pgf@xcolor@undeclaredcolor=\@undeclaredcolor

\AtBeginDocument{
  \let\pgf@texht@declaredcolor=\@declaredcolor
  \let\pgf@texht@undeclaredcolor=\@undeclaredcolor
  \def\@declaredcolor{\ifpgfpicture\expandafter\pgf@xcolor@declaredcolor\else\expandafter\pgf@texht@declaredcolor\fi}
  \def\@undeclaredcolor{\ifpgfpicture\expandafter\pgf@xcolor@undeclaredcolor\else\expandafter\pgf@texht@undeclaredcolor\fi}
}

\endinput


%%% Local Variables: 
%%% mode: latex
%%% End: 
