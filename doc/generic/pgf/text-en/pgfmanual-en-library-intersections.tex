% Copyright 2008 by Mark Wibrow
%
% This file may be distributed and/or modified
%
% 1. under the LaTeX Project Public License and/or
% 2. under the GNU Free Documentation License.
%
% See the file doc/generic/pgf/licenses/LICENSE for more details.


\section{Intersections Library}

{\bf\emph{This library is experimental and likely to change,
move, or disappear, without warning.}}

\begin{pgflibrary}{intersections}
  This library enables the calculation of intersections of
  two arbitrary paths. However, due to the low accuracy of
  \TeX, the paths should not be ``too complicated''.
  In particular, you should not try to intersect paths consisting 
  lots of very small segments such as plots or decorated paths.
\end{pgflibrary}

\subsection{Intersecting Two Paths in PGF}
  
  To find the intersections of two paths in \pgfname, the following 
  command is provided:
   
\begin{command}{\pgfintersectionofpaths\marg{path 1}\marg{path 2}}
  This command finds the intersection points on the paths 
  \meta{path 1} and \meta{path 2}. The number of intersection points
  (``solutions'') that are found will be stored, and each point 
  can be accessed afterward. The code for \meta{path 1} and 
  \meta{path 2} is executed within a \TeX{} group and so can contain
  transformations (which will be in addition to any existing
  transformations). The code should not use the path in any way, 
  unless the path is saved first and restored afterward.
  \pgfname{} will regard solutions as ``a bit
  special'', in that the points returned  will be ``absolute'' and 
  unaffected by any further transformations.

\begin{codeexample}[]
\begin{pgfpicture}
\pgfintersectionofpaths
{
  \pgfpathellipse{\pgfpointxy{0}{0}}{\pgfpointxy{1}{0}}{\pgfpointxy{0}{2}}
  \pgfgetpath\temppath
  \pgfusepath{stroke}
  \pgfsetpath\temppath
}
{
  \pgftransformrotate{-30}
  \pgfpathrectangle{\pgfpointorigin}{\pgfpointxy{2}{2}}
  \pgfgetpath\temppath
  \pgfusepath{stroke}
  \pgfsetpath\temppath
}
\foreach \s in {1,...,\pgfintersectionsolutions}
  {\pgfpathcircle{\pgfpointintersectionsolution{\s}}{2pt}}
\pgfusepath{stroke}
\end{pgfpicture}
\end{codeexample}

\end{command}

\begin{command}{\pgfintersectionsolutions}
  After using the |\pgfintersectionofpaths| command, this \TeX-counter
  will indicate the number of solutions found.
\end{command}

\begin{command}{\pgfpointintersectionsolution\marg{number}}
  After using the |\pgfintersectionofpaths| command, this command
  will return the point for solution \meta{number} or the origin
  if this solution was not found. Unfortunately
  there can be no guarantee of a ``helpful'' ordering of solutions.
\end{command}

\subsection{Intersecting Two Paths in \tikzname}

  There are two ways of finding the intersection points of two paths 
  in \tikzname. The first way is to use the |intersection| 
  coordinate system which is described in 
  Section~\ref{section-intersection-coordinates}. This requires
  the following two keys:

\begin{key}{/tikz/cs/first path=\marg{path}}
  This key describes one of the paths to be used in when calculating
  the intersection. The value \meta{path} can be any valid \tikzname{}
  code (omitting the semi-colon at the end). It is possible to use
  transformations and nodes, as well, however, for maximum 
  success, you should avoid complicated paths like plots or 
  decorated paths. No actions such as drawing or filling will be
  carried out, as it is only the structure of the path that is
  relevant. The braces around \meta{path} should always be
  used.
\end{key}

\begin{key}{/tikz/cs/second path=\marg{path}}
  This key describes the other path to be used in when calculating
  the intersections.
\end{key}
  
  If a path has multiple intersections, they can be found
  using the |solution| key (see 
  Section~\ref{section-intersection-coordinates}).
  
\begin{codeexample}[]
\begin{tikzpicture}[thick]
  \draw [help lines] grid (3,2);
  \draw [path name=circle, blue]  (1.5,1.25) circle (0.75cm);
  \draw [path name=curve] (0,0) .. controls (0,2) and (3,2) .. (3,0);
  \fill [red, opacity=0.5]
    (intersection cs:first path={(1.5,1.25) circle (0.75cm)}, 
     second path={(0,0) .. controls (0,2) and (3,2) .. (3,0)})
     circle (2pt);
\end{tikzpicture}
\end{codeexample}

  One drawback with the |intersection| coordinate system is that
  it is rather cumbersome to specify each path twice, once for drawing
  (for example) and again for the intersection, particularly if
  either path is fairly long. To overcome this problem, this library 
  introduces the concept of ``named paths''. A ``named path'' is, 
  quite simply, a path that has been named using the following key:
  
\begin{key}{/tikz/path name=\meta{name}}

	The effect of this key is that, after the path has been constructed,
  just before it is used, it is associated \meta{name}. This 
  association is global, so lasts after the final semi-colon on the
  path.  
  The border path created by any nodes are also included, however,
  as this may not always be desirable, one value for \meta{name} 
  is special: the value |none|. When |path name=none| is given 
  in the options to a node on a path, the border path of that node 
  is ignored. 

\begin{codeexample}[]
\begin{tikzpicture}[every node/.style={circle, midway, minimum size=1cm, draw}]
  \draw [help lines] grid (3,2);
  \draw [path name=path 1, thick, blue] (1,0) -- (2,2) 
    node [path name=none, left=0.25cm, draw] {}
    node [right=0.25cm, draw]                {};
  \draw [path name=path 2, thick] (0,0.5) -- (3,1.5);
  \tikzintersectnamedpaths{path 1}{path 2}
  \fill [red, opacity=0.5] \foreach \s in {1,...,\solutions}
      { (solution cs:number=\s) circle (2pt) };  
\end{tikzpicture}
\end{codeexample}

 
\end{key}

  Two further keys are provided to use named paths with the
  intersection coordinate system:
  
\begin{key}{/tikz/cs/first path name=\meta{name}}
  This key specifies the first path name.
\end{key}

\begin{key}{/tikz/cs/second path name=\meta{name}}
  This key specifies the second path name.
\end{key}

These keys can then be used as follows:
  
\begin{codeexample}[]
\begin{tikzpicture}[thick]
  \draw [help lines] grid (3,2);
  \draw [path name=circle, blue]  (1.5,0.75) circle (0.75cm);
  \draw [path name=curve] (0,2) .. controls (0,0) and (3,0) .. (3,2);
  \fill [red, opacity=0.5]
    (intersection cs:first path name=circle, second path name=curve)
     circle (2pt);
\end{tikzpicture}
\end{codeexample}

  This is approach is fine if only one or two intersections are 
  required. For paths with many intersections, the intersection
  coordinate system will prove to be quite slow as the solutions 
  are recalculated every time it is used. It would be
  easier if the solutions could be calculated ``all at once'', and
  then accessed later. It might also be nice if, say, two or
  more intersections could be calculated and then all the solutions
  were made available for subsequent drawing. This leads to the
  second way of finding intersections in \tikzname: by using the
  following command:

\begin{command}{\tikzintersectnamedpaths\opt{|[id=|\meta{name}|]|}\marg{path name 1}\marg{path name 2}}
  
  This command finds all the intersections of the paths associated 
  with \meta{path name 1} \meta{path name 2}. 
  By default, when the optional |id| key is not 
  specified, the number of solutions will be stored in the \TeX-macro 
  |\solutions|. Using the |id| key will associate any solutions
  found with \meta{name}. In addition, the number of solutions will 
  be stored in the \TeX-macro |\|\meta{name}|solutions|, so, for 
  example, by using |id=foo|, the \TeX-macro |\foosolutions|  will 
  expand to the number of solutions. This means that, in general, 
  \meta{name} should be a single word consisting only of alphabetic 
  characters.
  
  Solutions will only be ``remembered'' up to the end of the current
  scope, and can be accessed using the |solution| coordinate system:
    
\begin{coordinatesystem}{solution}
  This coordinate system returns a particular solution from 
  a intersection (which may or may not have an identification 
  name). The following keys can be used with this coordinate
  system:

\begin{key}{/tikz/cs/solution=\meta{number}}
  This key specifies the number of the required solution. It is not
  possible to guarantee the order of the solutions. It is possible
  to omit the |solution=| and use \meta{number} on its own, but it
  is important to remember that this is only possible within this
  coordinate system. If a solution does not exist, the origin will be
  returned.

\begin{codeexample}[]
\begin{tikzpicture}[every node/.style={opacity=1, circle, black, above left}]
  \clip (-2,-2) rectangle (2,2);
  \draw [path name=curve 1] (-2,-1) .. controls (8,-1) and (-8,1) .. (2,1);
  \draw [path name=curve 2] (-1,-2) .. controls (-1,8) and (1,-8) .. (1,2);
  \tikzintersectnamedpaths{curve 1}{curve 2}
  \fill [red, opacity=0.5] \foreach \s in {1,...,\solutions}
  { (solution cs:\s) circle (2pt) node {\footnotesize\s} };
\end{tikzpicture}
\end{codeexample}
\end{key}

\begin{key}{/tikz/cs/id=\meta{name}}
  Using this key will mean that solutions associated with the 
  intersection \meta{name} will be accessed.  
\end{key}

\begin{codeexample}[]
\begin{tikzpicture}
  \draw [help lines] grid  (3,2);
  \draw [path name=line 1] (0,0) -- (1,2);
  \draw [path name=line 2] (0,1) -- (2,2);
  \draw [path name=circle] (2,1) circle (0.75cm);
  \draw [path name=square] (2,0) rectangle +(1,1);
  \tikzintersectnamedpaths[id=first]{line 1}{line 2}
  \tikzintersectnamedpaths[id=second]{circle}{square}
  \draw [red, thick]  (solution cs:solution=1,id=first) --
  	(solution cs:solution=2,id=second);
  \draw [blue, thick] (solution cs:solution=1,id=first) --
  	(solution cs:solution=1,id=second);
\end{tikzpicture}

\end{codeexample}

\end{coordinatesystem}

\end{command}

  There are keys to invoke |\tikzintersectnamedpaths| inside a path. You
  must remember, however, that solutions will only be remembered until 
  the end of the path.
  
\begin{key}{/tikz/intersect named paths=\meta{path name 1}| |and| |\meta{path name 2}}
  This key calculates all the intersections of the paths
  associated with \meta{path name 1} and \meta{path name 2}.
   
\begin{codeexample}[]
\begin{tikzpicture}[every node/.style={opacity=1, circle, black, above left}]
  \draw [help lines] grid (3,2);
  \draw [path name=ellipse] (2,0.5) ellipse (0.75cm and 1cm);
  \draw [path name=rectangle, rotate=10]  (0.5,0.5) rectangle +(2,1);
  \fill [red, opacity=0.5, intersect named paths=ellipse and rectangle]
    \foreach \s in {1,...,\solutions}
      { (solution cs:solution=\s) circle (2pt) node {\footnotesize\s} };    
\end{tikzpicture}
\end{codeexample}
   
\end{key}

\begin{key}{/tikz/intersection id=\meta{name}}
  This key \emph{must} be given \emph{before} the |intersect| |named| 
  |paths| key is used. It will allow any intersection solutions
  to be accessed using the |id| key in the |solution| coordinate
  system.
\end{key}
