\section{Tutorial: A Petri-Net for Hagen}

In this second tutorial we explore the node mechanism of
\tikzname\ and \pgfname.

Hagen must give a talk tomorrow about his favorite formalism for
distributed systems: Petri nets! Hagen used to give his talks using a
blackboard and everyone seemed to be perfectly concent with
this. Unfortunately, his audience has been spoiled recently with fancy
projector-based presentations and there seems to be a certain amount
of peer pressure that this Petri nets should also be drawn using a
graphic program. One of the professors at his institutes recommends
\tikzname\ for this and Hagen decides to give it a try.


\subsection{Problem Statement}

For his talk, Hagen wishes to create a graphic that demonstrates how a
net with place capacities can be simulated by a net without
capacities. The graphic should look like this, ideally:

\begin{quote}
\begin{tikzpicture}[node distance=6mm,>=stealth']

  \tikzstyle{place}=[circle,thick,draw=blue!75,fill=blue!20,minimum size=6mm]
  \tikzstyle{red place}=[place,draw=red!75,fill=red!20]
  \tikzstyle{transition}=[rectangle,thick,draw=black!75,fill=black!20,minimum size=4mm]
  \tikzstyle{pre}=[<-,shorten <=1pt,semithick,black!80]
  \tikzstyle{post}=[->,shorten >=1pt,semithick,black!80]

  \tikzstyle{mark}=[circle,fill,minimum size=1.5mm,inner sep=0pt]

  \begin{scope}
    % First net
    \node [place] (w1)               {};
    \node [place] (c1) [below of=w1] {};
    \node [place] (s)  [below of=c1] {}; \node [above,red!75!black] at (s.north) {$s\le 3$};
    \node [place] (c2) [below of=s]  {};
    \node [place] (w2) [below of=c2] {};
    
    \node [transition] (e1) [left of=c1] {}
      edge [pre,out=90,in=180]   (w1)
      edge [post,out=-90,in=180] (s)
      edge [post]                (c1);

    \node [transition] (e2) [left of=c2] {}
      edge [pre,out=-90,in=-180] (w2)
      edge [post,out=90,in=180]  (s)
      edge [post]                (c2);
      
    \node [transition] (l1) [right of=c1] {}
      edge [pre]                 (c1)
      edge [pre,out=-90,in=0]    (s)
      edge [post,out=90,in=0]    (w1);

    \node [transition] (l2) [right of=c2] {}
      edge [pre]                 (c2)
      edge [pre,out=90,in=0]     (s)
      edge [post,out=-90,in=0]   (w2);

    \node [mark] at (w1) {};
    \node [mark] at (w2) {};
  \end{scope}
  
  \begin{scope}[xshift=6cm]
    % Second net
    \node [place]     (w1')                            {};
    \node [place]     (c1') [below of=w1']             {};
    \node [red place] (s1') [below of=c1',xshift=-5mm] {}; \node [left,red!75!black]  at (s1'.west) {$s$};
    \node [red place] (s2') [below of=c1',xshift=5mm]  {}; \node [right,red!75!black] at (s2'.east) {$\bar s$};
    \node [place]     (c2') [below of=s1',xshift=5mm]  {};
    \node [place]     (w2') [below of=c2']             {};
    
    \node [transition] (e1') [left of=c1'] {}
      edge [pre,out=90,in=180]   (w1')
      edge [post]                (s1')
      edge [pre]                 (s2')
      edge [post]                (c1');

    \node [transition] (e2') [left of=c2'] {}
      edge [pre,out=-90,in=-180] (w2')
      edge [post]                (s1')
      edge [pre]                 (s2')
      edge [post]                (c2');
      
    \node [transition] (l1') [right of=c1'] {}
      edge [pre]                 (c1')
      edge [pre]                 (s1')
      edge [post]                (s2')
      edge [post,out=90,in=0]    (w1');

    \node [transition] (l2') [right of=c2'] {}
      edge [pre]                 (c2')
      edge [pre]                 (s1')
      edge [post]                (s2')
      edge [post,out=-90,in=0]   (w2');

    \node [mark] at (w1') {};
    \node [mark] at (w2') {};
    \node [mark] at ([shift={(90:1.1mm)}]s2') {};
    \node [mark] at ([shift={(210:1.1mm)}]s2') {};
    \node [mark] at ([shift={(330:1.1mm)}]s2') {};
  \end{scope}

  \draw [-to,thick,snake=snake,segment amplitude=.4mm,segment length=2mm,line after snake=1mm]
    ([xshift=5mm]s -| l1) -- ([xshift=-5mm]s1' -| e1')
    node [above=1mm,midway,text width=3cm,text centered]
      {replacement of the \textcolor{red!75!black}{capacity} by \textcolor{red!75!black}{two places}};

  \begin{pgfonlayer}{background}
    \filldraw [line width=4mm,join=round,black!10]
      (w1.north  -| l1.east)  rectangle (w2.south  -| e1.west)
      (w1'.north -| l1'.east) rectangle (w2'.south -| e1'.west);
  \end{pgfonlayer}
\end{tikzpicture}
\end{quote}


\subsection{Setting up the Environment}

For the picture Hagen will need to load the \tikzname\ package as did
Karl in the previous tutorial. However, Hagen will also need to load
some additional  \emph{library packages} that Karl did not need. These
library packages contain additional definitions like extra arrow tips
that are typically not needed in a picture and that need to be
loaded explicitly.

Hagen will need to load three libraries: The arrow tip library for the
special arrow tip used in the graphic, the snake library with the
``snaking line'' in the middle, and the background library for the two
rectangular areas that are behind the two main parts of the picture. 


\subsubsection{Setting up the Environment in \LaTeX}

When using \LaTeX\ use:

\begin{codeexample}[code only]
\documentclass{article} % say

\usepackage{tikz}
\usepackage{pgflibraryarrows}
\usepackage{pgflibrarysnakes}
\usepackage{pgflibrarytikzbackgrounds}

\begin{document}
\begin{tikzpicture}
  \draw (0,0) -- (1,1);
\end{tikzpicture}
\end{document}
\end{codeexample}

\subsubsection{Setting up the Environment in Plain \TeX}

When using plain \TeX\ use:

\begin{codeexample}[code only]
%% Plain TeX file
\input tikz.tex
\input pgflibraryarrows.tex
\input pgflibrarysnakes.tex
\input pgflibrarytikzbackgrounds.tex
\baselineskip=12pt
\hsize=6.3truein
\vsize=8.7truein
\tikzpicture
  \draw (0,0) -- (1,1);
\endtikzpicture
\bye
\end{codeexample}

\subsubsection{Setting up the Environment in Con\TeX t}

When using Con\TeX\ use:
\begin{codeexample}[code only]
%% ConTeXt file
\usemodule[tikz]
\usemodule[pgflibraryarrows]
\usemodule[pgflibrarysnakes]
\usemodule[pgflibrarytikzbackgrounds]

\starttikzpicture
  \draw (0,0) -- (1,1);
\stoptikzpicture
\end{codeexample}



\subsection{Introduction to Nodes}

In principle, we already know how to create the graphics that Hagen
desires (except perhaps for the snaked line, we will come to that): We
start with big light gray rectangle and then add lots of circles and
small rectangle, plus some arrows.

However, this approach has numerous disadvantages: First, it is hard
to change anything at a later stage. For example, if we decide to add
more places to the Petri nets (the circles are called places in Petri
net theory), all of the coordinates change and we need to recalculate
everything. Second, it is hard to read the code for the Petri net as
it just a long and complicated list of coordinates and drawing
commands -- the underlying structure of the Petri net is lost.

Fortunately, \tikzname\ offers a powerful mechanism for avoiding the
above problems: nodes. We already came across nodes in the previous
tutorial, where we used them to add labels to Karl's graphic. In the
present tutorial we will see that nodes are much more powerful.

A node is a small part of a picture. When a node is created, you
provide a position where the node should be drawn and a
\emph{shape}. A node of shape |circle| will be drawn as a circle, a
node of shape |rectangle| as a rectangle, and so on. A node may also
contain same text, which is why Karl used nodes to show text. Finally,
a node can get a \emph{name} for later reference.

In Hagen's picture we will use nodes for the places and for the
transitions of the Petri net (the places are the circles, the
transitions are the rectangles). Let us start with the topmost four
nodes on the left: Two places and two rectangles left and right. For
this, we 




\subsection{Nodes}

to be rewritten:

Placing text at a given position is just a special case of a more
general underlying mechanism. When you say |\draw (0,0) node{text};|,
what actually happens is that a rectangular node, anchored at its center, is
put at position $(0,0)$. On top of the rectangular node the text
|text| is drawn. Since no action is specified for the rectangle (like
|draw| or |fill|), the rectangle is actually discarded and only the
text is shown. However, by adding |fill| or |draw|, we can make the
underlying shape visible. Furthermore, we can \emph{change} the
shape using for example |shape=circle| or just |circle|. If we include
the package |pgflibraryshapes| we also get |ellipse|:


\begin{codeexample}[]
\begin{tikzpicture}
  \path (0,0)   node[ellipse,fill=examplefill,draw]
                  (h1) {hello world}
        (0.5,2) node[circle,shade,ball color=examplefill]
                  (h2) {hello world};
  \draw [->,shorten >=2pt] (h1.north) -- (h2.south);
\end{tikzpicture}
\end{codeexample}

As the above example shows, we can add the a name to a node by
putting it in parentheses between |node| and the |{|\meta{text}|}|
(you can also use the |name=| option). This will make \tikzname\ remember your node and all
its anchors. You can then refer to these anchors when specifying
coordinates. The syntax is |(|\meta{node
  name}|.|\meta{anchor}|)|. Currently, and also in the near future, 
\emph{this will not work across pictures since \tikzname\ looses track
  of the positions when it returns control to \TeX.} Magic hackery is
possible for certain drivers, but a portable implementation seems
impossible (just think of a possible \textsc{svg} driver). 

The option |shorten >| causes lines to be shortened by 2pt at the
end. Similarly, |shorten <| can be used to shorten (or even lengthen)
lines at the beginning. This is possible even if no arrow is drawn.

It is not always necessary to specify the anchor. If you do not give
an anchor, \tikzname\ will try to determine a reasonable border anchor by
itself (if \tikzname\ fails to find anything useful, it will use the
center instead). Here is a typical example:

\begin{codeexample}[]
\begin{tikzpicture}
  \begin{scope}[shape=circle,minimum size=1cm,fill=examplefill]
    \tikzstyle{every node}=[draw,fill]
    \node (q_A) at (0,0) {$q_A$};
    \node (q_E) at (6,0) {$q_E$};
    \node (q_1) at (2,0) {$q_1$};
    \node (q_2) at (4,2) {$q_2$};
  \end{scope}
  \draw (q_A) -- (q_1) -- (q_2) -| (q_E);
  \draw[->,shorten >=2pt] (q_A) .. controls +(75:1.4cm) and +(105:1.4cm) .. node[above] {$x$} (q_A);
\end{tikzpicture}
\end{codeexample}

In the example, we used the |\node| command, which is an abbreviation
for |\path node|. 
